var _e=Object.defineProperty;var Me=(s,t,a)=>t in s?_e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a;var te=(s,t,a)=>Me(s,typeof t!="symbol"?t+"":t,a);import{e as Ie,c as G,R as Y,j as e,u as ie,r as x,b as Ce,bY as ue,cK as Se}from"./vendor-DX97-qL9.js";import{G as I,S as u,I as m,A as ke,s as Te,l as Ae,o as B}from"./ui-components-DWjWyKd7.js";import{u as Ee}from"./useScrollMemory-C8VkSb5_.js";import{l as w,s as X,u as ee,g as he}from"./page-fridge-BvAjnJpI.js";import{A as ne}from"./Avatar3DViewer-ChhNpHs3.js";import{b as q}from"./stores-DcNfcD_j.js";import{m as j,A as re}from"./motion-DLE-fuXv.js";import{f as ge}from"./page-fridge-scan-ZLPWYd6x.js";import{f as J,a as Z}from"./date-utils-sCOX3Ksr.js";import"./utils-CUtLAp28.js";import"./supabase-C_rF2iqf.js";import"./normalizeSkinTone-gBHfMnNZ.js";function pe(){const{profile:s}=q(),t=Ie(),a=s?.userId,i=G({queryKey:["body-scan-data",a],queryFn:async()=>{if(!a)return w.debug("USE_BODY_SCAN_DATA","No user ID available",{philosophy:"no_user_id"}),null;w.info("USE_BODY_SCAN_DATA","Fetching latest body scan",{userId:a,philosophy:"body_scan_fetch_start"});const{data:l,error:r}=await X.from("body_scans").select("*").eq("user_id",a).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(r)throw w.error("USE_BODY_SCAN_DATA","Error fetching body scan",{userId:a,error:r.message,philosophy:"body_scan_fetch_error"}),r;if(!l)return w.info("USE_BODY_SCAN_DATA","No body scan found",{userId:a,philosophy:"no_body_scan"}),null;const n=l.metrics||{},o=l.morph_values||l.morph3d||n.final_shape_params||{},f=l.limb_masses||n.final_limb_masses||{},p=l.skin_tone_map_v2||n.skin_tone||l.skin_tone||null,b=l.resolved_gender||n.resolved_gender||null,d=n.estimate_result?.extracted_data||{},y=l.raw_measurements||d.raw_measurements||{},M=l.weight||y.weight_kg||d.weight_kg||null,_=l.body_fat_percentage||d.estimated_body_fat_perc||null,g=l.bmi||d.estimated_bmi||null,v=l.waist_circumference||y.waist_cm||null;return w.info("USE_BODY_SCAN_DATA","Body scan loaded successfully",{userId:a,scanId:l.id,timestamp:l.timestamp,hasMorphValues:!!o&&Object.keys(o).length>0,morphValuesCount:Object.keys(o).length,morphValuesSource:l.morph_values?"direct_column":n.final_shape_params?"metrics_jsonb":"none",hasLimbMasses:!!f&&Object.keys(f).length>0,limbMassesCount:Object.keys(f).length,limbMassesSource:l.limb_masses?"direct_column":n.final_limb_masses?"metrics_jsonb":"none",hasSkinTone:!!p,skinToneSource:l.skin_tone_map_v2?"v2_direct_column":n.skin_tone?"metrics_jsonb":l.skin_tone?"legacy_column":"none",hasResolvedGender:!!b,resolvedGenderValue:b,resolvedGenderSource:l.resolved_gender?"direct_column":n.resolved_gender?"metrics_jsonb":"none",hasWeight:!!M,weight:M,hasBodyFat:!!_,bodyFatPercentage:_,hasBMI:!!g,bmi:g,hasWaist:!!v,waistCircumference:v,avatarVersion:l.avatar_version||n.avatar_version||"unknown",gltfModelId:l.gltf_model_id||n.gltf_model_id||"unknown",philosophy:"body_scan_loaded_with_extraction"}),{...l,morph_values:o,limb_masses:f,skin_tone:p,resolved_gender:b,weight:M,body_fat_percentage:_,bmi:g,waist_circumference:v,raw_measurements:y}},enabled:!!a,staleTime:5*60*1e3,gcTime:30*60*1e3,refetchOnMount:"always",refetchOnWindowFocus:!1}),c=()=>{w.info("USE_BODY_SCAN_DATA","Invalidating body scan data cache",{userId:a,philosophy:"cache_invalidation"}),t.invalidateQueries({queryKey:["body-scan-data",a]})},h=l=>{w.info("USE_BODY_SCAN_DATA","Updating body scan data cache manually",{userId:a,scanId:l.id,philosophy:"manual_cache_update"}),t.setQueryData(["body-scan-data",a],l)};return{bodyScanData:i.data,isLoading:i.isLoading,isError:i.isError,error:i.error,refetch:i.refetch,invalidateBodyScanData:c,updateBodyScanDataCache:h}}function Be(s,t,a){const i=[],c=a.weight_kg/Math.pow(a.height_cm/100,2),h=s.pearFigure||0,l=Math.abs(s.narrowWaist||0),r=s.bigHips||0;let n;h>.3||r>.3?n={id:"silhouette-curves",title:"Silhouette Harmonieuse",description:"Vos courbes naturelles cr√©ent une silhouette √©quilibr√©e et f√©minine",icon:"Heart",color:"#EC4899",value:"Courbes",category:"silhouette"}:l>.3?n={id:"silhouette-athletic",title:"Taille D√©finie",description:"Votre taille marqu√©e r√©v√®le une silhouette athl√©tique et structur√©e",icon:"Target",color:"#10B981",value:"Athl√©tique",category:"silhouette"}:n={id:"silhouette-balanced",title:"Silhouette √âquilibr√©e",description:"Vos proportions naturelles cr√©ent une harmonie corporelle parfaite",icon:"Circle",color:"#06B6D4",value:"√âquilibr√©e",category:"silhouette"},i.push(n);const o=s.bodybuilderSize||0,f=s.bodybuilderDetails||0,p=s.emaciated||0;let b;o>.3||f>.3?b={id:"development-muscular",title:"D√©veloppement Musculaire",description:"Votre masse musculaire t√©moigne d'un excellent travail physique",icon:"Zap",color:"#8B5CF6",value:"D√©velopp√©",category:"development"}:p<-.3?b={id:"development-lean",title:"Composition Lean",description:"Votre physique fin r√©v√®le une excellente d√©finition musculaire",icon:"TrendingUp",color:"#F59E0B",value:"D√©fini",category:"development"}:b={id:"development-natural",title:"Tonus Naturel",description:"Votre d√©veloppement musculaire naturel offre une base solide",icon:"Activity",color:"#22C55E",value:"Naturel",category:"development"},i.push(b);let d;c<18.5?d={id:"composition-lean",title:"M√©tabolisme Rapide",description:"Votre composition r√©v√®le un m√©tabolisme efficace et dynamique",icon:"Zap",color:"#06B6D4",value:"Dynamique",category:"composition"}:c>=18.5&&c<25?d={id:"composition-optimal",title:"Composition Optimale",description:"Votre √©quilibre masse/taille se situe dans la zone id√©ale",icon:"Check",color:"#10B981",value:"Optimale",category:"composition"}:c>=25&&c<30?d={id:"composition-robust",title:"Constitution Robuste",description:"Votre morphologie r√©v√®le une constitution solide et puissante",icon:"Shield",color:"#F59E0B",value:"Robuste",category:"composition"}:d={id:"composition-powerful",title:"Potentiel de Transformation",description:"Votre morphologie actuelle offre un excellent potentiel d'√©volution",icon:"TrendingUp",color:"#8B5CF6",value:"√âvolutif",category:"composition"},i.push(d);const y=s.assLarge||0,M=s.superBreast||0,_=s.breastsSmall||0;let g;return t==="female"&&(M>.2||_>.2)?g={id:"balance-feminine",title:"F√©minit√© Naturelle",description:"Vos attributs f√©minins cr√©ent une harmonie corporelle unique",icon:"Heart",color:"#EC4899",value:"F√©minine",category:"balance"}:y>.2?g={id:"balance-curves",title:"√âquilibre des Volumes",description:"La r√©partition de vos volumes cr√©e une silhouette harmonieuse",icon:"Circle",color:"var(--color-body-scan-primary)",value:"Harmonieuse",category:"balance"}:g={id:"balance-symmetrical",title:"Sym√©trie Parfaite",description:"Votre morphologie pr√©sente un √©quilibre naturel remarquable",icon:"GitCompare",color:"var(--color-body-scan-accent)",value:"Sym√©trique",category:"balance"},i.push(g),i}const Fe=({finalShapeParams:s,resolvedGender:t,userProfile:a})=>{const i=Y.useMemo(()=>Be(s,t,a),[s,t,a]);return e.jsx(I,{className:"p-6",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, #06B6D4 8%, transparent) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"color-mix(in srgb, #06B6D4 25%, transparent)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px color-mix(in srgb, #06B6D4 10%, transparent)
        `},children:e.jsxs(j.div,{className:"slide-enter",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.3},children:[e.jsxs("div",{className:"bodyscan-flex-between mb-6",children:[e.jsxs("h4",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #06B6D4 35%, transparent), color-mix(in srgb, #06B6D4 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #06B6D4 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #06B6D4 30%, transparent)"},children:e.jsx(u,{Icon:m.Zap,size:20,style:{color:"#06B6D4"},variant:"pure"})}),"Votre Profil Morphologique"]}),e.jsxs("div",{className:"bodyscan-status-badge bodyscan-status-badge--active",children:[e.jsx("div",{className:"bodyscan-status-icon"}),e.jsx("span",{className:"bodyscan-status-text",children:"Analyse Spatiale"})]})]}),e.jsx("div",{className:"morphology-insights-grid",children:i.map((c,h)=>e.jsxs(j.div,{className:"morphology-insight-item",style:{"--insight-color":c.color},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.1+h*.1},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(u,{Icon:m[c.icon],size:20,color:c.color})}),e.jsx("div",{className:"morphology-insight-value",children:c.value}),e.jsx("div",{className:"morphology-insight-title",children:c.title})]},c.id))}),e.jsx(j.div,{className:"morphology-summary-card",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.6},style:{borderRadius:"24px",overflow:"hidden"},children:e.jsx("p",{className:"text-white/80 text-sm leading-relaxed",children:"Votre morphologie unique r√©v√®le un potentiel extraordinaire. Chaque caract√©ristique de votre corps raconte l'histoire de votre parcours et offre des opportunit√©s d'optimisation personnalis√©es."})})]})})};function De(s){return s?{weight:s.weight?`${s.weight.toFixed(1)} kg`:"N/A",bmi:s.bmi?s.bmi.toFixed(1):"N/A",bodyFat:s.bodyFatPercentage?`${s.bodyFatPercentage.toFixed(1)}%`:"N/A",waist:s.waistCircumference?`${s.waistCircumference.toFixed(0)} cm`:"N/A",scanDate:s.createdAt?new Date(s.createdAt).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"}):"N/A"}:null}const ze=[{id:"weight",label:"Poids",icon:"Scale",color:"#10B981",getValue:s=>s.weight?`${s.weight.toFixed(1)} kg`:"N/A"},{id:"bmi",label:"IMC",icon:"Activity",color:"#06B6D4",getValue:s=>s.bmi?s.bmi.toFixed(1):"N/A",getSubtext:s=>s.bmi?s.bmi<18.5?"L√©ger":s.bmi<25?"Normal":s.bmi<30?"Surpoids":"Ob√®se":""},{id:"bodyFat",label:"Masse Grasse",icon:"Droplet",color:"#F59E0B",getValue:s=>{if(s.bodyFatPercentage)return`${s.bodyFatPercentage.toFixed(1)}%`;const t=30,a=s.userProfile?.sex||s.resolvedGender||"male";if(s.bmi){const i=a==="male"?1:0,c=1.2*s.bmi+.23*t-10.8*i-5.4;return`${Math.max(5,Math.min(50,c)).toFixed(1)}%`}return"N/A"},getSubtext:s=>!s.bodyFatPercentage&&s.bmi?"Estim√©":"",getTooltip:s=>{if(!s.bodyFatPercentage&&s.bmi)return"Estimation bas√©e sur l'IMC et le sexe biologique (formule de Deurenberg)";if(!s.bodyFatPercentage)return"M√©trique non disponible pour ce scan"}},{id:"leanMass",label:"Masse Maigre",icon:"Zap",color:"#06B6D4",getValue:s=>{const t=s.weight||s.userProfile?.weight_kg,a=s.bodyFatPercentage;if(t&&a)return`${(t*((100-a)/100)).toFixed(1)} kg`;const i=s.userProfile?.height_cm,c=s.userProfile?.sex||s.resolvedGender||"male";return t&&i&&s.bmi?c==="male"?`${(.407*t+.267*i-19.2).toFixed(1)} kg`:`${(.252*t+.473*i-48.3).toFixed(1)} kg`:"N/A"},getSubtext:s=>!(s.weight&&s.bodyFatPercentage)&&s.weight&&s.userProfile?.height_cm?"Estim√©":"",getTooltip:s=>s.weight&&s.bodyFatPercentage?"Masse maigre = poids total - masse grasse. Inclut muscles, os, organes et eau corporelle.":s.weight&&s.userProfile?.height_cm?"Estimation bas√©e sur la formule de Boer utilisant le poids, la taille et le sexe biologique.":"M√©trique non disponible pour ce scan"}],Re=({scan:s})=>{const t=De(s);return e.jsx(I,{className:"p-6",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, #06B6D4 8%, transparent) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"color-mix(in srgb, #06B6D4 25%, transparent)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px color-mix(in srgb, #06B6D4 10%, transparent)
        `},children:e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #06B6D4 35%, transparent), color-mix(in srgb, #06B6D4 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #06B6D4 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #06B6D4 30%, transparent)"},children:e.jsx(u,{Icon:m.BarChart3,size:16,style:{color:"#06B6D4"},variant:"pure"})}),e.jsx("span",{children:"M√©triques Corporelles"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 border border-green-500/30",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-400"}),e.jsxs("span",{className:"text-green-300 text-xs font-medium",children:["Scan du ",t?.scanDate]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:ze.map((a,i)=>{const c=a.getValue(s),h=a.getSubtext?.(s),l=a.getTooltip?.(s),r=c!=="N/A";return e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1+i*.1},whileHover:{y:-2},className:"relative p-4 rounded-xl border transition-all duration-300 group",style:{background:r?`linear-gradient(135deg, color-mix(in srgb, ${a.color} 10%, transparent), color-mix(in srgb, ${a.color} 5%, transparent))`:"rgba(255, 255, 255, 0.03)",borderColor:r?`color-mix(in srgb, ${a.color} 30%, transparent)`:"rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{background:r?`color-mix(in srgb, ${a.color} 20%, transparent)`:"rgba(255, 255, 255, 0.05)"},children:e.jsx(u,{Icon:m[a.icon],size:16,color:r?a.color:"rgba(255, 255, 255, 0.3)"})}),e.jsx("span",{className:"text-white/60 text-xs font-medium",children:a.label}),l&&e.jsxs("div",{className:"relative ml-auto",children:[e.jsx(u,{Icon:m.Info,size:12,className:"text-white/40"}),e.jsx("div",{className:"absolute bottom-full right-0 mb-2 hidden group-hover:block z-10 w-48",children:e.jsx("div",{className:"bg-black/90 text-white text-xs rounded-lg px-3 py-2 shadow-xl",children:l})})]})]}),e.jsx("div",{className:"text-white text-xl font-bold mb-1",children:c}),h&&r&&e.jsx("div",{className:"text-xs font-medium",style:{color:a.color},children:h})]},a.id)})}),s.rawMeasurements&&Object.keys(s.rawMeasurements).length>0&&e.jsx(j.div,{className:"mt-6 p-4 rounded-xl bg-white/5 border border-white/10",initial:{opacity:0},animate:{opacity:1},transition:{duration:.5,delay:.6},children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(u,{Icon:m.Ruler,size:16,className:"text-white/40 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white/60 text-xs font-medium mb-2",children:"Mesures d√©taill√©es"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:Object.entries(s.rawMeasurements).map(([a,i])=>e.jsxs("div",{className:"text-xs",children:[e.jsxs("span",{className:"text-white/40",children:[a.replace(/_/g," "),":"]})," ",e.jsxs("span",{className:"text-white/70 font-medium",children:[i," cm"]})]},a))})]})]})})]})})},Oe=()=>{const s=ie(),{profile:t}=q(),{bodyScanData:a,isLoading:i,error:c}=pe(),[h,l]=x.useState(!0),[r,n]=x.useState(!1),o=x.useRef(void 0);x.useEffect(()=>{const T=setTimeout(()=>{l(!1),w.debug("AVATAR_TAB","Component mounting delay complete",{philosophy:"minimum_skeleton_display_time"})},400);return()=>clearTimeout(T)},[]),x.useEffect(()=>{a?.id&&a.id!==o.current&&(n(!1),o.current=a.id,w.debug("AVATAR_TAB","Scan data changed to different scan, resetting viewer ready state",{scanId:a.id,previousScanId:o.current,philosophy:"reset_viewer_on_scan_change"}))},[a?.id]);const f=x.useCallback(()=>{w.info("AVATAR_TAB","Avatar 3D viewer ready callback triggered",{currentlyReady:r,scanId:a?.id,philosophy:"viewer_ready_callback_triggered"}),n(!0),w.info("AVATAR_TAB","Avatar 3D viewer fully initialized and state updated",{philosophy:"viewer_ready_state_updated"})},[r,a?.id]),p=i||h||!r;if(x.useEffect(()=>{if(!r&&a?.id){const T=setTimeout(()=>{r||(w.warn("AVATAR_TAB","Safety timeout: forcing viewer ready after 10s",{scanId:a.id,isLoading:i,isComponentMounting:h,philosophy:"safety_timeout_force_ready"}),n(!0))},1e4);return()=>clearTimeout(T)}},[r,a?.id,i,h]),w.info("AVATAR_TAB","Scan data loaded",{hasScan:!!a,scanId:a?.id,hasMorphValues:!!a?.morph_values,morphValuesCount:a?.morph_values?Object.keys(a.morph_values).length:0,hasLimbMasses:!!a?.limb_masses,limbMassesCount:a?.limb_masses?Object.keys(a.limb_masses).length:0,hasResolvedGender:!!a?.resolved_gender,resolvedGender:a?.resolved_gender,hasWeight:!!a?.weight,weight:a?.weight,philosophy:"avatar_tab_diagnostics"}),p&&!c)return e.jsx(ke,{});if(c)return e.jsxs(I,{className:"text-center p-8",children:[e.jsx(j.div,{className:"w-16 h-16 mx-auto mb-6 rounded-full bg-red-500/20 border border-red-400/30 flex items-center justify-center",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx(u,{Icon:m.AlertCircle,size:32,color:"#EF4444"})}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de chargement"}),e.jsx("p",{className:"text-red-300 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:c instanceof Error?c.message:"Une erreur est survenue lors du chargement de votre avatar."}),e.jsx("button",{className:"btn-glass px-6 py-3",onClick:()=>window.location.reload(),children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(u,{Icon:m.RotateCcw,size:16}),e.jsx("span",{children:"Actualiser"})]})})]});const b=a&&a.morph_values&&Object.keys(a.morph_values).length>0&&a.limb_masses&&Object.keys(a.limb_masses).length>0;if(a&&!b&&w.warn("AVATAR_TAB","Scan data incomplete",{scanId:a.id,morphValuesCount:a.morph_values?Object.keys(a.morph_values).length:0,limbMassesCount:a.limb_masses?Object.keys(a.limb_masses).length:0,missingMorphs:!a.morph_values||Object.keys(a.morph_values).length===0,missingLimbMasses:!a.limb_masses||Object.keys(a.limb_masses).length===0,philosophy:"incomplete_scan_validation"}),!a||!b)return e.jsxs(I,{className:"text-center p-8",interactive:!0,children:[e.jsxs(j.div,{className:"w-20 h-20 mx-auto rounded-full bg-blue-500/20 flex items-center justify-center mb-6 relative",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(u,{Icon:m.Scan,size:40,className:"text-blue-400"}),e.jsx(j.div,{className:"absolute inset-0 rounded-full border-2 border-blue-400/30",animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:"Aucun avatar corporel"}),e.jsx("p",{className:"text-white/70 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:a?"Donn√©es morphologiques incompl√®tes. Veuillez effectuer un nouveau scan.":"Effectuez un scan corporel pour cr√©er votre avatar 3D personnalis√©."}),e.jsx("button",{className:"btn-glass--primary px-8 py-4 text-lg font-semibold",onClick:()=>s("/body-scan"),children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(u,{Icon:m.Camera,size:20}),e.jsx("span",{children:"Commencer le scan corporel"})]})})]});const d=a.morph_values||{},y=a.limb_masses||{},M=a.skin_tone||null,_=a.resolved_gender||t?.sex||"male",g={sex:_,height_cm:t?.height_cm||170,weight_kg:a.weight||t?.weight_kg||70};w.info("AVATAR_TAB","Rendering avatar with data",{scanId:a.id,morphDataKeys:Object.keys(d).length,limbMassesKeys:Object.keys(y).length,hasSkinTone:!!M,resolvedGender:_,userProfile:g,philosophy:"avatar_render_data"});const v=t?.preferences?.face?.final_face_params||{},C=t?.preferences?.face?.skin_tone||null;return e.jsxs("div",{className:"space-y-8",children:[e.jsxs(I,{className:"bodyscan-card p-6",children:[e.jsx("div",{className:"flex items-center mb-4",children:e.jsxs("h3",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, rgba(6, 182, 212, 0.35), rgba(6, 182, 212, 0.25))
                `,border:"2px solid rgba(6, 182, 212, 0.5)",boxShadow:"0 0 20px rgba(6, 182, 212, 0.3)"},children:e.jsx(u,{Icon:m.Eye,size:20,style:{color:"#06B6D4"},variant:"pure"})}),e.jsx("span",{className:"glowing-title-text",children:"Votre Avatar 3D"})]})}),e.jsx("div",{className:"avatar-3d-viewer-container h-[400px] sm:h-[500px] lg:h-[600px] rounded-xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-400/20 relative overflow-hidden",children:e.jsx(ne,{userProfile:g,morphData:d,limbMasses:y,skinTone:M,resolvedGender:_,faceMorphData:v,faceSkinTone:C,className:"w-full h-full",autoRotate:!0,showControls:!0,onViewerReady:f})})]}),e.jsx(Re,{scan:a}),d&&Object.keys(d).length>0&&e.jsx(Fe,{finalShapeParams:d,resolvedGender:_,userProfile:g}),e.jsxs(I,{className:"p-0 overflow-hidden relative",interactive:!0,style:{background:`
            radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.10) 0%, transparent 50%),
            var(--glass-opacity-base)
          `,borderColor:"rgba(139, 92, 246, 0.4)",boxShadow:`
            0 12px 40px rgba(0, 0, 0, 0.25),
            0 0 40px rgba(139, 92, 246, 0.25),
            inset 0 2px 0 rgba(255, 255, 255, 0.2)
          `},children:[e.jsx("div",{className:"absolute inset-0 rounded-inherit pointer-events-none urgent-forge-glow-css",style:{background:"radial-gradient(circle at center, color-mix(in srgb, #8B5CF6 8%, transparent) 0%, transparent 70%)",filter:"blur(20px)",transform:"scale(1.2)",zIndex:0}}),e.jsxs(j.button,{onClick:()=>s("/body-scan"),className:"w-full px-8 py-4 rounded-2xl font-bold text-lg text-white relative overflow-hidden min-h-[64px] z-10",style:{background:`
              linear-gradient(135deg,
                rgba(139, 92, 246, 0.25),
                rgba(139, 92, 246, 0.15)
              )
            `,border:"none",backdropFilter:"blur(20px) saturate(160%)"},whileHover:{scale:1.01,y:-1},whileTap:{scale:.99},children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent)",animation:"celebration-cta-shimmer-movement 2s ease-in-out infinite",borderRadius:"inherit"}}),e.jsxs("div",{className:"relative z-10 flex items-center justify-center gap-3",children:[e.jsx(u,{Icon:m.Scan,size:24,style:{color:"#8B5CF6",filter:"drop-shadow(0 2px 6px rgba(139, 92, 246, 0.5))"},variant:"pure"}),e.jsx("span",{style:{textShadow:"0 2px 8px rgba(139, 92, 246, 0.6)",color:"white"},children:"Nouveau scan corporel"})]})]})]})]})};function Le(s){if(!s)return null;try{const t=new Date(s),a=new Date;let i=a.getFullYear()-t.getFullYear();const c=a.getMonth()-t.getMonth();return(c<0||c===0&&a.getDate()<t.getDate())&&i--,i}catch{return null}}function $e(s,t){const a=s/100;return t/(a*a)}async function Ve(s,t){w.info("INSIGHTS_GENERATION","üöÄ Calling generate-morph-insights Edge Function",{userId:t?.userId,hasScanData:!!s,hasUserProfile:!!t,philosophy:"ai_powered_morphology_insights",supabaseUrl:"https://kwipydbtjagypocpvbwn.supabase.co",timestamp:new Date().toISOString()});try{w.info("INSIGHTS_GENERATION","üì° Invoking Supabase function...");const{data:a,error:i}=await X.functions.invoke("generate-morph-insights",{body:{scan_data:{final_shape_params:s?.morph_values||s?.finalShapeParams||{},final_limb_masses:s?.limb_masses||s?.finalLimbMasses||{},skin_tone:s?.skin_tone||s?.skinTone,resolved_gender:s?.resolved_gender||s?.resolvedGender,avatar_version:s?.avatar_version||s?.avatarVersion,scan_id:s?.id||s?.scanId},user_profile:{user_id:t?.userId,age:Le(t?.birthdate),sex:t?.sex,height_cm:t?.height||t?.height_cm,weight_kg:t?.weight||t?.weight_kg,target_weight_kg:t?.target_weight||t?.target_weight_kg,activity_level:t?.activity_level,objective:t?.objective,bmi:(t?.height||t?.height_cm)&&(t?.weight||t?.weight_kg)?$e(t.height||t.height_cm,t.weight||t.weight_kg):null,goals:t?.goals||{},health:t?.health||{},emotions:t?.emotions||{},nutrition:t?.nutrition||{}},analysis_config:{include_recommendations:!0,include_comparisons:!0,include_goal_tracking:!0,detail_level:"comprehensive"}}});if(w.info("INSIGHTS_GENERATION","üì• Function response received",{hasData:!!a,hasError:!!i,errorMessage:i?.message}),i)throw w.error("INSIGHTS_GENERATION","‚ùå Failed to generate insights",{error:i.message,userId:t?.userId,errorDetails:i}),new Error(`Failed to generate insights: ${i.message}`);return w.info("INSIGHTS_GENERATION","‚úÖ Insights generated successfully",{userId:t?.userId,insightsCount:a?.insights?.length||0}),a}catch(a){throw w.error("INSIGHTS_GENERATION","‚ùå Network or parsing error",{error:a.message,stack:a.stack,userId:t?.userId}),a}}function qe(s){switch(s){case"recommendation":return m.Target;case"observation":return m.Eye;case"achievement":return m.Check;case"goal_progress":return m.TrendingUp;default:return m.Info}}function Pe(s){switch(s){case"recommendation":return"Recommandation";case"observation":return"Observation";case"achievement":return"R√©ussite";case"goal_progress":return"Progression";default:return"Info"}}function He(s){switch(s){case"high":return"Haute";case"medium":return"Moyenne";case"low":return"Basse";default:return s}}const Q=({insight:s,index:t})=>e.jsxs(j.div,{className:"insight-card",style:{"--insight-color":s.color},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:t*.1},whileHover:{y:-2},children:[e.jsxs("div",{className:"insight-card-badges",children:[e.jsxs("div",{className:`insight-metadata-badge insight-metadata-badge--type-${s.type}`,children:[e.jsx(u,{Icon:qe(s.type),size:10,variant:"pure"}),e.jsx("span",{children:Pe(s.type)})]}),(s.priority==="high"||s.priority==="medium")&&e.jsx("div",{className:`insight-metadata-badge insight-metadata-badge--priority-${s.priority}`,children:e.jsx("span",{children:He(s.priority)})}),s.confidence>=.8&&e.jsxs("div",{className:"insight-metadata-badge insight-metadata-badge--confidence",children:[e.jsx(u,{Icon:m.Check,size:10,variant:"pure"}),e.jsxs("span",{children:[Math.round(s.confidence*100),"%"]})]})]}),e.jsxs("div",{className:"insight-card-header",children:[e.jsx("div",{className:"insight-card-icon-container",children:e.jsx(u,{Icon:m[s.icon],size:18,color:s.color})}),e.jsxs("div",{className:"insight-card-content",children:[e.jsxs("div",{className:"insight-card-title-row",children:[e.jsx("h5",{className:"insight-card-title",children:s.title}),s.value&&e.jsx("span",{className:"insight-card-value-badge",children:s.value})]}),e.jsx("p",{className:"insight-card-description",children:s.description})]})]})]}),Ge=()=>e.jsx("div",{className:"space-y-6 w-full",children:e.jsx(I,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-warning) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-warning) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-warning) 10%, transparent)
          `},children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-6",children:[e.jsxs(j.div,{className:"w-20 h-20 rounded-full flex items-center justify-center relative",style:{background:"color-mix(in srgb, var(--color-body-scan-warning) 20%, transparent)",border:"2px solid color-mix(in srgb, var(--color-body-scan-warning) 40%, transparent)",boxShadow:"0 0 30px color-mix(in srgb, var(--color-body-scan-warning) 30%, transparent)"},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(u,{Icon:m.Loader2,size:32,style:{color:"var(--color-body-scan-warning)"},variant:"pure",className:"loader-essential"}),e.jsx(j.div,{className:"absolute inset-0 rounded-full border-2",style:{borderColor:"color-mix(in srgb, var(--color-body-scan-warning) 40%, transparent)"},animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"G√©n√©ration d'insights..."}),e.jsx("p",{className:"text-white/70 text-sm leading-relaxed max-w-sm",children:"Nos syst√®mes analysent votre morphologie pour g√©n√©rer des recommandations personnalis√©es"})]})]})})}),Ue=({error:s})=>e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(I,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-error) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-error) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-error) 10%, transparent)
          `},children:[e.jsx(j.div,{className:"bodyscan-size-2xl bodyscan-absolute-center-x mb-6 bodyscan-rounded-full bodyscan-flex-center",style:{background:"color-mix(in srgb, var(--color-body-scan-error) 20%, transparent)",border:"2px solid color-mix(in srgb, var(--color-body-scan-error) 40%, transparent)",boxShadow:"0 0 30px color-mix(in srgb, var(--color-body-scan-error) 30%, transparent)"},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx(u,{Icon:m.AlertCircle,size:32,style:{color:"var(--color-body-scan-error)"},variant:"pure"})}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de g√©n√©ration d'insights"}),e.jsx("p",{className:"bodyscan-text-error text-sm mb-6 leading-relaxed max-w-md mx-auto",children:s instanceof Error?s.message:"Une erreur est survenue lors de la g√©n√©ration des insights."}),e.jsx("button",{className:"btn-glass--primary px-6 py-3",onClick:()=>window.location.reload(),children:e.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx(u,{Icon:m.RotateCcw,size:16}),e.jsx("span",{children:"R√©essayer"})]})})]})}),We=()=>e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(I,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
          `},children:[e.jsxs(j.div,{className:"bodyscan-size-3xl bodyscan-absolute-center-x mb-6 bodyscan-rounded-full bodyscan-flex-center bodyscan-relative",style:{background:"color-mix(in srgb, var(--color-body-scan-primary) 20%, transparent)",border:"2px solid color-mix(in srgb, var(--color-body-scan-primary) 40%, transparent)",boxShadow:"0 0 30px color-mix(in srgb, var(--color-body-scan-primary) 30%, transparent)"},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(u,{Icon:m.Scan,size:40,style:{color:"var(--color-body-scan-primary)"},variant:"pure"}),e.jsx(j.div,{className:"bodyscan-absolute-fill bodyscan-rounded-full bodyscan-border-2",style:{borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 40%, transparent)"},animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:"Aucun scan disponible"}),e.jsx("p",{className:"text-white/70 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:"Effectuez un scan corporel pour d√©bloquer vos insights morphologiques personnalis√©s."}),e.jsx("button",{className:"btn-glass--primary px-8 py-4 text-lg font-semibold",onClick:()=>{},children:e.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-md",children:[e.jsx(u,{Icon:m.Camera,size:20}),e.jsx("span",{children:"Commencer le scan corporel"})]})})]})}),Qe=({summary:s})=>e.jsx(I,{className:"p-6",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, #F59E0B 8%, transparent) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"color-mix(in srgb, #F59E0B 25%, transparent)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px color-mix(in srgb, #F59E0B 10%, transparent)
        `},children:e.jsxs(j.div,{className:"slide-enter",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:[e.jsxs("div",{className:"bodyscan-flex-between mb-6",children:[e.jsxs("h3",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(u,{Icon:m.BarChart3,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Tableau de bord morphologique"]}),e.jsxs("div",{className:"bodyscan-status-badge bodyscan-status-badge--active",children:[e.jsx("div",{className:"bodyscan-status-icon"}),e.jsx("span",{className:"bodyscan-status-text",children:"Analyse Spatiale"})]})]}),e.jsxs("div",{className:"bodyscan-grid-cols-2 md:bodyscan-grid-cols-4 bodyscan-gap-md",children:[e.jsxs("div",{className:"summary-metric-card summary-metric-card--blue",children:[e.jsxs("div",{className:"summary-metric-value",children:[Math.round(s.morphology_score),"%"]}),e.jsx("div",{className:"summary-metric-label",children:"Score Morphologique"})]}),e.jsxs("div",{className:"summary-metric-card summary-metric-card--green",children:[e.jsxs("div",{className:"summary-metric-value",children:[Math.round(s.goal_alignment),"%"]}),e.jsx("div",{className:"summary-metric-label",children:"Alignement Objectifs"})]}),e.jsxs("div",{className:"summary-metric-card summary-metric-card--purple",children:[e.jsxs("div",{className:"summary-metric-value",children:[Math.round(s.health_indicators),"%"]}),e.jsx("div",{className:"summary-metric-label",children:"Indicateurs Sant√©"})]}),e.jsxs("div",{className:"summary-metric-card summary-metric-card--orange",children:[e.jsx("div",{className:"summary-metric-value",children:s.recommendations_count}),e.jsx("div",{className:"summary-metric-label",children:"Recommandations"})]})]})]})}),Ke=({isOpen:s,onDiscardAndExit:t,onCancel:a,isGenerating:i,hasError:c,fallbackUsed:h})=>{const{click:l,error:r}=ee(),o=i?{title:"G√©n√©ration d'Insights en Cours",message:"Une analyse IA de votre morphologie est actuellement en cours. Si vous quittez maintenant, l'analyse sera interrompue et les insights ne seront pas g√©n√©r√©s.",icon:"Loader2",color:"#8B5CF6",actionText:"Interrompre l'analyse et Quitter",cancelText:"Continuer l'analyse"}:c?{title:"Erreur de G√©n√©ration",message:"Une erreur est survenue lors de la g√©n√©ration des insights. Vous pouvez quitter et r√©essayer plus tard, ou rester pour voir les insights de base disponibles.",icon:"AlertTriangle",color:"#EF4444",actionText:"Quitter",cancelText:"Rester et voir les insights de base"}:h?{title:"Insights de Base Disponibles",message:"L'IA n'√©tait pas disponible, mais des insights bas√©s sur des r√®gles ont √©t√© g√©n√©r√©s. Voulez-vous quitter ou consulter ces insights ?",icon:"Info",color:"#F59E0B",actionText:"Quitter",cancelText:"Consulter les insights"}:{title:"Quitter les Insights",message:"√ätes-vous s√ªr de vouloir quitter la section insights ?",icon:"AlertCircle",color:"#6B7280",actionText:"Quitter",cancelText:"Rester"};return e.jsx(re,{children:s&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{background:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(16px)",WebkitBackdropFilter:"blur(16px)"},onClick:f=>{f.target===f.currentTarget&&(l(),a())},children:e.jsx(j.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",stiffness:300,damping:30},className:"w-full max-w-md",onClick:f=>f.stopPropagation(),children:e.jsxs(I,{className:"p-6 relative",style:{background:`
                  radial-gradient(circle at 30% 20%, color-mix(in srgb, ${o.color} 12%, transparent) 0%, transparent 60%),
                  radial-gradient(circle at 70% 80%, color-mix(in srgb, ${o.color} 8%, transparent) 0%, transparent 50%),
                  var(--glass-opacity)
                `,borderColor:`color-mix(in srgb, ${o.color} 30%, transparent)`,boxShadow:`
                  0 20px 60px rgba(0, 0, 0, 0.4),
                  0 0 40px color-mix(in srgb, ${o.color} 20%, transparent),
                  inset 0 2px 0 rgba(255, 255, 255, 0.2)
                `,backdropFilter:"blur(24px) saturate(160%)"},children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, ${o.color} 35%, transparent), color-mix(in srgb, ${o.color} 25%, transparent))
                    `,border:`2px solid color-mix(in srgb, ${o.color} 50%, transparent)`,boxShadow:`0 0 30px color-mix(in srgb, ${o.color} 40%, transparent)`},children:e.jsx(u,{Icon:m[o.icon],size:28,style:{color:o.color},className:i?"animate-spin":""})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:o.title}),e.jsx("p",{className:"text-white/80 text-base leading-relaxed",children:o.message})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{r(),t()},className:"w-full btn-glass--warning py-3",style:{background:`
                      linear-gradient(135deg, 
                        color-mix(in srgb, #EF4444 70%, transparent), 
                        color-mix(in srgb, #DC2626 50%, transparent)
                      )
                    `,borderColor:"color-mix(in srgb, #EF4444 60%, transparent)",boxShadow:`
                      0 8px 32px color-mix(in srgb, #EF4444 30%, transparent),
                      inset 0 2px 0 rgba(255,255,255,0.2)
                    `},children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(u,{Icon:m.X,size:18,className:"text-white"}),e.jsx("span",{className:"font-bold",children:o.actionText})]})}),e.jsx("button",{onClick:()=>{l(),a()},className:"w-full btn-glass--secondary-nav py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(u,{Icon:m.ArrowLeft,size:18}),e.jsx("span",{className:"font-medium",children:o.cancelText})]})})]}),e.jsx("div",{className:"mt-4 p-3 rounded-xl text-center",style:{background:`color-mix(in srgb, ${o.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${o.color} 20%, transparent)`},children:e.jsx("p",{className:"text-white/70 text-sm",children:i?"L'analyse IA sera interrompue et devra √™tre relanc√©e.":c?"Vous pourrez r√©essayer la g√©n√©ration d'insights plus tard.":h?"Les insights de base fournissent des informations utiles sur votre morphologie.":"Vous pourrez revenir consulter vos insights √† tout moment."})})]})})})})},Ye=()=>{const{profile:s}=q(),{data:t,isLoading:a}=G({queryKey:["body-scans","latest",s?.userId],queryFn:async()=>{const{data:d,error:y}=await X.from("body_scans").select("*").eq("user_id",s?.userId).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(y)throw y;return d},enabled:!!s?.userId,staleTime:5*60*1e3}),[i,c]=Y.useState(!1),{data:h,isLoading:l,error:r}=G({queryKey:["morph-insights",s?.userId,t?.id],queryFn:()=>Ve(t,s),enabled:!!(t?.id&&s?.userId),staleTime:1/0,gcTime:24*60*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1,retry:1}),n=()=>{c(!1),window.history.back()},o=()=>{c(!1)};if(Y.useEffect(()=>{const d=y=>{l&&(y.preventDefault(),y.returnValue="Une analyse IA est en cours. √ätes-vous s√ªr de vouloir quitter ?",c(!0))};return window.addEventListener("beforeunload",d),()=>{window.removeEventListener("beforeunload",d)}},[l]),a||l)return e.jsx(Ge,{});if(r)return e.jsx(Ue,{error:r});if(!t)return e.jsx(We,{});const f=h?.insights||[],p=h?.summary,b=h?.fallback_used||!1;return e.jsxs(e.Fragment,{children:[e.jsx(Ke,{isOpen:i,onDiscardAndExit:n,onCancel:o,isGenerating:l,hasError:!!r,fallbackUsed:b}),e.jsxs("div",{className:"space-y-8",children:[p&&e.jsx(Qe,{summary:p}),f.length>0&&e.jsxs("div",{className:"space-y-6",children:[f.filter(d=>d.priority==="high").length>0&&e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.2},children:e.jsxs(I,{className:"p-6 glass-card--priority",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#EF4444"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(u,{Icon:m.Zap,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Insights prioritaires",e.jsx("span",{className:"text-xs bg-red-500/20 text-red-300 px-2 py-1 rounded-full",children:"Haute priorit√©"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.filter(d=>d.priority==="high").map((d,y)=>e.jsx(Q,{insight:d,index:y},d.id))})]})}),f.filter(d=>d.category==="morphology").length>0&&e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.3},children:e.jsxs(I,{className:"p-6",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#8B5CF6"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(u,{Icon:m.Eye,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Analyse morphologique"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.filter(d=>d.category==="morphology").map((d,y)=>e.jsx(Q,{insight:d,index:y},d.id))})]})}),f.filter(d=>["fitness","goals"].includes(d.category)).length>0&&e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.4},children:e.jsxs(I,{className:"p-6",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#22C55E"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(u,{Icon:m.Target,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Objectifs & Fitness"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.filter(d=>["fitness","goals"].includes(d.category)).map((d,y)=>e.jsx(Q,{insight:d,index:y},d.id))})]})}),f.filter(d=>["health","nutrition"].includes(d.category)).length>0&&e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.5},children:e.jsxs(I,{className:"p-6",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#EC4899"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(u,{Icon:m.Heart,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Sant√© & Nutrition"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.filter(d=>["health","nutrition"].includes(d.category)).map((d,y)=>e.jsx(Q,{insight:d,index:y},d.id))})]})})]})]})]})},Je=({scanId:s,onClose:t})=>{const{profile:a}=q(),i=a,c=x.useRef(null),[h,l]=x.useState(!1);x.useEffect(()=>{console.log("HISTORICAL_SCAN_MODAL: Received scanId:",s)},[s]);const{data:r,isLoading:n,error:o}=G({queryKey:["historical-scan",s],queryFn:()=>ge.getById(s),enabled:!!s,staleTime:1/0,gcTime:24*60*60*1e3});x.useEffect(()=>{console.log("HISTORICAL_SCAN_MODAL: isLoading:",n,"error:",o)},[n,o]),x.useEffect(()=>{r&&console.log("HISTORICAL_SCAN_MODAL: Scan data loaded:",r)},[r]);const f=r?J(new Date(r.created_at),"dd MMMM yyyy",{locale:Z}):"N/A";x.useEffect(()=>{h&&c.current?.resetCamera&&c.current.resetCamera()},[h]),x.useEffect(()=>{const b=d=>{d.key==="Escape"&&t()};return document.addEventListener("keydown",b),()=>document.removeEventListener("keydown",b)},[t]);const p=e.jsx(j.div,{className:"fixed inset-0 z-[1000] bg-black/80 backdrop-blur-lg flex items-start justify-center p-2 sm:p-4 pt-20 sm:pt-24",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:b=>{b.target===b.currentTarget&&t()},children:e.jsx(j.div,{className:"relative w-full max-w-6xl my-4 sm:my-8 rounded-xl overflow-y-auto flex flex-col",style:{height:"calc(100vh - 8rem)",maxHeight:"900px",minHeight:"600px"},initial:{scale:.9,y:50},animate:{scale:1,y:0},exit:{scale:.9,y:50},transition:{type:"spring",stiffness:300,damping:30},onClick:b=>b.stopPropagation(),children:e.jsxs(I,{className:"flex-1 p-4 sm:p-6 flex flex-col h-full bg-gradient-to-br from-purple-900/20 to-blue-900/20 border-purple-500/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0 pb-4 border-b border-white/10",children:[e.jsxs("h3",{className:"text-white font-semibold text-lg sm:text-xl flex items-center gap-2",children:[e.jsx(u,{Icon:m.Timeline,size:24,className:"text-blue-400"}),e.jsxs("span",{className:"truncate",children:["Scan du ",f]})]}),e.jsx("button",{onClick:t,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors flex-shrink-0","aria-label":"Fermer",children:e.jsx(u,{Icon:m.X,size:20,className:"text-white"})})]}),e.jsxs("div",{className:"flex-1 relative min-h-0 grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2 relative min-h-0",children:[n&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(u,{Icon:m.Loader2,size:48,className:"text-purple-400 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-white/70",children:"Chargement du scan..."})]})}),o&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-red-400",children:[e.jsx(u,{Icon:m.AlertCircle,size:48,className:"mx-auto mb-4"}),e.jsx("p",{children:"Erreur de chargement du scan"}),e.jsx("p",{className:"text-sm mt-2 text-red-300",children:o.message})]})}),r&&!n&&e.jsxs("div",{className:"w-full h-full relative min-h-[400px]",children:[(()=>{const b=r.metrics?.final_shape_params||r.metrics?.morph_values,d=r.metrics?.final_limb_masses||r.metrics?.limb_masses,y=r.metrics?.skin_tone,M=r.metrics?.resolved_gender||i?.sex;return console.log("HISTORICAL_SCAN_MODAL: Avatar3DViewer props:",{morphData:b,limbMasses:d,skinTone:y,resolvedGender:M,scanId:s,hasScanResult:!!r,hasUserProfile:!!i}),null})(),e.jsx(ne,{ref:c,scanResult:r,userProfile:i,morphData:r.metrics?.final_shape_params||r.metrics?.morph_values,limbMasses:r.metrics?.final_limb_masses||r.metrics?.limb_masses,skinTone:r.metrics?.skin_tone,resolvedGender:r.metrics?.resolved_gender||i?.sex,className:"w-full h-full",autoRotate:!0,showControls:!0,onViewerReady:()=>l(!0)})]})]}),r&&!n&&e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[e.jsxs("h4",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(u,{Icon:m.BarChart3,size:16,className:"text-blue-400"}),"R√©sum√© du scan"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[r.metrics?.estimate_result?.processing_confidence&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/70",children:"Confiance"}),e.jsxs("span",{className:"text-white font-medium",children:[Math.round(r.metrics.estimate_result.processing_confidence*100),"%"]})]}),r.metrics?.resolved_gender&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/70",children:"Genre d√©tect√©"}),e.jsx("span",{className:"text-white font-medium capitalize",children:r.metrics.resolved_gender})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/70",children:"Date de cr√©ation"}),e.jsx("span",{className:"text-white font-medium",children:J(new Date(r.created_at),"HH:mm",{locale:Z})})]})]})]}),e.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[e.jsxs("h4",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(u,{Icon:m.Ruler,size:16,className:"text-green-400"}),"Mesures"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[r.metrics?.estimate_result?.extracted_data?.raw_measurements?.weight_kg&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"Poids"}),e.jsxs("p",{className:"text-white font-medium",children:[r.metrics.estimate_result.extracted_data.raw_measurements.weight_kg.toFixed(1)," kg"]})]}),r.metrics?.estimate_result?.extracted_data?.raw_measurements?.height_cm&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"Taille"}),e.jsxs("p",{className:"text-white font-medium",children:[r.metrics.estimate_result.extracted_data.raw_measurements.height_cm.toFixed(1)," cm"]})]}),r.metrics?.estimate_result?.estimated_bmi&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"IMC"}),e.jsx("p",{className:"text-white font-medium",children:r.metrics.estimate_result.estimated_bmi.toFixed(1)})]}),r.metrics?.estimate_result?.extracted_data?.processing_confidence&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"Pr√©cision"}),e.jsxs("p",{className:"text-white font-medium",children:[Math.round(r.metrics.estimate_result.extracted_data.processing_confidence*100),"%"]})]})]})]}),(r.metrics?.final_shape_params||r.metrics?.morph_values)&&e.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[e.jsxs("h4",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(u,{Icon:m.Zap,size:16,className:"text-purple-400"}),"Morphologie"]}),e.jsxs("div",{className:"text-sm text-white/70",children:[e.jsxs("p",{children:["Mod√®le 3D g√©n√©r√© avec ",Object.keys(r.metrics?.final_shape_params||r.metrics?.morph_values||{}).length," param√®tres morphologiques."]}),r.metrics?.final_limb_masses&&e.jsx("p",{className:"mt-2",children:"Masses des membres ajust√©es pour une repr√©sentation pr√©cise."})]})]})]})]})]})})});return Ce.createPortal(p,document.body)},z=s=>typeof s=="number"&&Number.isFinite(s),E=s=>{if(typeof s=="number")return Number.isFinite(s)?s:void 0;if(typeof s=="string"){const t=parseFloat(s);return Number.isFinite(t)?t:void 0}},Ze=s=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s),xe=({children:s,tone:t="info"})=>e.jsx("span",{className:`ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[10px] uppercase tracking-wide ${t==="info"?"bg-blue-500/15 text-blue-200 border border-blue-400/20":"bg-white/5 text-white/50 border border-white/10"}`,children:s}),ae=({icon:s,label:t,value:a})=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-7 h-7 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center shrink-0",children:e.jsx(u,{Icon:m[s],size:14,className:"text-white/70"})}),e.jsxs("div",{className:"flex-1 flex justify-between items-baseline",children:[e.jsx("span",{className:"text-white/60 text-xs",children:t}),e.jsx("span",{className:"text-white font-medium text-sm",children:typeof a=="number"?a.toFixed(1):a})]})]}),Xe=()=>{const{profile:s}=q(),t=s?.userId,[a,i]=x.useState(null),[c,h]=x.useState(!1),[l,r]=x.useState(4),{data:n,isLoading:o,error:f}=G({queryKey:["body-scan-history",t,l],queryFn:()=>ge.getHistory(t,l),enabled:!!t,staleTime:5*60*1e3,gcTime:10*60*1e3}),p=g=>{i(g),h(!0)},b=()=>{i(null),h(!1)};if(o)return e.jsxs(I,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
          `},children:[e.jsx(u,{Icon:m.Loader2,size:48,className:"bodyscan-text-accent loader-essential mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Chargement de l'historique..."}),e.jsx("p",{className:"text-white/70 text-sm",children:"R√©cup√©ration de vos scans pass√©s."})]});if(f)return e.jsxs(I,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-error) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-error) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-error) 10%, transparent)
          `},children:[e.jsx(u,{Icon:m.AlertCircle,size:48,className:"bodyscan-text-error mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de chargement"}),e.jsx("p",{className:"bodyscan-text-error text-sm mb-6",children:f?.message}),e.jsx("button",{onClick:()=>window.location.reload(),className:"btn-glass--primary",children:"R√©essayer"})]});if(!n||n.length===0)return e.jsxs(I,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
          `},children:[e.jsx(u,{Icon:m.Info,size:48,className:"bodyscan-text-info mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Aucun scan trouv√©"}),e.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Vous n'avez pas encore d'historique de scans corporels. Effectuez votre premier scan !"}),e.jsx("button",{onClick:()=>window.location.href="/body-scan",className:"btn-glass--primary",children:"Commencer un scan"})]});const d=n.filter(g=>{const v=g.id&&typeof g.id=="string"&&Ze(g.id);return console.log("Scan ID:",g.id,"Valid UUID:",v),v}),y=m.History,M=()=>{r(g=>g+4)},_=n&&n.length>0&&n.length===l;return e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6",children:e.jsx(re,{children:d.map(g=>{const v=new Date(g.created_at),C=g?.metrics,T=E(C?.estimate_result?.extracted_data?.raw_measurements?.weight_kg)??E(C?.estimate_result?.weight_kg)??E(C?.weight_kg),A=E(C?.estimate_result?.extracted_data?.raw_measurements?.height_cm)??E(C?.estimate_result?.height_cm)??E(C?.height_cm),D=E(C?.estimate_result?.estimated_bmi)??E(C?.estimated_bmi),O=!z(T)&&z(E(s?.weight_kg)),S=!z(A)&&z(E(s?.height_cm)),k=T??E(s?.weight_kg),$=A??E(s?.height_cm);let P=D;if(!z(P)&&z(k)&&z($)&&$>0){const R=$/100;P=k/(R*R)}const U=E(C?.estimate_result?.extracted_data?.processing_confidence);return e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:e.jsxs(I,{interactive:!0,className:"p-6",style:{background:`
                      radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
                      var(--glass-opacity-base)
                    `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
                      var(--glass-shadow-sm),
                      0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
                    `},onClick:()=>p(g.id),children:[e.jsxs("div",{className:"bodyscan-flex-between",children:[e.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{width:"2.25rem",height:"2.25rem"},children:e.jsx(u,{Icon:y,size:18,style:{color:"var(--color-body-scan-primary)"},variant:"pure"})}),e.jsxs("h4",{className:"text-white font-semibold text-lg",children:["Scan du ",J(v,"dd MMMM yyyy",{locale:Z})]})]}),e.jsx("div",{className:"text-xs text-white/50",children:J(v,"HH:mm",{locale:Z})})]}),e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsxs("div",{className:"history-metric-row",children:[e.jsx(ae,{icon:"Scale",label:"Poids",value:z(k)?k:"-"}),O&&e.jsx(xe,{tone:"muted",children:"profil"})]}),e.jsxs("div",{className:"history-metric-row",children:[e.jsx(ae,{icon:"Ruler",label:"Taille",value:z($)?$:"-"}),S&&e.jsx(xe,{tone:"muted",children:"profil"})]}),e.jsx("div",{className:"history-metric-row",children:e.jsx(ae,{icon:"Activity",label:"IMC",value:z(P)?P:"-"})}),z(U)&&e.jsxs("div",{className:"history-metric-row flex items-center gap-2 text-xs text-white/60",children:[e.jsx(u,{Icon:m.Shield,size:14,className:"text-white/60"}),e.jsx("span",{children:"Confiance"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[Math.round(U*100),"%"]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-white/10",children:e.jsx("button",{className:"btn-glass--secondary-nav bodyscan-size-full py-2 text-sm",children:"Voir le scan"})})]})},g.id)})})}),_&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx(j.button,{onClick:M,className:"btn-glass--secondary px-6 py-3",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{Icon:m.ChevronDown,size:16,className:"text-white/70"}),e.jsx("span",{children:"Charger plus de scans"})]})})}),e.jsx(re,{children:c&&a&&e.jsx(Je,{scanId:a,onClose:b})})]})},es=[{value:1,label:"1 mois"},{value:3,label:"3 mois"},{value:6,label:"6 mois"},{value:12,label:"1 an"}],ss=({onParamsChange:s,initialParams:t={},isCalculating:a=!1})=>{const[i,c]=x.useState(t.activityLevel??50),[h,l]=x.useState(t.nutritionQuality??50),[r,n]=x.useState(t.caloricBalance??0),[o,f]=x.useState(t.timePeriodMonths??3),p=x.useRef(null),b=x.useRef(!1),d=x.useCallback(()=>{if(b.current)return;s({activityLevel:i,nutritionQuality:h,caloricBalance:r,timePeriodMonths:o})},[i,h,r,o,s]);x.useEffect(()=>(p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{d()},300),()=>{p.current&&clearTimeout(p.current)}),[d]);const y=g=>g<=20?"S√©dentaire":g<=40?"L√©g√®rement actif":g<=60?"Mod√©r√©ment actif":g<=80?"Tr√®s actif":"Extr√™mement actif",M=g=>g<=20?"Tr√®s pauvre":g<=40?"Insuffisante":g<=60?"Correcte":g<=80?"Bonne":"Optimale",_=g=>g<=-60?"D√©ficit important":g<=-20?"D√©ficit mod√©r√©":g<20?"Maintenance":g<60?"Surplus mod√©r√©":"Surplus important";return e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"glass-card p-6 space-y-6 rounded-2xl",style:{background:`
          radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"rgba(16, 185, 129, 0.3)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px rgba(16, 185, 129, 0.15)
        `},children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0",style:{background:`
              radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
              linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(16, 185, 129, 0.25))
            `,border:"2px solid rgba(16, 185, 129, 0.5)",boxShadow:"0 0 20px rgba(16, 185, 129, 0.3)"},children:e.jsx(u,{Icon:m.Sliders,size:20,style:{color:"#10B981"},variant:"pure"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-1",children:"Param√®tres de Projection"}),e.jsx("p",{className:"text-sm text-white/70",children:"Ajustez vos habitudes de vie pour visualiser leur impact sur votre corps"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{Icon:m.Activity,size:16,className:"text-green-400"}),e.jsx("label",{className:"text-sm font-medium text-white",children:"Niveau d'Activit√© Physique"})]}),e.jsx("span",{className:"text-xs text-white/60 font-medium",children:y(i)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>c(Math.max(0,i-5)),disabled:i===0||a,className:`flex items-center justify-center w-10 h-10 rounded-xl bg-white/10
                       hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed
                       transition-all active:scale-95 border border-white/10`,children:e.jsx(u,{Icon:m.Minus,size:20,className:"text-white"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-400",children:[i,"%"]}),e.jsx("div",{className:"w-full h-1.5 bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-300",style:{width:`${i}%`}})})]}),e.jsx("button",{onClick:()=>c(Math.min(100,i+5)),disabled:i===100||a,className:`flex items-center justify-center w-10 h-10 rounded-xl bg-white/10
                       hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed
                       transition-all active:scale-95 border border-white/10`,children:e.jsx(u,{Icon:m.Plus,size:20,className:"text-white"})})]}),e.jsxs("div",{className:"flex justify-between text-xs text-white/40 px-1",children:[e.jsx("span",{children:"S√©dentaire"}),e.jsx("span",{children:"Tr√®s actif"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{Icon:m.Apple,size:16,className:"text-blue-400"}),e.jsx("label",{className:"text-sm font-medium text-white",children:"Qualit√© Nutritionnelle"})]}),e.jsx("span",{className:"text-xs text-white/60 font-medium",children:M(h)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>l(Math.max(0,h-5)),disabled:h===0||a,className:`flex items-center justify-center w-10 h-10 rounded-xl bg-white/10
                       hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed
                       transition-all active:scale-95 border border-white/10`,children:e.jsx(u,{Icon:m.Minus,size:20,className:"text-white"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-400",children:[h,"%"]}),e.jsx("div",{className:"w-full h-1.5 bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all duration-300",style:{width:`${h}%`}})})]}),e.jsx("button",{onClick:()=>l(Math.min(100,h+5)),disabled:h===100||a,className:`flex items-center justify-center w-10 h-10 rounded-xl bg-white/10
                       hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed
                       transition-all active:scale-95 border border-white/10`,children:e.jsx(u,{Icon:m.Plus,size:20,className:"text-white"})})]}),e.jsxs("div",{className:"flex justify-between text-xs text-white/40 px-1",children:[e.jsx("span",{children:"Pauvre"}),e.jsx("span",{children:"Optimale"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{Icon:m.Flame,size:16,className:"text-orange-400"}),e.jsx("label",{className:"text-sm font-medium text-white",children:"Balance Calorique"})]}),e.jsx("span",{className:"text-xs text-white/60 font-medium",children:_(r)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>n(Math.max(-100,r-5)),disabled:r===-100||a,className:`flex items-center justify-center w-10 h-10 rounded-xl bg-white/10
                       hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed
                       transition-all active:scale-95 border border-white/10`,children:e.jsx(u,{Icon:m.Minus,size:20,className:"text-white"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsxs("div",{className:`text-2xl font-bold ${r<-20?"text-red-400":r>20?"text-green-400":"text-orange-400"}`,children:[r>0?"+":"",r]}),e.jsx("div",{className:"w-full h-1.5 bg-white/10 rounded-full mt-2 overflow-hidden",children:e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("div",{className:"absolute left-1/2 top-0 w-px h-full bg-white/30"}),e.jsx("div",{className:`absolute h-full transition-all duration-300 ${r<0?"bg-gradient-to-r from-red-500 to-red-400 right-1/2":"bg-gradient-to-r from-green-500 to-green-400 left-1/2"}`,style:{width:`${Math.abs(r)/2}%`}})]})})]}),e.jsx("button",{onClick:()=>n(Math.min(100,r+5)),disabled:r===100||a,className:`flex items-center justify-center w-10 h-10 rounded-xl bg-white/10
                       hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed
                       transition-all active:scale-95 border border-white/10`,children:e.jsx(u,{Icon:m.Plus,size:20,className:"text-white"})})]}),e.jsxs("div",{className:"flex justify-between text-xs text-white/40 px-1",children:[e.jsx("span",{children:"D√©ficit"}),e.jsx("span",{children:"Maintenance"}),e.jsx("span",{children:"Surplus"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{Icon:m.Clock,size:16,className:"text-purple-400"}),e.jsx("label",{className:"text-sm font-medium text-white block",children:"P√©riode de Projection"})]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:es.map(g=>e.jsx("button",{onClick:()=>{f(g.value),p.current&&(clearTimeout(p.current),p.current=null);const v={activityLevel:i,nutritionQuality:h,caloricBalance:r,timePeriodMonths:g.value};s(v)},disabled:a,className:`
                px-4 py-2 rounded-xl text-sm font-medium transition-all
                disabled:opacity-50 disabled:cursor-not-allowed
                ${o===g.value?"bg-purple-500 text-white shadow-lg scale-105 border-2 border-purple-400":"bg-white/10 text-white/70 hover:bg-white/20 border border-white/10"}
              `,children:g.label},g.value))})]}),a&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-purple-500/20 rounded-xl border border-purple-400/30",children:[e.jsx(u,{Icon:m.Loader2,size:16,className:"text-purple-400 animate-spin"}),e.jsx("span",{className:"text-xs text-purple-300 font-medium",children:"Calcul en cours..."})]}),e.jsx("div",{className:"mt-6 p-4 bg-white/5 rounded-xl border border-white/10",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(u,{Icon:m.Lightbulb,size:16,className:"text-yellow-400 flex-shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-white/60 leading-relaxed",children:[e.jsx("strong",{className:"text-white/80",children:"Astuce:"})," Ces param√®tres simulent l'impact de vos habitudes de vie sur votre morphologie. Les calculs sont bas√©s sur des formules scientifiques valid√©es (√©quation de Mifflin-St Jeor, m√©tabolisme de base, etc.)."]})]})})]})},ts=({currentWeight:s,currentBMI:t,projection:a,isLoading:i=!1})=>{if(i)return e.jsx("div",{className:"glass-card p-6",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-white/10 rounded w-1/2"}),e.jsx("div",{className:"h-8 bg-white/10 rounded"}),e.jsx("div",{className:"h-8 bg-white/10 rounded"})]})});if(!a)return e.jsx("div",{className:"glass-card p-6 text-center",children:e.jsx("p",{className:"text-white/60",children:"Ajustez les param√®tres pour voir les projections"})});const c=a.projectedWeight-s,h=a.projectedBMI-t,l=o=>o>.1?e.jsx(u,{Icon:m.TrendingUp,size:16,className:"text-green-400"}):o<-.1?e.jsx(u,{Icon:m.TrendingDown,size:16,className:"text-red-400"}):e.jsx(u,{Icon:m.Minus,size:16,className:"text-white/40"}),r=o=>o>.1?"text-green-400":o<-.1?"text-red-400":"text-white/40",n=o=>`${o>0?"+":""}${o.toFixed(1)}`;return e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"space-y-4 w-full",children:[e.jsxs("div",{className:"glass-card p-6 rounded-2xl",style:{background:`
            radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"rgba(16, 185, 129, 0.3)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px rgba(16, 185, 129, 0.15)
          `},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(16, 185, 129, 0.25))
              `,border:"2px solid rgba(16, 185, 129, 0.5)",boxShadow:"0 0 20px rgba(16, 185, 129, 0.3)"},children:e.jsx(u,{Icon:m.BarChart3,size:20,style:{color:"#10B981"},variant:"pure"})}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:"M√©triques Projet√©es"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-white/5 rounded-xl border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{Icon:m.Scale,size:16,className:"text-purple-400"}),e.jsx("span",{className:"text-sm text-white/60 font-medium",children:"Poids"})]}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsxs("span",{className:"text-2xl font-bold text-white",children:[a.projectedWeight," kg"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[l(c),e.jsxs("span",{className:`text-sm font-medium ${r(c)}`,children:[n(c)," kg"]})]})]})]}),e.jsxs("div",{className:"p-4 bg-white/5 rounded-xl border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{Icon:m.Activity,size:16,className:"text-blue-400"}),e.jsx("span",{className:"text-sm text-white/60 font-medium",children:"IMC"})]}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"text-2xl font-bold text-white",children:a.projectedBMI}),e.jsxs("div",{className:"flex items-center gap-1",children:[l(h),e.jsx("span",{className:`text-sm font-medium ${r(h)}`,children:n(h)})]})]})]}),e.jsxs("div",{className:"p-4 bg-white/5 rounded-xl border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{Icon:m.Ruler,size:16,className:"text-green-400"}),e.jsx("span",{className:"text-sm text-white/60 font-medium",children:"Tour de taille"})]}),e.jsx("div",{className:"flex items-baseline gap-2",children:e.jsxs("span",{className:"text-2xl font-bold text-white",children:[a.projectedWaistCircumference," cm"]})})]}),e.jsxs("div",{className:"p-4 bg-white/5 rounded-xl border border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(u,{Icon:m.Flame,size:16,className:"text-orange-400"}),e.jsx("span",{className:"text-sm text-white/60 font-medium",children:"Masse musculaire"})]}),e.jsx("div",{className:"flex items-baseline gap-2",children:e.jsxs("span",{className:"text-2xl font-bold text-white",children:[a.projectedMuscleMassPercentage,"%"]})})]})]})]}),e.jsxs("div",{className:"glass-card p-6 rounded-2xl",style:{background:`
            radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"rgba(16, 185, 129, 0.3)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px rgba(16, 185, 129, 0.15)
          `},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(16, 185, 129, 0.25))
              `,border:"2px solid rgba(16, 185, 129, 0.5)",boxShadow:"0 0 20px rgba(16, 185, 129, 0.3)"},children:e.jsx(u,{Icon:m.Activity2,size:20,style:{color:"#10B981"},variant:"pure"})}),e.jsx("h4",{className:"text-md font-semibold text-white",children:"Composition Corporelle"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-white/70",children:"Masse musculaire"}),e.jsxs("span",{className:"text-white font-medium",children:[a.projectedMuscleMassPercentage,"%"]})]}),e.jsx("div",{className:"h-3 bg-white/10 rounded-full overflow-hidden",children:e.jsx(j.div,{initial:{width:0},animate:{width:`${a.projectedMuscleMassPercentage}%`},transition:{duration:.8,ease:"easeOut"},className:"h-full bg-gradient-to-r from-green-500 to-green-400 rounded-full"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-white/70",children:"Masse grasse"}),e.jsxs("span",{className:"text-white font-medium",children:[a.projectedBodyFatPercentage,"%"]})]}),e.jsx("div",{className:"h-3 bg-white/10 rounded-full overflow-hidden",children:e.jsx(j.div,{initial:{width:0},animate:{width:`${a.projectedBodyFatPercentage}%`},transition:{duration:.8,ease:"easeOut",delay:.1},className:"h-full bg-gradient-to-r from-orange-500 to-orange-400 rounded-full"})})]})]})]}),e.jsxs("details",{className:"glass-card p-6 cursor-pointer rounded-xl",style:{background:`
            radial-gradient(circle at 30% 20%, rgba(245, 158, 11, 0.12) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"rgba(245, 158, 11, 0.3)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px rgba(245, 158, 11, 0.15)
          `},children:[e.jsxs("summary",{className:"text-sm font-semibold text-white/80 hover:text-white transition-colors flex items-center gap-2",children:[e.jsx(u,{Icon:m.Calculator,size:16,className:"text-orange-400"}),"D√©tails des Calculs"]}),e.jsxs("div",{className:"mt-4 space-y-2 text-sm text-white/60",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"M√©tabolisme de base (BMR)"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[a.calculations.basalMetabolicRate," kcal/jour"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"D√©pense √©nerg√©tique totale (TDEE)"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[a.calculations.totalDailyEnergyExpenditure," kcal/jour"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Ajustement calorique quotidien"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[a.calculations.dailyCaloricAdjustment>0?"+":"",a.calculations.dailyCaloricAdjustment," kcal/jour"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Diff√©rence calorique totale"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[a.calculations.totalCaloricDifference>0?"+":"",a.calculations.totalCaloricDifference," kcal"]})]}),e.jsx("div",{className:"h-px bg-white/10 my-2"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Changement de poids estim√©"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[n(a.calculations.estimatedWeightChange)," kg"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Gain musculaire estim√©"}),e.jsxs("span",{className:"text-green-400 font-medium",children:[n(a.calculations.estimatedMuscleChange)," kg"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Perte de graisse estim√©e"}),e.jsxs("span",{className:"text-orange-400 font-medium",children:[n(a.calculations.estimatedFatChange)," kg"]})]})]})]})]})},as=.02;function K(s,t,a=as){if(s===t)return!0;if(!s||!t)return s===t;const i=Object.keys(s),c=Object.keys(t);return i.length!==c.length?!1:i.every(h=>Math.abs((s[h]||0)-(t[h]||0))<a)}function rs(s,t){return!(s.serverScanId!==t.serverScanId||s.currentGender!==t.currentGender||s.projectedGender!==t.projectedGender||s.isLoading!==t.isLoading||!K(s.projectedMorphData,t.projectedMorphData)||!K(s.currentMorphData,t.currentMorphData)||!K(s.projectedLimbMasses,t.projectedLimbMasses)||!K(s.currentLimbMasses,t.currentLimbMasses)||s.currentSkinTone!==t.currentSkinTone||s.projectedSkinTone!==t.projectedSkinTone)}const is=({serverScanId:s,currentMorphData:t,currentLimbMasses:a,currentSkinTone:i,currentGender:c,projectedMorphData:h,projectedLimbMasses:l,projectedSkinTone:r,projectedGender:n,isLoading:o=!1,onViewerReady:f})=>{const p=x.useMemo(()=>h||t,[h,t]),b=x.useMemo(()=>l||a,[l,a]),d=x.useMemo(()=>r||i,[r,i]),y=x.useMemo(()=>n||c,[n,c]);return o?e.jsx("div",{className:"glass-card p-6",children:e.jsx("div",{className:"animate-pulse space-y-4",children:e.jsx("div",{className:"h-96 bg-white/10 rounded-lg"})})}):!s||!t?e.jsx("div",{className:"glass-card p-6",children:e.jsx("div",{className:"h-96 flex items-center justify-center bg-white/5 rounded-lg",children:e.jsx("p",{className:"text-white/40",children:"Aucun scan disponible"})})}):e.jsxs("div",{className:"space-y-4 w-full",children:[o&&e.jsx("div",{className:"glass-card p-3 bg-purple-500/20 border border-purple-400/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-purple-400 border-t-transparent"}),e.jsx("p",{className:"text-sm text-purple-300 font-medium",children:"Calcul de la projection en cours..."})]})}),e.jsxs("div",{className:"glass-card p-4 w-full rounded-2xl",style:{background:`
            radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"rgba(16, 185, 129, 0.3)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px rgba(16, 185, 129, 0.15)
          `},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",style:{background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(16, 185, 129, 0.25))
              `,border:"2px solid rgba(16, 185, 129, 0.5)",boxShadow:"0 0 20px rgba(16, 185, 129, 0.3)"},children:e.jsx(u,{Icon:m.Eye,size:20,style:{color:"#10B981"},variant:"pure"})}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Visualisation 3D de la Projection"})]}),e.jsx("div",{className:"w-full h-[450px] sm:h-[550px] lg:h-[650px] rounded-xl overflow-hidden",children:e.jsx(ne,{serverScanId:s,overrideMorphData:p,overrideLimbMasses:b,overrideSkinTone:d,overrideGender:y,showControls:!0,className:"w-full h-full",onViewerReady:f},"projection-viewer-stable")})]}),e.jsx("div",{className:"glass-card p-4 bg-white/5 w-full rounded-xl border border-white/10",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(u,{Icon:m.Info,size:16,className:"text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-white/60 leading-relaxed",children:[e.jsx("strong",{className:"text-white/80",children:"Projection en temps r√©el:"})," Ajustez les param√®tres d'activit√©, nutrition et balance calorique pour visualiser imm√©diatement l'impact sur votre morphologie projet√©e."]})]})})]})},ns=x.memo(is,rs),F=new Map,os=100;function oe(s,...t){return`${s}:${t.join(":")}`}function le(){F.size>os&&Array.from(F.keys()).slice(0,50).forEach(t=>F.delete(t))}function ls(s,t,a,i){const c=oe("bmr",s,t,a,i);if(F.has(c))return F.get(c);const h=i==="male"?5:-161,l=10*s+6.25*t-5*a+h;return F.set(c,l),le(),l}function cs(s,t){const a=oe("tdee",s.toFixed(1),t);if(F.has(a))return F.get(a);const i=[{max:20,base:1.2,next:1.375},{max:40,base:1.375,next:1.55},{max:60,base:1.55,next:1.725},{max:80,base:1.725,next:1.9},{max:100,base:1.9,next:1.9}];let c=1.2;for(let l=0;l<i.length;l++){const r=i[l];if(t<=r.max){const n=l>0?i[l-1].max:0,o=r.max-n,f=t-n;c=r.base+f/o*(r.next-r.base);break}}const h=s*c;return F.set(a,h),le(),h}function ds(s,t,a){const i=t==="male"?1:0;return 1.2*s+.23*a-10.8*i-5.4}function ms(s,t){const a=Math.min(t*.5,1e3);return s/100*a}function us(s,t,a,i,c){const h=i==="male"?1.2:.6,l=.3+s/100*1.7,r=.3+t/100*1.7,n=a>=0?Math.min(1+a/100*1.5,2.5):.5;return h*l*r*n*c}function hs(s,t,a){const i=s/100,c=t/100,h=(i+c)/2,l=Math.min(i,c)*.5;return 1+h*l}function be(s){return{1:1,3:1.3,6:1.7,12:2.2}[s]||1+s/12*1.2}function xs(s,t,a,i,c,h,l,r,n){if(Math.abs(t)<.001&&Math.abs(a)<.001&&Math.abs(i)<.001)return s;const o={...s},f=hs(l,r),p=be(h),b=f*p;if(Math.abs(a)>.001){const d=a/5*b,y=[{key:"bodyFat",factor:1,min:-1.5,max:1.5},{key:"assLarge",factor:.6,min:-1.5,max:1.5},{key:"bigHips",factor:.5,min:-1.5,max:1.5},{key:"pearFigure",factor:.8,min:-1.5,max:1.5},{key:"narrowWaist",factor:-.8,min:-1.5,max:1.5},{key:"animeWaist",factor:-.6,min:-1.5,max:1.5}];for(const M of y)o[M.key]=V((o[M.key]||0)+d*M.factor,M.min,M.max)}if(Math.abs(i)>.001){const d=i/3*b;o.bodybuilderSize=V((o.bodybuilderSize||0)+d*1.2,0,2),(o.bodybuilderSize||0)>.2&&(o.bodybuilderDetails=V((o.bodybuilderDetails||0)+d*1,0,2)),(o.bodybuilderSize||0)>.5&&(o.muscularV=V((o.muscularV||0)+d*.8,0,2))}if(t<-8){const d=Math.abs(t)/15*p;o.emaciated=V((o.emaciated||0)+d,-1.5,0)}else t>0&&i>0&&(o.emaciated=V((o.emaciated||0)-Math.abs(i)/8,-1.5,0));return w.debug("PROJECTION_ENGINE","Morph adjustments calculated",{synergyBonus:f.toFixed(2),temporalAmp:p.toFixed(2),totalMultiplier:b.toFixed(2),fatChange:a.toFixed(2),muscleChange:i.toFixed(2),philosophy:"upgraded_projection_v2"}),o}function gs(s,t,a,i){if(Math.abs(t)<.001&&Math.abs(a)<.001)return s;const c={...s},h=be(i),l=t/3,r=a/5,n=l*.3*h,o=r*.15*h,f=n+o,p=["leftArm","rightArm","leftLeg","rightLeg","torso"];for(const b of p)c[b]=V((c[b]||0)+f,-1,1);return c}function V(s,t,a){return Math.max(t,Math.min(a,s))}function ps(s){const t=oe("projection",s.currentWeight,s.currentHeight,s.currentAge,s.currentGender,s.activityLevel,s.nutritionQuality,s.caloricBalance,s.timePeriodMonths);if(F.has(t)){const k=F.get(t);return w.debug("PROJECTION_ENGINE","Using cached projection result"),k}w.info("PROJECTION_ENGINE","Starting body projection calculation",{weight:s.currentWeight,height:s.currentHeight,activityLevel:s.activityLevel,nutritionQuality:s.nutritionQuality,caloricBalance:s.caloricBalance,months:s.timePeriodMonths});const a=s.currentWeight/Math.pow(s.currentHeight/100,2),i=s.currentBodyFatPercentage||ds(a,s.currentGender,s.currentAge),c=ls(s.currentWeight,s.currentHeight,s.currentAge,s.currentGender),h=cs(c,s.activityLevel),l=ms(s.caloricBalance,h),r=s.timePeriodMonths*30,n=l*r,o=n/7700,f=us(s.activityLevel,s.nutritionQuality,s.caloricBalance,s.currentGender,s.timePeriodMonths);let p,b;s.caloricBalance>=0?(b=Math.min(f,o*.6),p=o-b):(p=o*.85,b=f*.3);const d=s.targetWeight||s.currentWeight+o,y=d/Math.pow(s.currentHeight/100,2),_=s.currentWeight*(1-i/100)+b,v=(s.currentWeight*(i/100)+p)/d*100,C=_/d*100,T=s.currentGender==="male"?.52:.48,A=s.currentHeight*T*(y/22),D=xs(s.currentMorphValues||{},o,p,b,s.currentGender,s.timePeriodMonths,s.activityLevel,s.nutritionQuality,s.caloricBalance),O=gs(s.currentLimbMasses||{},b,p,s.timePeriodMonths);w.info("PROJECTION_ENGINE","Projection calculation complete",{projectedWeight:d,projectedBMI:y,weightChange:o,muscleChange:b,fatChange:p});const S={projectedWeight:Math.round(d*10)/10,projectedBMI:Math.round(y*10)/10,projectedWaistCircumference:Math.round(A*10)/10,projectedMuscleMassPercentage:Math.round(C*10)/10,projectedBodyFatPercentage:Math.round(v*10)/10,projectedMorphValues:D,projectedLimbMasses:O,calculations:{basalMetabolicRate:Math.round(c),totalDailyEnergyExpenditure:Math.round(h),dailyCaloricAdjustment:Math.round(l),totalCaloricDifference:Math.round(n),estimatedWeightChange:Math.round(o*10)/10,estimatedFatChange:Math.round(p*10)/10,estimatedMuscleChange:Math.round(b*10)/10}};return F.set(t,S),le(),S}class bs{constructor(t){te(this,"cache",new Map);te(this,"accessOrder",[]);this.maxSize=t}get(t){const a=this.cache.get(t);return a!==void 0&&(this.accessOrder=this.accessOrder.filter(i=>i!==t),this.accessOrder.push(t)),a}set(t,a){if(this.cache.has(t)&&(this.accessOrder=this.accessOrder.filter(i=>i!==t)),this.cache.set(t,a),this.accessOrder.push(t),this.cache.size>this.maxSize){const i=this.accessOrder.shift();i!==void 0&&this.cache.delete(i)}}has(t){return this.cache.has(t)}clear(){this.cache.clear(),this.accessOrder=[]}get size(){return this.cache.size}}const H=new bs(250);function fs({profile:s,bodyScan:t,projectionParams:a,enabled:i=!0}){const[c,h]=x.useState(null),[l,r]=x.useState(!1),[n,o]=x.useState(null),f=x.useRef(null),p=x.useRef(""),b=x.useRef(!1),d=x.useCallback((_,g,v)=>!_||!g?"":[g.weight||_.weight,_.height,_.age,_.sex,g.body_fat_percentage||0,v.activityLevel,v.nutritionQuality,v.caloricBalance,v.timePeriodMonths].join("|"),[]),y=x.useMemo(()=>!s||!t||!i?"":d(s,t,a),[s,t,a,i,d]);x.useEffect(()=>{if(!i||!s||!t){r(!1);return}if(!t.morph_values||Object.keys(t.morph_values).length===0){o("Donn√©es de scan incompl√®tes"),r(!1);return}if(y===p.current){r(!1);return}if(H.has(y)){const _=H.get(y);h(_),p.current=y,r(!1),o(null);return}if(!b.current)return f.current&&clearTimeout(f.current),r(!0),o(null),f.current=setTimeout(async()=>{b.current=!0;const _=Date.now();try{const g={currentWeight:t.weight||s.weight||70,currentHeight:s.height||170,currentAge:s.age||30,currentGender:s.sex==="male"?"male":"female",currentBodyFatPercentage:t.body_fat_percentage,currentMorphValues:t.morph_values||{},currentLimbMasses:t.limb_masses||{},...a};let v,C=!1;try{const A=await fetch(`${he.supabaseUrl}/functions/v1/compute-morphology-state`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${he.supabaseAnon}`},body:JSON.stringify(g)});if(A.ok){const{success:D,data:O,cached:S,computeTime:k}=await A.json();if(D&&O)v=O,C=!0;else throw new Error("Backend returned unsuccessful response")}else throw new Error(`Backend responded with ${A.status}`)}catch{v=ps(g),C=!1}const T=Date.now()-_;H.set(y,v),h(v),p.current=y,T>200&&w.info("USE_BODY_PROJECTION","‚ú® Projection calculated successfully",{duration:`${T}ms`,backendUsed:C,cacheSize:H.size,projectedWeight:v.projectedWeight.toFixed(1),projectedBMI:v.projectedBMI.toFixed(1),projectedMorphKeysCount:v.projectedMorphValues?Object.keys(v.projectedMorphValues).length:0,projectedLimbMassesCount:v.projectedLimbMasses?Object.keys(v.projectedLimbMasses).length:0,inputHash:y.substring(0,30),philosophy:"calculation_success_sampled"})}catch(g){const v=g instanceof Error?g.message:"Erreur de calcul";o(v),w.error("USE_BODY_PROJECTION","Calculation error",{error:g})}finally{r(!1),b.current=!1}},200),()=>{f.current&&clearTimeout(f.current)}},[i,s,t,a,y]);const M=x.useCallback(()=>{w.info("USE_BODY_PROJECTION","üîÑ Manual recalculation triggered",{previousCacheSize:H.size,clearedCache:!0,philosophy:"manual_recalculation"}),p.current="",H.clear(),r(!0)},[]);return x.useEffect(()=>{},[]),{projection:c,isCalculating:l,error:n,recalculate:M}}const ys=()=>{const{profile:s}=q(),{bodyScanData:t,isLoading:a}=pe(),[i,c]=x.useState("female"),[h,l]=x.useState(!0),[r,n]=x.useState(!1);x.useEffect(()=>{const N=setTimeout(()=>{l(!1)},400);return()=>clearTimeout(N)},[]),x.useEffect(()=>{if(s?.sex){const N=s.sex==="male"?"male":"female";c(N)}},[s?.sex]);const{showError:o}=ee(),[f,p]=x.useState({activityLevel:50,nutritionQuality:50,caloricBalance:0,timePeriodMonths:3}),b=x.useCallback(N=>{p(N)},[]),{projection:d,isCalculating:y,error:M}=fs({profile:s,bodyScan:t,projectionParams:f,enabled:!a});x.useEffect(()=>{M&&o(M)},[M,o]);const _=x.useMemo(()=>{const N=t?.weight||s?.weight||0,L=s?.height||0,se=N&&L?N/Math.pow(L/100,2):0;return{currentWeight:N,currentHeight:L,currentBMI:se}},[t?.weight,s?.weight,s?.height]),g=x.useRef(),v=x.useRef(),C=x.useRef(),T=x.useRef(),A=x.useRef(),D=x.useRef(null),O=x.useRef(null),S=.05,k=x.useCallback((N,L,se=S,Ms)=>{if(N===L)return!0;if(!N||!L)return N===L;const de=Object.keys(N),Ne=Object.keys(L);return de.length!==Ne.length?!1:de.every(me=>Math.abs((N[me]||0)-(L[me]||0))<se)},[S]),$=x.useMemo(()=>k(t?.morph_values,g.current,S,"stableMorphData")?g.current:(g.current=t?.morph_values,t?.morph_values),[t?.morph_values,k,S]),P=x.useMemo(()=>k(t?.limb_masses,C.current,S,"stableLimbMasses")?C.current:(C.current=t?.limb_masses,t?.limb_masses),[t?.limb_masses,k,S]),U=x.useMemo(()=>{const N=t?.skin_tone;return N===A.current?A.current:(A.current=N,N)},[t?.skin_tone]),R=x.useRef(void 0);!R.current&&t?.id&&(R.current=t.id,w.info("PROJECTION_TAB","üîí ServerScanId locked for projection session",{lockedId:R.current,philosophy:"permanent_scan_id_lock"})),x.useEffect(()=>{const N=t?.id;N&&R.current&&N!==R.current&&w.error("PROJECTION_TAB","üö® CRITICAL: ServerScanId changed during projection session!",{lockedId:R.current,attemptedNewId:N,willIgnoreChange:!0,philosophy:"scan_id_change_blocked"})},[t?.id]);const fe=R.current,[W,ce]=x.useState(null);x.useEffect(()=>{if(!d){ce(null);return}return D.current&&clearTimeout(D.current),O.current=d,D.current=setTimeout(()=>{ce(O.current)},400),()=>{D.current&&clearTimeout(D.current)}},[d]);const ye=x.useMemo(()=>{const N=W?.projectedMorphValues;return k(N,v.current,S,"stableProjectedMorphs")?v.current:(v.current=N,N)},[W?.projectedMorphValues,k,S]),je=x.useMemo(()=>{const N=W?.projectedLimbMasses;return k(N,T.current,S,"stableProjectedLimbMasses")?T.current:(T.current=N,N)},[W?.projectedLimbMasses,k,S]),ve=a||h||!r&&!!t,we=x.useCallback(()=>{n(!0),w.info("PROJECTION_TAB","Projection viewer fully initialized")},[]);return x.useEffect(()=>{if(!r&&t?.id){const N=setTimeout(()=>{r||(w.warn("PROJECTION_TAB","Safety timeout: forcing viewer ready after 10s"),n(!0))},1e4);return()=>clearTimeout(N)}},[r,t?.id]),ve&&t?e.jsx(Te,{}):t?t&&(!t.morph_values||Object.keys(t.morph_values).length===0)?e.jsxs("div",{className:"glass-card p-8 text-center",children:[e.jsx(ue,{className:"w-16 h-16 text-red-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Donn√©es de scan incompl√®tes"}),e.jsx("p",{className:"text-white/70 mb-6",children:"Votre dernier scan ne contient pas toutes les donn√©es n√©cessaires. Veuillez effectuer un nouveau scan corporel."}),e.jsx("a",{href:"/body-scan",className:`inline-flex items-center gap-2 px-6 py-3 bg-purple-500 hover:bg-purple-600
                     text-white rounded-lg transition-colors`,children:"Effectuer un nouveau scan"})]}):e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx("div",{className:"w-full",children:e.jsx(ss,{onParamsChange:b,initialParams:f,isCalculating:y})}),e.jsx("div",{className:"w-full",children:e.jsx(ns,{serverScanId:fe,currentMorphData:$,currentLimbMasses:P,currentSkinTone:U,currentGender:i,projectedMorphData:ye,projectedLimbMasses:je,projectedSkinTone:U,projectedGender:i,isLoading:a||y,onViewerReady:we})}),e.jsx("div",{className:"w-full",children:e.jsx(ts,{currentWeight:_.currentWeight,currentBMI:_.currentBMI,projection:W,isLoading:y})})]}):e.jsxs("div",{className:"glass-card p-8 text-center",children:[e.jsx(ue,{className:"w-16 h-16 text-orange-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Scan corporel requis"}),e.jsx("p",{className:"text-white/70 mb-6",children:a?"Chargement de vos donn√©es...":"Vous devez d'abord effectuer un scan corporel pour utiliser le syst√®me de projection."}),!a&&e.jsx("a",{href:"/body-scan",className:`inline-flex items-center gap-2 px-6 py-3 bg-purple-500 hover:bg-purple-600
                       text-white rounded-lg transition-colors`,children:"Effectuer un scan corporel"})]})};function js(s){if(!s)return 1/0;const t=new Date,a=new Date(s),i=Math.abs(t.getTime()-a.getTime());return Math.ceil(i/(1e3*60*60*24))}function vs(s){return s===1/0?{status:"never_scanned",urgency:"high",color:"#8B5CF6",message:"Cr√©ez votre premier avatar",subtitle:"Commencez votre parcours de transformation corporelle"}:s<=7?{status:"up_to_date",urgency:"low",color:"#8B5CF6",message:"Vous √™tes √† jour !",subtitle:`Dernier scan il y a ${s} jour${s>1?"s":""}`}:s<=10?{status:"due_soon",urgency:"medium",color:"#F59E0B",message:"Scan recommand√© bient√¥t",subtitle:`Dernier scan il y a ${s} jours`}:{status:"overdue",urgency:"high",color:"#EF4444",message:"Nouveau scan recommand√©",subtitle:`Dernier scan il y a ${s} jours`}}async function ws(s){const{data:t,error:a}=await X.from("body_scans").select("id, created_at, timestamp").eq("user_id",s).order("created_at",{ascending:!1}).limit(1);if(a)throw w.error("SCAN_CTA","Failed to fetch latest body scan",{error:a.message,userId:s,timestamp:new Date().toISOString()}),a;return t&&t.length>0?t[0]:null}const Ns=()=>{const s=ie(),{profile:t}=q(),{click:a,success:i}=ee(),{data:c,isLoading:h,error:l}=G({queryKey:["body-scans","latest",t?.userId],queryFn:()=>ws(t?.userId),enabled:!!t?.userId,staleTime:5*60*1e3,retry:1}),r=js(c?.created_at||null),n=vs(r),o=()=>{a(),i(),w.info("SCAN_CTA","User initiated new scan from CTA",{userId:t?.userId,daysSinceLastScan:r,scanStatus:n.status,timestamp:new Date().toISOString()}),s("/body-scan")},f=()=>{a(),w.info("SCAN_CTA","User navigated to insights from CTA",{userId:t?.userId,daysSinceLastScan:r,scanStatus:n.status,timestamp:new Date().toISOString()}),s("/avatar#insights")};return h?e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(I,{className:"text-center p-8",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
              var(--glass-opacity-base)
            `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
              var(--glass-shadow-sm),
              0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
            `},children:[e.jsx(u,{Icon:m.Loader2,size:48,className:"bodyscan-text-accent loader-essential mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"V√©rification de votre historique..."}),e.jsx("p",{className:"text-white/70 text-sm",children:"Analyse de vos scans pr√©c√©dents."})]})}):l?e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(I,{className:"text-center p-8",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-error) 8%, transparent) 0%, transparent 60%),
              var(--glass-opacity-base)
            `,borderColor:"color-mix(in srgb, var(--color-body-scan-error) 25%, transparent)",boxShadow:`
              var(--glass-shadow-sm),
              0 0 16px color-mix(in srgb, var(--color-body-scan-error) 10%, transparent)
            `},children:[e.jsx(u,{Icon:m.AlertCircle,size:48,className:"bodyscan-text-error mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de chargement"}),e.jsx("p",{className:"bodyscan-text-error text-sm mb-6",children:l?.message}),e.jsx("button",{onClick:()=>window.location.reload(),className:"btn-glass--primary",children:"R√©essayer"})]})}):e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:e.jsxs(I,{className:"p-8 text-center relative overflow-visible",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, ${n.color} 12%, transparent) 0%, transparent 60%),
              radial-gradient(circle at 70% 80%, color-mix(in srgb, ${n.color} 8%, transparent) 0%, transparent 50%),
              var(--glass-opacity-base)
            `,borderColor:`color-mix(in srgb, ${n.color} 30%, transparent)`,boxShadow:`
              0 12px 40px rgba(0, 0, 0, 0.25),
              0 0 30px color-mix(in srgb, ${n.color} 20%, transparent),
              inset 0 2px 0 rgba(255, 255, 255, 0.15)
            `},children:[e.jsx("div",{className:"training-hero-corners","aria-hidden":"true",children:[0,1,2,3].map(p=>e.jsx(j.div,{className:"corner-particle",style:{position:"absolute",width:"8px",height:"8px",borderRadius:"2px",background:`linear-gradient(135deg, ${n.color}, rgba(255, 255, 255, 0.8))`,boxShadow:`0 0 20px ${n.color}`,top:p<2?"12px":"auto",bottom:p>=2?"12px":"auto",left:p%2===0?"12px":"auto",right:p%2===1?"12px":"auto"},initial:{rotate:p%2===0?45:-45},animate:{scale:[1,1.3,1],opacity:[.6,1,.6],rotate:p%2===0?[45,60,45]:[-45,-60,-45]},transition:{duration:3,repeat:1/0,delay:p*.2,ease:[.4,0,.2,1]}},p))}),e.jsx("div",{className:"absolute inset-0 rounded-inherit pointer-events-none urgent-forge-glow-css",style:{background:`radial-gradient(circle at center, color-mix(in srgb, ${n.color} 8%, transparent) 0%, transparent 70%)`,filter:"blur(20px)",transform:"scale(1.2)",zIndex:-1}}),e.jsxs(j.div,{className:"w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center relative",style:{background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                linear-gradient(135deg, color-mix(in srgb, ${n.color} 35%, transparent), color-mix(in srgb, ${n.color} 25%, transparent))
              `,border:`2px solid color-mix(in srgb, ${n.color} 50%, transparent)`,boxShadow:`0 0 40px color-mix(in srgb, ${n.color} 40%, transparent)`},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25,delay:.2},children:[e.jsx(u,{Icon:n.status==="never_scanned"?m.Scan:n.status==="up_to_date"?m.Check:m.Timer,size:48,style:{color:n.color},variant:"pure"}),n.urgency==="high"&&e.jsx(j.div,{className:"absolute inset-0 rounded-full border-2",style:{borderColor:`color-mix(in srgb, ${n.color} 40%, transparent)`},animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),n.status==="up_to_date"&&e.jsx(e.Fragment,{children:[...Array(6)].map((p,b)=>{const d=b*360/6,y=60,M=Math.cos(d*Math.PI/180)*y,_=Math.sin(d*Math.PI/180)*y;return e.jsx("div",{className:`absolute w-2 h-2 rounded-full dynamic-particle-css dynamic-particle-css--${b+1}`,style:{background:n.color,boxShadow:`0 0 12px color-mix(in srgb, ${n.color} 70%, transparent)`,"--particle-x":`${M*.4}px`,"--particle-y":`${_*.4}px`,"--particle-x-end":`${M}px`,"--particle-y-end":`${_}px`}},b)})})]}),e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},className:"mb-8",children:[e.jsx("h3",{className:"text-3xl font-bold mb-3",style:{color:n.color},children:n.message}),e.jsx("p",{className:"text-white/80 text-lg leading-relaxed max-w-md mx-auto",children:n.subtitle})]}),e.jsxs(j.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.6},className:"mb-8 p-4 rounded-xl",style:{background:`color-mix(in srgb, ${n.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${n.color} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)"},children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(u,{Icon:m.Info,size:16,style:{color:n.color}}),e.jsx("span",{className:"text-white font-medium text-sm",children:"Recommandation TwinForge"})]}),e.jsx("p",{className:"text-white/80 text-sm leading-relaxed",children:"Pour un suivi optimal de votre √©volution corporelle, nous recommandons un scan tous les 7 jours. Cela permet de d√©tecter les changements subtils et d'ajuster vos objectifs en cons√©quence."})]}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.8},className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsxs(j.button,{onClick:o,className:"px-8 py-4 rounded-full font-bold text-lg text-white relative overflow-hidden min-h-[64px]",style:{background:`
                  linear-gradient(135deg,
                    color-mix(in srgb, ${n.color} 85%, transparent),
                    color-mix(in srgb, ${n.color} 70%, transparent)
                  )
                `,border:`2px solid ${n.color}`,boxShadow:`
                  0 12px 40px color-mix(in srgb, ${n.color} 40%, transparent),
                  0 0 60px color-mix(in srgb, ${n.color} 30%, transparent),
                  inset 0 3px 0 rgba(255, 255, 255, 0.4)
                `,backdropFilter:"blur(20px) saturate(160%)"},whileHover:{scale:1.02,y:-2,boxShadow:`
                  0 16px 50px color-mix(in srgb, ${n.color} 50%, transparent),
                  0 0 80px color-mix(in srgb, ${n.color} 40%, transparent),
                  inset 0 3px 0 rgba(255, 255, 255, 0.5)
                `},whileTap:{scale:.98},children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)",animation:"celebration-cta-shimmer-movement 2s ease-in-out infinite",borderRadius:"inherit"}}),e.jsxs("div",{className:"relative z-10 flex items-center justify-center gap-3",children:[e.jsx(u,{Icon:m.Scan,size:24,style:{color:"white",filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.3))"},variant:"pure"}),e.jsx("span",{style:{textShadow:"0 2px 4px rgba(0,0,0,0.3)"},children:n.status==="never_scanned"?"Cr√©er mon Avatar 3D":"Nouveau Scan"})]})]}),n.status!=="never_scanned"&&e.jsx(j.button,{onClick:f,className:"px-6 py-4 rounded-full font-medium text-white/90 transition-all duration-200 min-h-[64px]",style:{background:`color-mix(in srgb, ${n.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${n.color} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)"},onMouseEnter:p=>{p.currentTarget.style.background=`color-mix(in srgb, ${n.color} 12%, transparent)`,p.currentTarget.style.borderColor=`color-mix(in srgb, ${n.color} 30%, transparent)`,p.currentTarget.style.transform="translateY(-1px) scale(1.02)"},onMouseLeave:p=>{p.currentTarget.style.background=`color-mix(in srgb, ${n.color} 8%, transparent)`,p.currentTarget.style.borderColor=`color-mix(in srgb, ${n.color} 20%, transparent)`,p.currentTarget.style.transform="translateY(0) scale(1)"},whileHover:{scale:1.02,y:-1},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(u,{Icon:m.Zap,size:20,color:"white",variant:"pure"}),e.jsx("span",{children:"Voir mes Insights"})]})})]})]})}),n.status!=="never_scanned"&&e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.3},children:e.jsxs(I,{className:"p-6",style:{background:`
                radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
                var(--glass-opacity-base)
              `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
                0 12px 40px rgba(0, 0, 0, 0.25),
                0 0 30px color-mix(in srgb, var(--color-body-scan-primary) 15%, transparent),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm text-xl",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, var(--color-body-scan-primary) 35%, transparent), color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent))
                    `,border:"2px solid color-mix(in srgb, var(--color-body-scan-primary) 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, var(--color-body-scan-primary) 30%, transparent)"},children:e.jsx(u,{Icon:m.TrendingUp,size:20,style:{color:"var(--color-body-scan-primary)"},variant:"pure"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-sm",children:"Suivi de Progression"}),e.jsx("div",{className:"text-white/60 text-xs font-normal mt-0.5",children:"√âtat de votre √©volution corporelle"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"bodyscan-status-badge bodyscan-status-badge--active",children:[e.jsx("div",{className:"bodyscan-status-icon"}),e.jsx("span",{className:"bodyscan-status-text",children:n.urgency==="low"?"√Ä jour":n.urgency==="medium"?"Bient√¥t":"Urgent"})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl font-bold mb-2",style:{color:n.color},children:r===1/0?"‚àû":r}),e.jsx("div",{className:"text-white/70 text-sm",children:r===1/0?"Aucun scan effectu√©":r===1?"jour depuis le dernier scan":"jours depuis le dernier scan"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-full bg-white/10 rounded-full h-3 overflow-hidden",children:e.jsx(j.div,{className:"h-3 rounded-full relative overflow-hidden",style:{background:`linear-gradient(90deg, ${n.color}, color-mix(in srgb, ${n.color} 80%, white))`,boxShadow:`0 0 12px ${n.color}60, inset 0 1px 0 rgba(255,255,255,0.3)`},initial:{width:0},animate:{width:`${Math.min(100,Math.max(0,100-r/7*100))}%`},transition:{duration:1.2,ease:"easeOut",delay:.5},children:e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:`linear-gradient(90deg,
                          transparent 0%,
                          rgba(255,255,255,0.4) 50%,
                          transparent 100%
                        )`,animation:"progressShimmer 2s ease-in-out infinite"}})})}),e.jsxs("div",{className:"flex justify-between mt-2 text-xs text-white/50",children:[e.jsx("span",{children:"Nouveau"}),e.jsx("span",{children:"7 jours"})]})]}),e.jsx("div",{className:"text-center p-3 rounded-xl",style:{background:`color-mix(in srgb, ${n.color} 6%, transparent)`,border:`1px solid color-mix(in srgb, ${n.color} 15%, transparent)`},children:e.jsx("p",{className:"text-white/80 text-sm",children:n.status==="up_to_date"?`Prochain scan recommand√© dans ${7-r} jour${7-r>1?"s":""}`:"Un nouveau scan est recommand√© pour suivre votre √©volution"})})]})]})}),e.jsx(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.5},children:e.jsxs(I,{className:"p-6",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-accent) 6%, transparent) 0%, transparent 60%),
              var(--glass-opacity-base)
            `,borderColor:"color-mix(in srgb, var(--color-body-scan-accent) 20%, transparent)",boxShadow:`
              var(--glass-shadow-sm),
              0 0 12px color-mix(in srgb, var(--color-body-scan-accent) 8%, transparent)
            `},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #8B5CF6 35%, transparent), color-mix(in srgb, #8B5CF6 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #8B5CF6 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #8B5CF6 30%, transparent)"},children:e.jsx(u,{Icon:m.Info,size:20,style:{color:"#8B5CF6"},variant:"pure"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Pourquoi scanner r√©guli√®rement ?"}),e.jsx("div",{className:"text-white/60 text-xs font-normal mt-0.5",children:"Optimisez votre suivi corporel avec des scans r√©guliers"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(j.div,{className:"morphology-insight-item",style:{"--insight-color":"#22C55E"},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.1},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(u,{Icon:m.TrendingUp,size:20,style:{color:"#22C55E"},variant:"pure"})}),e.jsx("div",{className:"morphology-insight-value",children:"Suivi Pr√©cis"}),e.jsx("div",{className:"morphology-insight-title",children:"D√©tectez les changements subtils"})]}),e.jsxs(j.div,{className:"morphology-insight-item",style:{"--insight-color":"#3B82F6"},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.2},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(u,{Icon:m.Zap,size:20,style:{color:"#3B82F6"},variant:"pure"})}),e.jsx("div",{className:"morphology-insight-value",children:"Insights IA"}),e.jsx("div",{className:"morphology-insight-title",children:"Recommandations personnalis√©es"})]}),e.jsxs(j.div,{className:"morphology-insight-item",style:{"--insight-color":"#A855F7"},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.3},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(u,{Icon:m.Heart,size:20,style:{color:"#A855F7"},variant:"pure"})}),e.jsx("div",{className:"morphology-insight-value",children:"Motivation"}),e.jsx("div",{className:"morphology-insight-title",children:"Visualisez vos progr√®s"})]})]})]})})]})};function _s(s){switch(s){case"scanCta":return{icon:"Scan",title:"Forge Corporelle",subtitle:"Capturez votre √©volution corporelle avec un nouveau scan 3D",circuit:"avatar",color:"#8B5CF6"};case"avatar":return{icon:"Eye",title:"Votre Avatar 3D",subtitle:"Visualisez et ajustez votre reflet num√©rique personnalis√©",circuit:"avatar",color:"#06B6D4"};case"projection":return{icon:"TrendingUp",title:"Projection Corporelle",subtitle:"Visualisez votre √©volution future selon vos habitudes de vie",circuit:"avatar",color:"#10B981"};case"insights":return{icon:"Zap",title:"Insights Avatar",subtitle:"Analyses IA personnalis√©es et recommandations bas√©es sur votre scan corporel",circuit:"avatar",color:"#F59E0B"};case"history":return{icon:"History",title:"Historique des Scans",subtitle:"Revivez vos transformations corporelles au fil du temps",circuit:"avatar",color:"#8B5CF6"};default:return{icon:"Eye",title:"Votre Avatar 3D",subtitle:"Visualisez et ajustez votre reflet num√©rique personnalis√©",circuit:"avatar",color:"#8B5CF6"}}}const qs=()=>{const s=Se(),t=ie(),{click:a}=ee(),i=Y.useMemo(()=>{const l=s.hash.replace("#","");return["scanCta","avatar","projection","insights","history"].includes(l)?l:"scanCta"},[s.hash]);Ee(`avatar:${i}`);const c=_s(i),h=l=>{const r=l||"scanCta";a(),w.debug("AVATAR_PAGE","Changement d'onglet d√©clench√©",{nouvelOnglet:r}),t({pathname:s.pathname,search:s.search,hash:`#${r}`},{replace:!1})};return e.jsxs("div",{className:"space-y-6 w-full max-w-none",children:[e.jsx(Ae,{icon:c.icon,title:c.title,subtitle:c.subtitle,circuit:c.circuit,iconColor:c.color}),e.jsxs(B,{defaultValue:"scanCta",className:"w-full min-w-0 avatar-tabs",onValueChange:h,forgeContext:"avatar",children:[e.jsxs(B.List,{role:"tablist","aria-label":"Sections de l'avatar",className:"mb-4 md:mb-6 w-full",children:[e.jsx(B.Trigger,{value:"scanCta",icon:"Scan","aria-controls":"panel-scancta",children:e.jsx("span",{className:"tab-text",children:"Scanner"})}),e.jsx(B.Trigger,{value:"avatar",icon:"Eye","aria-controls":"panel-avatar",children:e.jsx("span",{className:"tab-text",children:"Avatar"})}),e.jsx(B.Trigger,{value:"projection",icon:"TrendingUp","aria-controls":"panel-projection",children:e.jsx("span",{className:"tab-text",children:"Projection"})}),e.jsx(B.Trigger,{value:"insights",icon:"Zap","aria-controls":"panel-insights",children:e.jsx("span",{className:"tab-text",children:"Insights"})}),e.jsx(B.Trigger,{value:"history",icon:"History","aria-controls":"panel-history",children:e.jsx("span",{className:"tab-text",children:"Historique"})})]}),e.jsx(B.Panel,{id:"panel-scancta",value:"scanCta",children:e.jsx(Ns,{})}),e.jsx(B.Panel,{id:"panel-avatar",value:"avatar",children:e.jsx(Oe,{})}),e.jsx(B.Panel,{id:"panel-projection",value:"projection",children:e.jsx(ys,{})}),e.jsx(B.Panel,{id:"panel-insights",value:"insights",children:e.jsx(Ye,{})}),e.jsx(B.Panel,{id:"panel-history",value:"history",children:e.jsx(Xe,{})})]})]})};export{qs as default};
