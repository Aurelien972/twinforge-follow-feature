import{u as le,r as y,j as e,R as ae}from"./vendor-BefW7Bxj.js";import{n as ge}from"./utils-CUtLAp28.js";import{u as ce,K as S,O as de,S as P,I as k,G as z,s as be,Q as xe,m as se}from"./ui-components-lrK_WhZu.js";import{u as L,B as ye}from"./BodyScanProgressHeader-Cl4niUVu.js";import{s as Y,a as _e}from"./stores-Dp3vmZ5-.js";import{l as c,s as ve,u as Z}from"./page-fridge-Cp-W9isk.js";import{f as W,_ as Se}from"./page-fridge-scan-C62RDC3k.js";import{g as Ce,P as we}from"./signedUrlService-DUv0zqbl.js";import{createCompleteSkinTone as ne}from"./normalizeSkinTone-BhVF89EQ.js";import{E as Q,L as J}from"./index-CJfAiy_W.js";import"./supabase-pyFrrmXL.js";import"./motion-BQvLDPOm.js";import"./date-utils-BlBdbPk_.js";import"./page-profile-CZR_5_Mb.js";import"./forms-BkbsF97i.js";const X=new Map;function q(t,i={}){const n=i.scan_id||i.session_id||"unknown",a=`${t}_${n}`,s=Date.now(),l=X.get(a);if(l&&s-l<5e3){c.debug("Analytics Event deduplicated",{event:t,scanId:n,reason:"recent_duplicate",timeSinceLastMs:s-l});return}X.set(a,s);for(const[m,f]of X.entries())s-f>3e4&&X.delete(m);const r={event:t,properties:{...i,scan_id:n,timestamp:Date.now(),session_id:ke(),user_agent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}},timestamp:Date.now()};Ne(r)}const je={captureStarted:t=>{q("scan.capture_started",t)},photoTaken:t=>{q("scan.photo_taken",t)},photoRetake:t=>{q("scan.photo_retake_reason",t)},captureCompleted:t=>{q("scan.capture_completed",t)},processingStarted:t=>{q("scan.processing_started",t)},processingCompleted:t=>{q("scan.processing_completed",t)}};function ke(){let t=sessionStorage.getItem("scan_session_id");return t||(t=`scan_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("scan_session_id",t)),t}function Ne(t){try{const i=localStorage.getItem("scan_analytics_events"),n=i?JSON.parse(i):[];n.push(t),n.length>100&&n.splice(0,n.length-100),localStorage.setItem("scan_analytics_events",JSON.stringify(n))}catch(i){console.warn("Failed to store analytics event:",i)}}async function Ee(t){const{userId:i,clientScanId:n,capturedPhotos:a,stableScanParams:s,resolvedGender:l}=t,{setProcessingStep:r,setServerScanId:m,setComplete:f,setOverallProgress:o,incrementProgress:h,startDynamicProcessing:u,stopDynamicProcessing:g}=Y.getState();c.info("SCAN_PROCESSING_SERVICE","Starting complete pipeline processing",{clientScanId:n,userId:i,photosCount:a.length,userProfile:s,resolvedGender:l,timestamp:new Date().toISOString()}),o(52,"Préparation des données","Téléchargement sécurisé de vos photos...");const p=setInterval(()=>{h(1,"Préparation des données","Téléchargement sécurisé de vos photos...")},200),v=await Ae(i,n,a);clearInterval(p),c.info("SCAN_PROCESSING_SERVICE","Starting dynamic processing progression",{clientScanId:n,startPercentage:52,endPercentage:92,totalSteps:17,philosophy:"dynamic_scan_progression_start"}),u(52,92);const x=await Ie(i,v,s,l,n),N=await Pe(i,v,x,l,n),O=await Te(i,x,N,l,n),d=await Fe(O,v,x,N,s,l,n,i);c.info("SCAN_PROCESSING_SERVICE","Stopping dynamic processing before commit",{clientScanId:n,philosophy:"dynamic_scan_progression_stop_before_commit"}),g(),o(92,"Sauvegarde des Données","Persistance de votre avatar personnalisé...");const{commitResult:b,skinTone:_}=await Re(i,x,d,N,a,l,n);b.scan_id&&m(b.scan_id),r("model_loading"),o(95,"Finalisation","Préparation de votre avatar 3D..."),await new Promise(B=>setTimeout(B,800)),r("model_loaded"),o(98,"Prêt","Tout est prêt !"),c.info("SCAN_PROCESSING_SERVICE","🎨 CRITICAL: Validating skin tone before buildCompleteResults",{clientScanId:n,hasSkinTone:!!_,skinToneSchema:_?.schema,skinToneRGB:_?.rgb?`rgb(${_.rgb.r}, ${_.rgb.g}, ${_.rgb.b})`:"unknown",skinToneHex:_?.hex||"unknown",skinToneSource:_?.source,skinToneConfidence:_?.confidence,philosophy:"pre_build_complete_results_validation"});const A=Me(x,N,d,b,v,s,l,n,i,_);return c.info("SCAN_PROCESSING_SERVICE","Complete pipeline processing finished successfully",{clientScanId:n,serverScanId:b.scan_id,hasAllResults:!!(A.estimate&&A.semantic&&A.match&&A.commit),finalConfidence:A.estimate?.extracted_data?.processing_confidence||0,aiRefined:!!d.ai_refinement?.ai_refine,aiConfidence:d.ai_refinement?.ai_confidence,insightsCount:A.insights?.items?.length||0,timestamp:new Date().toISOString(),philosophy:"pipeline_complete_ready_for_navigation"}),f(),o(100,"Terminé","Traitement complet !"),c.info("SCAN_PROCESSING_SERVICE","Processing state marked as complete, ready for celebration",{clientScanId:n,serverScanId:b.scan_id,philosophy:"ready_for_celebration_after_complete_processing"}),{estimate:x,semantic:N,match:d,commit:b,completeResults:A}}async function Ae(t,i,n){c.info("SCAN_PROCESSING_SERVICE","Step 0: Starting photo upload",{clientScanId:i,photosCount:n.length});const a=await Promise.all(n.map(async(s,l)=>{try{const m=await(await fetch(s.url)).blob(),f=new File([m],`scan-${i}-${s.type}.jpg`,{type:"image/jpeg"}),o=`scans/${t}/${i}/${s.type}.jpg`,{data:h,error:u}=await ve.storage.from("body-scans").upload(o,f,{cacheControl:"3600",upsert:!1});if(u)throw new Error(`Upload failed for ${s.type}: ${u.message}`);const g=await Ce(we.BODY_SCANS,o);if(!g)throw new Error(`Failed to get signed URL for ${s.type}`);return{view:s.type,url:g,report:s.captureReport}}catch(r){throw c.error("SCAN_PROCESSING_SERVICE",`Failed to upload ${s.type} photo`,{clientScanId:i,error:r instanceof Error?r.message:"Unknown error"}),r}}));return c.info("SCAN_PROCESSING_SERVICE","Step 0: Photo upload completed",{clientScanId:i,uploadedCount:a.length,uploadedUrls:a.map(s=>({view:s.view,urlLength:s.url.length}))}),a}async function Ie(t,i,n,a,s){c.info("SCAN_PROCESSING_SERVICE","Step 1: Starting scan-estimate",{clientScanId:s,requestData:{userId:t,photosCount:i.length,userMetrics:n}});const l={user_id:t,photos:i,user_declared_height_cm:n.height_cm,user_declared_weight_kg:n.weight_kg,user_declared_gender:a,clientScanId:s,resolvedGender:a},r=await W.estimate(l);return c.info("SCAN_PROCESSING_SERVICE","Step 1: scan-estimate completed",{clientScanId:s,hasExtractedData:!!r.extracted_data,confidence:r.extracted_data?.processing_confidence,hasSkinTone:!!r.extracted_data?.skin_tone,measurementsKeys:r.extracted_data?.raw_measurements?Object.keys(r.extracted_data.raw_measurements):[]}),r}async function Pe(t,i,n,a,s){c.info("SCAN_PROCESSING_SERVICE","Step 2: Starting scan-semantic",{clientScanId:s,requestData:{userId:t,hasExtractedData:!!n.extracted_data,estimatedBMI:n.extracted_data?.estimated_bmi}});const l={user_id:t,photos:i,extracted_data:n.extracted_data,user_declared_gender:a,clientScanId:s,resolvedGender:a},r=await W.semantic(l);return c.info("SCAN_PROCESSING_SERVICE","Step 2: scan-semantic completed",{clientScanId:s,hasSemanticProfile:!!r.semantic_profile,semanticConfidence:r.semantic_confidence,adjustmentsMade:r.adjustments_made?.length||0,semanticClasses:r.semantic_profile?{obesity:r.semantic_profile.obesity,muscularity:r.semantic_profile.muscularity,level:r.semantic_profile.level,morphotype:r.semantic_profile.morphotype}:null}),r}async function Te(t,i,n,a,s){c.info("SCAN_PROCESSING_SERVICE","Step 3: Starting scan-match",{clientScanId:s,userBMICalculated:i.extracted_data?.estimated_bmi,semanticClassificationForMatching:{obesity:n.semantic_profile?.obesity,muscularity:n.semantic_profile?.muscularity,level:n.semantic_profile?.level,morphotype:n.semantic_profile?.morphotype}});const l={user_id:t,extracted_data:i.extracted_data,semantic_profile:n.semantic_profile,user_semantic_indices:{morph_index:n.semantic_profile.morph_index||0,muscle_index:n.semantic_profile.muscle_index||0},matching_config:{gender:a,limit:5},clientScanId:s,resolvedGender:a},r=await W.match(l);return c.info("SCAN_PROCESSING_SERVICE","Step 3: scan-match completed",{clientScanId:s,selectedArchetypesCount:r.selected_archetypes?.length||0,strategyUsed:r.strategy_used,semanticCoherenceScore:r.semantic_coherence_score}),r}async function Fe(t,i,n,a,s,l,r,m){c.info("AI_REFINEMENT","Starting AI morphological refinement",{scanId:r,resolvedGender:l,mappingVersion:"v1.0",blendShapeParamsCount:Object.keys(t.selected_archetypes?.[0]?.morph_values||{}).length,philosophy:"ai_driven_photo_realistic_refinement"});const f=i.map(p=>({view:p.view,url:p.url,report:p.report})),o=t.selected_archetypes?.[0]?.morph_values||{},h=t.selected_archetypes?.[0]?.limb_masses||{},u={height_cm:s.height_cm,weight_kg:s.weight_kg,estimated_bmi:n.extracted_data?.estimated_bmi||s.weight_kg/Math.pow(s.height_cm/100,2),raw_measurements:{waist_cm:n.extracted_data?.raw_measurements?.waist_cm||80,chest_cm:n.extracted_data?.raw_measurements?.chest_cm||95,hips_cm:n.extracted_data?.raw_measurements?.hips_cm||100}};let g=null;try{g=await W.refine({scan_id:r,user_id:m,resolvedGender:l,photos:f,blend_shape_params:o,blend_limb_masses:h,k5_envelope:t.k5_envelope,vision_classification:a.semantic_profile,mapping_version:"v1.0",user_measurements:u}),c.info("AI_REFINEMENT","AI refinement completed successfully",{scanId:r,resolvedGender:l,aiRefine:g.ai_refine,finalShapeParamsCount:Object.keys(g.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(g.final_limb_masses||{}).length,clampedKeysCount:g.clamped_keys?.length||0,outOfRangeCount:g.out_of_range_count||0,activeKeysCount:g.active_keys_count||0,aiConfidence:g.ai_confidence,topDeltas:g.refinement_deltas?.top_10_shape_deltas?.slice(0,3)||[],philosophy:"ai_refinement_success"}),t.ai_refinement=g,t.final_shape_params=g.final_shape_params,t.final_limb_masses=g.final_limb_masses}catch(p){c.warn("AI_REFINEMENT","AI refinement failed, using blend fallback",{scanId:r,resolvedGender:l,error:p instanceof Error?p.message:"Unknown error",philosophy:"ai_refinement_fallback"}),t.ai_refinement={ai_refine:!1,error:p instanceof Error?p.message:"Unknown error",fallback_used:!0}}return t}async function Re(t,i,n,a,s,l,r){c.info("SCAN_PROCESSING_SERVICE","Step 4: Starting scan-commit",{clientScanId:r,requestData:{userId:t,hasEstimateResult:!!i,hasMatchResult:!!n,hasSemanticResult:!!a,hasAIRefinement:!!n.ai_refinement}}),c.info("SCAN_PROCESSING_SERVICE","Step 4: Analyzing matchResult structure",{clientScanId:r,matchResultKeys:n?Object.keys(n):[],hasK5Envelope:!!n?.k5_envelope,hasMorphBounds:!!n?.morph_bounds,hasSelectedArchetypes:!!n?.selected_archetypes,selectedArchetypesCount:n?.selected_archetypes?.length||0,hasAIRefinement:!!n?.ai_refinement,philosophy:"debug_match_result_structure"});const m=n.ai_refinement?.final_shape_params||n.final_shape_params||n.selected_archetypes?.[0]?.morph_values||{},f=n.ai_refinement?.final_limb_masses||n.final_limb_masses||n.selected_archetypes?.[0]?.limb_masses||{};c.info("SCAN_PROCESSING_SERVICE","Step 4: 🔍 About to import V2 skin tone extractor",{clientScanId:r,philosophy:"pre_skin_tone_extraction_import"});let o;try{console.log("🔍 [SKIN TONE DEBUG] Starting extraction, photos count:",s?.length||0);const{extractSkinToneFromScanData:p}=await Se(async()=>{const{extractSkinToneFromScanData:x}=await Promise.resolve().then(()=>ze);return{extractSkinToneFromScanData:x}},void 0);c.info("SCAN_PROCESSING_SERVICE","Step 4: ✅ V2 extractor imported successfully",{clientScanId:r,philosophy:"extractor_import_success"});const v=s.map(x=>({view:x.type,url:x.url,report:x.captureReport}));o=p(v,i,r),c.info("SCAN_PROCESSING_SERVICE","Step 4: ✅ Skin tone extracted successfully",{clientScanId:r,hasSkinTone:!!o,skinToneType:typeof o,skinToneKeys:o&&typeof o=="object"?Object.keys(o):[],skinToneSchema:o?.schema,skinToneRGB:o?.rgb?`rgb(${o.rgb.r}, ${o.rgb.g}, ${o.rgb.b})`:"unknown",skinToneHex:o?.hex||"unknown",philosophy:"skin_tone_extraction_success"})}catch(p){throw c.error("SCAN_PROCESSING_SERVICE","Step 4: ❌ Skin tone extraction FAILED",{clientScanId:r,error:p instanceof Error?p.message:String(p),stack:p instanceof Error?p.stack:void 0,errorType:p?.constructor?.name,errorName:p instanceof Error?p.name:"unknown",capturedPhotosCount:s?.length||0,hasEstimateResult:!!i,philosophy:"skin_tone_extraction_fatal_error"}),console.error("🚨 [SKIN TONE EXTRACTION ERROR] Full error details:",p),p}const h=n.k5_envelope||null;c.info("SCAN_PROCESSING_SERVICE","Step 4: Building commit request",{clientScanId:r,hasFinalShapeParams:!!m,finalShapeParamsCount:Object.keys(m).length,finalShapeParamsKeys:Object.keys(m).slice(0,5),hasFinalLimbMasses:!!f,finalLimbMassesCount:Object.keys(f).length,finalLimbMassesKeys:Object.keys(f),hasSkinTone:!!o,hasK5Envelope:!!h,hasAIRefinement:!!n.ai_refinement,aiRefined:!!n.ai_refinement?.ai_refine,philosophy:"pre_commit_request_construction_v2"});const u={user_id:t,resolvedGender:l,estimate_result:i,match_result:n,morph_bounds:h,semantic_result:a,ai_refinement_result:n.ai_refinement,validation_metadata:{},temporal_analysis:{},smoothing_metadata:{},visionfit_result:{},photos_metadata:s.map(p=>({type:p.type,captureReport:p.captureReport})),final_shape_params:m,final_limb_masses:f,skin_tone:o,resolved_gender:l,mapping_version:"v1.0",gltf_model_id:`${l}_v4.13`,material_config_version:"pbr-v2",avatar_version:"v2.0",clientScanId:r};c.info("SCAN_PROCESSING_SERVICE","Step 4: Complete commit request prepared",{clientScanId:r,requestKeys:Object.keys(u),finalDataSummary:{finalShapeParamsCount:Object.keys(m).length,finalLimbMassesCount:Object.keys(f).length,skinTonePresent:!!o,aiRefinementPresent:!!n.ai_refinement,aiRefine:n.ai_refinement?.ai_refine||!1,k5EnvelopePresent:!!h},philosophy:"commit_request_structure_audit_v2"}),c.info("SCAN_PROCESSING_SERVICE","Step 4: 🎨 SKIN TONE BEFORE COMMIT",{clientScanId:r,skinToneComplete:o,skinToneKeys:o&&typeof o=="object"?Object.keys(o):[],skinToneSchema:o?.schema,skinToneRGB:o?.rgb,skinToneHex:o?.hex,skinToneSource:o?.source,skinToneConfidence:o?.confidence,philosophy:"CRITICAL_SKIN_TONE_AUDIT_BEFORE_COMMIT"});try{c.info("SCAN_PROCESSING_SERVICE","Step 4: Complete avatar data prepared for commit",{clientScanId:r,finalShapeParamsCount:Object.keys(m).length,finalLimbMassesCount:Object.keys(f).length,hasSkinTone:!!o,skinToneType:typeof o,skinToneKeys:o&&typeof o=="object"?Object.keys(o):[],skinToneV2:o&&o.rgb?{rgb:`rgb(${o.rgb.r}, ${o.rgb.g}, ${o.rgb.b})`,hex:o.hex,schema:o.schema,source:o.source,confidence:o.confidence}:"invalid_or_missing",skinToneRaw:JSON.stringify(o),resolvedGender:l,philosophy:"complete_avatar_data_v2_for_server_persistence"})}catch(p){c.error("SCAN_PROCESSING_SERVICE","Failed to log skin tone structure",{clientScanId:r,error:p instanceof Error?p.message:String(p),skinToneType:typeof o,skinToneStringified:String(o)})}c.info("SCAN_PROCESSING_SERVICE","🚨 CRITICAL: About to call bodyScanRepo.commit",{clientScanId:r,requestKeys:Object.keys(u),requestSummary:{user_id:u.user_id?.substring(0,8)+"...",resolved_gender:u.resolvedGender,has_final_shape_params:!!u.final_shape_params,final_shape_params_count:u.final_shape_params?Object.keys(u.final_shape_params).length:0,has_final_limb_masses:!!u.final_limb_masses,final_limb_masses_count:u.final_limb_masses?Object.keys(u.final_limb_masses).length:0,has_skin_tone:!!u.skin_tone,skin_tone_type:typeof u.skin_tone,skin_tone_preview:u.skin_tone&&typeof u.skin_tone=="object"?{has_rgb:!!u.skin_tone.rgb,has_hex:!!u.skin_tone.hex,has_schema:!!u.skin_tone.schema,schema_value:u.skin_tone.schema}:"not_object"},philosophy:"pre_commit_call_audit"});let g;try{g=await W.commit(u),c.info("SCAN_PROCESSING_SERVICE","✅ bodyScanRepo.commit returned successfully",{clientScanId:r,hasResult:!!g,resultKeys:g?Object.keys(g):[]})}catch(p){throw c.error("SCAN_PROCESSING_SERVICE","❌ bodyScanRepo.commit threw error",{clientScanId:r,error:p instanceof Error?p.message:String(p),stack:p instanceof Error?p.stack:void 0,errorType:p?.constructor?.name||typeof p}),p}return c.info("SCAN_PROCESSING_SERVICE","Step 4: scan-commit completed",{clientScanId:r,serverScanId:g.scan_id,commitSuccess:!!g.success,processingComplete:!!g.processing_complete}),{commitResult:g,skinTone:o}}function Me(t,i,n,a,s,l,r,m,f,o){c.info("BUILD_COMPLETE_RESULTS","Building complete results with pre-extracted skin tone",{clientScanId:m,hasPreExtractedSkinTone:!!o,skinToneSchema:o?.schema,philosophy:"use_pre_extracted_skin_tone_v2"});const h=o||Ve(s,t,m),u=!!o;return c.info("BUILD_COMPLETE_RESULTS","🎨 CRITICAL: Final skin tone decision for complete results",{clientScanId:m,usedPreExtracted:u,finalSkinToneSchema:h?.schema,finalSkinToneRGB:h?.rgb?`rgb(${h.rgb.r}, ${h.rgb.g}, ${h.rgb.b})`:h?.r?`rgb(${h.r}, ${h.g}, ${h.b})`:"unknown",finalSkinToneHex:h?.hex||"unknown",finalSkinToneSource:h?.source,finalSkinToneConfidence:h?.confidence,philosophy:u?"using_pre_extracted_v2_no_fallback":"emergency_extraction_called"}),{resolvedGender:r,estimate:t,semantic:i,match:n,commit:a,userId:f,serverScanId:a.scan_id,userProfile:{...l,sex:r},insights:Oe(t,i,n),clientScanId:m,skin_tone:h,limb_masses:De(n,t,m)}}function Oe(t,i,n){const a=[],s=t?.extracted_data?.processing_confidence||0;if(s>.8&&a.push({id:"high-confidence",type:"achievement",title:"Analyse de Haute Qualité",description:`Votre scan a été analysé avec ${Math.round(s*100)}% de confiance.`,category:"morphology",priority:"high",confidence:s,source:"ai_analysis",color:"#22C55E"}),n?.selected_archetypes?.length>0){const l=n.selected_archetypes[0];a.push({id:"archetype-match",type:"observation",title:"Profil Morphologique",description:`Votre morphologie correspond au profil "${l.name}".`,category:"morphology",priority:"medium",confidence:.8,source:"archetype",color:"#8B5CF6"})}if(i?.semantic_profile){const l=i.semantic_profile;a.push({id:"semantic-classification",type:"observation",title:"Classification Morphologique",description:`Profil: ${l.obesity} • ${l.muscularity} • ${l.morphotype}`,category:"morphology",priority:"medium",confidence:i.semantic_confidence||.6,source:"semantic",color:"#06B6D4"})}return{items:a,source:"generated",confidence:s||.8}}function Ve(t,i,n){c.warn("SKIN_TONE_EXTRACTION_DEPRECATED","Using deprecated skin tone extraction - should use V2 from dataExtractors",{clientScanId:n,uploadedPhotosCount:t?.length||0,hasEstimateResult:!!i,philosophy:"emergency_fallback_only"});const a=i?.extracted_data?.skin_tone;if(a?.schema==="v2"&&a?.rgb)return c.info("SKIN_TONE_EXTRACTION_DEPRECATED","Found V2 skin tone from Vision AI",{clientScanId:n,skinTone:`rgb(${a.rgb.r}, ${a.rgb.g}, ${a.rgb.b})`,confidence:a.confidence||"unknown",source:"estimate_extracted_data_v2"}),{r:a.rgb.r,g:a.rgb.g,b:a.rgb.b,confidence:a.confidence};if(a&&typeof a=="object"&&typeof a.r=="number"&&typeof a.g=="number"&&typeof a.b=="number")return c.info("SKIN_TONE_EXTRACTION_DEPRECATED","Found legacy skin tone from Vision AI",{clientScanId:n,skinTone:`rgb(${a.r}, ${a.g}, ${a.b})`,confidence:a.confidence||"unknown",source:"estimate_extracted_data_legacy"}),a;const s={r:153,g:108,b:78,confidence:.5};return c.error("SKIN_TONE_EXTRACTION_DEPRECATED","Using emergency fallback - this should not happen",{clientScanId:n,fallbackSkinTone:`rgb(${s.r}, ${s.g}, ${s.b})`,reason:"no_valid_skin_tone_found_in_scan_data",source:"emergency_fallback"}),s}function De(t,i,n){c.info("LIMB_MASSES_EXTRACTION","Starting limb masses extraction from scan data",{clientScanId:n,hasMatchResult:!!t,hasEstimateResult:!!i,matchResultKeys:t?Object.keys(t):[]});const a=t?.blended_limb_masses||t?.advanced_matching?.blending?.blended_limb_masses;if(a&&typeof a=="object"&&Object.keys(a).length>0)return c.info("LIMB_MASSES_EXTRACTION","Found limb masses from match result blending",{clientScanId:n,limbMassesKeys:Object.keys(a),sampleValues:Object.entries(a).slice(0,3).map(([l,r])=>({key:l,value:r})),source:"match_result_blended"}),a;const s=t?.selected_archetypes;if(s&&Array.isArray(s)&&s.length>0){const l=s[0],r=l?.limb_masses;if(r&&typeof r=="object"&&Object.keys(r).length>0)return c.info("LIMB_MASSES_EXTRACTION","Found limb masses from primary archetype",{clientScanId:n,archetypeId:l.id,archetypeName:l.name,limbMassesKeys:Object.keys(r),sampleValues:Object.entries(r).slice(0,3).map(([m,f])=>({key:m,value:f})),source:"primary_archetype"}),r}return $e(i,n)}function $e(t,i){const n=t?.extracted_data?.estimated_bmi||22,a=t?.extracted_data?.estimated_body_fat_perc||15,s=Math.max(.7,Math.min(1.4,n/22)),l=Math.max(.8,Math.min(1.3,a/15)),r={gate:1,armMass:1+(s-1)*.3+(l-1)*.2,calfMass:1+(s-1)*.25+(l-1)*.15,neckMass:1+(s-1)*.2+(l-1)*.1,thighMass:1+(s-1)*.4+(l-1)*.3,torsoMass:1+(s-1)*.5+(l-1)*.4,forearmMass:1+(s-1)*.25+(l-1)*.15};return Object.keys(r).forEach(m=>{m!=="gate"&&(r[m]=Math.max(.6,Math.min(1.6,r[m])))}),c.info("LIMB_MASSES_EXTRACTION","Generated intelligent limb masses fallback",{clientScanId:i,estimatedBMI:n.toFixed(2),bodyFatPerc:a.toFixed(1),bmiFactor:s.toFixed(3),fatFactor:l.toFixed(3),generatedMasses:Object.entries(r).map(([m,f])=>({key:m,value:f.toFixed(3)}))}),r}function Be(t,i,n){c.info("DATA_EXTRACTORS","Extracting skin tone from Vision AI analysis",{clientScanId:n,hasEstimateResult:!!i,hasExtractedData:!!i?.extracted_data,philosophy:"vision_ai_exclusive_extraction"});const a=i?.extracted_data?.skin_tone;if(a&&typeof a=="object"){if(a.schema==="v2"&&a.rgb)return c.info("DATA_EXTRACTORS","Found V2 skin tone from Vision AI",{clientScanId:n,skinTone:`rgb(${a.rgb.r}, ${a.rgb.g}, ${a.rgb.b})`,hex:a.hex,confidence:a.confidence,source:a.source||"vision_ai"}),a;if(typeof a.r=="number"&&typeof a.g=="number"&&typeof a.b=="number")return c.info("DATA_EXTRACTORS","Converting legacy Vision AI skin tone to V2",{clientScanId:n,skinTone:`rgb(${a.r}, ${a.g}, ${a.b})`,confidence:a.confidence||.85}),ne(a.r,a.g,a.b,"vision_ai_analysis",a.confidence||.85,a.pixelCount)}return c.error("DATA_EXTRACTORS","Vision AI failed to provide skin tone - this should not happen",{clientScanId:n,hasEstimateResult:!!i,hasExtractedData:!!i?.extracted_data,extractedSkinToneType:typeof a,philosophy:"vision_ai_extraction_failure"}),ne(153,108,78,"emergency_fallback",.3)}function me(t,i){if(c.info("DATA_EXTRACTORS","Starting user profile extraction from sources",{hasProfile:!!t,profileKeys:t?Object.keys(t):[],source:"user_profile_extraction"}),!t?.sex||!t?.height_cm||!t?.weight_kg){c.warn("DATA_EXTRACTORS","Profile incomplete - missing required fields",{hasSex:!!t?.sex,hasHeight:!!t?.height_cm,hasWeight:!!t?.weight_kg,source:"user_profile_extraction"});return}const n={sex:t.sex,height_cm:t.height_cm,weight_kg:t.weight_kg};return c.info("DATA_EXTRACTORS","User profile extracted from sources",{extractedProfile:n,source:"user_profile_extraction"}),n}function pe(t,i,n,a){if(c.info("DATA_EXTRACTORS","Starting gender resolution from sources",{hasProfile:!!t,profileSex:t?.sex,source:"gender_resolution"}),t?.sex){const l=t.sex==="male"?"masculine":"feminine";return c.info("DATA_EXTRACTORS","Gender resolved from user profile",{profileSex:t.sex,resolvedGender:l,source:"user_profile_sex"}),l}const s="masculine";return c.warn("DATA_EXTRACTORS","Using fallback gender",{fallbackGender:s,reason:"no_valid_sex_found_in_profile",source:"fallback"}),s}const ze=Object.freeze(Object.defineProperty({__proto__:null,extractSkinToneFromScanData:Be,extractUserProfileFromSources:me,resolveGenderFromSources:pe},Symbol.toStringTag,{value:"Module"}));function Le(t={}){const{profile:i,sessionInfo:n}=_e(),a=le(),{showToast:s}=ce(),{success:l}=Z(),[r,m]=y.useState("front-photo"),[f,o]=y.useState([]),[h,u]=y.useState(null),[g,p]=y.useState(!1),[v,x]=y.useState(null),[N,O]=y.useState(!1),d=y.useRef(!1),b=y.useMemo(()=>n?.userId||i?.userId||null,[n?.userId,i?.userId]),_=y.useMemo(()=>{const E=me(i);return c.info("BODY_SCAN_CAPTURE_FLOW","Extracting scan parameters from profile",{hasProfile:!!i,profileKeys:i?Object.keys(i):[],profileIdentityFields:i?{displayName:i.displayName,sex:i.sex,height_cm:i.height_cm,weight_kg:i.weight_kg,target_weight_kg:i.target_weight_kg,activity_level:i.activity_level,objective:i.objective,birthdate:i.birthdate}:null,extractedParams:E,extractedKeys:E?Object.keys(E):[],philosophy:"scan_params_extraction"}),E},[i?.sex,i?.height_cm,i?.weight_kg]),A=y.useMemo(()=>!!_,[_]);return{currentStep:r,capturedPhotos:f,scanResults:h,showValidationResults:g,validationSummary:v,userId:b,isProfileComplete:A,stableScanParams:_,processingGuardRef:d,isProcessing:N,setCapturedPhotos:o,setCurrentStep:m,setScanResults:u,setShowValidationResults:p,setValidationSummary:x,handleStartCapture:()=>{m("front-photo"),o([]),u(null),p(!1),x(null)},onProceedToProcessing:async()=>{const E=pe(_,null,!1,t.scanId);if(d.current){c.warn("BODY_SCAN_CAPTURE_FLOW","Processing already in progress, ignoring duplicate request",{clientScanId:t.scanId});return}if(f.length!==2){s({type:"error",title:"Photos manquantes",message:"Veuillez capturer les deux photos avant de continuer",duration:4e3});return}if(!_||!b){s({type:"error",title:"Paramètres manquants",message:"Profil utilisateur incomplet",duration:4e3});return}if(!t.scanId){c.error("BODY_SCAN_CAPTURE_FLOW","No scanId provided to processing flow"),s({type:"error",title:"Erreur système",message:"Identifiant de scan manquant",duration:4e3});return}d.current=!0,O(!0),m("processing");const V=t.scanId;try{je.processingStarted({photos_count:f.length,scan_id:V});const{completeResults:C}=await Ee({userId:b,clientScanId:V,capturedPhotos:f,stableScanParams:_,resolvedGender:E});u(C),m("results"),c.info("BODY_SCAN_CAPTURE_FLOW","Processing complete, preparing for celebration",{clientScanId:V,serverScanId:C.serverScanId,hasResults:!!C,hasEstimate:!!C.estimate,hasSemantic:!!C.semantic,hasMatch:!!C.match,hasCommit:!!C.commit,aiRefined:!!C.match?.ai_refinement?.ai_refine,processingComplete:!0,philosophy:"verify_complete_before_celebration"}),l(),setTimeout(()=>{c.info("BODY_SCAN_CAPTURE_FLOW","Navigating to celebration with verified complete scan data",{clientScanId:V,serverScanId:C.serverScanId,resultsKeys:C?Object.keys(C):[],navigationDelay:"1000ms",timestamp:new Date().toISOString(),philosophy:"safe_navigation_after_complete_processing"}),a("/body-scan/celebration",{state:{scanResults:C,processingComplete:!0},replace:!1})},1e3)}catch(C){const U=C instanceof Error?C.message:"Erreur inconnue";c.error("BODY_SCAN_CAPTURE_FLOW","Processing pipeline failed",{clientScanId:V,error:U,stack:C instanceof Error?C.stack:void 0,step:"pipeline_processing",timestamp:new Date().toISOString()}),s({type:"error",title:"Erreur de traitement",message:U,duration:4e3}),m("profile-photo")}finally{d.current=!1,O(!1)}}}}const Ue={male:{front:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/homme-face.png",profile:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/homme-profil.png"},female:{front:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/femme-face.png",profile:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/femme-profil.png"}};function Ge(t,i){return Ue[t==="female"?"female":"male"][i]}const Ke=({type:t,isFaceScan:i=!1,gender:n})=>{const a=L(),s=Ge(n,t);return e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx("div",{className:"relative",style:{width:"180px",height:"260px"},children:e.jsxs("div",{className:"w-full h-full border-2 rounded-3xl flex items-center justify-center relative overflow-hidden",style:{borderColor:t==="front"?"color-mix(in srgb, var(--color-plasma-cyan) 50%, transparent)":"color-mix(in srgb, #A855F7 50%, transparent)",background:t==="front"?`
                radial-gradient(circle at center, color-mix(in srgb, var(--color-plasma-cyan) 12%, transparent) 0%, transparent 70%),
                rgba(255, 255, 255, 0.05)
              `:`
                radial-gradient(circle at center, color-mix(in srgb, #A855F7 12%, transparent) 0%, transparent 70%),
                rgba(255, 255, 255, 0.05)
              `,backdropFilter:"blur(8px) saturate(120%)",boxShadow:t==="front"?`
                0 0 30px color-mix(in srgb, var(--color-plasma-cyan) 20%, transparent),
                0 8px 32px rgba(0, 0, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `:`
                0 0 30px color-mix(in srgb, #A855F7 20%, transparent),
                0 8px 32px rgba(0, 0, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `},children:[e.jsxs(S,{className:"absolute inset-2 rounded-2xl overflow-hidden",initial:a.enableInitialAnimations?{opacity:0,scale:.95}:!1,animate:a.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:a.enableFramerMotion?{duration:.8,ease:[.25,.1,.25,1]}:void 0,children:[e.jsx("img",{src:s,alt:`Guide ${t} - ${n==="female"?"Femme":"Homme"}`,className:"w-full h-full object-cover",style:{filter:t==="front"?`
                    brightness(0.7) 
                    contrast(1.1) 
                    saturate(0.8)
                    drop-shadow(0 0 8px color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent))
                  `:`
                    brightness(0.7) 
                    contrast(1.1) 
                    saturate(0.8)
                    drop-shadow(0 0 8px color-mix(in srgb, #A855F7 30%, transparent))
                  `,opacity:.85}}),e.jsx("div",{className:"absolute inset-0",style:{background:t==="front"?`
                    linear-gradient(135deg, 
                      color-mix(in srgb, var(--color-plasma-cyan) 15%, transparent) 0%, 
                      transparent 30%, 
                      color-mix(in srgb, var(--color-plasma-cyan) 8%, transparent) 70%, 
                      transparent 100%
                    )
                  `:`
                    linear-gradient(135deg, 
                      color-mix(in srgb, #A855F7 15%, transparent) 0%, 
                      transparent 30%, 
                      color-mix(in srgb, #A855F7 8%, transparent) 70%, 
                      transparent 100%
                    )
                  `,backdropFilter:"blur(1px)",mixBlendMode:"overlay"}})]}),e.jsx("div",{className:"absolute top-6 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded-lg text-xs font-medium",style:{background:`
                radial-gradient(circle at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%)
              `,backdropFilter:"blur(8px) saturate(120%)",border:t==="front"?"1px solid color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent)":"1px solid color-mix(in srgb, #A855F7 30%, transparent)",color:t==="front"?"var(--color-plasma-cyan)":"#A855F7",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.4)",zIndex:20},children:t==="front"?"Face":"Profil"}),e.jsx("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2 px-3 py-1.5 rounded-lg text-sm font-bold",style:{background:t==="front"?`
                  radial-gradient(circle at center, color-mix(in srgb, var(--color-plasma-cyan) 25%, transparent) 0%, color-mix(in srgb, var(--color-plasma-cyan) 15%, transparent) 100%)
                `:`
                  radial-gradient(circle at center, color-mix(in srgb, #A855F7 25%, transparent) 0%, color-mix(in srgb, #A855F7 15%, transparent) 100%)
                `,border:t==="front"?"1px solid color-mix(in srgb, var(--color-plasma-cyan) 50%, transparent)":"1px solid color-mix(in srgb, #A855F7 50%, transparent)",color:t==="front"?"var(--color-plasma-cyan)":"#A855F7",backdropFilter:"blur(8px) saturate(130%)",boxShadow:t==="front"?`
                  0 4px 12px rgba(0, 0, 0, 0.3),
                  0 0 12px color-mix(in srgb, var(--color-plasma-cyan) 40%, transparent)
                `:`
                  0 4px 12px rgba(0, 0, 0, 0.3),
                  0 0 12px color-mix(in srgb, #A855F7 40%, transparent)
                `,zIndex:20},children:t==="front"?"180°":"90°"})," ",a.enableBreathingAnimations&&e.jsx("div",{className:"absolute inset-0 border-2 border-white/20 rounded-3xl pointer-events-none",style:{animation:"guide-breathing-animation 4s ease-in-out infinite",boxShadow:t==="front"?"inset 0 0 20px color-mix(in srgb, var(--color-plasma-cyan) 10%, transparent)":"inset 0 0 20px color-mix(in srgb, #A855F7 10%, transparent)",zIndex:10}})]})}),e.jsx("div",{className:"flex-1 text-left space-y-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:`text-sm font-medium ${t==="front"?"text-cyan-400":"text-purple-400"}`,children:["Position ",t==="front"?"face":"profil"]}),e.jsx("div",{className:"space-y-1 text-xs text-white/60",children:t==="front"?i?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Regardez l'objectif"}),e.jsx("p",{children:"• Visage au centre du cadre"}),e.jsx("p",{children:"• Expression neutre"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Regardez l'objectif"}),e.jsx("p",{children:"• Bras légèrement décollés"}),e.jsx("p",{children:"• Posture droite"})]}):i?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Tournez-vous de 90°"}),e.jsx("p",{children:"• Regardez droit devant"}),e.jsx("p",{children:"• Visage au centre du cadre"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Tournez-vous à 90°"}),e.jsx("p",{children:"• Même distance que face"}),e.jsx("p",{children:"• Bras visible"})]})})]})})]})},qe=({photo:t,showSuccessAnimation:i,onRetake:n})=>{const a=L(),{click:s}=Z();return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative aspect-[3/4] rounded-xl overflow-hidden",children:[e.jsx(S,{as:"img",src:t.url,alt:`Photo ${t.type}`,className:"w-full h-full object-contain bg-black/20 border border-white/10 photo-processing",initial:a.enableInitialAnimations?{opacity:0,scale:.95}:!1,animate:a.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:a.enableFramerMotion?{duration:.6,ease:"easeOut"}:void 0}),e.jsx(de,{children:i&&e.jsx(S,{className:"absolute inset-0 flex items-center justify-center backdrop-blur-md rounded-xl success-ripple",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.4))",border:"1px solid rgba(34, 197, 94, 0.5)"},initial:a.enableInitialAnimations?{opacity:0,scale:.8}:!1,animate:a.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},exit:a.enableInitialAnimations?{opacity:0,scale:1.1}:void 0,transition:a.enableFramerMotion?{duration:.6,ease:"easeOut"}:void 0,children:e.jsx(S,{className:"w-24 h-24 rounded-full flex items-center justify-center backdrop-blur-sm",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.5))",border:"2px solid rgba(34, 197, 94, 0.6)",boxShadow:"0 0 40px rgba(34, 197, 94, 0.6), inset 0 2px 0 rgba(255,255,255,0.3)"},initial:a.enableInitialAnimations?{scale:0,rotate:-180}:!1,animate:a.enableInitialAnimations?{scale:1,rotate:0}:{scale:1},transition:a.enableFramerMotion?{type:"spring",stiffness:300,damping:20,delay:.2}:void 0,children:e.jsx(P,{Icon:k.Check,size:36,className:"text-green-400"})})})})]}),e.jsx(S,{as:"button",onClick:()=>{s(),n()},className:"w-full btn-glass",whileHover:a.enableWhileHover?{scale:1.02}:void 0,whileTap:a.enableWhileTap?{scale:.98}:void 0,style:{borderRadius:"999px",padding:".5rem 1.5rem",minHeight:"44px",overflow:"hidden"},initial:a.enableInitialAnimations?{opacity:0,y:10}:!1,animate:a.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:a.enableFramerMotion?{duration:.4,delay:.2}:void 0,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(P,{Icon:k.RotateCcw,size:14}),e.jsx("span",{children:"Reprendre"})]})})]})},He=({photo:t,photoType:i,isValidating:n})=>{const s=i==="front"?"var(--color-nutrition-primary)":"#A855F7";return e.jsx("div",{className:"flex flex-col items-end gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium",style:{background:t?`color-mix(in srgb, ${s} 15%, transparent)`:"color-mix(in srgb, #60A5FA 15%, transparent)",border:t?`1px solid color-mix(in srgb, ${s} 30%, transparent)`:"1px solid color-mix(in srgb, #60A5FA 30%, transparent)",color:t?s:"#60A5FA",backdropFilter:"blur(8px) saturate(120%)"},children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-current opacity-60 flex items-center justify-center"}),e.jsx("span",{children:t?t.validationResult?.isValid?"Capturée & Validée":"Capturée":"En attente"})]})})},We=({photoType:t,isValidating:i,onCameraCapture:n,onGallerySelect:a,isProgressInitialized:s,fileInputRef:l,onFileSelect:r})=>{const m=L(),f=t==="front"?"var(--color-plasma-cyan)":"#A855F7";c.debug("PHOTO_CONTROLS","state",{photoType:t,isValidating:i,isProgressInitialized:s});const o=i||!s,h=()=>{l?.current?l.current.click():a()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx(S,{as:"button",type:"button",onClick:n,disabled:o,"aria-busy":i,className:"px-6 py-3 rounded-full font-semibold text-white transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60",whileHover:m.enableWhileHover&&!o?{scale:1.02,y:-2}:void 0,whileTap:m.enableWhileTap&&!o?{scale:.98}:void 0,initial:m.enableInitialAnimations?{opacity:0,y:12}:!1,animate:m.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:m.enableFramerMotion?{duration:.25}:void 0,style:{background:`
              linear-gradient(135deg,
                color-mix(in srgb, ${f} 80%, transparent),
                color-mix(in srgb, ${f} 60%, transparent)
              )
            `,border:`2px solid color-mix(in srgb, ${f} 60%, transparent)`,boxShadow:`
              0 8px 32px color-mix(in srgb, ${f} 40%, transparent),
              0 0 40px color-mix(in srgb, ${f} 25%, transparent),
              inset 0 2px 0 rgba(255, 255, 255, 0.30)
            `,backdropFilter:"blur(16px) saturate(150%)",opacity:o?.6:1,cursor:o?"not-allowed":"pointer"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{animate:m.enableLoadingAnimations&&i?{rotate:360}:void 0,transition:m.enableFramerMotion?{duration:2,repeat:1/0,ease:"linear"}:void 0,children:e.jsx(P,{Icon:i?k.Loader2??k.Camera:k.Camera,size:16,color:"white",glowColor:f,variant:"pure"})}),e.jsx("span",{children:i?"Validation…":"Caméra"})]})}),e.jsx(S,{as:"button",type:"button",onClick:h,disabled:o,className:"px-6 py-3 rounded-full font-medium text-white/90 transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40",whileHover:m.enableWhileHover&&!o?{scale:1.02,y:-1}:void 0,whileTap:m.enableWhileTap&&!o?{scale:.98}:void 0,initial:m.enableInitialAnimations?{opacity:0,y:12}:!1,animate:m.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:m.enableFramerMotion?{duration:.25,delay:.05}:void 0,style:{background:`color-mix(in srgb, ${f} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${f} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)",opacity:o?.6:1,cursor:o?"not-allowed":"pointer"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{Icon:k.Image,size:16,color:"white",glowColor:f,variant:"pure"}),e.jsx("span",{children:"Galerie"})]})})]}),l&&r&&e.jsx("input",{ref:l,type:"file",accept:"image/*",onChange:r,className:"hidden",capture:"environment"})]})},ie=({photoType:t,step:i,capturedPhotos:n,userGender:a,isFaceScan:s=!1,isValidating:l,showSuccessAnimation:r,isProgressInitialized:m,onRetake:f,onCameraClick:o,onGalleryClick:h,fileInputRef:u,onFileSelect:g})=>{const p=L(),v=n.find(b=>b.type===t),x=t==="front"&&i==="front-photo"||t==="profile"&&i==="profile-photo",N=s||t==="front"?"var(--color-plasma-cyan)":"#A855F7",O=t==="front"?k.User:k.RotateCcw,d=t==="front"?"Photo de face":"Photo de profil";return e.jsx(S,{"data-photo-type":t,initial:p.enableInitialAnimations?{opacity:0,x:t==="front"?-20:20}:!1,animate:p.enableInitialAnimations?{opacity:1,x:0}:{opacity:1},transition:p.enableFramerMotion?{duration:.6,delay:t==="front"?0:.1,ease:[.25,.1,.25,1]}:void 0,className:"w-full max-w-2xl",children:e.jsxs(z,{className:`p-6 h-full relative photo-card photo-card--${t}`,style:{background:`radial-gradient(circle at 30% 20%, color-mix(in srgb, ${N} 8%, transparent) 0%, transparent 60%), var(--glass-opacity-base)`,borderColor:`color-mix(in srgb, ${N} 25%, transparent)`,borderRadius:"24px",overflow:"hidden"},children:[e.jsxs("div",{className:"flex items-start justify-between mb-6 min-h-[3rem]",children:[e.jsxs("h4",{className:"text-white text-lg font-semibold flex items-center gap-3",children:[e.jsx("div",{className:"glowing-icon-container",style:{"--icon-color":N},children:e.jsx(P,{Icon:O,size:16,style:{color:N,filter:`drop-shadow(0 0 8px ${N}80) drop-shadow(0 0 16px ${N}60)`},variant:"pure"})}),e.jsx("span",{className:"glowing-title-text",children:d})]}),e.jsx(He,{photo:v,photoType:t,isValidating:l})]}),v?e.jsx(qe,{photo:v,showSuccessAnimation:r===t,onRetake:()=>f(t)}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ke,{type:t,isFaceScan:s,gender:a}),x&&e.jsx(We,{photoType:t,isValidating:l,isProgressInitialized:m,onCameraClick:o,onGalleryClick:h,fileInputRef:u,onFileSelect:g}),!x&&!v&&e.jsx("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(P,{Icon:k.Clock,size:24,className:"text-white/60"}),e.jsx("p",{className:"text-sm text-white/60",children:t==="profile"?"Complétez d'abord la photo de face":"En attente"})]})})]})]})})};function re(t){const i=[];if(!t.type.startsWith("image/"))return i.push("File is not an image"),{isValid:!1,issues:i};const n=15*1024*1024;return t.size>n?(i.push("File is too large (max 15MB)"),{isValid:!1,issues:i}):t.size<1024?(i.push("File is too small (min 1KB)"),{isValid:!1,issues:i}):(!t.type.includes("jpeg")&&!t.type.includes("jpg")&&i.push("JPEG format is recommended for better compatibility"),{isValid:i.length===0||!i.some(a=>a.includes("not an image")||a.includes("too large")||a.includes("too small")),issues:i})}async function Xe(t){return new Promise(i=>{const n=[],a=new Image,s=document.createElement("canvas"),l=s.getContext("2d");a.onload=()=>{try{(a.width<200||a.height<200)&&n.push("Image resolution is too low (minimum 200x200)"),(a.width>4e3||a.height>4e3)&&n.push("Image resolution is very high and will be optimized");const r=a.width/a.height;(r<.3||r>3)&&n.push("Unusual aspect ratio detected"),l&&(s.width=Math.min(a.width,100),s.height=Math.min(a.height,100),l.drawImage(a,0,0,s.width,s.height),l.getImageData(0,0,s.width,s.height).data.some(o=>o>0)||n.push("Image appears to be corrupted or blank")),i({isValid:!n.some(m=>m.includes("corrupted")||m.includes("too low")),issues:n})}catch{n.push("Failed to analyze image quality"),i({isValid:!1,issues:n})}},a.onerror=()=>{n.push("Image file is corrupted or invalid"),i({isValid:!1,issues:n})},a.src=URL.createObjectURL(t)})}async function Ye(t,i=2048,n=.8,a="image/jpeg"){const s=Math.round(t.size/1024);return s<=i?(c.debug("PHOTO_UTILS","No compression needed",{fileName:t.name,originalSizeKB:s,maxSizeKB:i}),{compressedFile:t,compressionApplied:!1,originalSizeKB:s,finalSizeKB:s}):new Promise((l,r)=>{const m=document.createElement("canvas"),f=m.getContext("2d"),o=new Image;o.onload=()=>{try{let{width:h,height:u}=o;const g=1920;if(h>g||u>g){const p=Math.min(g/h,g/u);h=Math.round(h*p),u=Math.round(u*p)}m.width=h,m.height=u,f?(f.drawImage(o,0,0,h,u),m.toBlob(p=>{if(p){const v=new File([p],t.name,{type:a,lastModified:Date.now()}),x=Math.round(p.size/1024);c.debug("PHOTO_UTILS","Image compressed",{fileName:t.name,originalSizeKB:s,finalSizeKB:x,compressionApplied:!0,outputMimeType:a}),l({compressedFile:v,compressionApplied:!0,originalSizeKB:s,finalSizeKB:x})}else r(new Error("Failed to create blob after compression"))},a,n)):r(new Error("Failed to get canvas context for compression"))}catch(h){r(h)}},o.onerror=()=>r(new Error("Failed to load image for compression")),o.src=URL.createObjectURL(t)})}async function Qe(t){c.info("🔍 [PhotoProcessing] Starting photo processing",{fileName:t.name,fileSize:Math.round(t.size/1024),fileType:t.type});try{const i=t.type.includes("jpeg")||t.type.includes("jpg")?"image/jpeg":t.type.includes("png")?"image/png":"image/jpeg";c.debug("PHOTO_UTILS","Determined output MIME type",{originalType:t.type,outputMimeType:i});const n=await Ye(t,2048,.85,i),a=await oe(n.compressedFile,i),s=new File([a],t.name,{type:i,lastModified:Date.now()}),l=Math.round(s.size/1024),r=Je(n.originalSizeKB,l,n.compressionApplied);return c.info("✅ [PhotoProcessing] Photo processing completed",{originalSizeKB:n.originalSizeKB,finalSizeKB:l,compressionApplied:n.compressionApplied,qualityScore:r,finalMimeType:i}),{processedFile:s,validationReport:{originalSizeKB:n.originalSizeKB,finalSizeKB:l,compressionApplied:n.compressionApplied,qualityScore:r}}}catch(i){c.error("❌ [PhotoProcessing] Photo processing failed",{error:i instanceof Error?i.message:String(i)});try{const n=t.type.startsWith("image/")?t.type:"image/jpeg",a=await oe(t,n),s=new File([a],t.name,{type:n,lastModified:Date.now()}),l=Math.round(t.size/1024),r=Math.round(s.size/1024);return c.warn("PHOTO_UTILS","Photo processing fallback executed",{fileName:t.name,originalSizeKB:l,finalSizeKB:r,fallbackMimeType:n}),{processedFile:s,validationReport:{originalSizeKB:l,finalSizeKB:r,compressionApplied:!1,qualityScore:.7}}}catch{throw new Error(`Photo processing failed: ${i instanceof Error?i.message:String(i)}`)}}}function Je(t,i,n){let a=1;if(n){const s=i/t;s<.3?a-=.3:s<.5?a-=.2:a-=.1}return i<100?a-=.2:i>3e3&&(a-=.1),Math.max(.1,Math.min(1,a))}async function oe(t,i="image/jpeg"){return new Promise((n,a)=>{const s=document.createElement("canvas"),l=s.getContext("2d"),r=new Image;r.onload=()=>{s.width=r.width,s.height=r.height,l?(l.drawImage(r,0,0),s.toBlob(m=>{m?(c.debug("PHOTO_UTILS","EXIF stripped",{fileName:t.name,outputMimeType:i}),n(m)):a(new Error("Failed to create blob from canvas after EXIF stripping"))},i,.95)):a(new Error("Failed to get canvas context for EXIF stripping"))},r.onerror=()=>a(new Error("Failed to load image for EXIF stripping")),r.src=URL.createObjectURL(t)})}async function Ze(t,i,n,a){const s=new Date().toISOString();c.info("📸 [PhotoCapture] Creating capture report",{type:i,fileSize:Math.round(t.size/1024),isValid:n.isValid,confidence:Math.round(n.confidence*100)}),c.info("🎨 [PhotoCapture] Skin tone extraction delegated to Vision AI",{type:i,philosophy:"vision_ai_exclusive_extraction"});const r={timestamp:s,photoType:i,fileInfo:{name:t.name,size:t.size,type:t.type,lastModified:t.lastModified},validation:n,quality:n.qualityMetrics||{blur_score:.5,brightness:.5,contrast:.5,sharpness:.5},content:n.contentMetrics||{person_detected:!1,face_detected:!1,pose_quality:.5},scale:n.scaleMetrics||{person_size_ratio:.5,distance_score:.5},skinTone:void 0,streamInfo:void 0,userId:null};return c.info("📸 [PhotoCapture] Capture report created",{type:i,hasValidation:!!n,hasStreamInfo:!1,philosophy:"vision_ai_exclusive_skin_tone_extraction"}),r}const et=({isCapturing:t,onCapture:i,onClose:n,onSwitchCamera:a})=>{const s=L();return e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 sm:p-12 bg-gradient-to-t from-black/95 via-black/70 to-transparent",children:[e.jsxs("div",{className:"flex items-center justify-between max-w-lg mx-auto",children:[e.jsx(S,{as:"button",onClick:n,className:"w-16 h-16 sm:w-18 sm:h-18 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shadow-lg",whileHover:s.enableWhileHover?{scale:1.05}:void 0,whileTap:s.enableWhileTap?{scale:.95}:void 0,initial:s.enableInitialAnimations?{opacity:0,y:20}:!1,animate:s.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:s.enableFramerMotion?{delay:.2,duration:.5}:void 0,children:e.jsx(P,{Icon:k.X,size:26,className:"text-white"})}),e.jsxs(S,{as:"button",onClick:i,disabled:t,className:"w-24 h-24 sm:w-28 sm:h-28 rounded-full border-4 border-white/30 flex items-center justify-center relative shadow-2xl",style:{background:t?"linear-gradient(135deg, var(--brand-warning), var(--brand-warning-dark))":"linear-gradient(135deg, var(--brand-primary), var(--brand-accent))",boxShadow:t?"0 0 30px color-mix(in srgb, var(--brand-warning) 60%, transparent), 0 8px 32px rgba(0,0,0,0.4)":"0 0 30px color-mix(in srgb, var(--brand-primary) 60%, transparent), 0 8px 32px rgba(0,0,0,0.4)"},whileHover:s.enableWhileHover?{scale:1.05}:void 0,whileTap:s.enableWhileTap?{scale:.92}:void 0,initial:s.enableInitialAnimations?{opacity:0,scale:.8}:!1,animate:s.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:s.enableFramerMotion?{delay:.1,duration:.6,type:"spring",stiffness:300}:void 0,children:[t?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-white",animate:s.enableCSSAnimations?{scale:[1,.7,1]}:{scale:1},transition:s.enableFramerMotion?{duration:.6,repeat:1/0,ease:"easeInOut"}:void 0}),e.jsx(S,{className:"absolute inset-0 rounded-full border-4 border-brand-warning/60",animate:s.enableCSSAnimations?{scale:[1,1.3,1],opacity:[.8,.2,.8]}:{scale:1,opacity:.5},transition:s.enableFramerMotion?{duration:.8,repeat:1/0}:void 0})]}):e.jsx("div",{className:"w-18 h-18 sm:w-20 sm:h-20 rounded-full shadow-inner bg-white"}),!t&&s.enablePulseAnimations&&e.jsx(S,{className:"absolute inset-0 rounded-full border-2 border-brand-accent/40",animate:s.enableCSSAnimations?{scale:[1,1.1,1],opacity:[.5,.8,.5]}:{scale:1,opacity:.5},transition:s.enableFramerMotion?{duration:2,repeat:1/0,ease:"easeInOut"}:void 0})]}),e.jsx(S,{as:"button",onClick:a,className:"w-16 h-16 sm:w-18 sm:h-18 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shadow-lg",whileHover:s.enableWhileHover?{scale:1.05}:void 0,whileTap:s.enableWhileTap?{scale:.95}:void 0,initial:s.enableInitialAnimations?{opacity:0,y:20}:!1,animate:s.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:s.enableFramerMotion?{delay:.3,duration:.5}:void 0,children:e.jsx(P,{Icon:k.RotateCcw,size:26,className:"text-white"})})]}),e.jsx(S,{className:"text-center mt-8",initial:s.enableInitialAnimations?{opacity:0}:!1,animate:s.enableInitialAnimations?{opacity:1}:{opacity:1},transition:s.enableFramerMotion?{delay:.8,duration:.6}:void 0,children:e.jsx("p",{className:"text-white/80 text-lg font-medium",children:t?"Capture en cours...":"Appuyez pour capturer"})})]})},tt=({isAnyPhotoValidating:t,onProceedToProcessing:i,glassClick:n})=>{const a=L(),s=()=>{t||(n(),i())};return e.jsxs(z,{className:"glass-card refined-glass-cta p-8 text-center relative overflow-visible rounded-3xl",children:[e.jsx("div",{className:"refined-inner-glow absolute inset-0 rounded-[inherit] pointer-events-none"}),e.jsx("div",{className:"refined-glass-texture absolute inset-0 rounded-[inherit] pointer-events-none"}),e.jsxs("div",{className:"relative z-10 space-y-8",children:[e.jsxs(S,{className:"flex items-center justify-center gap-4 mb-2",initial:a.enableInitialAnimations?{opacity:0,scale:.9}:!1,animate:a.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:a.enableFramerMotion?{duration:.5,delay:.15,ease:[.25,.1,.25,1]}:void 0,children:[e.jsxs("div",{className:"refined-success-icon-container relative",children:[e.jsx("div",{className:"refined-success-halo absolute inset-0"}),e.jsx("div",{className:"refined-success-icon size-12 rounded-full grid place-items-center relative z-10",children:e.jsx(P,{Icon:k.Check,size:24,className:"text-white"})}),e.jsx("div",{className:"refined-success-ring-1 absolute inset-0 rounded-full"}),e.jsx("div",{className:"refined-success-ring-2 absolute inset-0 rounded-full"})]}),e.jsx(S,{as:"span",className:"refined-success-text text-xl font-bold",initial:a.enableInitialAnimations?{opacity:0,x:-16}:!1,animate:a.enableInitialAnimations?{opacity:1,x:0}:{opacity:1},transition:a.enableFramerMotion?{duration:.45,delay:.3}:void 0,children:"Photos capturées avec succès !"})]}),e.jsx(S,{as:"p",className:"refined-description text-lg leading-relaxed max-w-md mx-auto",initial:a.enableInitialAnimations?{opacity:0,y:10}:!1,animate:a.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:a.enableFramerMotion?{duration:.45,delay:.25}:void 0,children:"Vos photos de face et de profil sont prêtes pour l'analyse IA avancée."}),e.jsxs(S,{as:"button","data-launch-analysis":!0,onClick:s,className:"refined-cta-button w-full relative overflow-hidden rounded-full py-3 glass-focus hover-lift",disabled:t,"aria-busy":t,"aria-live":"polite",whileHover:a.enableWhileHover?{scale:1.02,y:-2}:void 0,whileTap:a.enableWhileTap?{scale:.98}:void 0,initial:a.enableInitialAnimations?{opacity:0,y:16}:!1,animate:a.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:a.enableFramerMotion?{duration:.5,delay:.35,ease:[.25,.1,.25,1]}:void 0,type:"button",children:[e.jsx("span",{className:"refined-cta-glow absolute inset-0 pointer-events-none rounded-[inherit]"}),e.jsxs("span",{className:"refined-cta-content relative z-10 flex items-center justify-center gap-3",children:[e.jsx(S,{as:"span",className:"refined-cta-icon",animate:a.enableLoadingAnimations&&t?{rotate:360}:void 0,transition:a.enableFramerMotion?{duration:2,repeat:1/0,ease:"linear"}:void 0,children:e.jsx(P,{Icon:t?k.Loader2:k.Zap,size:20,className:"text-white"})}),e.jsx("span",{className:"refined-cta-text text-lg font-bold",children:t?"Analyse en cours...":"Lancer l'analyse IA"})]})]})]})]})},at=({step:t,capturedPhotos:i,onPhotoCapture:n,onRetake:a,onBack:s,onProceedToProcessing:l,isProcessingInProgress:r=!1,isFaceScan:m=!1,userGender:f,isProgressInitialized:o})=>{const[h,u]=y.useState(!1),[g,p]=y.useState(!1),[v,x]=y.useState(!1),[N,O]=y.useState(null),d=y.useRef(null),{click:b,success:_,error:A,glassClick:B}=Z(),{showToast:I}=ce();L();const E=t==="front-photo"?"front":"profile",V=i.find(w=>w.type==="front"),C=i.find(w=>w.type==="profile"),U=[{id:"tracking",icon:"TrendingUp",color:"#22C55E",title:"Suivi Précis",description:"Détectez les changements morphologiques subtils"},{id:"avatar-3d",icon:"Eye",color:"#8B5CF6",title:"Avatar 3D Réaliste",description:"Visualisez votre morphologie en 3 dimensions"},{id:"recommendation",icon:"Calendar",color:"#3B82F6",title:"Scan 2x/mois",description:"Recommandation pour un suivi optimal"}],K=y.useCallback(async w=>{p(!0),x(!0),c.info("🔍 [PhotoCapture] Starting photo processing",{photoType:E,fileSize:Math.round(w.size/1024),fileType:w.type,fileName:w.name,timestamp:Date.now()});try{const j=re(w);if(!j.isValid){const $=j.issues.filter(H=>H.includes("not an image")||H.includes("too large")||H.includes("too small"));if($.length>0){I({type:"error",title:"Format de fichier invalide",message:$[0],duration:4e3}),A();return}else I({type:"warning",title:"Format non optimal",message:"Le format JPEG est recommandé pour une meilleure compatibilité",duration:3e3})}const{processedFile:D,validationReport:F}=await Qe(w);if(c.info("🔍 [PhotoCapture] Photo processing completed",{photoType:E,validationReport:F,processingSuccess:!0}),F.compressionApplied){const $=((F.originalSizeKB-F.finalSizeKB)/F.originalSizeKB*100).toFixed(0);I({type:"info",title:"Photo optimisée",message:`Taille réduite de ${$}% pour une meilleure compatibilité`,duration:2e3})}let R;try{R={isValid:!0,issues:[],retakeReasons:[],confidence:.8,qualityMetrics:{blur_score:.7,brightness:.6,exposure_ok:!0,noise_score:.3},contentMetrics:{single_person:!0,pose_ok:!0,face_detected:!0,face_bbox_norm:[.3,.1,.7,.4]},scaleMetrics:{pixel_per_cm_estimate:3.5,method:"face-heuristic"}}}catch($){c.warn("Worker validation failed, using permissive fallback:",$),R={isValid:!0,issues:["Validation simplifiée - Photo acceptée"],retakeReasons:[],confidence:.8,qualityMetrics:{blur_score:.7,brightness:.6,exposure_ok:!0,noise_score:.3},contentMetrics:{single_person:!0,pose_ok:!0,face_detected:!0,face_bbox_norm:[.3,.1,.7,.4]},scaleMetrics:{pixel_per_cm_estimate:3.5,method:"face-heuristic"}}}const G=await Ze(D,E,R,void 0),ee=["multiple_people","no_person"];if(R.retakeReasons?.some($=>ee.includes($))){const H=R.retakeReasons.find(he=>ee.includes(he))==="multiple_people"?"Une seule personne doit être visible sur la photo":"Aucune personne détectée - Assurez-vous d’être visible dans le cadre";I({type:"error",title:"Photo non utilisable",message:H,duration:4e3}),A();return}O(E);const{setCaptureProgress:te}=Y.getState();te(E==="front"?"front_taken":"done");const ue=R.isValid?"Photo capturée avec succès":"Photo capturée - Qualité à améliorer",fe=R.isValid?"success":"warning";setTimeout(async()=>{await n(D,E,G),O(null),E==="front"&&setTimeout(()=>{document.querySelector('[data-photo-type="profile"]')?.scrollIntoView({behavior:"smooth",block:"center"})},500),E==="profile"&&setTimeout(()=>{document.querySelector("[data-launch-analysis]")?.scrollIntoView({behavior:"smooth",block:"center"})},800)},1e3),I({type:fe,title:ue,message:R.isValid?"Excellente qualité détectée":`${R.issues.length} point(s) d’amélioration détecté(s). Vous pouvez continuer ou reprendre la photo.`,duration:2e3}),R.isValid&&_()}catch(j){c.error(`Photo processing error: ${j instanceof Error?j.message:String(j)}`,j),I({type:"error",title:"Erreur de traitement",message:"Impossible de traiter la photo",duration:4e3}),A()}finally{p(!1),x(!1),d.current&&(d.current.value="")}},[E,n,I,_,A,i]),T=y.useCallback(async w=>{const j=w.target.files?.[0];if(!j)return;const D=re(j);if(!D.isValid){const F=D.issues.filter(R=>R.includes("not an image")||R.includes("too large"));if(F.length>0){I({type:"error",title:"Fichier invalide",message:F[0],duration:4e3});return}}j.size>8*1024*1024&&I({type:"warning",title:"Fichier volumineux",message:"La photo sera automatiquement optimisée pour un traitement plus rapide",duration:2e3});try{const F=await Xe(j);if(!F.isValid&&F.issues.some(G=>G.includes("corrupted")||G.includes("too small"))){I({type:"error",title:"Qualité d’image insuffisante",message:F.issues[0],duration:4e3});return}}catch(F){c.warn("🔍 [PhotoCapture] Quality validation failed, continuing with processing",{error:F instanceof Error?F.message:"Unknown error"})}if(j.size>15*1024*1024){I({type:"error",title:"Fichier trop volumineux",message:"La photo doit faire moins de 15MB",duration:4e3});return}await K(j)},[K,I]),M=y.useCallback(async w=>{u(!1),await K(w)},[K]);return e.jsxs("div",{className:"body-scan-page twinforge visionos-26 space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(motion.div,{"data-photo-type":"front",initial:preferredMotion?{opacity:0,x:-20}:!1,animate:{opacity:1,x:0},transition:{duration:animConfig.duration,ease:animConfig.ease},children:e.jsx(ie,{photoType:"front",step:t,capturedPhotos:i,userGender:f,isFaceScan:m,isValidating:g,showSuccessAnimation:N,isProgressInitialized:o,onRetake:a,onCameraClick:()=>u(!0),onGalleryClick:()=>d.current?.click(),fileInputRef:d,onFileSelect:T})}),e.jsx(motion.div,{"data-photo-type":"profile",initial:preferredMotion?{opacity:0,x:20}:!1,animate:{opacity:1,x:0},transition:{duration:animConfig.duration,delay:.1,ease:animConfig.ease},children:e.jsx(ie,{photoType:"profile",step:t,capturedPhotos:i,userGender:f,isFaceScan:m,isValidating:g,showSuccessAnimation:N,isProgressInitialized:o,onRetake:a,onCameraClick:()=>u(!0),onGalleryClick:()=>d.current?.click(),fileInputRef:d,onFileSelect:T})})]}),e.jsx(AnimatePresence,{children:v&&e.jsx(motion.div,{initial:preferredMotion?{opacity:0,y:20}:!1,animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.6,ease:[.25,.1,.25,1]},"aria-live":"polite",children:e.jsx(z,{className:"glass-card refined-glass-info p-6 text-center rounded-3xl overflow-hidden",children:e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("span",{className:"refined-spinner refined-spinner--cyan size-8","aria-hidden":"true"}),e.jsx("span",{className:"text-secondary text-base font-medium",children:"Validation en cours…"})]})})})}),e.jsx(AnimatePresence,{children:i.length===2&&!v&&e.jsx(motion.div,{className:"ready-for-processing-entrance",initial:preferredMotion?{opacity:0,y:30,scale:.95}:!1,animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-20,scale:.95},transition:{duration:.8,ease:[.25,.1,.25,1]},children:e.jsx(tt,{isAnyPhotoValidating:v,onProceedToProcessing:l,glassClick:B})})}),t==="front-photo"&&e.jsx(be,{benefits:U,themeColor:"#8B5CF6",title:"Pourquoi scanner mon corps ?"}),h&&e.jsx(et,{photoType:E,onCapture:M,onClose:()=>u(!1)}),e.jsx("input",{ref:d,type:"file",accept:"image/*",onChange:T,className:"hidden",capture:"environment"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(motion.button,{onClick:()=>{b(),s()},className:"btn-glass--secondary-nav px-6 py-3 rounded-full",whileHover:preferredMotion?{scale:1.02}:void 0,whileTap:preferredMotion?{scale:.98}:void 0,initial:preferredMotion?{opacity:0,x:-20}:!1,animate:{opacity:1,x:0},transition:{duration:.5,delay:.2},children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(P,{Icon:k.ArrowLeft,size:16}),e.jsx("span",{children:"Retour"})]})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:`text-caption text-white/60 ${animConfig.shouldAnimate?"progress-text-pulse":""}`,children:V&&C?"Photos capturées":t==="front-photo"?"Étape 1 sur 2":"Étape 2 sur 2"})}),e.jsx("div",{className:"w-24"})]})]})},st=({capturedPhotos:t,currentProgress:i,currentMessage:n,currentSubMessage:a})=>{const s=L(),l=s.enableCSSAnimations,r=y.useMemo(()=>t.find(d=>d.type==="front"),[t]),m=y.useMemo(()=>t.find(d=>d.type==="profile"),[t]);if(!r||!m)return c.warn("IMMERSIVE_PHOTO_ANALYSIS","Photos manquantes pour l’analyse immersive",{hasFrontPhoto:!!r,hasProfilePhoto:!!m,totalPhotos:t.length}),null;const f=y.useMemo(()=>{const d=[{x:50,y:12,label:"Tête"},{x:40,y:25,label:"Épaule G"},{x:60,y:25,label:"Épaule D"},{x:50,y:45,label:"Taille"},{x:45,y:65,label:"Hanche G"},{x:55,y:65,label:"Hanche D"},{x:45,y:90,label:"Pied G"},{x:55,y:90,label:"Pied D"}];return s.mode==="high-performance"?[d[0],d[1],d[2],d[3],d[6]]:d},[s.mode]),o=y.useMemo(()=>{const d=[{x:50,y:15,label:"Tête"},{x:45,y:35,label:"Épaule"},{x:50,y:50,label:"Taille"},{x:48,y:70,label:"Hanche"},{x:50,y:90,label:"Pied"}];return s.mode==="high-performance"?[d[0],d[2],d[4]]:d},[s.mode]),[h,u]=y.useState([]);y.useEffect(()=>{if(!l||!s.enableParticleEffects){u([]);return}const d=()=>{const _=s.mode==="quality"?3:2,A=Array.from({length:_},(B,I)=>({x:Math.random()*80+10,y:Math.random()*80+10,intensity:Math.random()*.8+.2,id:`zone-${Date.now()}-${I}`}));u(A)};d();const b=setInterval(d,3e3);return()=>clearInterval(b)},[l,s.enableParticleEffects,s.mode]);const g=y.useMemo(()=>{const d=s.mode==="quality"?6:s.mode==="balanced"?4:0;return d===0?[]:Array.from({length:d},(b,_)=>{const A=12+Math.random()*76,B=70+Math.random()*25,I=(Math.random()-.5)*30,E=-120-Math.random()*120,V=3+Math.random()*3,C=8+Math.round(Math.random()*6),U=_*.3;return{id:`p-${_}`,x:A,y:B,dx:I,dy:E,speed:V,size:C,delay:U}})},[s.mode]),p=s.enableInitialAnimations?{opacity:0,scale:.94}:!1,v={opacity:1,scale:1},x=[.25,.1,.25,1],N="var(--color-body-scan-primary)",O=[{icon:"Scan",label:"Détection Morphologique",sublabel:"Extraction des points clés corporels",color:"#8B5CF6",activeThreshold:10},{icon:"Zap",label:"Analyse IA Avancée",sublabel:"Matching archetypes et affinement",color:"#A855F7",activeThreshold:40},{icon:"Box",label:"Génération 3D",sublabel:"Construction avatar personnalisé",color:"#C084FC",activeThreshold:70}];return e.jsxs("div",{className:"immersive-analysis-container twinforge visionos-26 space-y-8 -mt-2",style:{"--analysis-color":N},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(S,{initial:p,animate:v,transition:s.enableFramerMotion?{duration:.7,ease:x}:void 0,children:e.jsxs(z,{className:"glass-card analysis-photo-card analysis-photo-card--front p-4 relative overflow-hidden rounded-2xl border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center breathing-icon",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, var(--color-plasma-cyan) 35%, transparent), color-mix(in srgb, var(--color-plasma-cyan) 25%, transparent))
                    `,border:"3px solid color-mix(in srgb, var(--color-plasma-cyan) 70%, transparent)",boxShadow:`
                      0 0 40px color-mix(in srgb, var(--color-plasma-cyan) 60%, transparent),
                      0 0 80px color-mix(in srgb, var(--color-plasma-cyan) 40%, transparent),
                      0 0 120px color-mix(in srgb, var(--brand-primary) 30%, transparent),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -2px 0 rgba(0,0,0,0.2)
                    `,backdropFilter:"blur(20px) saturate(170%)",WebkitBackdropFilter:"blur(20px) saturate(170%)","--icon-color":"var(--color-plasma-cyan)"},children:e.jsx(P,{Icon:k.User,size:16,style:{color:"var(--color-plasma-cyan)"},variant:"pure"})}),"Photo de Face"]}),e.jsxs("div",{className:"analysis-status-badge",children:[e.jsx("div",{className:"w-2 h-2 rounded-full status-dot"}),e.jsx("span",{className:"text-xs font-medium",children:"Analyse IA"})]})]}),e.jsxs("figure",{className:"relative aspect-[3/4] rounded-xl overflow-hidden bg-black/20",role:"group","aria-label":"Analyse de la photo de face",children:[e.jsx("img",{src:r.url,alt:"Photo de face en cours d’analyse",className:"w-full h-full object-contain analysis-photo",loading:"eager",decoding:"async",fetchpriority:"high"}),l&&s.enableScanLineOverlays&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"scan-line-vertical","aria-hidden":"true"}),e.jsx("div",{className:"analysis-grid","aria-hidden":"true",children:Array.from({length:16}).map((d,b)=>e.jsx("div",{className:"grid-cell",style:{"--cell-index":b},"aria-hidden":"true"},b))}),e.jsx("div",{className:"body-keypoints body-keypoints--front","aria-hidden":"true",children:f.map((d,b)=>e.jsx("div",{className:"keypoint",style:{left:`${d.x}%`,top:`${d.y}%`,"--keypoint-index":b}},d.label))}),h.map(d=>e.jsx("div",{className:"analysis-zone",style:{left:`${d.x}%`,top:`${d.y}%`,"--zone-intensity":d.intensity},"aria-hidden":"true"},d.id)),e.jsx("div",{className:"ai-focus-overlay ai-focus-overlay--front","aria-hidden":"true"})]}),e.jsx("figcaption",{className:"sr-only",children:"Repérage des articulations et analyse de surface"})]})]})}),e.jsx(S,{initial:p,animate:v,transition:s.enableFramerMotion?{duration:.7,delay:.15,ease:x}:void 0,children:e.jsxs(z,{className:"glass-card analysis-photo-card analysis-photo-card--profile p-4 relative overflow-hidden rounded-2xl border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center breathing-icon",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, #A855F7 35%, transparent), color-mix(in srgb, #A855F7 25%, transparent))
                    `,border:"3px solid color-mix(in srgb, #A855F7 70%, transparent)",boxShadow:`
                      0 0 40px color-mix(in srgb, #A855F7 60%, transparent),
                      0 0 80px color-mix(in srgb, #A855F7 40%, transparent),
                      0 0 120px color-mix(in srgb, var(--brand-primary) 30%, transparent),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -2px 0 rgba(0,0,0,0.2)
                    `,backdropFilter:"blur(20px) saturate(170%)",WebkitBackdropFilter:"blur(20px) saturate(170%)","--icon-color":"#A855F7"},children:e.jsx(P,{Icon:k.RotateCcw,size:16,style:{color:"#A855F7"},variant:"pure"})}),"Photo de Profil"]}),e.jsxs("div",{className:"analysis-status-badge",children:[e.jsx("div",{className:"w-2 h-2 rounded-full status-dot"}),e.jsx("span",{className:"text-xs font-medium",children:"Analyse IA"})]})]}),e.jsxs("figure",{className:"relative aspect-[3/4] rounded-xl overflow-hidden bg-black/20",role:"group","aria-label":"Analyse de la photo de profil",children:[e.jsx("img",{src:m.url,alt:"Photo de profil en cours d’analyse",className:"w-full h-full object-contain analysis-photo",loading:s.imageLoadingStrategy,decoding:"async"}),l&&s.enableScanLineOverlays&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"scan-line-horizontal","aria-hidden":"true"}),e.jsx("div",{className:"analysis-grid","aria-hidden":"true",children:Array.from({length:16}).map((d,b)=>e.jsx("div",{className:"grid-cell",style:{"--cell-index":b},"aria-hidden":"true"},b))}),e.jsx("div",{className:"body-keypoints body-keypoints--profile","aria-hidden":"true",children:o.map((d,b)=>e.jsx("div",{className:"keypoint",style:{left:`${d.x}%`,top:`${d.y}%`,"--keypoint-index":b}},d.label))}),h.map(d=>e.jsx("div",{className:"analysis-zone",style:{left:`${d.x}%`,top:`${d.y}%`,"--zone-intensity":d.intensity},"aria-hidden":"true"},d.id)),e.jsx("div",{className:"ai-focus-overlay ai-focus-overlay--profile","aria-hidden":"true"})]}),e.jsx("figcaption",{className:"sr-only",children:"Analyse latérale et maillage de contrôle"})]})]})})]}),e.jsx(xe,{modules:O,progress:i,themeColor:"#8B5CF6",reduceMotion:!l,className:"mt-8"}),l&&s.enableDataParticles&&e.jsx("div",{className:"data-flow-container","aria-hidden":"true",children:g.map((d,b)=>e.jsx("div",{className:"data-particle",style:{left:`${d.x}%`,top:`${d.y}%`,"--particle-index":b,"--data-particle-speed":`${d.speed}s`,"--particle-dx":`${d.dx}%`,"--particle-dy":`${d.dy}px`,"--data-particle-size":`${d.size}px`,animationDelay:`${d.delay}s`}},d.id))})]})},nt=()=>{const t=le(),{startProgress:i,progress:n,message:a,subMessage:s,isActive:l,steps:r,currentStep:m}=Y(),f=L(),o=y.useRef(null),h=y.useRef(!1),{currentStep:u,capturedPhotos:g,setCapturedPhotos:p,scanResults:v,showValidationResults:x,validationSummary:N,userId:O,isProfileComplete:d,setCurrentStep:b,onProceedToProcessing:_,isProcessing:A}=Le({scanId:o.current??void 0});ae.useEffect(()=>{window.scrollTo({top:0,behavior:"instant"});const T=document.getElementById("main-content");T&&T.scrollTo({top:0,behavior:"instant"})},[u]);const B=[{id:"capture",title:"Capture Photographique",subtitle:"Face et profil",icon:"Camera",color:"#8B5CF6"},{id:"processing",title:"Analyse IA Avancée",subtitle:"Traitement en cours",icon:"Scan",color:"#8B5CF6"},{id:"celebration",title:"Données Traitées",subtitle:"Préparation du rendu 3D",icon:"Check",color:"#8B5CF6"},{id:"avatar",title:"Avatar 3D",subtitle:"Votre reflet numérique",icon:"Eye",color:"#8B5CF6"}];y.useEffect(()=>{if(h.current)return;h.current=!0,o.current||(o.current=ge());const T=o.current,{resetProgress:M}=Y.getState();M(),i(B,T,"body"),c.info("BODY_SCAN_CAPTURE","Component initialized with scanId",{clientScanId:T,flowType:"body",isDevelopment:!1,timestamp:new Date().toISOString()})},[i]);const I=ae.useCallback(async(T,M,w)=>{try{const j=URL.createObjectURL(T);p(D=>{const R=[...D.filter(G=>G.type!==M),{file:T,url:j,type:M,validationResult:{isValid:w.validation?.isValid??!1,issues:w.validation?.issues??[],retakeReasons:w.validation?.retakeReasons??[],confidence:w.validation?.confidence??0},captureReport:w}];return c.info("BODY_SCAN_CAPTURE","Photo captured successfully",{clientScanId:o.current,photoType:M,totalPhotos:R.length,isValid:R.find(G=>G.type===M)?.validationResult?.isValid}),R}),M==="front"&&b("profile-photo")}catch(j){c.error("BODY_SCAN_CAPTURE","Photo capture error",{error:j,clientScanId:o.current,photoType:M})}},[p,b]),E=T=>{p(M=>M.filter(w=>w.type!==T)),b(T==="front"?"front-photo":"profile-photo"),c.info("BODY_SCAN_CAPTURE","Photo retake requested",{clientScanId:o.current,photoType:T})};if(O===null)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(se,{icon:"Shield",title:"Authentification requise",subtitle:"Connectez-vous pour accéder au scanner corporel",circuit:"body-scan"}),e.jsxs(z,{className:"text-center p-8",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-blue-500/20 flex items-center justify-center",children:e.jsx(P,{Icon:k.Shield,size:24,className:"text-red-400"})}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Authentification requise"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Vous devez être connecté avec un compte valide pour utiliser le scanner corporel"})]})]});if(!d)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(se,{icon:"User",title:"Profil incomplet",subtitle:"Complétez votre profil pour accéder au scanner corporel",circuit:"body-scan"}),e.jsxs(z,{className:"text-center p-8",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-yellow-500/20 flex items-center justify-center",children:e.jsx(P,{Icon:k.User,size:24,className:"text-yellow-400"})}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Profil incomplet"}),e.jsx("p",{className:"text-white/60 text-sm mb-4",children:"Veuillez renseigner votre sexe, taille et poids dans votre profil"}),e.jsx("button",{onClick:()=>t("/profile#identity"),className:"btn-glass--primary px-6 py-3 rounded-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(P,{Icon:k.User,size:16}),e.jsx("span",{children:"Compléter mon profil"})]})})]})]});const V=()=>x&&N?"validation":u==="processing"?"processing-stable":u,C=(T,M,w)=>{if(x&&N)return e.jsx(Q,{fallback:e.jsx(J,{}),children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h3",{className:"text-white font-semibold mb-4",children:"Validation en cours..."}),e.jsx("p",{className:"text-white/60",children:"Les résultats de validation seront bientôt disponibles."})]})});switch(u){case"front-photo":case"profile-photo":return e.jsx(at,{step:u,capturedPhotos:g,onPhotoCapture:I,onRetake:j=>{E(j),j==="profile"&&p(D=>D.filter(F=>F.type==="front"))},onBack:()=>{u==="profile-photo"?(b("front-photo"),p(j=>j.filter(D=>D.type==="front"))):t("/")},onProceedToProcessing:_,isProcessingInProgress:A,isProgressInitialized:l});case"processing":return e.jsx(Q,{fallback:e.jsx(J,{}),children:e.jsx(st,{capturedPhotos:g,currentProgress:T,currentMessage:M,currentSubMessage:w})});case"results":return e.jsx(Q,{fallback:e.jsx(J,{}),children:e.jsxs(z,{className:"text-center p-8",children:[e.jsx(P,{Icon:k.Check,size:48,className:"text-green-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Scan terminé !"}),e.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Votre avatar 3D a été généré avec succès"}),e.jsx("button",{onClick:()=>t("/body-scan/review",{state:{scanResults:v}}),className:"btn-glass--primary px-6 py-3 rounded-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(P,{Icon:k.Eye,size:16}),e.jsx("span",{children:"Voir mon avatar"})]})})]})});default:return e.jsxs(z,{className:"text-center p-8",children:[e.jsx(P,{Icon:k.AlertCircle,size:48,className:"text-red-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Étape inconnue"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Une erreur est survenue dans le flux de scan"})]})}},U=()=>{switch(u){case"front-photo":case"profile-photo":return"capture";case"processing":return"processing";case"results":return"celebration";default:return"capture"}},K=l&&r.length>0&&u!=="results";return e.jsxs("div",{className:"space-y-6",children:[K&&e.jsx(ye,{steps:r,currentStepId:U(),progress:n,message:a,subMessage:s}),e.jsx(de,{mode:"wait",children:e.jsx(S,{initial:f.enableInitialAnimations?{opacity:0,y:20}:!1,animate:f.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},exit:f.enableExitAnimations?{opacity:0,y:-20}:void 0,transition:f.enableFramerMotion?{duration:.3}:void 0,children:C(n,a,s)},V())})]})},it=()=>e.jsx(nt,{}),St=()=>e.jsx("div",{className:"max-w-4xl mx-auto mt-4",children:e.jsx(it,{})});export{St as default};
