import{l as o,s as d,u as S}from"./page-fridge-BvAjnJpI.js";import{j as i}from"./vendor-DX97-qL9.js";import{G as y,S as u,I as f}from"./ui-components-DWjWyKd7.js";import{A as _,m as E}from"./motion-DLE-fuXv.js";async function A(e,t){try{const a=Date.now(),r=Math.random().toString(36).substring(7),s=e.name.split(".").pop(),n=`${t}/${a}-${r}.${s}`;o.debug("MEAL_PHOTO_UPLOAD","Uploading meal photo",{fileName:n,fileSize:e.size,fileType:e.type});const{data:c,error:m}=await d.storage.from("meal-photos").upload(n,e,{cacheControl:"3600",upsert:!1});if(m)return o.error("MEAL_PHOTO_UPLOAD","Failed to upload meal photo",{error:m.message,fileName:n}),{success:!1,error:m.message};const{data:{publicUrl:p}}=d.storage.from("meal-photos").getPublicUrl(n);return o.info("MEAL_PHOTO_UPLOAD","Meal photo uploaded successfully",{fileName:n,publicUrl:p}),{success:!0,publicUrl:p,uploadPath:n}}catch(a){return o.error("MEAL_PHOTO_UPLOAD","Error uploading meal photo",{error:a instanceof Error?a.message:"Unknown error"}),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}async function w(e){try{const a=new URL(e).pathname.split("/"),r=a.slice(a.indexOf("meal-photos")+1).join("/");o.debug("MEAL_PHOTO_DELETE","Deleting meal photo",{filePath:r});const{error:s}=await d.storage.from("meal-photos").remove([r]);if(s)throw o.error("MEAL_PHOTO_DELETE","Failed to delete meal photo",{error:s.message,filePath:r}),s;o.info("MEAL_PHOTO_DELETE","Meal photo deleted successfully",{filePath:r})}catch(t){throw o.error("MEAL_PHOTO_DELETE","Error deleting meal photo",{error:t instanceof Error?t.message:"Unknown error"}),t}}const O={async analyzeMeal(e){o.info("MEALS_REPO","Starting meal analysis",{userId:e.user_id,hasImageUrl:!!e.image_url,hasImageData:!!e.image_data,imageDataLength:e.image_data?.length||0,hasUserContext:!!e.user_profile_context,userObjective:e.user_profile_context?.objective,userAllergies:e.user_profile_context?.nutrition?.allergies?.length||0,mealType:e.meal_type,hasScannedProducts:!!(e.scanned_products&&e.scanned_products.length>0),scannedProductsCount:e.scanned_products?.length||0,timestamp:new Date().toISOString()});try{const t={...e,timestamp:new Date().toISOString()};o.info("MEALS_REPO","Invoking meal-analyzer edge function",{userId:e.user_id,payloadKeys:Object.keys(t),payloadSize:JSON.stringify(t).length,hasImage:!!(t.image_url||t.image_data),hasScannedProducts:!!(t.scanned_products&&t.scanned_products.length>0),timestamp:new Date().toISOString()});const{data:a,error:r}=await d.functions.invoke("meal-analyzer",{body:t});if(console.log("ðŸ“¡ Edge function response:",{hasData:!!a,hasError:!!r,error:r,data:a}),r&&r.context instanceof Response)try{const n=await r.context.clone().text();console.error("ðŸ”´ RESPONSE BODY from edge function (status 400):",n);try{const c=JSON.parse(n);console.error("ðŸ”´ PARSED ERROR from edge function:",c)}catch(c){console.error("ðŸ”´ Could not parse error body as JSON:",c)}}catch(s){console.error("ðŸ”´ Could not read response body:",s)}if(o.info("MEALS_REPO","Received response from meal-analyzer",{userId:e.user_id,hasData:!!a,hasError:!!r,dataSuccess:a?.success,timestamp:new Date().toISOString()}),r)throw console.error("ðŸ”´ CRITICAL ERROR DEBUG - Edge function error:",{errorType:typeof r,errorConstructor:r?.constructor?.name,errorMessage:r.message,errorContext:r.context,errorName:r.name,errorStack:r.stack,fullErrorStringified:JSON.stringify(r,Object.getOwnPropertyNames(r),2),allErrorKeys:Object.keys(r),allErrorValues:Object.values(r)}),o.error("MEALS_REPO",`Meal analysis edge function error - ${r.message}`,{userId:e.user_id,hasUserContext:!!e.user_profile_context,hasScannedProducts:!!(e.scanned_products&&e.scanned_products.length>0),timestamp:new Date().toISOString()}),new Error(`Analyse Ã©chouÃ©e: ${r.message}`);if(!a)throw o.error("MEALS_REPO","No data received from edge function",{userId:e.user_id,hasUserContext:!!e.user_profile_context,timestamp:new Date().toISOString()}),new Error("Aucune donnÃ©e reÃ§ue du service d'analyse");if(!a.success)throw o.error("MEALS_REPO","Meal analysis returned success:false",{data:a,dataError:a.error,userId:e.user_id,hasUserContext:!!e.user_profile_context,timestamp:new Date().toISOString()}),new Error(a.error||"Analyse Ã©chouÃ©e sans dÃ©tails");return o.info("MEALS_REPO","Meal analysis completed successfully",{analysisId:a.analysis_id,userId:e.user_id,totalCalories:a.total_calories,detectedFoodsCount:a.detected_foods?.length||0,detectedFoods:a.detected_foods?.map(s=>s.name).join(", "),confidence:a.confidence,insightsCount:a.personalized_insights?.length||0,aiModelUsed:a.analysis_metadata?.ai_model_used,tokensUsed:a.analysis_metadata?.tokens_used?.total||0,processingTime:a.analysis_metadata?.processing_time_ms,fallbackUsed:a.analysis_metadata?.fallback_used||!1,aiPowered:a.ai_powered,timestamp:new Date().toISOString()}),a}catch(t){throw t instanceof TypeError&&(t.message==="Failed to fetch"||t.message==="undefined")?(o.info("MEALS_REPO","Meal analysis request interrupted (user navigation/app closed)",{userId:e.user_id,errorType:"request_interrupted",timestamp:new Date().toISOString()}),t):(o.error("MEALS_REPO","Meal analysis exception",{error:t instanceof Error?t.message:"Unknown error",errorName:t instanceof Error?t.name:"UnknownError",errorStack:t instanceof Error?t.stack:void 0,userId:e.user_id,hasUserContext:!!e.user_profile_context,hasScannedProducts:!!(e.scanned_products&&e.scanned_products.length>0),timestamp:new Date().toISOString()}),t instanceof Error?new Error(`Erreur lors de l'analyse: ${t.message}`):t)}},async generateDailySummary(e,t,a){o.info("MEALS_REPO","Generating daily AI summary",{userId:e,mealsCount:t.length,hasUserProfile:!!a,userObjective:a?.objective,timestamp:new Date().toISOString()});try{const{data:r,error:s}=await d.functions.invoke("daily-nutrition-summary",{body:{user_id:e,meals:t,user_profile:a,analysis_date:new Date().toISOString().split("T")[0],model:"gpt-5-mini"}});if(s)throw o.error("MEALS_REPO","Daily summary generation failed",{error:s.message,userId:e,timestamp:new Date().toISOString()}),new Error(`Daily summary failed: ${s.message}`);if(!r||!r.success)throw o.error("MEALS_REPO","Daily summary invalid response",{data:r,userId:e,timestamp:new Date().toISOString()}),new Error(r?.error||"Daily summary failed");return o.info("MEALS_REPO","Daily summary generated successfully",{userId:e,summaryLength:r.summary?.length||0,highlightsCount:r.highlights?.length||0,alertsCount:r.proactive_alerts?.length||0,overallScore:r.overall_score,modelUsed:r.model_used,timestamp:new Date().toISOString()}),r}catch(r){throw r instanceof TypeError&&(r.message==="Failed to fetch"||r.message==="undefined")?(o.info("MEALS_REPO","Daily summary request interrupted (user navigation/app closed)",{userId:e,errorType:"request_interrupted",timestamp:new Date().toISOString()}),r):(o.error("MEALS_REPO","Daily summary exception",{error:r instanceof Error?r.message:"Unknown error",userId:e,timestamp:new Date().toISOString()}),r)}},async generateTrendAnalysis(e,t,a){o.info("MEALS_REPO","Generating AI trend analysis",{userId:e,mealsCount:t.length,hasUserProfile:!!a,userObjective:a?.objective,userDiet:a?.nutrition?.diet,timestamp:new Date().toISOString()});try{const{data:r,error:s}=await d.functions.invoke("nutrition-trend-analysis",{body:{user_id:e,meals:t,user_profile:a,analysis_period:"7_days",model:"gpt-5-mini"}});if(s)throw o.error("MEALS_REPO","Trend analysis generation failed",{error:s.message,userId:e,timestamp:new Date().toISOString()}),new Error(`Trend analysis failed: ${s.message}`);if(!r||!r.success)throw o.error("MEALS_REPO","Trend analysis invalid response",{data:r,userId:e,timestamp:new Date().toISOString()}),new Error(r?.error||"Trend analysis failed");return o.info("MEALS_REPO","Trend analysis generated successfully",{userId:e,trendsCount:r.trends?.length||0,adviceCount:r.strategic_advice?.length||0,classificationsCount:r.meal_classifications?.length||0,dietComplianceScore:r.diet_compliance?.overall_score,modelUsed:r.model_used,timestamp:new Date().toISOString()}),r}catch(r){throw r instanceof TypeError&&(r.message==="Failed to fetch"||r.message==="undefined")?(o.info("MEALS_REPO","Trend analysis request interrupted (user navigation/app closed)",{userId:e,errorType:"request_interrupted",timestamp:new Date().toISOString()}),r):(o.error("MEALS_REPO","Trend analysis exception",{error:r instanceof Error?r.message:"Unknown error",userId:e,timestamp:new Date().toISOString()}),r)}},async saveMeal(e){o.info("MEALS_REPO","Saving meal to database",{userId:e.user_id,totalCalories:e.total_kcal,itemsCount:e.items.length,mealType:e.meal_type,hasPhotoUrl:!!e.photo_url,timestamp:e.timestamp});try{const{data:t,error:a}=await d.from("meals").insert({user_id:e.user_id,timestamp:e.timestamp,items:e.items,total_kcal:e.total_kcal,meal_type:e.meal_type,meal_name:e.meal_name,photo_url:e.photo_url}).select().single();if(a)throw o.error("MEALS_REPO","Failed to save meal",{error:a.message,userId:e.user_id,timestamp:new Date().toISOString()}),new Error(`Failed to save meal: ${a.message}`);return o.info("MEALS_REPO","Meal saved successfully",{mealId:t.id,userId:e.user_id,savedMealData:{id:t.id,total_kcal:t.total_kcal,meal_type:t.meal_type,items_count:t.items?.length||0},timestamp:new Date().toISOString()}),t}catch(t){throw o.error("MEALS_REPO","Save meal exception",{error:t instanceof Error?t.message:"Unknown error",userId:e.user_id,timestamp:new Date().toISOString()}),t}},async getUserMeals(e,t,a,r=100){o.debug("MEALS_REPO","Fetching user meals",{userId:e,startDate:t.toISOString(),endDate:a.toISOString(),limit:r});try{const{data:s,error:n}=await d.from("meals").select("*").eq("user_id",e).gte("timestamp",t.toISOString()).lte("timestamp",a.toISOString()).order("timestamp",{ascending:!1}).limit(r);if(n)throw o.error("MEALS_REPO","Failed to fetch meals",{error:n.message,userId:e,timestamp:new Date().toISOString()}),new Error(`Failed to fetch meals: ${n.message}`);return o.debug("MEALS_REPO","Meals fetched successfully",{userId:e,mealsCount:s?.length||0,timestamp:new Date().toISOString()}),s||[]}catch(s){throw o.error("MEALS_REPO","Fetch meals exception",{error:s instanceof Error?s.message:"Unknown error",userId:e,timestamp:new Date().toISOString()}),s}},async getTodayMeals(e){const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=new Date(a.getTime()+24*60*60*1e3-1);return this.getUserMeals(e,a,r)},async getRecentMeals(e,t=7){const a=new Date,r=new Date;return r.setDate(a.getDate()-t),this.getUserMeals(e,r,a,t*5)},async getWeeklyMeals(e){return this.getRecentMeals(e,7)},async getMonthlyMeals(e){return this.getRecentMeals(e,30)},async getMealsWithInsights(e,t=30){return(await this.getRecentMeals(e,t)).map(r=>{const s=new Date(r.timestamp),n=s.getHours(),c=r.items.reduce((m,p)=>(m.proteins+=p.proteins||0,m.carbs+=p.carbs||0,m.fats+=p.fats||0,m),{proteins:0,carbs:0,fats:0});return{...r,dayOfWeek:s.getDay(),timeOfDay:n<10?"morning":n<14?"afternoon":n<20?"evening":"night",macroBalance:c}})},async deleteMeal(e,t){o.info("MEALS_REPO","Deleting meal",{mealId:e,userId:t,timestamp:new Date().toISOString()});try{const{data:a,error:r}=await d.from("meals").select("photo_url").eq("id",e).eq("user_id",t).single();r&&o.warn("MEALS_REPO","Could not fetch meal for photo cleanup",{error:r.message,mealId:e,userId:t,timestamp:new Date().toISOString()});const{error:s}=await d.from("meals").delete().eq("id",e).eq("user_id",t);if(s)throw o.error("MEALS_REPO","Failed to delete meal",{error:s.message,mealId:e,userId:t,timestamp:new Date().toISOString()}),new Error(`Failed to delete meal: ${s.message}`);if(a?.photo_url&&a.photo_url.includes("supabase.co")&&a.photo_url.includes("meal_photos")){o.info("MEALS_REPO","Deleting associated meal photo",{photoUrl:a.photo_url,mealId:e,userId:t,timestamp:new Date().toISOString()});const n=await w(a.photo_url,t);n.success||o.warn("MEALS_REPO","Failed to delete meal photo, but meal was deleted",{error:n.error,photoUrl:a.photo_url,mealId:e,userId:t,timestamp:new Date().toISOString()})}o.info("MEALS_REPO","Meal deleted successfully",{mealId:e,userId:t,photoDeleted:!!a?.photo_url,timestamp:new Date().toISOString()})}catch(a){throw o.error("MEALS_REPO","Delete meal exception",{error:a instanceof Error?a.message:"Unknown error",mealId:e,userId:t,timestamp:new Date().toISOString()}),a}},async updateMeal(e,t,a){o.info("MEALS_REPO","Updating meal",{mealId:e,userId:t,updateKeys:Object.keys(a),timestamp:new Date().toISOString()});try{const{data:r,error:s}=await d.from("meals").update(a).eq("id",e).eq("user_id",t).select().single();if(s)throw o.error("MEALS_REPO","Failed to update meal",{error:s.message,mealId:e,userId:t,timestamp:new Date().toISOString()}),new Error(`Failed to update meal: ${s.message}`);return o.info("MEALS_REPO","Meal updated successfully",{mealId:e,userId:t,timestamp:new Date().toISOString()}),r}catch(r){throw o.error("MEALS_REPO","Update meal exception",{error:r instanceof Error?r.message:"Unknown error",mealId:e,userId:t,timestamp:new Date().toISOString()}),r}}},L=Object.freeze(Object.defineProperty({__proto__:null,mealsRepo:O},Symbol.toStringTag,{value:"Module"})),R=({isOpen:e,onSaveAndExit:t,onDiscardAndExit:a,onCancel:r,hasResults:s,isProcessing:n,capturedPhoto:c})=>{const{click:m,error:p,success:h}=S(),l=n&&!s&&!c?{title:"Analyse en Cours",message:"Une analyse de vos donnÃ©es nutritionnelles est en cours. Si vous quittez maintenant, l'analyse sera interrompue et les insights ne seront pas gÃ©nÃ©rÃ©s.",icon:"Loader2",color:"#F59E0B",showSaveOption:!1}:n?{title:"Analyse en Cours",message:"Une analyse est actuellement en cours. Si vous quittez maintenant, l'analyse sera interrompue et perdue.",icon:"Loader2",color:"#F59E0B",showSaveOption:!1}:s?{title:"RÃ©sultats Non SauvegardÃ©s",message:"Votre repas a Ã©tÃ© analysÃ© mais n'est pas encore sauvegardÃ©. Voulez-vous sauvegarder avant de quitter ?",icon:"AlertCircle",color:"#EF4444",showSaveOption:!0}:c?{title:"Photo Non AnalysÃ©e",message:"Vous avez capturÃ© une photo mais elle n'a pas encore Ã©tÃ© analysÃ©e. Voulez-vous continuer l'analyse ?",icon:"Camera",color:"#F59E0B",showSaveOption:!1}:{title:"Quitter le Scan",message:"ÃŠtes-vous sÃ»r de vouloir quitter le flux de scan ?",icon:"AlertCircle",color:"#6B7280",showSaveOption:!1};return i.jsx(_,{children:e&&i.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{background:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(16px)",WebkitBackdropFilter:"blur(16px)"},onClick:g=>{g.target===g.currentTarget&&(m(),r())},children:i.jsx(E.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",stiffness:300,damping:30},className:"w-full max-w-md",onClick:g=>g.stopPropagation(),children:i.jsxs(y,{className:"p-6 relative",style:{background:`
                  radial-gradient(circle at 30% 20%, color-mix(in srgb, ${l.color} 12%, transparent) 0%, transparent 60%),
                  radial-gradient(circle at 70% 80%, color-mix(in srgb, ${l.color} 8%, transparent) 0%, transparent 50%),
                  var(--glass-opacity)
                `,borderColor:`color-mix(in srgb, ${l.color} 30%, transparent)`,boxShadow:`
                  0 20px 60px rgba(0, 0, 0, 0.4),
                  0 0 40px color-mix(in srgb, ${l.color} 20%, transparent),
                  inset 0 2px 0 rgba(255, 255, 255, 0.2)
                `,backdropFilter:"blur(24px) saturate(160%)"},children:[i.jsxs("div",{className:"text-center mb-6",children:[i.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, ${l.color} 35%, transparent), color-mix(in srgb, ${l.color} 25%, transparent))
                    `,border:`2px solid color-mix(in srgb, ${l.color} 50%, transparent)`,boxShadow:`0 0 30px color-mix(in srgb, ${l.color} 40%, transparent)`},children:i.jsx(u,{Icon:f[l.icon],size:28,style:{color:l.color},className:n?"animate-spin":""})}),i.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:l.title}),i.jsx("p",{className:"text-white/80 text-base leading-relaxed",children:l.message})]}),i.jsxs("div",{className:"space-y-3",children:[l.showSaveOption&&i.jsx("button",{onClick:()=>{h(),t()},className:"w-full btn-glass--primary py-3",style:{background:`
                        linear-gradient(135deg, 
                          color-mix(in srgb, #22C55E 80%, transparent), 
                          color-mix(in srgb, #10B981 60%, transparent)
                        )
                      `,borderColor:"color-mix(in srgb, #22C55E 60%, transparent)",boxShadow:`
                        0 8px 32px color-mix(in srgb, #22C55E 40%, transparent),
                        inset 0 2px 0 rgba(255,255,255,0.3)
                      `},children:i.jsxs("div",{className:"flex items-center justify-center gap-3",children:[i.jsx(u,{Icon:f.Save,size:18,className:"text-white"}),i.jsx("span",{className:"font-bold",children:"Sauvegarder et Quitter"})]})}),i.jsx("button",{onClick:()=>{p(),a()},className:"w-full btn-glass--warning py-3",style:{background:`
                      linear-gradient(135deg, 
                        color-mix(in srgb, #EF4444 70%, transparent), 
                        color-mix(in srgb, #DC2626 50%, transparent)
                      )
                    `,borderColor:"color-mix(in srgb, #EF4444 60%, transparent)",boxShadow:`
                      0 8px 32px color-mix(in srgb, #EF4444 30%, transparent),
                      inset 0 2px 0 rgba(255,255,255,0.2)
                    `},children:i.jsxs("div",{className:"flex items-center justify-center gap-3",children:[i.jsx(u,{Icon:f.Trash2,size:18,className:"text-white"}),i.jsx("span",{className:"font-bold",children:n&&!c?"Interrompre l'analyse et Quitter":n?"Interrompre et Quitter":"Jeter et Quitter"})]})}),i.jsx("button",{onClick:()=>{m(),r()},className:"w-full btn-glass--secondary-nav py-3",children:i.jsxs("div",{className:"flex items-center justify-center gap-3",children:[i.jsx(u,{Icon:f.X,size:18}),i.jsx("span",{className:"font-medium",children:n&&!c?"Continuer l'analyse":"Continuer le Scan"})]})})]}),i.jsx("div",{className:"mt-4 p-3 rounded-xl text-center",style:{background:`color-mix(in srgb, ${l.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${l.color} 20%, transparent)`},children:i.jsx("p",{className:"text-white/70 text-sm",children:n&&!c?"L'analyse IA sera interrompue et devra Ãªtre relancÃ©e.":n?"L'analyse sera interrompue et devra Ãªtre relancÃ©e.":s?"Les rÃ©sultats d'analyse seront perdus si vous ne sauvegardez pas.":c?"Votre photo sera perdue et devra Ãªtre reprise.":"Le systÃ¨me d'analyse a rencontrÃ© une erreur technique."})})]})})})})};export{R as S,L as a,O as m,A as u};
