import{u as he,r as v,j as e,R as oe}from"./vendor-DX97-qL9.js";import{n as ve}from"./utils-CUtLAp28.js";import{u as fe,S as k,I as j,G as U,p as Z,r as Se,t as we,l as ce}from"./ui-components-DWjWyKd7.js";import{m as Q,b as je}from"./stores-DcNfcD_j.js";import{l as c,s as le,u as ne}from"./page-fridge-BvAjnJpI.js";import{f as X,_ as Ce}from"./page-fridge-scan-ZLPWYd6x.js";import{createCompleteSkinTone as de}from"./normalizeSkinTone-gBHfMnNZ.js";import{m as b,A as J}from"./motion-DLE-fuXv.js";import{E as ee,L as te}from"./index-sYo4R74g.js";import{B as ke}from"./BodyScanProgressHeader-C9OstcTU.js";import"./supabase-C_rF2iqf.js";import"./date-utils-sCOX3Ksr.js";const Y=new Map;function q(t,a={}){const s=a.scan_id||a.session_id||"unknown",n=`${t}_${s}`,r=Date.now(),o=Y.get(n);if(o&&r-o<5e3){c.debug("Analytics Event deduplicated",{event:t,scanId:s,reason:"recent_duplicate",timeSinceLastMs:r-o});return}Y.set(n,r);for(const[d,u]of Y.entries())r-u>3e4&&Y.delete(d);const i={event:t,properties:{...a,scan_id:s,timestamp:Date.now(),session_id:Ee(),user_agent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}},timestamp:Date.now()};Ie(i)}const Ne={captureStarted:t=>{q("scan.capture_started",t)},photoTaken:t=>{q("scan.photo_taken",t)},photoRetake:t=>{q("scan.photo_retake_reason",t)},captureCompleted:t=>{q("scan.capture_completed",t)},processingStarted:t=>{q("scan.processing_started",t)},processingCompleted:t=>{q("scan.processing_completed",t)}};function Ee(){let t=sessionStorage.getItem("scan_session_id");return t||(t=`scan_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("scan_session_id",t)),t}function Ie(t){try{const a=localStorage.getItem("scan_analytics_events"),s=a?JSON.parse(a):[];s.push(t),s.length>100&&s.splice(0,s.length-100),localStorage.setItem("scan_analytics_events",JSON.stringify(s))}catch(a){console.warn("Failed to store analytics event:",a)}}async function Ae(t){const{userId:a,clientScanId:s,capturedPhotos:n,stableScanParams:r,resolvedGender:o}=t,{setProcessingStep:i,setServerScanId:d,setComplete:u,setOverallProgress:l,incrementProgress:f,startDynamicProcessing:h,stopDynamicProcessing:g}=Q.getState();c.info("SCAN_PROCESSING_SERVICE","Starting complete pipeline processing",{clientScanId:s,userId:a,photosCount:n.length,userProfile:r,resolvedGender:o,timestamp:new Date().toISOString()}),l(52,"Préparation des données","Téléchargement sécurisé de vos photos...");const p=setInterval(()=>{f(1,"Préparation des données","Téléchargement sécurisé de vos photos...")},200),w=await Pe(a,s,n);clearInterval(p),c.info("SCAN_PROCESSING_SERVICE","Starting dynamic processing progression",{clientScanId:s,startPercentage:52,endPercentage:92,totalSteps:17,philosophy:"dynamic_scan_progression_start"}),h(52,92);const x=await Te(a,w,r,o,s),A=await Re(a,w,x,o,s),D=await Oe(a,x,A,o,s),m=await Fe(D,w,x,A,r,o,s,a);c.info("SCAN_PROCESSING_SERVICE","Stopping dynamic processing before commit",{clientScanId:s,philosophy:"dynamic_scan_progression_stop_before_commit"}),g(),l(92,"Sauvegarde des Données","Persistance de votre avatar personnalisé...");const{commitResult:_,skinTone:S}=await Me(a,x,m,A,n,o,s);_.scan_id&&d(_.scan_id),i("model_loading"),l(95,"Finalisation","Préparation de votre avatar 3D..."),await new Promise(B=>setTimeout(B,800)),i("model_loaded"),l(98,"Prêt","Tout est prêt !"),c.info("SCAN_PROCESSING_SERVICE","🎨 CRITICAL: Validating skin tone before buildCompleteResults",{clientScanId:s,hasSkinTone:!!S,skinToneSchema:S?.schema,skinToneRGB:S?.rgb?`rgb(${S.rgb.r}, ${S.rgb.g}, ${S.rgb.b})`:"unknown",skinToneHex:S?.hex||"unknown",skinToneSource:S?.source,skinToneConfidence:S?.confidence,philosophy:"pre_build_complete_results_validation"});const C=Ve(x,A,m,_,w,r,o,s,a,S);return c.info("SCAN_PROCESSING_SERVICE","Complete pipeline processing finished successfully",{clientScanId:s,serverScanId:_.scan_id,hasAllResults:!!(C.estimate&&C.semantic&&C.match&&C.commit),finalConfidence:C.estimate?.extracted_data?.processing_confidence||0,aiRefined:!!m.ai_refinement?.ai_refine,aiConfidence:m.ai_refinement?.ai_confidence,insightsCount:C.insights?.items?.length||0,timestamp:new Date().toISOString(),philosophy:"pipeline_complete_ready_for_navigation"}),u(),l(100,"Terminé","Traitement complet !"),c.info("SCAN_PROCESSING_SERVICE","Processing state marked as complete, ready for celebration",{clientScanId:s,serverScanId:_.scan_id,philosophy:"ready_for_celebration_after_complete_processing"}),{estimate:x,semantic:A,match:m,commit:_,completeResults:C}}async function Pe(t,a,s){c.info("SCAN_PROCESSING_SERVICE","Step 0: Starting photo upload",{clientScanId:a,photosCount:s.length});const n=await Promise.all(s.map(async(r,o)=>{try{const d=await(await fetch(r.url)).blob(),u=new File([d],`scan-${a}-${r.type}.jpg`,{type:"image/jpeg"}),l=`scans/${t}/${a}/${r.type}.jpg`,{data:f,error:h}=await le.storage.from("body-scans").upload(l,u,{cacheControl:"3600",upsert:!1});if(h)throw new Error(`Upload failed for ${r.type}: ${h.message}`);const{data:{publicUrl:g}}=le.storage.from("body-scans").getPublicUrl(l);return{view:r.type,url:g,report:r.captureReport}}catch(i){throw c.error("SCAN_PROCESSING_SERVICE",`Failed to upload ${r.type} photo`,{clientScanId:a,error:i instanceof Error?i.message:"Unknown error"}),i}}));return c.info("SCAN_PROCESSING_SERVICE","Step 0: Photo upload completed",{clientScanId:a,uploadedCount:n.length,uploadedUrls:n.map(r=>({view:r.view,urlLength:r.url.length}))}),n}async function Te(t,a,s,n,r){c.info("SCAN_PROCESSING_SERVICE","Step 1: Starting scan-estimate",{clientScanId:r,requestData:{userId:t,photosCount:a.length,userMetrics:s}});const o={user_id:t,photos:a,user_declared_height_cm:s.height_cm,user_declared_weight_kg:s.weight_kg,user_declared_gender:n,clientScanId:r,resolvedGender:n},i=await X.estimate(o);return c.info("SCAN_PROCESSING_SERVICE","Step 1: scan-estimate completed",{clientScanId:r,hasExtractedData:!!i.extracted_data,confidence:i.extracted_data?.processing_confidence,hasSkinTone:!!i.extracted_data?.skin_tone,measurementsKeys:i.extracted_data?.raw_measurements?Object.keys(i.extracted_data.raw_measurements):[]}),i}async function Re(t,a,s,n,r){c.info("SCAN_PROCESSING_SERVICE","Step 2: Starting scan-semantic",{clientScanId:r,requestData:{userId:t,hasExtractedData:!!s.extracted_data,estimatedBMI:s.extracted_data?.estimated_bmi}});const o={user_id:t,photos:a,extracted_data:s.extracted_data,user_declared_gender:n,clientScanId:r,resolvedGender:n},i=await X.semantic(o);return c.info("SCAN_PROCESSING_SERVICE","Step 2: scan-semantic completed",{clientScanId:r,hasSemanticProfile:!!i.semantic_profile,semanticConfidence:i.semantic_confidence,adjustmentsMade:i.adjustments_made?.length||0,semanticClasses:i.semantic_profile?{obesity:i.semantic_profile.obesity,muscularity:i.semantic_profile.muscularity,level:i.semantic_profile.level,morphotype:i.semantic_profile.morphotype}:null}),i}async function Oe(t,a,s,n,r){c.info("SCAN_PROCESSING_SERVICE","Step 3: Starting scan-match",{clientScanId:r,userBMICalculated:a.extracted_data?.estimated_bmi,semanticClassificationForMatching:{obesity:s.semantic_profile?.obesity,muscularity:s.semantic_profile?.muscularity,level:s.semantic_profile?.level,morphotype:s.semantic_profile?.morphotype}});const o={user_id:t,extracted_data:a.extracted_data,semantic_profile:s.semantic_profile,user_semantic_indices:{morph_index:s.semantic_profile.morph_index||0,muscle_index:s.semantic_profile.muscle_index||0},matching_config:{gender:n,limit:5},clientScanId:r,resolvedGender:n},i=await X.match(o);return c.info("SCAN_PROCESSING_SERVICE","Step 3: scan-match completed",{clientScanId:r,selectedArchetypesCount:i.selected_archetypes?.length||0,strategyUsed:i.strategy_used,semanticCoherenceScore:i.semantic_coherence_score}),i}async function Fe(t,a,s,n,r,o,i,d){c.info("AI_REFINEMENT","Starting AI morphological refinement",{scanId:i,resolvedGender:o,mappingVersion:"v1.0",blendShapeParamsCount:Object.keys(t.selected_archetypes?.[0]?.morph_values||{}).length,philosophy:"ai_driven_photo_realistic_refinement"});const u=a.map(p=>({view:p.view,url:p.url,report:p.report})),l=t.selected_archetypes?.[0]?.morph_values||{},f=t.selected_archetypes?.[0]?.limb_masses||{},h={height_cm:r.height_cm,weight_kg:r.weight_kg,estimated_bmi:s.extracted_data?.estimated_bmi||r.weight_kg/Math.pow(r.height_cm/100,2),raw_measurements:{waist_cm:s.extracted_data?.raw_measurements?.waist_cm||80,chest_cm:s.extracted_data?.raw_measurements?.chest_cm||95,hips_cm:s.extracted_data?.raw_measurements?.hips_cm||100}};let g=null;try{g=await X.refine({scan_id:i,user_id:d,resolvedGender:o,photos:u,blend_shape_params:l,blend_limb_masses:f,k5_envelope:t.k5_envelope,vision_classification:n.semantic_profile,mapping_version:"v1.0",user_measurements:h}),c.info("AI_REFINEMENT","AI refinement completed successfully",{scanId:i,resolvedGender:o,aiRefine:g.ai_refine,finalShapeParamsCount:Object.keys(g.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(g.final_limb_masses||{}).length,clampedKeysCount:g.clamped_keys?.length||0,outOfRangeCount:g.out_of_range_count||0,activeKeysCount:g.active_keys_count||0,aiConfidence:g.ai_confidence,topDeltas:g.refinement_deltas?.top_10_shape_deltas?.slice(0,3)||[],philosophy:"ai_refinement_success"}),t.ai_refinement=g,t.final_shape_params=g.final_shape_params,t.final_limb_masses=g.final_limb_masses}catch(p){c.warn("AI_REFINEMENT","AI refinement failed, using blend fallback",{scanId:i,resolvedGender:o,error:p instanceof Error?p.message:"Unknown error",philosophy:"ai_refinement_fallback"}),t.ai_refinement={ai_refine:!1,error:p instanceof Error?p.message:"Unknown error",fallback_used:!0}}return t}async function Me(t,a,s,n,r,o,i){c.info("SCAN_PROCESSING_SERVICE","Step 4: Starting scan-commit",{clientScanId:i,requestData:{userId:t,hasEstimateResult:!!a,hasMatchResult:!!s,hasSemanticResult:!!n,hasAIRefinement:!!s.ai_refinement}}),c.info("SCAN_PROCESSING_SERVICE","Step 4: Analyzing matchResult structure",{clientScanId:i,matchResultKeys:s?Object.keys(s):[],hasK5Envelope:!!s?.k5_envelope,hasMorphBounds:!!s?.morph_bounds,hasSelectedArchetypes:!!s?.selected_archetypes,selectedArchetypesCount:s?.selected_archetypes?.length||0,hasAIRefinement:!!s?.ai_refinement,philosophy:"debug_match_result_structure"});const d=s.ai_refinement?.final_shape_params||s.final_shape_params||s.selected_archetypes?.[0]?.morph_values||{},u=s.ai_refinement?.final_limb_masses||s.final_limb_masses||s.selected_archetypes?.[0]?.limb_masses||{};c.info("SCAN_PROCESSING_SERVICE","Step 4: 🔍 About to import V2 skin tone extractor",{clientScanId:i,philosophy:"pre_skin_tone_extraction_import"});let l;try{console.log("🔍 [SKIN TONE DEBUG] Starting extraction, photos count:",r?.length||0);const{extractSkinToneFromScanData:p}=await Ce(async()=>{const{extractSkinToneFromScanData:x}=await Promise.resolve().then(()=>Ue);return{extractSkinToneFromScanData:x}},void 0);c.info("SCAN_PROCESSING_SERVICE","Step 4: ✅ V2 extractor imported successfully",{clientScanId:i,philosophy:"extractor_import_success"});const w=r.map(x=>({view:x.type,url:x.url,report:x.captureReport}));l=p(w,a,i),c.info("SCAN_PROCESSING_SERVICE","Step 4: ✅ Skin tone extracted successfully",{clientScanId:i,hasSkinTone:!!l,skinToneType:typeof l,skinToneKeys:l&&typeof l=="object"?Object.keys(l):[],skinToneSchema:l?.schema,skinToneRGB:l?.rgb?`rgb(${l.rgb.r}, ${l.rgb.g}, ${l.rgb.b})`:"unknown",skinToneHex:l?.hex||"unknown",philosophy:"skin_tone_extraction_success"})}catch(p){throw c.error("SCAN_PROCESSING_SERVICE","Step 4: ❌ Skin tone extraction FAILED",{clientScanId:i,error:p instanceof Error?p.message:String(p),stack:p instanceof Error?p.stack:void 0,errorType:p?.constructor?.name,errorName:p instanceof Error?p.name:"unknown",capturedPhotosCount:r?.length||0,hasEstimateResult:!!a,philosophy:"skin_tone_extraction_fatal_error"}),console.error("🚨 [SKIN TONE EXTRACTION ERROR] Full error details:",p),p}const f=s.k5_envelope||null;c.info("SCAN_PROCESSING_SERVICE","Step 4: Building commit request",{clientScanId:i,hasFinalShapeParams:!!d,finalShapeParamsCount:Object.keys(d).length,finalShapeParamsKeys:Object.keys(d).slice(0,5),hasFinalLimbMasses:!!u,finalLimbMassesCount:Object.keys(u).length,finalLimbMassesKeys:Object.keys(u),hasSkinTone:!!l,hasK5Envelope:!!f,hasAIRefinement:!!s.ai_refinement,aiRefined:!!s.ai_refinement?.ai_refine,philosophy:"pre_commit_request_construction_v2"});const h={user_id:t,resolvedGender:o,estimate_result:a,match_result:s,morph_bounds:f,semantic_result:n,ai_refinement_result:s.ai_refinement,validation_metadata:{},temporal_analysis:{},smoothing_metadata:{},visionfit_result:{},photos_metadata:r.map(p=>({type:p.type,captureReport:p.captureReport})),final_shape_params:d,final_limb_masses:u,skin_tone:l,resolved_gender:o,mapping_version:"v1.0",gltf_model_id:`${o}_v4.13`,material_config_version:"pbr-v2",avatar_version:"v2.0",clientScanId:i};c.info("SCAN_PROCESSING_SERVICE","Step 4: Complete commit request prepared",{clientScanId:i,requestKeys:Object.keys(h),finalDataSummary:{finalShapeParamsCount:Object.keys(d).length,finalLimbMassesCount:Object.keys(u).length,skinTonePresent:!!l,aiRefinementPresent:!!s.ai_refinement,aiRefine:s.ai_refinement?.ai_refine||!1,k5EnvelopePresent:!!f},philosophy:"commit_request_structure_audit_v2"}),c.info("SCAN_PROCESSING_SERVICE","Step 4: 🎨 SKIN TONE BEFORE COMMIT",{clientScanId:i,skinToneComplete:l,skinToneKeys:l&&typeof l=="object"?Object.keys(l):[],skinToneSchema:l?.schema,skinToneRGB:l?.rgb,skinToneHex:l?.hex,skinToneSource:l?.source,skinToneConfidence:l?.confidence,philosophy:"CRITICAL_SKIN_TONE_AUDIT_BEFORE_COMMIT"});try{c.info("SCAN_PROCESSING_SERVICE","Step 4: Complete avatar data prepared for commit",{clientScanId:i,finalShapeParamsCount:Object.keys(d).length,finalLimbMassesCount:Object.keys(u).length,hasSkinTone:!!l,skinToneType:typeof l,skinToneKeys:l&&typeof l=="object"?Object.keys(l):[],skinToneV2:l&&l.rgb?{rgb:`rgb(${l.rgb.r}, ${l.rgb.g}, ${l.rgb.b})`,hex:l.hex,schema:l.schema,source:l.source,confidence:l.confidence}:"invalid_or_missing",skinToneRaw:JSON.stringify(l),resolvedGender:o,philosophy:"complete_avatar_data_v2_for_server_persistence"})}catch(p){c.error("SCAN_PROCESSING_SERVICE","Failed to log skin tone structure",{clientScanId:i,error:p instanceof Error?p.message:String(p),skinToneType:typeof l,skinToneStringified:String(l)})}c.info("SCAN_PROCESSING_SERVICE","🚨 CRITICAL: About to call bodyScanRepo.commit",{clientScanId:i,requestKeys:Object.keys(h),requestSummary:{user_id:h.user_id?.substring(0,8)+"...",resolved_gender:h.resolvedGender,has_final_shape_params:!!h.final_shape_params,final_shape_params_count:h.final_shape_params?Object.keys(h.final_shape_params).length:0,has_final_limb_masses:!!h.final_limb_masses,final_limb_masses_count:h.final_limb_masses?Object.keys(h.final_limb_masses).length:0,has_skin_tone:!!h.skin_tone,skin_tone_type:typeof h.skin_tone,skin_tone_preview:h.skin_tone&&typeof h.skin_tone=="object"?{has_rgb:!!h.skin_tone.rgb,has_hex:!!h.skin_tone.hex,has_schema:!!h.skin_tone.schema,schema_value:h.skin_tone.schema}:"not_object"},philosophy:"pre_commit_call_audit"});let g;try{g=await X.commit(h),c.info("SCAN_PROCESSING_SERVICE","✅ bodyScanRepo.commit returned successfully",{clientScanId:i,hasResult:!!g,resultKeys:g?Object.keys(g):[]})}catch(p){throw c.error("SCAN_PROCESSING_SERVICE","❌ bodyScanRepo.commit threw error",{clientScanId:i,error:p instanceof Error?p.message:String(p),stack:p instanceof Error?p.stack:void 0,errorType:p?.constructor?.name||typeof p}),p}return c.info("SCAN_PROCESSING_SERVICE","Step 4: scan-commit completed",{clientScanId:i,serverScanId:g.scan_id,commitSuccess:!!g.success,processingComplete:!!g.processing_complete}),{commitResult:g,skinTone:l}}function Ve(t,a,s,n,r,o,i,d,u,l){c.info("BUILD_COMPLETE_RESULTS","Building complete results with pre-extracted skin tone",{clientScanId:d,hasPreExtractedSkinTone:!!l,skinToneSchema:l?.schema,philosophy:"use_pre_extracted_skin_tone_v2"});const f=l||$e(r,t,d),h=!!l;return c.info("BUILD_COMPLETE_RESULTS","🎨 CRITICAL: Final skin tone decision for complete results",{clientScanId:d,usedPreExtracted:h,finalSkinToneSchema:f?.schema,finalSkinToneRGB:f?.rgb?`rgb(${f.rgb.r}, ${f.rgb.g}, ${f.rgb.b})`:f?.r?`rgb(${f.r}, ${f.g}, ${f.b})`:"unknown",finalSkinToneHex:f?.hex||"unknown",finalSkinToneSource:f?.source,finalSkinToneConfidence:f?.confidence,philosophy:h?"using_pre_extracted_v2_no_fallback":"emergency_extraction_called"}),{resolvedGender:i,estimate:t,semantic:a,match:s,commit:n,userId:u,serverScanId:n.scan_id,userProfile:{...o,sex:i},insights:De(t,a,s),clientScanId:d,skin_tone:f,limb_masses:ze(s,t,d)}}function De(t,a,s){const n=[],r=t?.extracted_data?.processing_confidence||0;if(r>.8&&n.push({id:"high-confidence",type:"achievement",title:"Analyse de Haute Qualité",description:`Votre scan a été analysé avec ${Math.round(r*100)}% de confiance.`,category:"morphology",priority:"high",confidence:r,source:"ai_analysis",color:"#22C55E"}),s?.selected_archetypes?.length>0){const o=s.selected_archetypes[0];n.push({id:"archetype-match",type:"observation",title:"Profil Morphologique",description:`Votre morphologie correspond au profil "${o.name}".`,category:"morphology",priority:"medium",confidence:.8,source:"archetype",color:"#8B5CF6"})}if(a?.semantic_profile){const o=a.semantic_profile;n.push({id:"semantic-classification",type:"observation",title:"Classification Morphologique",description:`Profil: ${o.obesity} • ${o.muscularity} • ${o.morphotype}`,category:"morphology",priority:"medium",confidence:a.semantic_confidence||.6,source:"semantic",color:"#06B6D4"})}return{items:n,source:"generated",confidence:r||.8}}function $e(t,a,s){c.warn("SKIN_TONE_EXTRACTION_DEPRECATED","Using deprecated skin tone extraction - should use V2 from dataExtractors",{clientScanId:s,uploadedPhotosCount:t?.length||0,hasEstimateResult:!!a,philosophy:"emergency_fallback_only"});const n=a?.extracted_data?.skin_tone;if(n?.schema==="v2"&&n?.rgb)return c.info("SKIN_TONE_EXTRACTION_DEPRECATED","Found V2 skin tone from Vision AI",{clientScanId:s,skinTone:`rgb(${n.rgb.r}, ${n.rgb.g}, ${n.rgb.b})`,confidence:n.confidence||"unknown",source:"estimate_extracted_data_v2"}),{r:n.rgb.r,g:n.rgb.g,b:n.rgb.b,confidence:n.confidence};if(n&&typeof n=="object"&&typeof n.r=="number"&&typeof n.g=="number"&&typeof n.b=="number")return c.info("SKIN_TONE_EXTRACTION_DEPRECATED","Found legacy skin tone from Vision AI",{clientScanId:s,skinTone:`rgb(${n.r}, ${n.g}, ${n.b})`,confidence:n.confidence||"unknown",source:"estimate_extracted_data_legacy"}),n;const r={r:153,g:108,b:78,confidence:.5};return c.error("SKIN_TONE_EXTRACTION_DEPRECATED","Using emergency fallback - this should not happen",{clientScanId:s,fallbackSkinTone:`rgb(${r.r}, ${r.g}, ${r.b})`,reason:"no_valid_skin_tone_found_in_scan_data",source:"emergency_fallback"}),r}function ze(t,a,s){c.info("LIMB_MASSES_EXTRACTION","Starting limb masses extraction from scan data",{clientScanId:s,hasMatchResult:!!t,hasEstimateResult:!!a,matchResultKeys:t?Object.keys(t):[]});const n=t?.blended_limb_masses||t?.advanced_matching?.blending?.blended_limb_masses;if(n&&typeof n=="object"&&Object.keys(n).length>0)return c.info("LIMB_MASSES_EXTRACTION","Found limb masses from match result blending",{clientScanId:s,limbMassesKeys:Object.keys(n),sampleValues:Object.entries(n).slice(0,3).map(([o,i])=>({key:o,value:i})),source:"match_result_blended"}),n;const r=t?.selected_archetypes;if(r&&Array.isArray(r)&&r.length>0){const o=r[0],i=o?.limb_masses;if(i&&typeof i=="object"&&Object.keys(i).length>0)return c.info("LIMB_MASSES_EXTRACTION","Found limb masses from primary archetype",{clientScanId:s,archetypeId:o.id,archetypeName:o.name,limbMassesKeys:Object.keys(i),sampleValues:Object.entries(i).slice(0,3).map(([d,u])=>({key:d,value:u})),source:"primary_archetype"}),i}return Be(a,s)}function Be(t,a){const s=t?.extracted_data?.estimated_bmi||22,n=t?.extracted_data?.estimated_body_fat_perc||15,r=Math.max(.7,Math.min(1.4,s/22)),o=Math.max(.8,Math.min(1.3,n/15)),i={gate:1,armMass:1+(r-1)*.3+(o-1)*.2,calfMass:1+(r-1)*.25+(o-1)*.15,neckMass:1+(r-1)*.2+(o-1)*.1,thighMass:1+(r-1)*.4+(o-1)*.3,torsoMass:1+(r-1)*.5+(o-1)*.4,forearmMass:1+(r-1)*.25+(o-1)*.15};return Object.keys(i).forEach(d=>{d!=="gate"&&(i[d]=Math.max(.6,Math.min(1.6,i[d])))}),c.info("LIMB_MASSES_EXTRACTION","Generated intelligent limb masses fallback",{clientScanId:a,estimatedBMI:s.toFixed(2),bodyFatPerc:n.toFixed(1),bmiFactor:r.toFixed(3),fatFactor:o.toFixed(3),generatedMasses:Object.entries(i).map(([d,u])=>({key:d,value:u.toFixed(3)}))}),i}function Le(t,a,s){c.info("DATA_EXTRACTORS","Extracting skin tone from Vision AI analysis",{clientScanId:s,hasEstimateResult:!!a,hasExtractedData:!!a?.extracted_data,philosophy:"vision_ai_exclusive_extraction"});const n=a?.extracted_data?.skin_tone;if(n&&typeof n=="object"){if(n.schema==="v2"&&n.rgb)return c.info("DATA_EXTRACTORS","Found V2 skin tone from Vision AI",{clientScanId:s,skinTone:`rgb(${n.rgb.r}, ${n.rgb.g}, ${n.rgb.b})`,hex:n.hex,confidence:n.confidence,source:n.source||"vision_ai"}),n;if(typeof n.r=="number"&&typeof n.g=="number"&&typeof n.b=="number")return c.info("DATA_EXTRACTORS","Converting legacy Vision AI skin tone to V2",{clientScanId:s,skinTone:`rgb(${n.r}, ${n.g}, ${n.b})`,confidence:n.confidence||.85}),de(n.r,n.g,n.b,"vision_ai_analysis",n.confidence||.85,n.pixelCount)}return c.error("DATA_EXTRACTORS","Vision AI failed to provide skin tone - this should not happen",{clientScanId:s,hasEstimateResult:!!a,hasExtractedData:!!a?.extracted_data,extractedSkinToneType:typeof n,philosophy:"vision_ai_extraction_failure"}),de(153,108,78,"emergency_fallback",.3)}function ge(t,a){if(c.info("DATA_EXTRACTORS","Starting user profile extraction from sources",{hasProfile:!!t,profileKeys:t?Object.keys(t):[],source:"user_profile_extraction"}),!t?.sex||!t?.height_cm||!t?.weight_kg){c.warn("DATA_EXTRACTORS","Profile incomplete - missing required fields",{hasSex:!!t?.sex,hasHeight:!!t?.height_cm,hasWeight:!!t?.weight_kg,source:"user_profile_extraction"});return}const s={sex:t.sex,height_cm:t.height_cm,weight_kg:t.weight_kg};return c.info("DATA_EXTRACTORS","User profile extracted from sources",{extractedProfile:s,source:"user_profile_extraction"}),s}function xe(t,a,s,n){if(c.info("DATA_EXTRACTORS","Starting gender resolution from sources",{hasProfile:!!t,profileSex:t?.sex,source:"gender_resolution"}),t?.sex){const o=t.sex==="male"?"masculine":"feminine";return c.info("DATA_EXTRACTORS","Gender resolved from user profile",{profileSex:t.sex,resolvedGender:o,source:"user_profile_sex"}),o}const r="masculine";return c.warn("DATA_EXTRACTORS","Using fallback gender",{fallbackGender:r,reason:"no_valid_sex_found_in_profile",source:"fallback"}),r}const Ue=Object.freeze(Object.defineProperty({__proto__:null,extractSkinToneFromScanData:Le,extractUserProfileFromSources:ge,resolveGenderFromSources:xe},Symbol.toStringTag,{value:"Module"}));function Ge(t={}){const{profile:a,sessionInfo:s}=je(),n=he(),{showToast:r}=fe(),{success:o}=ne(),[i,d]=v.useState("front-photo"),[u,l]=v.useState([]),[f,h]=v.useState(null),[g,p]=v.useState(!1),[w,x]=v.useState(null),[A,D]=v.useState(!1),m=v.useRef(!1),_=v.useMemo(()=>s?.userId||a?.userId||null,[s?.userId,a?.userId]),S=v.useMemo(()=>{const N=ge(a);return c.info("BODY_SCAN_CAPTURE_FLOW","Extracting scan parameters from profile",{hasProfile:!!a,profileKeys:a?Object.keys(a):[],profileIdentityFields:a?{displayName:a.displayName,sex:a.sex,height_cm:a.height_cm,weight_kg:a.weight_kg,target_weight_kg:a.target_weight_kg,activity_level:a.activity_level,objective:a.objective,birthdate:a.birthdate}:null,extractedParams:N,extractedKeys:N?Object.keys(N):[],philosophy:"scan_params_extraction"}),N},[a?.sex,a?.height_cm,a?.weight_kg]),C=v.useMemo(()=>!!S,[S]);return{currentStep:i,capturedPhotos:u,scanResults:f,showValidationResults:g,validationSummary:w,userId:_,isProfileComplete:C,stableScanParams:S,processingGuardRef:m,isProcessing:A,setCapturedPhotos:l,setCurrentStep:d,setScanResults:h,setShowValidationResults:p,setValidationSummary:x,handleStartCapture:()=>{d("front-photo"),l([]),h(null),p(!1),x(null)},onProceedToProcessing:async()=>{const N=xe(S,null,!1,t.scanId);if(m.current){c.warn("BODY_SCAN_CAPTURE_FLOW","Processing already in progress, ignoring duplicate request",{clientScanId:t.scanId});return}if(u.length!==2){r({type:"error",title:"Photos manquantes",message:"Veuillez capturer les deux photos avant de continuer",duration:4e3});return}if(!S||!_){r({type:"error",title:"Paramètres manquants",message:"Profil utilisateur incomplet",duration:4e3});return}if(!t.scanId){c.error("BODY_SCAN_CAPTURE_FLOW","No scanId provided to processing flow"),r({type:"error",title:"Erreur système",message:"Identifiant de scan manquant",duration:4e3});return}m.current=!0,D(!0),d("processing");const R=t.scanId;try{Ne.processingStarted({photos_count:u.length,scan_id:R});const{completeResults:y}=await Ae({userId:_,clientScanId:R,capturedPhotos:u,stableScanParams:S,resolvedGender:N});h(y),d("results"),c.info("BODY_SCAN_CAPTURE_FLOW","Processing complete, preparing for celebration",{clientScanId:R,serverScanId:y.serverScanId,hasResults:!!y,hasEstimate:!!y.estimate,hasSemantic:!!y.semantic,hasMatch:!!y.match,hasCommit:!!y.commit,aiRefined:!!y.match?.ai_refinement?.ai_refine,processingComplete:!0,philosophy:"verify_complete_before_celebration"}),o(),setTimeout(()=>{c.info("BODY_SCAN_CAPTURE_FLOW","Navigating to celebration with verified complete scan data",{clientScanId:R,serverScanId:y.serverScanId,resultsKeys:y?Object.keys(y):[],navigationDelay:"1000ms",timestamp:new Date().toISOString(),philosophy:"safe_navigation_after_complete_processing"}),n("/body-scan/celebration",{state:{scanResults:y,processingComplete:!0},replace:!1})},1e3)}catch(y){const K=y instanceof Error?y.message:"Erreur inconnue";c.error("BODY_SCAN_CAPTURE_FLOW","Processing pipeline failed",{clientScanId:R,error:K,stack:y instanceof Error?y.stack:void 0,step:"pipeline_processing",timestamp:new Date().toISOString()}),r({type:"error",title:"Erreur de traitement",message:K,duration:4e3}),d("profile-photo")}finally{m.current=!1,D(!1)}}}}const Ke={male:{front:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/homme-face.png",profile:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/homme-profil.png"},female:{front:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/femme-face.png",profile:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/femme-profil.png"}};function qe(t,a){return Ke[t==="female"?"female":"male"][a]}const He=({type:t,isFaceScan:a=!1,gender:s})=>{const n=qe(s,t);return e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx("div",{className:"relative",style:{width:"180px",height:"260px"},children:e.jsxs("div",{className:"w-full h-full border-2 rounded-3xl flex items-center justify-center relative overflow-hidden",style:{borderColor:t==="front"?"color-mix(in srgb, var(--color-plasma-cyan) 50%, transparent)":"color-mix(in srgb, #A855F7 50%, transparent)",background:t==="front"?`
                radial-gradient(circle at center, color-mix(in srgb, var(--color-plasma-cyan) 12%, transparent) 0%, transparent 70%),
                rgba(255, 255, 255, 0.05)
              `:`
                radial-gradient(circle at center, color-mix(in srgb, #A855F7 12%, transparent) 0%, transparent 70%),
                rgba(255, 255, 255, 0.05)
              `,backdropFilter:"blur(8px) saturate(120%)",boxShadow:t==="front"?`
                0 0 30px color-mix(in srgb, var(--color-plasma-cyan) 20%, transparent),
                0 8px 32px rgba(0, 0, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `:`
                0 0 30px color-mix(in srgb, #A855F7 20%, transparent),
                0 8px 32px rgba(0, 0, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `},children:[e.jsxs(b.div,{className:"absolute inset-2 rounded-2xl overflow-hidden",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.8,ease:[.25,.1,.25,1]},children:[e.jsx("img",{src:n,alt:`Guide ${t} - ${s==="female"?"Femme":"Homme"}`,className:"w-full h-full object-cover",style:{filter:t==="front"?`
                    brightness(0.7) 
                    contrast(1.1) 
                    saturate(0.8)
                    drop-shadow(0 0 8px color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent))
                  `:`
                    brightness(0.7) 
                    contrast(1.1) 
                    saturate(0.8)
                    drop-shadow(0 0 8px color-mix(in srgb, #A855F7 30%, transparent))
                  `,opacity:.85}}),e.jsx("div",{className:"absolute inset-0",style:{background:t==="front"?`
                    linear-gradient(135deg, 
                      color-mix(in srgb, var(--color-plasma-cyan) 15%, transparent) 0%, 
                      transparent 30%, 
                      color-mix(in srgb, var(--color-plasma-cyan) 8%, transparent) 70%, 
                      transparent 100%
                    )
                  `:`
                    linear-gradient(135deg, 
                      color-mix(in srgb, #A855F7 15%, transparent) 0%, 
                      transparent 30%, 
                      color-mix(in srgb, #A855F7 8%, transparent) 70%, 
                      transparent 100%
                    )
                  `,backdropFilter:"blur(1px)",mixBlendMode:"overlay"}})]}),e.jsx("div",{className:"absolute top-6 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded-lg text-xs font-medium",style:{background:`
                radial-gradient(circle at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%)
              `,backdropFilter:"blur(8px) saturate(120%)",border:t==="front"?"1px solid color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent)":"1px solid color-mix(in srgb, #A855F7 30%, transparent)",color:t==="front"?"var(--color-plasma-cyan)":"#A855F7",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.4)",zIndex:20},children:t==="front"?"Face":"Profil"}),e.jsx("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2 px-3 py-1.5 rounded-lg text-sm font-bold",style:{background:t==="front"?`
                  radial-gradient(circle at center, color-mix(in srgb, var(--color-plasma-cyan) 25%, transparent) 0%, color-mix(in srgb, var(--color-plasma-cyan) 15%, transparent) 100%)
                `:`
                  radial-gradient(circle at center, color-mix(in srgb, #A855F7 25%, transparent) 0%, color-mix(in srgb, #A855F7 15%, transparent) 100%)
                `,border:t==="front"?"1px solid color-mix(in srgb, var(--color-plasma-cyan) 50%, transparent)":"1px solid color-mix(in srgb, #A855F7 50%, transparent)",color:t==="front"?"var(--color-plasma-cyan)":"#A855F7",backdropFilter:"blur(8px) saturate(130%)",boxShadow:t==="front"?`
                  0 4px 12px rgba(0, 0, 0, 0.3),
                  0 0 12px color-mix(in srgb, var(--color-plasma-cyan) 40%, transparent)
                `:`
                  0 4px 12px rgba(0, 0, 0, 0.3),
                  0 0 12px color-mix(in srgb, #A855F7 40%, transparent)
                `,zIndex:20},children:t==="front"?"180°":"90°"})," ",e.jsx("div",{className:"absolute inset-0 border-2 border-white/20 rounded-3xl pointer-events-none",style:{animation:"guide-breathing-animation 4s ease-in-out infinite",boxShadow:t==="front"?"inset 0 0 20px color-mix(in srgb, var(--color-plasma-cyan) 10%, transparent)":"inset 0 0 20px color-mix(in srgb, #A855F7 10%, transparent)",zIndex:10}})]})}),e.jsx("div",{className:"flex-1 text-left space-y-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:`text-sm font-medium ${t==="front"?"text-cyan-400":"text-purple-400"}`,children:["Position ",t==="front"?"face":"profil"]}),e.jsx("div",{className:"space-y-1 text-xs text-white/60",children:t==="front"?a?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Regardez l'objectif"}),e.jsx("p",{children:"• Visage au centre du cadre"}),e.jsx("p",{children:"• Expression neutre"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Regardez l'objectif"}),e.jsx("p",{children:"• Bras légèrement décollés"}),e.jsx("p",{children:"• Posture droite"})]}):a?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Tournez-vous de 90°"}),e.jsx("p",{children:"• Regardez droit devant"}),e.jsx("p",{children:"• Visage au centre du cadre"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"• Tournez-vous à 90°"}),e.jsx("p",{children:"• Même distance que face"}),e.jsx("p",{children:"• Bras visible"})]})})]})})]})},Xe=({photo:t,showSuccessAnimation:a,onRetake:s})=>{const{click:n}=ne();return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative aspect-[3/4] rounded-xl overflow-hidden",children:[e.jsx(b.img,{src:t.url,alt:`Photo ${t.type}`,className:"w-full h-full object-contain bg-black/20 border border-white/10 photo-processing",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.6,ease:"easeOut"}}),e.jsx(J,{children:a&&e.jsx(b.div,{className:"absolute inset-0 flex items-center justify-center backdrop-blur-md rounded-xl success-ripple",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.4))",border:"1px solid rgba(34, 197, 94, 0.5)"},initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.1},transition:{duration:.6,ease:"easeOut"},children:e.jsx(b.div,{className:"w-24 h-24 rounded-full flex items-center justify-center backdrop-blur-sm",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.5))",border:"2px solid rgba(34, 197, 94, 0.6)",boxShadow:"0 0 40px rgba(34, 197, 94, 0.6), inset 0 2px 0 rgba(255,255,255,0.3)"},initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:300,damping:20,delay:.2},children:e.jsx(k,{Icon:j.Check,size:36,className:"text-green-400"})})})})]}),e.jsx(b.button,{onClick:()=>{n(),s()},className:"w-full btn-glass",whileHover:{scale:1.02},whileTap:{scale:.98},style:{borderRadius:"999px",padding:".5rem 1.5rem",minHeight:"44px",overflow:"hidden"},initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.4,delay:.2},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(k,{Icon:j.RotateCcw,size:14}),e.jsx("span",{children:"Reprendre"})]})})]})},We=({photo:t,photoType:a,isValidating:s})=>{const r=a==="front"?"var(--color-nutrition-primary)":"#A855F7";return e.jsx("div",{className:"flex flex-col items-end gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium",style:{background:t?`color-mix(in srgb, ${r} 15%, transparent)`:"color-mix(in srgb, #60A5FA 15%, transparent)",border:t?`1px solid color-mix(in srgb, ${r} 30%, transparent)`:"1px solid color-mix(in srgb, #60A5FA 30%, transparent)",color:t?r:"#60A5FA",backdropFilter:"blur(8px) saturate(120%)"},children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-current opacity-60 flex items-center justify-center"}),e.jsx("span",{children:t?t.validationResult?.isValid?"Capturée & Validée":"Capturée":"En attente"})]})})},Ye=({photoType:t,isValidating:a,onCameraCapture:s,onGallerySelect:n,isProgressInitialized:r,fileInputRef:o,onFileSelect:i})=>{const d=t==="front"?"var(--color-plasma-cyan)":"#A855F7";c.debug("PHOTO_CONTROLS","state",{photoType:t,isValidating:a,isProgressInitialized:r});const u=a||!r,l=()=>{o?.current?o.current.click():n()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx(b.button,{type:"button",onClick:s,disabled:u,"aria-busy":a,className:"px-6 py-3 rounded-full font-semibold text-white transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60",whileHover:u?{}:{scale:1.02,y:-2},whileTap:u?{}:{scale:.98},initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{duration:.25},style:{background:`
              linear-gradient(135deg,
                color-mix(in srgb, ${d} 80%, transparent),
                color-mix(in srgb, ${d} 60%, transparent)
              )
            `,border:`2px solid color-mix(in srgb, ${d} 60%, transparent)`,boxShadow:`
              0 8px 32px color-mix(in srgb, ${d} 40%, transparent),
              0 0 40px color-mix(in srgb, ${d} 25%, transparent),
              inset 0 2px 0 rgba(255, 255, 255, 0.30)
            `,backdropFilter:"blur(16px) saturate(150%)",opacity:u?.6:1,cursor:u?"not-allowed":"pointer"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b.div,{animate:a?{rotate:360}:{},transition:{duration:2,repeat:1/0,ease:"linear"},children:e.jsx(k,{Icon:a?j.Loader2??j.Camera:j.Camera,size:16,color:"white",glowColor:d,variant:"pure"})}),e.jsx("span",{children:a?"Validation…":"Caméra"})]})}),e.jsx(b.button,{type:"button",onClick:l,disabled:u,className:"px-6 py-3 rounded-full font-medium text-white/90 transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40",whileHover:u?{}:{scale:1.02,y:-1},whileTap:u?{}:{scale:.98},initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{duration:.25,delay:.05},style:{background:`color-mix(in srgb, ${d} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${d} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)",opacity:u?.6:1,cursor:u?"not-allowed":"pointer"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{Icon:j.Image,size:16,color:"white",glowColor:d,variant:"pure"}),e.jsx("span",{children:"Galerie"})]})})]}),o&&i&&e.jsx("input",{ref:o,type:"file",accept:"image/*",onChange:i,className:"hidden",capture:"environment"})]})},pe=({photoType:t,step:a,capturedPhotos:s,userGender:n,isFaceScan:r=!1,isValidating:o,showSuccessAnimation:i,isProgressInitialized:d,onRetake:u,onCameraClick:l,onGalleryClick:f,fileInputRef:h,onFileSelect:g})=>{const p=s.find(m=>m.type===t),w=t==="front"&&a==="front-photo"||t==="profile"&&a==="profile-photo",x=r||t==="front"?"var(--color-plasma-cyan)":"#A855F7",A=t==="front"?j.User:j.RotateCcw,D=t==="front"?"Photo de face":"Photo de profil";return e.jsx(b.div,{"data-photo-type":t,initial:{opacity:0,x:t==="front"?-20:20},animate:{opacity:1,x:0},transition:{duration:.6,delay:t==="front"?0:.1,ease:[.25,.1,.25,1]},className:"w-full max-w-2xl",children:e.jsxs(U,{className:`p-6 h-full relative photo-card photo-card--${t}`,style:{background:`radial-gradient(circle at 30% 20%, color-mix(in srgb, ${x} 8%, transparent) 0%, transparent 60%), var(--glass-opacity-base)`,borderColor:`color-mix(in srgb, ${x} 25%, transparent)`,borderRadius:"24px",overflow:"hidden"},children:[e.jsxs("div",{className:"flex items-start justify-between mb-6 min-h-[3rem]",children:[e.jsxs("h4",{className:"text-white text-lg font-semibold flex items-center gap-3",children:[e.jsx("div",{className:"glowing-icon-container",style:{"--icon-color":x},children:e.jsx(k,{Icon:A,size:16,style:{color:x,filter:`drop-shadow(0 0 8px ${x}80) drop-shadow(0 0 16px ${x}60)`},variant:"pure"})}),e.jsx("span",{className:"glowing-title-text",children:D})]}),e.jsx(We,{photo:p,photoType:t,isValidating:o})]}),p?e.jsx(Xe,{photo:p,showSuccessAnimation:i===t,onRetake:()=>u(t)}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(He,{type:t,isFaceScan:r,gender:n}),w&&e.jsx(Ye,{photoType:t,isValidating:o,isProgressInitialized:d,onCameraClick:l,onGalleryClick:f,fileInputRef:h,onFileSelect:g}),!w&&!p&&e.jsx("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(k,{Icon:j.Clock,size:24,className:"text-white/60"}),e.jsx("p",{className:"text-sm text-white/60",children:t==="profile"?"Complétez d'abord la photo de face":"En attente"})]})})]})]})})},se={gentle:[.25,.1,.25,1],spring:[.175,.885,.32,1.275],smooth:[.16,1,.3,1]},ae={fast:.3,medium:.6,slow:1.2};function Qe(t="medium"){return Z()==="reduced"?{shouldAnimate:!1,duration:.1,ease:"linear",particleCount:0}:{simple:{shouldAnimate:!0,duration:ae.fast,ease:se.gentle,particleCount:2},medium:{shouldAnimate:!0,duration:ae.medium,ease:se.smooth,particleCount:3},complex:{shouldAnimate:!0,duration:ae.slow,ease:se.spring,particleCount:5}}[t]}function me(t){const a=[];if(!t.type.startsWith("image/"))return a.push("File is not an image"),{isValid:!1,issues:a};const s=15*1024*1024;return t.size>s?(a.push("File is too large (max 15MB)"),{isValid:!1,issues:a}):t.size<1024?(a.push("File is too small (min 1KB)"),{isValid:!1,issues:a}):(!t.type.includes("jpeg")&&!t.type.includes("jpg")&&a.push("JPEG format is recommended for better compatibility"),{isValid:a.length===0||!a.some(n=>n.includes("not an image")||n.includes("too large")||n.includes("too small")),issues:a})}async function Je(t){return new Promise(a=>{const s=[],n=new Image,r=document.createElement("canvas"),o=r.getContext("2d");n.onload=()=>{try{(n.width<200||n.height<200)&&s.push("Image resolution is too low (minimum 200x200)"),(n.width>4e3||n.height>4e3)&&s.push("Image resolution is very high and will be optimized");const i=n.width/n.height;(i<.3||i>3)&&s.push("Unusual aspect ratio detected"),o&&(r.width=Math.min(n.width,100),r.height=Math.min(n.height,100),o.drawImage(n,0,0,r.width,r.height),o.getImageData(0,0,r.width,r.height).data.some(l=>l>0)||s.push("Image appears to be corrupted or blank")),a({isValid:!s.some(d=>d.includes("corrupted")||d.includes("too low")),issues:s})}catch{s.push("Failed to analyze image quality"),a({isValid:!1,issues:s})}},n.onerror=()=>{s.push("Image file is corrupted or invalid"),a({isValid:!1,issues:s})},n.src=URL.createObjectURL(t)})}async function Ze(t,a=2048,s=.8,n="image/jpeg"){const r=Math.round(t.size/1024);return r<=a?(c.debug("PHOTO_UTILS","No compression needed",{fileName:t.name,originalSizeKB:r,maxSizeKB:a}),{compressedFile:t,compressionApplied:!1,originalSizeKB:r,finalSizeKB:r}):new Promise((o,i)=>{const d=document.createElement("canvas"),u=d.getContext("2d"),l=new Image;l.onload=()=>{try{let{width:f,height:h}=l;const g=1920;if(f>g||h>g){const p=Math.min(g/f,g/h);f=Math.round(f*p),h=Math.round(h*p)}d.width=f,d.height=h,u?(u.drawImage(l,0,0,f,h),d.toBlob(p=>{if(p){const w=new File([p],t.name,{type:n,lastModified:Date.now()}),x=Math.round(p.size/1024);c.debug("PHOTO_UTILS","Image compressed",{fileName:t.name,originalSizeKB:r,finalSizeKB:x,compressionApplied:!0,outputMimeType:n}),o({compressedFile:w,compressionApplied:!0,originalSizeKB:r,finalSizeKB:x})}else i(new Error("Failed to create blob after compression"))},n,s)):i(new Error("Failed to get canvas context for compression"))}catch(f){i(f)}},l.onerror=()=>i(new Error("Failed to load image for compression")),l.src=URL.createObjectURL(t)})}async function et(t){c.info("🔍 [PhotoProcessing] Starting photo processing",{fileName:t.name,fileSize:Math.round(t.size/1024),fileType:t.type});try{const a=t.type.includes("jpeg")||t.type.includes("jpg")?"image/jpeg":t.type.includes("png")?"image/png":"image/jpeg";c.debug("PHOTO_UTILS","Determined output MIME type",{originalType:t.type,outputMimeType:a});const s=await Ze(t,2048,.85,a),n=await ue(s.compressedFile,a),r=new File([n],t.name,{type:a,lastModified:Date.now()}),o=Math.round(r.size/1024),i=tt(s.originalSizeKB,o,s.compressionApplied);return c.info("✅ [PhotoProcessing] Photo processing completed",{originalSizeKB:s.originalSizeKB,finalSizeKB:o,compressionApplied:s.compressionApplied,qualityScore:i,finalMimeType:a}),{processedFile:r,validationReport:{originalSizeKB:s.originalSizeKB,finalSizeKB:o,compressionApplied:s.compressionApplied,qualityScore:i}}}catch(a){c.error("❌ [PhotoProcessing] Photo processing failed",{error:a instanceof Error?a.message:String(a)});try{const s=t.type.startsWith("image/")?t.type:"image/jpeg",n=await ue(t,s),r=new File([n],t.name,{type:s,lastModified:Date.now()}),o=Math.round(t.size/1024),i=Math.round(r.size/1024);return c.warn("PHOTO_UTILS","Photo processing fallback executed",{fileName:t.name,originalSizeKB:o,finalSizeKB:i,fallbackMimeType:s}),{processedFile:r,validationReport:{originalSizeKB:o,finalSizeKB:i,compressionApplied:!1,qualityScore:.7}}}catch{throw new Error(`Photo processing failed: ${a instanceof Error?a.message:String(a)}`)}}}function tt(t,a,s){let n=1;if(s){const r=a/t;r<.3?n-=.3:r<.5?n-=.2:n-=.1}return a<100?n-=.2:a>3e3&&(n-=.1),Math.max(.1,Math.min(1,n))}async function ue(t,a="image/jpeg"){return new Promise((s,n)=>{const r=document.createElement("canvas"),o=r.getContext("2d"),i=new Image;i.onload=()=>{r.width=i.width,r.height=i.height,o?(o.drawImage(i,0,0),r.toBlob(d=>{d?(c.debug("PHOTO_UTILS","EXIF stripped",{fileName:t.name,outputMimeType:a}),s(d)):n(new Error("Failed to create blob from canvas after EXIF stripping"))},a,.95)):n(new Error("Failed to get canvas context for EXIF stripping"))},i.onerror=()=>n(new Error("Failed to load image for EXIF stripping")),i.src=URL.createObjectURL(t)})}async function st(t,a,s,n){const r=new Date().toISOString();c.info("📸 [PhotoCapture] Creating capture report",{type:a,fileSize:Math.round(t.size/1024),isValid:s.isValid,confidence:Math.round(s.confidence*100)}),c.info("🎨 [PhotoCapture] Skin tone extraction delegated to Vision AI",{type:a,philosophy:"vision_ai_exclusive_extraction"});const i={timestamp:r,photoType:a,fileInfo:{name:t.name,size:t.size,type:t.type,lastModified:t.lastModified},validation:s,quality:s.qualityMetrics||{blur_score:.5,brightness:.5,contrast:.5,sharpness:.5},content:s.contentMetrics||{person_detected:!1,face_detected:!1,pose_quality:.5},scale:s.scaleMetrics||{person_size_ratio:.5,distance_score:.5},skinTone:void 0,streamInfo:void 0,userId:null};return c.info("📸 [PhotoCapture] Capture report created",{type:a,hasValidation:!!s,hasStreamInfo:!1,philosophy:"vision_ai_exclusive_skin_tone_extraction"}),i}const at=({isCapturing:t,onCapture:a,onClose:s,onSwitchCamera:n})=>e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 sm:p-12 bg-gradient-to-t from-black/95 via-black/70 to-transparent",children:[e.jsxs("div",{className:"flex items-center justify-between max-w-lg mx-auto",children:[e.jsx(b.button,{onClick:s,className:"w-16 h-16 sm:w-18 sm:h-18 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shadow-lg",whileHover:{scale:1.05},whileTap:{scale:.95},initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2,duration:.5},children:e.jsx(k,{Icon:j.X,size:26,className:"text-white"})}),e.jsxs(b.button,{onClick:a,disabled:t,className:"w-24 h-24 sm:w-28 sm:h-28 rounded-full border-4 border-white/30 flex items-center justify-center relative shadow-2xl",style:{background:t?"linear-gradient(135deg, var(--brand-warning), var(--brand-warning-dark))":"linear-gradient(135deg, var(--brand-primary), var(--brand-accent))",boxShadow:t?"0 0 30px color-mix(in srgb, var(--brand-warning) 60%, transparent), 0 8px 32px rgba(0,0,0,0.4)":"0 0 30px color-mix(in srgb, var(--brand-primary) 60%, transparent), 0 8px 32px rgba(0,0,0,0.4)"},whileHover:{scale:1.05},whileTap:{scale:.92},initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:.1,duration:.6,type:"spring",stiffness:300},children:[t?e.jsxs(e.Fragment,{children:[e.jsx(b.div,{className:"w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-white",animate:{scale:[1,.7,1]},transition:{duration:.6,repeat:1/0,ease:"easeInOut"}}),e.jsx(b.div,{className:"absolute inset-0 rounded-full border-4 border-brand-warning/60",animate:{scale:[1,1.3,1],opacity:[.8,.2,.8]},transition:{duration:.8,repeat:1/0}})]}):e.jsx("div",{className:"w-18 h-18 sm:w-20 sm:h-20 rounded-full shadow-inner bg-white"}),!t&&e.jsx(b.div,{className:"absolute inset-0 rounded-full border-2 border-brand-accent/40",animate:{scale:[1,1.1,1],opacity:[.5,.8,.5]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsx(b.button,{onClick:n,className:"w-16 h-16 sm:w-18 sm:h-18 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shadow-lg",whileHover:{scale:1.05},whileTap:{scale:.95},initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3,duration:.5},children:e.jsx(k,{Icon:j.RotateCcw,size:26,className:"text-white"})})]}),e.jsx(b.div,{className:"text-center mt-8",initial:{opacity:0},animate:{opacity:1},transition:{delay:.8,duration:.6},children:e.jsx("p",{className:"text-white/80 text-lg font-medium",children:t?"Capture en cours...":"Appuyez pour capturer"})})]}),nt=({isAnyPhotoValidating:t,onProceedToProcessing:a,glassClick:s})=>{const n=Z(),r=()=>{t||(s(),a())};return e.jsxs(U,{className:"glass-card refined-glass-cta p-8 text-center relative overflow-visible rounded-3xl",children:[e.jsx("div",{className:"refined-inner-glow absolute inset-0 rounded-[inherit] pointer-events-none"}),e.jsx("div",{className:"refined-glass-texture absolute inset-0 rounded-[inherit] pointer-events-none"}),e.jsxs("div",{className:"relative z-10 space-y-8",children:[e.jsxs(b.div,{className:"flex items-center justify-center gap-4 mb-2",initial:n?{opacity:0,scale:.9}:!1,animate:{opacity:1,scale:1},transition:{duration:.5,delay:.15,ease:[.25,.1,.25,1]},children:[e.jsxs("div",{className:"refined-success-icon-container relative",children:[e.jsx("div",{className:"refined-success-halo absolute inset-0"}),e.jsx("div",{className:"refined-success-icon size-12 rounded-full grid place-items-center relative z-10",children:e.jsx(k,{Icon:j.Check,size:24,className:"text-white"})}),e.jsx("div",{className:"refined-success-ring-1 absolute inset-0 rounded-full"}),e.jsx("div",{className:"refined-success-ring-2 absolute inset-0 rounded-full"})]}),e.jsx(b.span,{className:"refined-success-text text-xl font-bold",initial:n?{opacity:0,x:-16}:!1,animate:{opacity:1,x:0},transition:{duration:.45,delay:.3},children:"Photos capturées avec succès !"})]}),e.jsx(b.p,{className:"refined-description text-lg leading-relaxed max-w-md mx-auto",initial:n?{opacity:0,y:10}:!1,animate:{opacity:1,y:0},transition:{duration:.45,delay:.25},children:"Vos photos de face et de profil sont prêtes pour l’analyse IA avancée."}),e.jsxs(b.button,{"data-launch-analysis":!0,onClick:r,className:"refined-cta-button w-full relative overflow-hidden rounded-full py-3 glass-focus hover-lift",disabled:t,"aria-busy":t,"aria-live":"polite",whileHover:n?{scale:1.02,y:-2}:void 0,whileTap:n?{scale:.98}:void 0,initial:n?{opacity:0,y:16}:!1,animate:{opacity:1,y:0},transition:{duration:.5,delay:.35,ease:[.25,.1,.25,1]},type:"button",children:[e.jsx("span",{className:"refined-cta-glow absolute inset-0 pointer-events-none rounded-[inherit]"}),e.jsxs("span",{className:"refined-cta-content relative z-10 flex items-center justify-center gap-3",children:[e.jsx(b.span,{className:"refined-cta-icon",animate:t?{rotate:360}:void 0,transition:{duration:2,repeat:1/0,ease:"linear"},children:e.jsx(k,{Icon:t?j.Loader2:j.Zap,size:20,className:"text-white"})}),e.jsx("span",{className:"refined-cta-text text-lg font-bold",children:t?"Analyse en cours…":"Lancer l’analyse IA"})]})]})]})]})},rt=({step:t,capturedPhotos:a,onPhotoCapture:s,onRetake:n,onBack:r,onProceedToProcessing:o,isProcessingInProgress:i=!1,isFaceScan:d=!1,userGender:u,isProgressInitialized:l})=>{const[f,h]=v.useState(!1),[g,p]=v.useState(!1),[w,x]=v.useState(!1),[A,D]=v.useState(null),m=v.useRef(null),{click:_,success:S,error:C,glassClick:B}=ne(),{showToast:I}=fe(),N=Z(),R=Qe("medium"),y=t==="front-photo"?"front":"profile",K=a.find(T=>T.type==="front"),P=a.find(T=>T.type==="profile"),F=[{id:"tracking",icon:"TrendingUp",color:"#22C55E",title:"Suivi Précis",description:"Détectez les changements morphologiques subtils"},{id:"avatar-3d",icon:"Eye",color:"#8B5CF6",title:"Avatar 3D Réaliste",description:"Visualisez votre morphologie en 3 dimensions"},{id:"recommendation",icon:"Calendar",color:"#3B82F6",title:"Scan 2x/mois",description:"Recommandation pour un suivi optimal"}],M=v.useCallback(async T=>{p(!0),x(!0),c.info("🔍 [PhotoCapture] Starting photo processing",{photoType:y,fileSize:Math.round(T.size/1024),fileType:T.type,fileName:T.name,timestamp:Date.now()});try{const E=me(T);if(!E.isValid){const z=E.issues.filter(H=>H.includes("not an image")||H.includes("too large")||H.includes("too small"));if(z.length>0){I({type:"error",title:"Format de fichier invalide",message:z[0],duration:4e3}),C();return}else I({type:"warning",title:"Format non optimal",message:"Le format JPEG est recommandé pour une meilleure compatibilité",duration:3e3})}const{processedFile:L,validationReport:O}=await et(T);if(c.info("🔍 [PhotoCapture] Photo processing completed",{photoType:y,validationReport:O,processingSuccess:!0}),O.compressionApplied){const z=((O.originalSizeKB-O.finalSizeKB)/O.originalSizeKB*100).toFixed(0);I({type:"info",title:"Photo optimisée",message:`Taille réduite de ${z}% pour une meilleure compatibilité`,duration:2e3})}let V;try{V={isValid:!0,issues:[],retakeReasons:[],confidence:.8,qualityMetrics:{blur_score:.7,brightness:.6,exposure_ok:!0,noise_score:.3},contentMetrics:{single_person:!0,pose_ok:!0,face_detected:!0,face_bbox_norm:[.3,.1,.7,.4]},scaleMetrics:{pixel_per_cm_estimate:3.5,method:"face-heuristic"}}}catch(z){c.warn("Worker validation failed, using permissive fallback:",z),V={isValid:!0,issues:["Validation simplifiée - Photo acceptée"],retakeReasons:[],confidence:.8,qualityMetrics:{blur_score:.7,brightness:.6,exposure_ok:!0,noise_score:.3},contentMetrics:{single_person:!0,pose_ok:!0,face_detected:!0,face_bbox_norm:[.3,.1,.7,.4]},scaleMetrics:{pixel_per_cm_estimate:3.5,method:"face-heuristic"}}}const W=await st(L,y,V,void 0),re=["multiple_people","no_person"];if(V.retakeReasons?.some(z=>re.includes(z))){const H=V.retakeReasons.find(be=>re.includes(be))==="multiple_people"?"Une seule personne doit être visible sur la photo":"Aucune personne détectée - Assurez-vous d’être visible dans le cadre";I({type:"error",title:"Photo non utilisable",message:H,duration:4e3}),C();return}D(y);const{setCaptureProgress:ie}=Q.getState();ie(y==="front"?"front_taken":"done");const ye=V.isValid?"Photo capturée avec succès":"Photo capturée - Qualité à améliorer",_e=V.isValid?"success":"warning";setTimeout(async()=>{await s(L,y,W),D(null),y==="front"&&setTimeout(()=>{document.querySelector('[data-photo-type="profile"]')?.scrollIntoView({behavior:"smooth",block:"center"})},500),y==="profile"&&setTimeout(()=>{document.querySelector("[data-launch-analysis]")?.scrollIntoView({behavior:"smooth",block:"center"})},800)},1e3),I({type:_e,title:ye,message:V.isValid?"Excellente qualité détectée":`${V.issues.length} point(s) d’amélioration détecté(s). Vous pouvez continuer ou reprendre la photo.`,duration:2e3}),V.isValid&&S()}catch(E){c.error(`Photo processing error: ${E instanceof Error?E.message:String(E)}`,E),I({type:"error",title:"Erreur de traitement",message:"Impossible de traiter la photo",duration:4e3}),C()}finally{p(!1),x(!1),m.current&&(m.current.value="")}},[y,s,I,S,C,a]),$=v.useCallback(async T=>{const E=T.target.files?.[0];if(!E)return;const L=me(E);if(!L.isValid){const O=L.issues.filter(V=>V.includes("not an image")||V.includes("too large"));if(O.length>0){I({type:"error",title:"Fichier invalide",message:O[0],duration:4e3});return}}E.size>8*1024*1024&&I({type:"warning",title:"Fichier volumineux",message:"La photo sera automatiquement optimisée pour un traitement plus rapide",duration:2e3});try{const O=await Je(E);if(!O.isValid&&O.issues.some(W=>W.includes("corrupted")||W.includes("too small"))){I({type:"error",title:"Qualité d’image insuffisante",message:O.issues[0],duration:4e3});return}}catch(O){c.warn("🔍 [PhotoCapture] Quality validation failed, continuing with processing",{error:O instanceof Error?O.message:"Unknown error"})}if(E.size>15*1024*1024){I({type:"error",title:"Fichier trop volumineux",message:"La photo doit faire moins de 15MB",duration:4e3});return}await M(E)},[M,I]),G=v.useCallback(async T=>{h(!1),await M(T)},[M]);return e.jsxs("div",{className:"body-scan-page twinforge visionos-26 space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(b.div,{"data-photo-type":"front",initial:N?{opacity:0,x:-20}:!1,animate:{opacity:1,x:0},transition:{duration:R.duration,ease:R.ease},children:e.jsx(pe,{photoType:"front",step:t,capturedPhotos:a,userGender:u,isFaceScan:d,isValidating:g,showSuccessAnimation:A,isProgressInitialized:l,onRetake:n,onCameraClick:()=>h(!0),onGalleryClick:()=>m.current?.click(),fileInputRef:m,onFileSelect:$})}),e.jsx(b.div,{"data-photo-type":"profile",initial:N?{opacity:0,x:20}:!1,animate:{opacity:1,x:0},transition:{duration:R.duration,delay:.1,ease:R.ease},children:e.jsx(pe,{photoType:"profile",step:t,capturedPhotos:a,userGender:u,isFaceScan:d,isValidating:g,showSuccessAnimation:A,isProgressInitialized:l,onRetake:n,onCameraClick:()=>h(!0),onGalleryClick:()=>m.current?.click(),fileInputRef:m,onFileSelect:$})})]}),e.jsx(J,{children:w&&e.jsx(b.div,{initial:N?{opacity:0,y:20}:!1,animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.6,ease:[.25,.1,.25,1]},"aria-live":"polite",children:e.jsx(U,{className:"glass-card refined-glass-info p-6 text-center rounded-3xl overflow-hidden",children:e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("span",{className:"refined-spinner refined-spinner--cyan size-8","aria-hidden":"true"}),e.jsx("span",{className:"text-secondary text-base font-medium",children:"Validation en cours…"})]})})})}),e.jsx(J,{children:a.length===2&&!w&&e.jsx(b.div,{className:"ready-for-processing-entrance",initial:N?{opacity:0,y:30,scale:.95}:!1,animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-20,scale:.95},transition:{duration:.8,ease:[.25,.1,.25,1]},children:e.jsx(nt,{isAnyPhotoValidating:w,onProceedToProcessing:o,glassClick:B})})}),t==="front-photo"&&e.jsx(Se,{benefits:F,themeColor:"#8B5CF6",title:"Pourquoi scanner mon corps ?"}),f&&e.jsx(at,{photoType:y,onCapture:G,onClose:()=>h(!1)}),e.jsx("input",{ref:m,type:"file",accept:"image/*",onChange:$,className:"hidden",capture:"environment"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(b.button,{onClick:()=>{_(),r()},className:"btn-glass--secondary-nav px-6 py-3 rounded-full",whileHover:N?{scale:1.02}:void 0,whileTap:N?{scale:.98}:void 0,initial:N?{opacity:0,x:-20}:!1,animate:{opacity:1,x:0},transition:{duration:.5,delay:.2},children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(k,{Icon:j.ArrowLeft,size:16}),e.jsx("span",{children:"Retour"})]})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:`text-caption text-white/60 ${R.shouldAnimate?"progress-text-pulse":""}`,children:K&&P?"Photos capturées":t==="front-photo"?"Étape 1 sur 2":"Étape 2 sur 2"})}),e.jsx("div",{className:"w-24"})]})]})},it=({capturedPhotos:t,currentProgress:a,currentMessage:s,currentSubMessage:n})=>{const o=Z()==="full",i=v.useMemo(()=>t.find(m=>m.type==="front"),[t]),d=v.useMemo(()=>t.find(m=>m.type==="profile"),[t]);if(!i||!d)return c.warn("IMMERSIVE_PHOTO_ANALYSIS","Photos manquantes pour l’analyse immersive",{hasFrontPhoto:!!i,hasProfilePhoto:!!d,totalPhotos:t.length}),null;const u=v.useMemo(()=>[{x:50,y:12,label:"Tête"},{x:40,y:25,label:"Épaule G"},{x:60,y:25,label:"Épaule D"},{x:50,y:45,label:"Taille"},{x:45,y:65,label:"Hanche G"},{x:55,y:65,label:"Hanche D"},{x:45,y:90,label:"Pied G"},{x:55,y:90,label:"Pied D"}],[]),l=v.useMemo(()=>[{x:50,y:15,label:"Tête"},{x:45,y:35,label:"Épaule"},{x:50,y:50,label:"Taille"},{x:48,y:70,label:"Hanche"},{x:50,y:90,label:"Pied"}],[]),[f,h]=v.useState([]);v.useEffect(()=>{if(!o)return;const m=()=>{const S=Array.from({length:3},(C,B)=>({x:Math.random()*80+10,y:Math.random()*80+10,intensity:Math.random()*.8+.2,id:`zone-${Date.now()}-${B}`}));h(S)};m();const _=setInterval(m,2e3);return()=>clearInterval(_)},[o]);const g=v.useMemo(()=>Array.from({length:6},(m,_)=>{const S=12+Math.random()*76,C=70+Math.random()*25,B=(Math.random()-.5)*30,I=-120-Math.random()*120,N=3+Math.random()*3,R=8+Math.round(Math.random()*6),y=_*.3;return{id:`p-${_}`,x:S,y:C,dx:B,dy:I,speed:N,size:R,delay:y}}),[]),p={opacity:0,scale:.94},w={opacity:1,scale:1},x=[.25,.1,.25,1],A="var(--color-body-scan-primary)",D=[{icon:"Scan",label:"Détection Morphologique",sublabel:"Extraction des points clés corporels",color:"#8B5CF6",activeThreshold:10},{icon:"Zap",label:"Analyse IA Avancée",sublabel:"Matching archetypes et affinement",color:"#A855F7",activeThreshold:40},{icon:"Box",label:"Génération 3D",sublabel:"Construction avatar personnalisé",color:"#C084FC",activeThreshold:70}];return e.jsxs("div",{className:"immersive-analysis-container twinforge visionos-26 space-y-8 -mt-2",style:{"--analysis-color":A},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(b.div,{initial:p,animate:w,transition:{duration:.7,ease:x},children:e.jsxs(U,{className:"glass-card analysis-photo-card analysis-photo-card--front p-4 relative overflow-hidden rounded-2xl border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center breathing-icon",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, var(--color-plasma-cyan) 35%, transparent), color-mix(in srgb, var(--color-plasma-cyan) 25%, transparent))
                    `,border:"3px solid color-mix(in srgb, var(--color-plasma-cyan) 70%, transparent)",boxShadow:`
                      0 0 40px color-mix(in srgb, var(--color-plasma-cyan) 60%, transparent),
                      0 0 80px color-mix(in srgb, var(--color-plasma-cyan) 40%, transparent),
                      0 0 120px color-mix(in srgb, var(--brand-primary) 30%, transparent),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -2px 0 rgba(0,0,0,0.2)
                    `,backdropFilter:"blur(20px) saturate(170%)",WebkitBackdropFilter:"blur(20px) saturate(170%)","--icon-color":"var(--color-plasma-cyan)"},children:e.jsx(k,{Icon:j.User,size:16,style:{color:"var(--color-plasma-cyan)"},variant:"pure"})}),"Photo de Face"]}),e.jsxs("div",{className:"analysis-status-badge",children:[e.jsx("div",{className:"w-2 h-2 rounded-full status-dot"}),e.jsx("span",{className:"text-xs font-medium",children:"Analyse IA"})]})]}),e.jsxs("figure",{className:"relative aspect-[3/4] rounded-xl overflow-hidden bg-black/20",role:"group","aria-label":"Analyse de la photo de face",children:[e.jsx("img",{src:i.url,alt:"Photo de face en cours d’analyse",className:"w-full h-full object-contain analysis-photo",loading:"eager",decoding:"async",fetchpriority:"high"}),o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"scan-line-vertical","aria-hidden":"true"}),e.jsx("div",{className:"analysis-grid","aria-hidden":"true",children:Array.from({length:16}).map((m,_)=>e.jsx("div",{className:"grid-cell",style:{"--cell-index":_},"aria-hidden":"true"},_))}),e.jsx("div",{className:"body-keypoints body-keypoints--front","aria-hidden":"true",children:u.map((m,_)=>e.jsx("div",{className:"keypoint",style:{left:`${m.x}%`,top:`${m.y}%`,"--keypoint-index":_}},m.label))}),f.map(m=>e.jsx("div",{className:"analysis-zone",style:{left:`${m.x}%`,top:`${m.y}%`,"--zone-intensity":m.intensity},"aria-hidden":"true"},m.id)),e.jsx("div",{className:"ai-focus-overlay ai-focus-overlay--front","aria-hidden":"true"})]}),e.jsx("figcaption",{className:"sr-only",children:"Repérage des articulations et analyse de surface"})]})]})}),e.jsx(b.div,{initial:p,animate:w,transition:{duration:.7,delay:.15,ease:x},children:e.jsxs(U,{className:"glass-card analysis-photo-card analysis-photo-card--profile p-4 relative overflow-hidden rounded-2xl border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center breathing-icon",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, #A855F7 35%, transparent), color-mix(in srgb, #A855F7 25%, transparent))
                    `,border:"3px solid color-mix(in srgb, #A855F7 70%, transparent)",boxShadow:`
                      0 0 40px color-mix(in srgb, #A855F7 60%, transparent),
                      0 0 80px color-mix(in srgb, #A855F7 40%, transparent),
                      0 0 120px color-mix(in srgb, var(--brand-primary) 30%, transparent),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -2px 0 rgba(0,0,0,0.2)
                    `,backdropFilter:"blur(20px) saturate(170%)",WebkitBackdropFilter:"blur(20px) saturate(170%)","--icon-color":"#A855F7"},children:e.jsx(k,{Icon:j.RotateCcw,size:16,style:{color:"#A855F7"},variant:"pure"})}),"Photo de Profil"]}),e.jsxs("div",{className:"analysis-status-badge",children:[e.jsx("div",{className:"w-2 h-2 rounded-full status-dot"}),e.jsx("span",{className:"text-xs font-medium",children:"Analyse IA"})]})]}),e.jsxs("figure",{className:"relative aspect-[3/4] rounded-xl overflow-hidden bg-black/20",role:"group","aria-label":"Analyse de la photo de profil",children:[e.jsx("img",{src:d.url,alt:"Photo de profil en cours d’analyse",className:"w-full h-full object-contain analysis-photo",loading:"lazy",decoding:"async"}),o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"scan-line-horizontal","aria-hidden":"true"}),e.jsx("div",{className:"analysis-grid","aria-hidden":"true",children:Array.from({length:16}).map((m,_)=>e.jsx("div",{className:"grid-cell",style:{"--cell-index":_},"aria-hidden":"true"},_))}),e.jsx("div",{className:"body-keypoints body-keypoints--profile","aria-hidden":"true",children:l.map((m,_)=>e.jsx("div",{className:"keypoint",style:{left:`${m.x}%`,top:`${m.y}%`,"--keypoint-index":_}},m.label))}),f.map(m=>e.jsx("div",{className:"analysis-zone",style:{left:`${m.x}%`,top:`${m.y}%`,"--zone-intensity":m.intensity},"aria-hidden":"true"},m.id)),e.jsx("div",{className:"ai-focus-overlay ai-focus-overlay--profile","aria-hidden":"true"})]}),e.jsx("figcaption",{className:"sr-only",children:"Analyse latérale et maillage de contrôle"})]})]})})]}),e.jsx(we,{modules:D,progress:a,themeColor:"#8B5CF6",reduceMotion:!o,className:"mt-8"}),o&&e.jsx("div",{className:"data-flow-container","aria-hidden":"true",children:g.map((m,_)=>e.jsx("div",{className:"data-particle",style:{left:`${m.x}%`,top:`${m.y}%`,"--particle-index":_,"--data-particle-speed":`${m.speed}s`,"--particle-dx":`${m.dx}%`,"--particle-dy":`${m.dy}px`,"--data-particle-size":`${m.size}px`,animationDelay:`${m.delay}s`}},m.id))})]})},ot=()=>{const t=he(),{startProgress:a,progress:s,message:n,subMessage:r,isActive:o,steps:i,currentStep:d}=Q(),u=v.useRef(null),l=v.useRef(!1),{currentStep:f,capturedPhotos:h,setCapturedPhotos:g,scanResults:p,showValidationResults:w,validationSummary:x,userId:A,isProfileComplete:D,setCurrentStep:m,onProceedToProcessing:_,isProcessing:S}=Ge({scanId:u.current??void 0});oe.useEffect(()=>{window.scrollTo({top:0,behavior:"instant"});const P=document.getElementById("main-content");P&&P.scrollTo({top:0,behavior:"instant"})},[f]);const C=[{id:"capture",title:"Capture Photographique",subtitle:"Face et profil",icon:"Camera",color:"#8B5CF6"},{id:"processing",title:"Analyse IA Avancée",subtitle:"Traitement en cours",icon:"Scan",color:"#8B5CF6"},{id:"celebration",title:"Données Traitées",subtitle:"Préparation du rendu 3D",icon:"Check",color:"#8B5CF6"},{id:"avatar",title:"Avatar 3D",subtitle:"Votre reflet numérique",icon:"Eye",color:"#8B5CF6"}];v.useEffect(()=>{if(l.current)return;l.current=!0,u.current||(u.current=ve());const P=u.current,{resetProgress:F}=Q.getState();F(),a(C,P,"body"),c.info("BODY_SCAN_CAPTURE","Component initialized with scanId",{clientScanId:P,flowType:"body",isDevelopment:!1,timestamp:new Date().toISOString()})},[a]);const B=oe.useCallback(async(P,F,M)=>{try{const $=URL.createObjectURL(P);g(G=>{const E=[...G.filter(L=>L.type!==F),{file:P,url:$,type:F,validationResult:{isValid:M.validation?.isValid??!1,issues:M.validation?.issues??[],retakeReasons:M.validation?.retakeReasons??[],confidence:M.validation?.confidence??0},captureReport:M}];return c.info("BODY_SCAN_CAPTURE","Photo captured successfully",{clientScanId:u.current,photoType:F,totalPhotos:E.length,isValid:E.find(L=>L.type===F)?.validationResult?.isValid}),E}),F==="front"&&m("profile-photo")}catch($){c.error("BODY_SCAN_CAPTURE","Photo capture error",{error:$,clientScanId:u.current,photoType:F})}},[g,m]),I=P=>{g(F=>F.filter(M=>M.type!==P)),m(P==="front"?"front-photo":"profile-photo"),c.info("BODY_SCAN_CAPTURE","Photo retake requested",{clientScanId:u.current,photoType:P})};if(A===null)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ce,{icon:"Shield",title:"Authentification requise",subtitle:"Connectez-vous pour accéder au scanner corporel",circuit:"body-scan"}),e.jsxs(U,{className:"text-center p-8",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-blue-500/20 flex items-center justify-center",children:e.jsx(k,{Icon:j.Shield,size:24,className:"text-red-400"})}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Authentification requise"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Vous devez être connecté avec un compte valide pour utiliser le scanner corporel"})]})]});if(!D)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ce,{icon:"User",title:"Profil incomplet",subtitle:"Complétez votre profil pour accéder au scanner corporel",circuit:"body-scan"}),e.jsxs(U,{className:"text-center p-8",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-yellow-500/20 flex items-center justify-center",children:e.jsx(k,{Icon:j.User,size:24,className:"text-yellow-400"})}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Profil incomplet"}),e.jsx("p",{className:"text-white/60 text-sm mb-4",children:"Veuillez renseigner votre sexe, taille et poids dans votre profil"}),e.jsx("button",{onClick:()=>t("/profile#identity"),className:"btn-glass--primary px-6 py-3 rounded-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(k,{Icon:j.User,size:16}),e.jsx("span",{children:"Compléter mon profil"})]})})]})]});const N=()=>w&&x?"validation":f==="processing"?"processing-stable":f,R=(P,F,M)=>{if(w&&x)return e.jsx(ee,{fallback:e.jsx(te,{}),children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h3",{className:"text-white font-semibold mb-4",children:"Validation en cours..."}),e.jsx("p",{className:"text-white/60",children:"Les résultats de validation seront bientôt disponibles."})]})});switch(f){case"front-photo":case"profile-photo":return e.jsx(rt,{step:f,capturedPhotos:h,onPhotoCapture:B,onRetake:$=>{I($),$==="profile"&&g(G=>G.filter(T=>T.type==="front"))},onBack:()=>{f==="profile-photo"?(m("front-photo"),g($=>$.filter(G=>G.type==="front"))):t("/")},onProceedToProcessing:_,isProcessingInProgress:S,isProgressInitialized:o});case"processing":return e.jsx(ee,{fallback:e.jsx(te,{}),children:e.jsx(it,{capturedPhotos:h,currentProgress:P,currentMessage:F,currentSubMessage:M})});case"results":return e.jsx(ee,{fallback:e.jsx(te,{}),children:e.jsxs(U,{className:"text-center p-8",children:[e.jsx(k,{Icon:j.Check,size:48,className:"text-green-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Scan terminé !"}),e.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Votre avatar 3D a été généré avec succès"}),e.jsx("button",{onClick:()=>t("/body-scan/review",{state:{scanResults:p}}),className:"btn-glass--primary px-6 py-3 rounded-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(k,{Icon:j.Eye,size:16}),e.jsx("span",{children:"Voir mon avatar"})]})})]})});default:return e.jsxs(U,{className:"text-center p-8",children:[e.jsx(k,{Icon:j.AlertCircle,size:48,className:"text-red-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Étape inconnue"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Une erreur est survenue dans le flux de scan"})]})}},y=()=>{switch(f){case"front-photo":case"profile-photo":return"capture";case"processing":return"processing";case"results":return"celebration";default:return"capture"}},K=o&&i.length>0&&f!=="results";return e.jsxs("div",{className:"space-y-6",children:[K&&e.jsx(ke,{steps:i,currentStepId:y(),progress:s,message:n,subMessage:r}),e.jsx(J,{mode:"wait",children:e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:R(s,n,r)},N())})]})},ct=()=>e.jsx(ot,{}),St=()=>e.jsx("div",{className:"max-w-4xl mx-auto mt-4",children:e.jsx(ct,{})});export{St as default};
