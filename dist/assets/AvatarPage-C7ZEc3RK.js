import{e as ne,c as B,R as T,j as e,u as P,r as _,b as oe,cN as le}from"./vendor-BefW7Bxj.js";import{G as v,K as h,S as d,I as o,N as ce,m as de,p as F}from"./ui-components-lrK_WhZu.js";import{u as me}from"./useScrollMemory-DhxRhvvf.js";import{l as y,s as H,a as M,u as K}from"./page-fridge-Cp-W9isk.js";import{A as X}from"./Avatar3DViewer-CWA1lRRG.js";import{a as z}from"./stores-Dp3vmZ5-.js";import{m as A,A as U}from"./motion-BQvLDPOm.js";import{f as J}from"./page-fridge-scan-C62RDC3k.js";import{f as q,a as L}from"./date-utils-BlBdbPk_.js";import"./utils-CUtLAp28.js";import"./supabase-pyFrrmXL.js";import"./signedUrlService-DUv0zqbl.js";import"./normalizeSkinTone-BhVF89EQ.js";function ue(){const{profile:s}=z(),r=ne(),i=s?.userId,a=B({queryKey:["body-scan-data",i],queryFn:async()=>{if(!i)return y.debug("USE_BODY_SCAN_DATA","No user ID available",{philosophy:"no_user_id"}),null;y.info("USE_BODY_SCAN_DATA","Fetching latest body scan",{userId:i,philosophy:"body_scan_fetch_start"});const{data:l,error:n}=await H.from("body_scans").select("*").eq("user_id",i).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(n)throw y.error("USE_BODY_SCAN_DATA","Error fetching body scan",{userId:i,error:n.message,philosophy:"body_scan_fetch_error"}),n;if(!l)return y.info("USE_BODY_SCAN_DATA","No body scan found",{userId:i,philosophy:"no_body_scan"}),null;const c=l.metrics||{},t=l.morph_values||l.morph3d||c.final_shape_params||{},f=l.limb_masses||c.final_limb_masses||{},j=l.skin_tone_map_v2||c.skin_tone||l.skin_tone||null,x=l.resolved_gender||c.resolved_gender||null,b=c.estimate_result?.extracted_data||{},u=l.raw_measurements||b.raw_measurements||{},g=l.weight||u.weight_kg||b.weight_kg||null,I=l.body_fat_percentage||b.estimated_body_fat_perc||null,N=l.bmi||b.estimated_bmi||null,w=l.waist_circumference||u.waist_cm||null;return y.info("USE_BODY_SCAN_DATA","Body scan loaded successfully",{userId:i,scanId:l.id,timestamp:l.timestamp,hasMorphValues:!!t&&Object.keys(t).length>0,morphValuesCount:Object.keys(t).length,morphValuesSource:l.morph_values?"direct_column":c.final_shape_params?"metrics_jsonb":"none",hasLimbMasses:!!f&&Object.keys(f).length>0,limbMassesCount:Object.keys(f).length,limbMassesSource:l.limb_masses?"direct_column":c.final_limb_masses?"metrics_jsonb":"none",hasSkinTone:!!j,skinToneSource:l.skin_tone_map_v2?"v2_direct_column":c.skin_tone?"metrics_jsonb":l.skin_tone?"legacy_column":"none",hasResolvedGender:!!x,resolvedGenderValue:x,resolvedGenderSource:l.resolved_gender?"direct_column":c.resolved_gender?"metrics_jsonb":"none",hasWeight:!!g,weight:g,hasBodyFat:!!I,bodyFatPercentage:I,hasBMI:!!N,bmi:N,hasWaist:!!w,waistCircumference:w,avatarVersion:l.avatar_version||c.avatar_version||"unknown",gltfModelId:l.gltf_model_id||c.gltf_model_id||"unknown",philosophy:"body_scan_loaded_with_extraction"}),{...l,morph_values:t,limb_masses:f,skin_tone:j,resolved_gender:x,weight:g,body_fat_percentage:I,bmi:N,waist_circumference:w,raw_measurements:u}},enabled:!!i,staleTime:5*60*1e3,gcTime:30*60*1e3,refetchOnMount:"always",refetchOnWindowFocus:!1}),m=()=>{y.info("USE_BODY_SCAN_DATA","Invalidating body scan data cache",{userId:i,philosophy:"cache_invalidation"}),r.invalidateQueries({queryKey:["body-scan-data",i]})},p=l=>{y.info("USE_BODY_SCAN_DATA","Updating body scan data cache manually",{userId:i,scanId:l.id,philosophy:"manual_cache_update"}),r.setQueryData(["body-scan-data",i],l)};return{bodyScanData:a.data,isLoading:a.isLoading,isError:a.isError,error:a.error,refetch:a.refetch,invalidateBodyScanData:m,updateBodyScanDataCache:p}}function xe(s,r,i){const a=[],m=i.weight_kg/Math.pow(i.height_cm/100,2),p=s.pearFigure||0,l=Math.abs(s.narrowWaist||0),n=s.bigHips||0;let c;p>.3||n>.3?c={id:"silhouette-curves",title:"Silhouette Harmonieuse",description:"Vos courbes naturelles créent une silhouette équilibrée et féminine",icon:"Heart",color:"#EC4899",value:"Courbes",category:"silhouette"}:l>.3?c={id:"silhouette-athletic",title:"Taille Définie",description:"Votre taille marquée révèle une silhouette athlétique et structurée",icon:"Target",color:"#10B981",value:"Athlétique",category:"silhouette"}:c={id:"silhouette-balanced",title:"Silhouette Équilibrée",description:"Vos proportions naturelles créent une harmonie corporelle parfaite",icon:"Circle",color:"#06B6D4",value:"Équilibrée",category:"silhouette"},a.push(c);const t=s.bodybuilderSize||0,f=s.bodybuilderDetails||0,j=s.emaciated||0;let x;t>.3||f>.3?x={id:"development-muscular",title:"Développement Musculaire",description:"Votre masse musculaire témoigne d'un excellent travail physique",icon:"Zap",color:"#8B5CF6",value:"Développé",category:"development"}:j<-.3?x={id:"development-lean",title:"Composition Lean",description:"Votre physique fin révèle une excellente définition musculaire",icon:"TrendingUp",color:"#F59E0B",value:"Défini",category:"development"}:x={id:"development-natural",title:"Tonus Naturel",description:"Votre développement musculaire naturel offre une base solide",icon:"Activity",color:"#22C55E",value:"Naturel",category:"development"},a.push(x);let b;m<18.5?b={id:"composition-lean",title:"Métabolisme Rapide",description:"Votre composition révèle un métabolisme efficace et dynamique",icon:"Zap",color:"#06B6D4",value:"Dynamique",category:"composition"}:m>=18.5&&m<25?b={id:"composition-optimal",title:"Composition Optimale",description:"Votre équilibre masse/taille se situe dans la zone idéale",icon:"Check",color:"#10B981",value:"Optimale",category:"composition"}:m>=25&&m<30?b={id:"composition-robust",title:"Constitution Robuste",description:"Votre morphologie révèle une constitution solide et puissante",icon:"Shield",color:"#F59E0B",value:"Robuste",category:"composition"}:b={id:"composition-powerful",title:"Potentiel de Transformation",description:"Votre morphologie actuelle offre un excellent potentiel d'évolution",icon:"TrendingUp",color:"#8B5CF6",value:"Évolutif",category:"composition"},a.push(b);const u=s.assLarge||0,g=s.superBreast||0,I=s.breastsSmall||0;let N;return r==="female"&&(g>.2||I>.2)?N={id:"balance-feminine",title:"Féminité Naturelle",description:"Vos attributs féminins créent une harmonie corporelle unique",icon:"Heart",color:"#EC4899",value:"Féminine",category:"balance"}:u>.2?N={id:"balance-curves",title:"Équilibre des Volumes",description:"La répartition de vos volumes crée une silhouette harmonieuse",icon:"Circle",color:"var(--color-body-scan-primary)",value:"Harmonieuse",category:"balance"}:N={id:"balance-symmetrical",title:"Symétrie Parfaite",description:"Votre morphologie présente un équilibre naturel remarquable",icon:"GitCompare",color:"var(--color-body-scan-accent)",value:"Symétrique",category:"balance"},a.push(N),a}const ee=T.memo(({finalShapeParams:s,resolvedGender:r,userProfile:i})=>{const{isPerformanceMode:a}=M(),m=T.useMemo(()=>xe(s,r,i),[s,r,i]);return e.jsx(v,{className:"p-6",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, #06B6D4 8%, transparent) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"color-mix(in srgb, #06B6D4 25%, transparent)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px color-mix(in srgb, #06B6D4 10%, transparent)
        `},children:e.jsxs(h,{className:"slide-enter",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:a?0:.3},children:[e.jsxs("div",{className:"bodyscan-flex-between mb-6",children:[e.jsxs("h4",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #06B6D4 35%, transparent), color-mix(in srgb, #06B6D4 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #06B6D4 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #06B6D4 30%, transparent)"},children:e.jsx(d,{Icon:o.Zap,size:20,style:{color:"#06B6D4"},variant:"pure"})}),"Votre Profil Morphologique"]}),e.jsxs("div",{className:"bodyscan-status-badge bodyscan-status-badge--active",children:[e.jsx("div",{className:"bodyscan-status-icon"}),e.jsx("span",{className:"bodyscan-status-text",children:"Analyse Spatiale"})]})]}),e.jsx("div",{className:"morphology-insights-grid",children:m.map((p,l)=>e.jsxs(h,{className:"morphology-insight-item",style:{"--insight-color":p.color},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:a?0:.1+l*.1},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(d,{Icon:o[p.icon],size:20,color:p.color})}),e.jsx("div",{className:"morphology-insight-value",children:p.value}),e.jsx("div",{className:"morphology-insight-title",children:p.title})]},p.id))}),e.jsx(h,{className:"morphology-summary-card",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,delay:a?0:.6},style:{borderRadius:"24px",overflow:"hidden"},children:e.jsx("p",{className:"text-white/80 text-sm leading-relaxed",children:"Votre morphologie unique révèle un potentiel extraordinaire. Chaque caractéristique de votre corps raconte l'histoire de votre parcours et offre des opportunités d'optimisation personnalisées."})})]})})});ee.displayName="MorphologyInsightsCard";function pe(s){return s?{weight:s.weight?`${s.weight.toFixed(1)} kg`:"N/A",bmi:s.bmi?s.bmi.toFixed(1):"N/A",bodyFat:s.bodyFatPercentage?`${s.bodyFatPercentage.toFixed(1)}%`:"N/A",waist:s.waistCircumference?`${s.waistCircumference.toFixed(0)} cm`:"N/A",scanDate:s.createdAt?new Date(s.createdAt).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"}):"N/A"}:null}const he=[{id:"weight",label:"Poids",icon:"Scale",color:"#10B981",getValue:s=>s.weight?`${s.weight.toFixed(1)} kg`:"N/A"},{id:"bmi",label:"IMC",icon:"Activity",color:"#06B6D4",getValue:s=>s.bmi?s.bmi.toFixed(1):"N/A",getSubtext:s=>s.bmi?s.bmi<18.5?"Léger":s.bmi<25?"Normal":s.bmi<30?"Surpoids":"Obèse":""},{id:"bodyFat",label:"Masse Grasse",icon:"Droplet",color:"#F59E0B",getValue:s=>{if(s.bodyFatPercentage)return`${s.bodyFatPercentage.toFixed(1)}%`;const r=30,i=s.userProfile?.sex||s.resolvedGender||"male";if(s.bmi){const a=i==="male"?1:0,m=1.2*s.bmi+.23*r-10.8*a-5.4;return`${Math.max(5,Math.min(50,m)).toFixed(1)}%`}return"N/A"},getSubtext:s=>!s.bodyFatPercentage&&s.bmi?"Estimé":"",getTooltip:s=>{if(!s.bodyFatPercentage&&s.bmi)return"Estimation basée sur l'IMC et le sexe biologique (formule de Deurenberg)";if(!s.bodyFatPercentage)return"Métrique non disponible pour ce scan"}},{id:"leanMass",label:"Masse Maigre",icon:"Zap",color:"#06B6D4",getValue:s=>{const r=s.weight||s.userProfile?.weight_kg,i=s.bodyFatPercentage;if(r&&i)return`${(r*((100-i)/100)).toFixed(1)} kg`;const a=s.userProfile?.height_cm,m=s.userProfile?.sex||s.resolvedGender||"male";return r&&a&&s.bmi?m==="male"?`${(.407*r+.267*a-19.2).toFixed(1)} kg`:`${(.252*r+.473*a-48.3).toFixed(1)} kg`:"N/A"},getSubtext:s=>!(s.weight&&s.bodyFatPercentage)&&s.weight&&s.userProfile?.height_cm?"Estimé":"",getTooltip:s=>s.weight&&s.bodyFatPercentage?"Masse maigre = poids total - masse grasse. Inclut muscles, os, organes et eau corporelle.":s.weight&&s.userProfile?.height_cm?"Estimation basée sur la formule de Boer utilisant le poids, la taille et le sexe biologique.":"Métrique non disponible pour ce scan"}],se=T.memo(({scan:s})=>{const{isPerformanceMode:r}=M(),i=T.useMemo(()=>pe(s),[s]);return e.jsx(v,{className:"p-6",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, #06B6D4 8%, transparent) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"color-mix(in srgb, #06B6D4 25%, transparent)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px color-mix(in srgb, #06B6D4 10%, transparent)
        `},children:e.jsxs(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #06B6D4 35%, transparent), color-mix(in srgb, #06B6D4 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #06B6D4 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #06B6D4 30%, transparent)"},children:e.jsx(d,{Icon:o.BarChart3,size:16,style:{color:"#06B6D4"},variant:"pure"})}),e.jsx("span",{children:"Métriques Corporelles"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 border border-green-500/30",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-400"}),e.jsxs("span",{className:"text-green-300 text-xs font-medium",children:["Scan du ",i?.scanDate]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:he.map((a,m)=>{const p=a.getValue(s),l=a.getSubtext?.(s),n=a.getTooltip?.(s),c=p!=="N/A";return e.jsxs(h,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:r?0:.1+m*.1},whileHover:{y:-2},className:"relative p-4 rounded-xl border transition-all duration-300 group",style:{background:c?`linear-gradient(135deg, color-mix(in srgb, ${a.color} 10%, transparent), color-mix(in srgb, ${a.color} 5%, transparent))`:"rgba(255, 255, 255, 0.03)",borderColor:c?`color-mix(in srgb, ${a.color} 30%, transparent)`:"rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{background:c?`color-mix(in srgb, ${a.color} 20%, transparent)`:"rgba(255, 255, 255, 0.05)"},children:e.jsx(d,{Icon:o[a.icon],size:16,color:c?a.color:"rgba(255, 255, 255, 0.3)"})}),e.jsx("span",{className:"text-white/60 text-xs font-medium",children:a.label}),n&&e.jsxs("div",{className:"relative ml-auto",children:[e.jsx(d,{Icon:o.Info,size:12,className:"text-white/40"}),e.jsx("div",{className:"absolute bottom-full right-0 mb-2 hidden group-hover:block z-10 w-48",children:e.jsx("div",{className:"bg-black/90 text-white text-xs rounded-lg px-3 py-2 shadow-xl",children:n})})]})]}),e.jsx("div",{className:"text-white text-xl font-bold mb-1",children:p}),l&&c&&e.jsx("div",{className:"text-xs font-medium",style:{color:a.color},children:l})]},a.id)})}),s.rawMeasurements&&Object.keys(s.rawMeasurements).length>0&&e.jsx(h,{className:"mt-6 p-4 rounded-xl bg-white/5 border border-white/10",initial:{opacity:0},animate:{opacity:1},transition:{duration:.5,delay:r?0:.6},children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(d,{Icon:o.Ruler,size:16,className:"text-white/40 mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white/60 text-xs font-medium mb-2",children:"Mesures détaillées"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:Object.entries(s.rawMeasurements).map(([a,m])=>e.jsxs("div",{className:"text-xs",children:[e.jsxs("span",{className:"text-white/40",children:[a.replace(/_/g," "),":"]})," ",e.jsxs("span",{className:"text-white/70 font-medium",children:[m," cm"]})]},a))})]})]})})]})})});se.displayName="BodyMetricsCard";const ge=()=>{const s=P(),{profile:r}=z(),{isPerformanceMode:i}=M(),{bodyScanData:a,isLoading:m,error:p}=ue(),[l,n]=_.useState(!0),[c,t]=_.useState(!1),f=_.useRef(void 0);_.useEffect(()=>{const D=setTimeout(()=>{n(!1),y.debug("AVATAR_TAB","Component mounting delay complete",{philosophy:"minimum_skeleton_display_time"})},400);return()=>clearTimeout(D)},[]),_.useEffect(()=>{a?.id&&a.id!==f.current&&(t(!1),f.current=a.id,y.debug("AVATAR_TAB","Scan data changed to different scan, resetting viewer ready state",{scanId:a.id,previousScanId:f.current,philosophy:"reset_viewer_on_scan_change"}))},[a?.id]);const j=_.useCallback(()=>{y.info("AVATAR_TAB","Avatar 3D viewer ready callback triggered",{currentlyReady:c,scanId:a?.id,philosophy:"viewer_ready_callback_triggered"}),t(!0),y.info("AVATAR_TAB","Avatar 3D viewer fully initialized and state updated",{philosophy:"viewer_ready_state_updated"})},[c,a?.id]),x=m||l||!c;if(_.useEffect(()=>{if(!c&&a?.id){const D=setTimeout(()=>{c||(y.warn("AVATAR_TAB","Safety timeout: forcing viewer ready after 10s",{scanId:a.id,isLoading:m,isComponentMounting:l,philosophy:"safety_timeout_force_ready"}),t(!0))},1e4);return()=>clearTimeout(D)}},[c,a?.id,m,l]),y.info("AVATAR_TAB","Scan data loaded",{hasScan:!!a,scanId:a?.id,hasMorphValues:!!a?.morph_values,morphValuesCount:a?.morph_values?Object.keys(a.morph_values).length:0,hasLimbMasses:!!a?.limb_masses,limbMassesCount:a?.limb_masses?Object.keys(a.limb_masses).length:0,hasResolvedGender:!!a?.resolved_gender,resolvedGender:a?.resolved_gender,hasWeight:!!a?.weight,weight:a?.weight,philosophy:"avatar_tab_diagnostics"}),x&&!p)return e.jsx(ce,{});if(p)return e.jsxs(v,{className:"text-center p-8",children:[e.jsx(h,{className:"w-16 h-16 mx-auto mb-6 rounded-full bg-red-500/20 border border-red-400/30 flex items-center justify-center",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx(d,{Icon:o.AlertCircle,size:32,color:"#EF4444"})}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de chargement"}),e.jsx("p",{className:"text-red-300 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:p instanceof Error?p.message:"Une erreur est survenue lors du chargement de votre avatar."}),e.jsx("button",{className:"btn-glass px-6 py-3",onClick:()=>window.location.reload(),children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(d,{Icon:o.RotateCcw,size:16}),e.jsx("span",{children:"Actualiser"})]})})]});const b=a&&a.morph_values&&Object.keys(a.morph_values).length>0&&a.limb_masses&&Object.keys(a.limb_masses).length>0;if(a&&!b&&y.warn("AVATAR_TAB","Scan data incomplete",{scanId:a.id,morphValuesCount:a.morph_values?Object.keys(a.morph_values).length:0,limbMassesCount:a.limb_masses?Object.keys(a.limb_masses).length:0,missingMorphs:!a.morph_values||Object.keys(a.morph_values).length===0,missingLimbMasses:!a.limb_masses||Object.keys(a.limb_masses).length===0,philosophy:"incomplete_scan_validation"}),!a||!b)return e.jsxs(v,{className:"text-center p-8",interactive:!0,children:[e.jsxs(h,{className:"w-20 h-20 mx-auto rounded-full bg-blue-500/20 flex items-center justify-center mb-6 relative",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(d,{Icon:o.Scan,size:40,className:"text-blue-400"}),!i&&e.jsx(A.div,{className:"absolute inset-0 rounded-full border-2 border-blue-400/30",animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:"Aucun avatar corporel"}),e.jsx("p",{className:"text-white/70 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:a?"Données morphologiques incomplètes. Veuillez effectuer un nouveau scan.":"Effectuez un scan corporel pour créer votre avatar 3D personnalisé."}),e.jsx("button",{className:"btn-glass--primary px-8 py-4 text-lg font-semibold",onClick:()=>s("/body-scan"),children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(d,{Icon:o.Camera,size:20}),e.jsx("span",{children:"Commencer le scan corporel"})]})})]});const u=a.morph_values||{},g=a.limb_masses||{},I=a.skin_tone||null,N=a.resolved_gender||r?.sex||"male",w={sex:N,height_cm:r?.height_cm||170,weight_kg:a.weight||r?.weight_kg||70};y.info("AVATAR_TAB","Rendering avatar with data",{scanId:a.id,morphDataKeys:Object.keys(u).length,limbMassesKeys:Object.keys(g).length,hasSkinTone:!!I,resolvedGender:N,userProfile:w,philosophy:"avatar_render_data"});const E=r?.preferences?.face?.final_face_params||{},C=r?.preferences?.face?.skin_tone||null;return e.jsxs(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeOut"},className:"space-y-8",children:[e.jsxs(v,{className:"bodyscan-card p-6",children:[e.jsx("div",{className:"flex items-center mb-4",children:e.jsxs("h3",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, rgba(6, 182, 212, 0.35), rgba(6, 182, 212, 0.25))
                `,border:"2px solid rgba(6, 182, 212, 0.5)",boxShadow:"0 0 20px rgba(6, 182, 212, 0.3)"},children:e.jsx(d,{Icon:o.Eye,size:20,style:{color:"#06B6D4"},variant:"pure"})}),e.jsx("span",{className:"glowing-title-text",children:"Votre Avatar 3D"})]})}),e.jsx("div",{className:"avatar-3d-viewer-container h-[400px] sm:h-[500px] lg:h-[600px] rounded-xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-400/20 relative overflow-hidden",children:e.jsx(X,{userProfile:w,morphData:u,limbMasses:g,skinTone:I,resolvedGender:N,faceMorphData:E,faceSkinTone:C,className:"w-full h-full",autoRotate:!0,showControls:!0,onViewerReady:j})})]}),e.jsx(se,{scan:a}),u&&Object.keys(u).length>0&&e.jsx(ee,{finalShapeParams:u,resolvedGender:N,userProfile:w}),e.jsxs(v,{className:"p-0 overflow-hidden relative",interactive:!0,style:{background:`
            radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.10) 0%, transparent 50%),
            var(--glass-opacity-base)
          `,borderColor:"rgba(139, 92, 246, 0.4)",boxShadow:`
            0 12px 40px rgba(0, 0, 0, 0.25),
            0 0 40px rgba(139, 92, 246, 0.25),
            inset 0 2px 0 rgba(255, 255, 255, 0.2)
          `},children:[!i&&e.jsx("div",{className:"absolute inset-0 rounded-inherit pointer-events-none urgent-forge-glow-css",style:{background:"radial-gradient(circle at center, color-mix(in srgb, #8B5CF6 8%, transparent) 0%, transparent 70%)",filter:"blur(20px)",transform:"scale(1.2)",zIndex:0}}),e.jsxs(h,{as:"button",onClick:()=>s("/body-scan"),className:"w-full px-8 py-4 rounded-2xl font-bold text-lg text-white relative overflow-hidden min-h-[64px] z-10",style:{background:`
              linear-gradient(135deg,
                rgba(139, 92, 246, 0.25),
                rgba(139, 92, 246, 0.15)
              )
            `,border:"none",backdropFilter:"blur(20px) saturate(160%)"},whileHover:{scale:1.01,y:-1},whileTap:{scale:.99},children:[!i&&e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent)",animation:"celebration-cta-shimmer-movement 2s ease-in-out infinite",borderRadius:"inherit"}}),e.jsxs("div",{className:"relative z-10 flex items-center justify-center gap-3",children:[e.jsx(d,{Icon:o.Scan,size:24,style:{color:"#8B5CF6",filter:"drop-shadow(0 2px 6px rgba(139, 92, 246, 0.5))"},variant:"pure"}),e.jsx("span",{style:{textShadow:"0 2px 8px rgba(139, 92, 246, 0.6)",color:"white"},children:"Nouveau scan corporel"})]})]})]})]})};function be(s){if(!s)return null;try{const r=new Date(s),i=new Date;let a=i.getFullYear()-r.getFullYear();const m=i.getMonth()-r.getMonth();return(m<0||m===0&&i.getDate()<r.getDate())&&a--,a}catch{return null}}function ye(s,r){const i=s/100;return r/(i*i)}async function ve(s,r){y.info("INSIGHTS_GENERATION","🚀 Calling generate-morph-insights Edge Function",{userId:r?.userId,hasScanData:!!s,hasUserProfile:!!r,philosophy:"ai_powered_morphology_insights",supabaseUrl:"https://kwipydbtjagypocpvbwn.supabase.co",timestamp:new Date().toISOString()});try{y.info("INSIGHTS_GENERATION","📡 Invoking Supabase function...");const{data:i,error:a}=await H.functions.invoke("generate-morph-insights",{body:{scan_data:{final_shape_params:s?.morph_values||s?.finalShapeParams||{},final_limb_masses:s?.limb_masses||s?.finalLimbMasses||{},skin_tone:s?.skin_tone||s?.skinTone,resolved_gender:s?.resolved_gender||s?.resolvedGender,avatar_version:s?.avatar_version||s?.avatarVersion,scan_id:s?.id||s?.scanId},user_profile:{user_id:r?.userId,age:be(r?.birthdate),sex:r?.sex,height_cm:r?.height||r?.height_cm,weight_kg:r?.weight||r?.weight_kg,target_weight_kg:r?.target_weight||r?.target_weight_kg,activity_level:r?.activity_level,objective:r?.objective,bmi:(r?.height||r?.height_cm)&&(r?.weight||r?.weight_kg)?ye(r.height||r.height_cm,r.weight||r.weight_kg):null,goals:r?.goals||{},health:r?.health||{},emotions:r?.emotions||{},nutrition:r?.nutrition||{}},analysis_config:{include_recommendations:!0,include_comparisons:!0,include_goal_tracking:!0,detail_level:"comprehensive"}}});if(y.info("INSIGHTS_GENERATION","📥 Function response received",{hasData:!!i,hasError:!!a,errorMessage:a?.message}),a)throw y.error("INSIGHTS_GENERATION","❌ Failed to generate insights",{error:a.message,userId:r?.userId,errorDetails:a}),new Error(`Failed to generate insights: ${a.message}`);return y.info("INSIGHTS_GENERATION","✅ Insights generated successfully",{userId:r?.userId,insightsCount:i?.insights?.length||0}),i}catch(i){throw y.error("INSIGHTS_GENERATION","❌ Network or parsing error",{error:i.message,stack:i.stack,userId:r?.userId}),i}}function fe(s){switch(s){case"recommendation":return o.Target;case"observation":return o.Eye;case"achievement":return o.Check;case"goal_progress":return o.TrendingUp;default:return o.Info}}function je(s){switch(s){case"recommendation":return"Recommandation";case"observation":return"Observation";case"achievement":return"Réussite";case"goal_progress":return"Progression";default:return"Info"}}function we(s){switch(s){case"high":return"Haute";case"medium":return"Moyenne";case"low":return"Basse";default:return s}}const R=T.memo(({insight:s,index:r})=>{const{isPerformanceMode:i}=M();return e.jsxs(h,{className:"insight-card",style:{"--insight-color":s.color},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:i?0:r*.1},whileHover:{y:-2},children:[e.jsxs("div",{className:"insight-card-badges",children:[e.jsxs("div",{className:`insight-metadata-badge insight-metadata-badge--type-${s.type}`,children:[e.jsx(d,{Icon:fe(s.type),size:10,variant:"pure"}),e.jsx("span",{children:je(s.type)})]}),(s.priority==="high"||s.priority==="medium")&&e.jsx("div",{className:`insight-metadata-badge insight-metadata-badge--priority-${s.priority}`,children:e.jsx("span",{children:we(s.priority)})}),s.confidence>=.8&&e.jsxs("div",{className:"insight-metadata-badge insight-metadata-badge--confidence",children:[e.jsx(d,{Icon:o.Check,size:10,variant:"pure"}),e.jsxs("span",{children:[Math.round(s.confidence*100),"%"]})]})]}),e.jsxs("div",{className:"insight-card-header",children:[e.jsx("div",{className:"insight-card-icon-container",children:e.jsx(d,{Icon:o[s.icon],size:18,color:s.color})}),e.jsxs("div",{className:"insight-card-content",children:[e.jsxs("div",{className:"insight-card-title-row",children:[e.jsx("h5",{className:"insight-card-title",children:s.title}),s.value&&e.jsx("span",{className:"insight-card-value-badge",children:s.value})]}),e.jsx("p",{className:"insight-card-description",children:s.description})]})]})]})});R.displayName="InsightCard";const Ne=()=>e.jsx("div",{className:"space-y-6 w-full",children:e.jsx(v,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-warning) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-warning) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-warning) 10%, transparent)
          `},children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-6",children:[e.jsxs(A.div,{className:"w-20 h-20 rounded-full flex items-center justify-center relative",style:{background:"color-mix(in srgb, var(--color-body-scan-warning) 20%, transparent)",border:"2px solid color-mix(in srgb, var(--color-body-scan-warning) 40%, transparent)",boxShadow:"0 0 30px color-mix(in srgb, var(--color-body-scan-warning) 30%, transparent)"},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(d,{Icon:o.Loader2,size:32,style:{color:"var(--color-body-scan-warning)"},variant:"pure",className:"loader-essential"}),e.jsx(A.div,{className:"absolute inset-0 rounded-full border-2",style:{borderColor:"color-mix(in srgb, var(--color-body-scan-warning) 40%, transparent)"},animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Génération d'insights..."}),e.jsx("p",{className:"text-white/70 text-sm leading-relaxed max-w-sm",children:"Nos systèmes analysent votre morphologie pour générer des recommandations personnalisées"})]})]})})}),_e=({error:s})=>e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(v,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-error) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-error) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-error) 10%, transparent)
          `},children:[e.jsx(A.div,{className:"bodyscan-size-2xl bodyscan-absolute-center-x mb-6 bodyscan-rounded-full bodyscan-flex-center",style:{background:"color-mix(in srgb, var(--color-body-scan-error) 20%, transparent)",border:"2px solid color-mix(in srgb, var(--color-body-scan-error) 40%, transparent)",boxShadow:"0 0 30px color-mix(in srgb, var(--color-body-scan-error) 30%, transparent)"},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx(d,{Icon:o.AlertCircle,size:32,style:{color:"var(--color-body-scan-error)"},variant:"pure"})}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de génération d'insights"}),e.jsx("p",{className:"bodyscan-text-error text-sm mb-6 leading-relaxed max-w-md mx-auto",children:s instanceof Error?s.message:"Une erreur est survenue lors de la génération des insights."}),e.jsx("button",{className:"btn-glass--primary px-6 py-3",onClick:()=>window.location.reload(),children:e.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx(d,{Icon:o.RotateCcw,size:16}),e.jsx("span",{children:"Réessayer"})]})})]})}),Ie=()=>e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(v,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
          `},children:[e.jsxs(A.div,{className:"bodyscan-size-3xl bodyscan-absolute-center-x mb-6 bodyscan-rounded-full bodyscan-flex-center bodyscan-relative",style:{background:"color-mix(in srgb, var(--color-body-scan-primary) 20%, transparent)",border:"2px solid color-mix(in srgb, var(--color-body-scan-primary) 40%, transparent)",boxShadow:"0 0 30px color-mix(in srgb, var(--color-body-scan-primary) 30%, transparent)"},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(d,{Icon:o.Scan,size:40,style:{color:"var(--color-body-scan-primary)"},variant:"pure"}),e.jsx(A.div,{className:"bodyscan-absolute-fill bodyscan-rounded-full bodyscan-border-2",style:{borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 40%, transparent)"},animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:"Aucun scan disponible"}),e.jsx("p",{className:"text-white/70 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:"Effectuez un scan corporel pour débloquer vos insights morphologiques personnalisés."}),e.jsx("button",{className:"btn-glass--primary px-8 py-4 text-lg font-semibold",onClick:()=>{},children:e.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-md",children:[e.jsx(d,{Icon:o.Camera,size:20}),e.jsx("span",{children:"Commencer le scan corporel"})]})})]})}),ae=T.memo(({summary:s})=>{const{isPerformanceMode:r}=M();return e.jsx(v,{className:"p-6",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, #F59E0B 8%, transparent) 0%, transparent 60%),
          var(--glass-opacity-base)
        `,borderColor:"color-mix(in srgb, #F59E0B 25%, transparent)",boxShadow:`
          var(--glass-shadow-sm),
          0 0 16px color-mix(in srgb, #F59E0B 10%, transparent)
        `},children:e.jsxs(h,{className:"slide-enter",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:[e.jsxs("div",{className:"bodyscan-flex-between mb-6",children:[e.jsxs("h3",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(d,{Icon:o.BarChart3,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Tableau de bord morphologique"]}),e.jsxs("div",{className:"bodyscan-status-badge bodyscan-status-badge--active",children:[e.jsx("div",{className:"bodyscan-status-icon"}),e.jsx("span",{className:"bodyscan-status-text",children:"Analyse Spatiale"})]})]}),e.jsxs("div",{className:"bodyscan-grid-cols-2 md:bodyscan-grid-cols-4 bodyscan-gap-md",children:[e.jsxs("div",{className:"summary-metric-card summary-metric-card--blue",children:[e.jsxs("div",{className:"summary-metric-value",children:[Math.round(s.morphology_score),"%"]}),e.jsx("div",{className:"summary-metric-label",children:"Score Morphologique"})]}),e.jsxs("div",{className:"summary-metric-card summary-metric-card--green",children:[e.jsxs("div",{className:"summary-metric-value",children:[Math.round(s.goal_alignment),"%"]}),e.jsx("div",{className:"summary-metric-label",children:"Alignement Objectifs"})]}),e.jsxs("div",{className:"summary-metric-card summary-metric-card--purple",children:[e.jsxs("div",{className:"summary-metric-value",children:[Math.round(s.health_indicators),"%"]}),e.jsx("div",{className:"summary-metric-label",children:"Indicateurs Santé"})]}),e.jsxs("div",{className:"summary-metric-card summary-metric-card--orange",children:[e.jsx("div",{className:"summary-metric-value",children:s.recommendations_count}),e.jsx("div",{className:"summary-metric-label",children:"Recommandations"})]})]})]})})});ae.displayName="SummaryDashboard";const Se=({isOpen:s,onDiscardAndExit:r,onCancel:i,isGenerating:a,hasError:m,fallbackUsed:p})=>{const{click:l,error:n}=K(),t=a?{title:"Génération d'Insights en Cours",message:"Une analyse IA de votre morphologie est actuellement en cours. Si vous quittez maintenant, l'analyse sera interrompue et les insights ne seront pas générés.",icon:"Loader2",color:"#8B5CF6",actionText:"Interrompre l'analyse et Quitter",cancelText:"Continuer l'analyse"}:m?{title:"Erreur de Génération",message:"Une erreur est survenue lors de la génération des insights. Vous pouvez quitter et réessayer plus tard, ou rester pour voir les insights de base disponibles.",icon:"AlertTriangle",color:"#EF4444",actionText:"Quitter",cancelText:"Rester et voir les insights de base"}:p?{title:"Insights de Base Disponibles",message:"L'IA n'était pas disponible, mais des insights basés sur des règles ont été générés. Voulez-vous quitter ou consulter ces insights ?",icon:"Info",color:"#F59E0B",actionText:"Quitter",cancelText:"Consulter les insights"}:{title:"Quitter les Insights",message:"Êtes-vous sûr de vouloir quitter la section insights ?",icon:"AlertCircle",color:"#6B7280",actionText:"Quitter",cancelText:"Rester"};return e.jsx(U,{children:s&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",style:{background:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(16px)",WebkitBackdropFilter:"blur(16px)"},onClick:f=>{f.target===f.currentTarget&&(l(),i())},children:e.jsx(A.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",stiffness:300,damping:30},className:"w-full max-w-md",onClick:f=>f.stopPropagation(),children:e.jsxs(v,{className:"p-6 relative",style:{background:`
                  radial-gradient(circle at 30% 20%, color-mix(in srgb, ${t.color} 12%, transparent) 0%, transparent 60%),
                  radial-gradient(circle at 70% 80%, color-mix(in srgb, ${t.color} 8%, transparent) 0%, transparent 50%),
                  var(--glass-opacity)
                `,borderColor:`color-mix(in srgb, ${t.color} 30%, transparent)`,boxShadow:`
                  0 20px 60px rgba(0, 0, 0, 0.4),
                  0 0 40px color-mix(in srgb, ${t.color} 20%, transparent),
                  inset 0 2px 0 rgba(255, 255, 255, 0.2)
                `,backdropFilter:"blur(24px) saturate(160%)"},children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, ${t.color} 35%, transparent), color-mix(in srgb, ${t.color} 25%, transparent))
                    `,border:`2px solid color-mix(in srgb, ${t.color} 50%, transparent)`,boxShadow:`0 0 30px color-mix(in srgb, ${t.color} 40%, transparent)`},children:e.jsx(d,{Icon:o[t.icon],size:28,style:{color:t.color},className:a?"animate-spin":""})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:t.title}),e.jsx("p",{className:"text-white/80 text-base leading-relaxed",children:t.message})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{n(),r()},className:"w-full btn-glass--warning py-3",style:{background:`
                      linear-gradient(135deg, 
                        color-mix(in srgb, #EF4444 70%, transparent), 
                        color-mix(in srgb, #DC2626 50%, transparent)
                      )
                    `,borderColor:"color-mix(in srgb, #EF4444 60%, transparent)",boxShadow:`
                      0 8px 32px color-mix(in srgb, #EF4444 30%, transparent),
                      inset 0 2px 0 rgba(255,255,255,0.2)
                    `},children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(d,{Icon:o.X,size:18,className:"text-white"}),e.jsx("span",{className:"font-bold",children:t.actionText})]})}),e.jsx("button",{onClick:()=>{l(),i()},className:"w-full btn-glass--secondary-nav py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(d,{Icon:o.ArrowLeft,size:18}),e.jsx("span",{className:"font-medium",children:t.cancelText})]})})]}),e.jsx("div",{className:"mt-4 p-3 rounded-xl text-center",style:{background:`color-mix(in srgb, ${t.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${t.color} 20%, transparent)`},children:e.jsx("p",{className:"text-white/70 text-sm",children:a?"L'analyse IA sera interrompue et devra être relancée.":m?"Vous pourrez réessayer la génération d'insights plus tard.":p?"Les insights de base fournissent des informations utiles sur votre morphologie.":"Vous pourrez revenir consulter vos insights à tout moment."})})]})})})})},Ce=()=>{const{profile:s}=z(),{isPerformanceMode:r}=M(),{data:i,isLoading:a}=B({queryKey:["body-scans","latest",s?.userId],queryFn:async()=>{const{data:u,error:g}=await H.from("body_scans").select("*").eq("user_id",s?.userId).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(g)throw g;return u},enabled:!!s?.userId,staleTime:5*60*1e3}),[m,p]=T.useState(!1),{data:l,isLoading:n,error:c}=B({queryKey:["morph-insights",s?.userId,i?.id],queryFn:()=>ve(i,s),enabled:!!(i?.id&&s?.userId),staleTime:1/0,gcTime:24*60*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1,retry:1}),t=()=>{p(!1),window.history.back()},f=()=>{p(!1)};if(T.useEffect(()=>{const u=g=>{n&&(g.preventDefault(),g.returnValue="Une analyse IA est en cours. Êtes-vous sûr de vouloir quitter ?",p(!0))};return window.addEventListener("beforeunload",u),()=>{window.removeEventListener("beforeunload",u)}},[n]),a||n)return e.jsx(Ne,{});if(c)return e.jsx(_e,{error:c});if(!i)return e.jsx(Ie,{});const j=l?.insights||[],x=l?.summary,b=l?.fallback_used||!1;return e.jsx(e.Fragment,{children:e.jsxs(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeOut"},children:[e.jsx(Se,{isOpen:m,onDiscardAndExit:t,onCancel:f,isGenerating:n,hasError:!!c,fallbackUsed:b}),e.jsxs("div",{className:"space-y-8",children:[x&&e.jsx(ae,{summary:x}),j.length>0&&e.jsxs("div",{className:"space-y-6",children:[j.filter(u=>u.priority==="high").length>0&&e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:r?0:.2},children:e.jsxs(v,{className:"p-6 glass-card--priority",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#EF4444"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(d,{Icon:o.Zap,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Insights prioritaires",e.jsx("span",{className:"text-xs bg-red-500/20 text-red-300 px-2 py-1 rounded-full",children:"Haute priorité"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:j.filter(u=>u.priority==="high").map((u,g)=>e.jsx(R,{insight:u,index:g},u.id))})]})}),j.filter(u=>u.category==="morphology").length>0&&e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:r?0:.3},children:e.jsxs(v,{className:"p-6",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#8B5CF6"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(d,{Icon:o.Eye,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Analyse morphologique"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:j.filter(u=>u.category==="morphology").map((u,g)=>e.jsx(R,{insight:u,index:g},u.id))})]})}),j.filter(u=>["fitness","goals"].includes(u.category)).length>0&&e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:r?0:.4},children:e.jsxs(v,{className:"p-6",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#22C55E"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(d,{Icon:o.Target,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Objectifs & Fitness"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:j.filter(u=>["fitness","goals"].includes(u.category)).map((u,g)=>e.jsx(R,{insight:u,index:g},u.id))})]})}),j.filter(u=>["health","nutrition"].includes(u.category)).length>0&&e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:r?0:.5},children:e.jsxs(v,{className:"p-6",children:[e.jsxs("h4",{className:"text-white font-semibold mb-6 flex items-center gap-2 glowing-title-text",style:{"--title-glow-color":"#EC4899"},children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                        linear-gradient(135deg, color-mix(in srgb, #F59E0B 35%, transparent), color-mix(in srgb, #F59E0B 25%, transparent))
                      `,border:"2px solid color-mix(in srgb, #F59E0B 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #F59E0B 30%, transparent)"},children:e.jsx(d,{Icon:o.Heart,size:16,style:{color:"#F59E0B"},variant:"pure"})}),"Santé & Nutrition"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:j.filter(u=>["health","nutrition"].includes(u.category)).map((u,g)=>e.jsx(R,{insight:u,index:g},u.id))})]})})]})]})]})})},ke=({scanId:s,onClose:r})=>{const{profile:i}=z(),a=i,m=_.useRef(null),[p,l]=_.useState(!1);_.useEffect(()=>{console.log("HISTORICAL_SCAN_MODAL: Received scanId:",s)},[s]);const{data:n,isLoading:c,error:t}=B({queryKey:["historical-scan",s],queryFn:()=>J.getById(s),enabled:!!s,staleTime:1/0,gcTime:24*60*60*1e3});_.useEffect(()=>{console.log("HISTORICAL_SCAN_MODAL: isLoading:",c,"error:",t)},[c,t]),_.useEffect(()=>{n&&console.log("HISTORICAL_SCAN_MODAL: Scan data loaded:",n)},[n]);const f=n?q(new Date(n.created_at),"dd MMMM yyyy",{locale:L}):"N/A";_.useEffect(()=>{p&&m.current?.resetCamera&&m.current.resetCamera()},[p]),_.useEffect(()=>{const x=b=>{b.key==="Escape"&&r()};return document.addEventListener("keydown",x),()=>document.removeEventListener("keydown",x)},[r]);const j=e.jsx(A.div,{className:"fixed inset-0 z-[1000] bg-black/80 backdrop-blur-lg flex items-start justify-center p-2 sm:p-4 pt-20 sm:pt-24",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:x=>{x.target===x.currentTarget&&r()},children:e.jsx(A.div,{className:"relative w-full max-w-6xl my-4 sm:my-8 rounded-xl overflow-y-auto flex flex-col",style:{height:"calc(100vh - 8rem)",maxHeight:"900px",minHeight:"600px"},initial:{scale:.9,y:50},animate:{scale:1,y:0},exit:{scale:.9,y:50},transition:{type:"spring",stiffness:300,damping:30},onClick:x=>x.stopPropagation(),children:e.jsxs(v,{className:"flex-1 p-4 sm:p-6 flex flex-col h-full bg-gradient-to-br from-purple-900/20 to-blue-900/20 border-purple-500/30",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 flex-shrink-0 pb-4 border-b border-white/10",children:[e.jsxs("h3",{className:"text-white font-semibold text-lg sm:text-xl flex items-center gap-2",children:[e.jsx(d,{Icon:o.Timeline,size:24,className:"text-blue-400"}),e.jsxs("span",{className:"truncate",children:["Scan du ",f]})]}),e.jsx("button",{onClick:r,className:"p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors flex-shrink-0","aria-label":"Fermer",children:e.jsx(d,{Icon:o.X,size:20,className:"text-white"})})]}),e.jsxs("div",{className:"flex-1 relative min-h-0 grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2 relative min-h-0",children:[c&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(d,{Icon:o.Loader2,size:48,className:"text-purple-400 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-white/70",children:"Chargement du scan..."})]})}),t&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-red-400",children:[e.jsx(d,{Icon:o.AlertCircle,size:48,className:"mx-auto mb-4"}),e.jsx("p",{children:"Erreur de chargement du scan"}),e.jsx("p",{className:"text-sm mt-2 text-red-300",children:t.message})]})}),n&&!c&&e.jsxs("div",{className:"w-full h-full relative min-h-[400px]",children:[(()=>{const x=n.metrics?.final_shape_params||n.metrics?.morph_values,b=n.metrics?.final_limb_masses||n.metrics?.limb_masses,u=n.metrics?.skin_tone,g=n.metrics?.resolved_gender||a?.sex;return console.log("HISTORICAL_SCAN_MODAL: Avatar3DViewer props:",{morphData:x,limbMasses:b,skinTone:u,resolvedGender:g,scanId:s,hasScanResult:!!n,hasUserProfile:!!a}),null})(),e.jsx(X,{ref:m,scanResult:n,userProfile:a,morphData:n.metrics?.final_shape_params||n.metrics?.morph_values,limbMasses:n.metrics?.final_limb_masses||n.metrics?.limb_masses,skinTone:n.metrics?.skin_tone,resolvedGender:n.metrics?.resolved_gender||a?.sex,className:"w-full h-full",autoRotate:!0,showControls:!0,onViewerReady:()=>l(!0)})]})]}),n&&!c&&e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[e.jsxs("h4",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(d,{Icon:o.BarChart3,size:16,className:"text-blue-400"}),"Résumé du scan"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[n.metrics?.estimate_result?.processing_confidence&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/70",children:"Confiance"}),e.jsxs("span",{className:"text-white font-medium",children:[Math.round(n.metrics.estimate_result.processing_confidence*100),"%"]})]}),n.metrics?.resolved_gender&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/70",children:"Genre détecté"}),e.jsx("span",{className:"text-white font-medium capitalize",children:n.metrics.resolved_gender})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/70",children:"Date de création"}),e.jsx("span",{className:"text-white font-medium",children:q(new Date(n.created_at),"HH:mm",{locale:L})})]})]})]}),e.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[e.jsxs("h4",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(d,{Icon:o.Ruler,size:16,className:"text-green-400"}),"Mesures"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[n.metrics?.estimate_result?.extracted_data?.raw_measurements?.weight_kg&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"Poids"}),e.jsxs("p",{className:"text-white font-medium",children:[n.metrics.estimate_result.extracted_data.raw_measurements.weight_kg.toFixed(1)," kg"]})]}),n.metrics?.estimate_result?.extracted_data?.raw_measurements?.height_cm&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"Taille"}),e.jsxs("p",{className:"text-white font-medium",children:[n.metrics.estimate_result.extracted_data.raw_measurements.height_cm.toFixed(1)," cm"]})]}),n.metrics?.estimate_result?.estimated_bmi&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"IMC"}),e.jsx("p",{className:"text-white font-medium",children:n.metrics.estimate_result.estimated_bmi.toFixed(1)})]}),n.metrics?.estimate_result?.extracted_data?.processing_confidence&&e.jsxs("div",{className:"text-center bg-white/5 rounded p-2",children:[e.jsx("p",{className:"text-white/50 text-xs",children:"Précision"}),e.jsxs("p",{className:"text-white font-medium",children:[Math.round(n.metrics.estimate_result.extracted_data.processing_confidence*100),"%"]})]})]})]}),(n.metrics?.final_shape_params||n.metrics?.morph_values)&&e.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[e.jsxs("h4",{className:"text-white font-medium mb-3 flex items-center gap-2",children:[e.jsx(d,{Icon:o.Zap,size:16,className:"text-purple-400"}),"Morphologie"]}),e.jsxs("div",{className:"text-sm text-white/70",children:[e.jsxs("p",{children:["Modèle 3D généré avec ",Object.keys(n.metrics?.final_shape_params||n.metrics?.morph_values||{}).length," paramètres morphologiques."]}),n.metrics?.final_limb_masses&&e.jsx("p",{className:"mt-2",children:"Masses des membres ajustées pour une représentation précise."})]})]})]})]})]})})});return oe.createPortal(j,document.body)},k=s=>typeof s=="number"&&Number.isFinite(s),S=s=>{if(typeof s=="number")return Number.isFinite(s)?s:void 0;if(typeof s=="string"){const r=parseFloat(s);return Number.isFinite(r)?r:void 0}},Ae=s=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s),Q=({children:s,tone:r="info"})=>e.jsx("span",{className:`ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[10px] uppercase tracking-wide ${r==="info"?"bg-blue-500/15 text-blue-200 border border-blue-400/20":"bg-white/5 text-white/50 border border-white/10"}`,children:s}),G=({icon:s,label:r,value:i})=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-7 h-7 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center shrink-0",children:e.jsx(d,{Icon:o[s],size:14,className:"text-white/70"})}),e.jsxs("div",{className:"flex-1 flex justify-between items-baseline",children:[e.jsx("span",{className:"text-white/60 text-xs",children:r}),e.jsx("span",{className:"text-white font-medium text-sm",children:typeof i=="number"?i.toFixed(1):i})]})]}),Fe=()=>{const{profile:s}=z(),r=s?.userId,{isPerformanceMode:i}=M(),[a,m]=_.useState(null),[p,l]=_.useState(!1),[n,c]=_.useState(4),{data:t,isLoading:f,error:j}=B({queryKey:["body-scan-history",r,n],queryFn:()=>J.getHistory(r,n),enabled:!!r,staleTime:5*60*1e3,gcTime:10*60*1e3}),x=w=>{m(w),l(!0)},b=()=>{m(null),l(!1)};if(f)return e.jsxs(v,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
          `},children:[e.jsx(d,{Icon:o.Loader2,size:48,className:"bodyscan-text-accent loader-essential mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Chargement de l'historique..."}),e.jsx("p",{className:"text-white/70 text-sm",children:"Récupération de vos scans passés."})]});if(j)return e.jsxs(v,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-error) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-error) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-error) 10%, transparent)
          `},children:[e.jsx(d,{Icon:o.AlertCircle,size:48,className:"bodyscan-text-error mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de chargement"}),e.jsx("p",{className:"bodyscan-text-error text-sm mb-6",children:j?.message}),e.jsx("button",{onClick:()=>window.location.reload(),className:"btn-glass--primary",children:"Réessayer"})]});if(!t||t.length===0)return e.jsxs(v,{className:"text-center p-8",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
            var(--glass-opacity-base)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
            var(--glass-shadow-sm),
            0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
          `},children:[e.jsx(d,{Icon:o.Info,size:48,className:"bodyscan-text-info mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Aucun scan trouvé"}),e.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Vous n'avez pas encore d'historique de scans corporels. Effectuez votre premier scan !"}),e.jsx("button",{onClick:()=>window.location.href="/body-scan",className:"btn-glass--primary",children:"Commencer un scan"})]});const u=t.filter(w=>{const E=w.id&&typeof w.id=="string"&&Ae(w.id);return console.log("Scan ID:",w.id,"Valid UUID:",E),E}),g=o.History,I=()=>{c(w=>w+4)},N=t&&t.length>0&&t.length===n;return e.jsxs(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeOut"},className:"space-y-6 w-full",children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6",children:e.jsx(U,{children:u.map(w=>{const E=new Date(w.created_at),C=w?.metrics,D=S(C?.estimate_result?.extracted_data?.raw_measurements?.weight_kg)??S(C?.estimate_result?.weight_kg)??S(C?.weight_kg),Y=S(C?.estimate_result?.extracted_data?.raw_measurements?.height_cm)??S(C?.estimate_result?.height_cm)??S(C?.height_cm),re=S(C?.estimate_result?.estimated_bmi)??S(C?.estimated_bmi),te=!k(D)&&k(S(s?.weight_kg)),ie=!k(Y)&&k(S(s?.height_cm)),V=D??S(s?.weight_kg),$=Y??S(s?.height_cm);let O=re;if(!k(O)&&k(V)&&k($)&&$>0){const Z=$/100;O=V/(Z*Z)}const W=S(C?.estimate_result?.extracted_data?.processing_confidence);return e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:e.jsxs(v,{interactive:!0,className:"p-6",style:{background:`
                      radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
                      var(--glass-opacity-base)
                    `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
                      var(--glass-shadow-sm),
                      0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
                    `},onClick:()=>x(w.id),children:[e.jsxs("div",{className:"bodyscan-flex-between",children:[e.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[e.jsx("div",{className:"bodyscan-header-icon-container",style:{width:"2.25rem",height:"2.25rem"},children:e.jsx(d,{Icon:g,size:18,style:{color:"var(--color-body-scan-primary)"},variant:"pure"})}),e.jsxs("h4",{className:"text-white font-semibold text-lg",children:["Scan du ",q(E,"dd MMMM yyyy",{locale:L})]})]}),e.jsx("div",{className:"text-xs text-white/50",children:q(E,"HH:mm",{locale:L})})]}),e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsxs("div",{className:"history-metric-row",children:[e.jsx(G,{icon:"Scale",label:"Poids",value:k(V)?V:"-"}),te&&e.jsx(Q,{tone:"muted",children:"profil"})]}),e.jsxs("div",{className:"history-metric-row",children:[e.jsx(G,{icon:"Ruler",label:"Taille",value:k($)?$:"-"}),ie&&e.jsx(Q,{tone:"muted",children:"profil"})]}),e.jsx("div",{className:"history-metric-row",children:e.jsx(G,{icon:"Activity",label:"IMC",value:k(O)?O:"-"})}),k(W)&&e.jsxs("div",{className:"history-metric-row flex items-center gap-2 text-xs text-white/60",children:[e.jsx(d,{Icon:o.Shield,size:14,className:"text-white/60"}),e.jsx("span",{children:"Confiance"}),e.jsxs("span",{className:"text-white/80 font-medium",children:[Math.round(W*100),"%"]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-white/10",children:e.jsx("button",{className:"btn-glass--secondary-nav bodyscan-size-full py-2 text-sm",children:"Voir le scan"})})]})},w.id)})})}),N&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx(h,{as:"button",onClick:I,className:"btn-glass--secondary px-6 py-3",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{Icon:o.ChevronDown,size:16,className:"text-white/70"}),e.jsx("span",{children:"Charger plus de scans"})]})})}),e.jsx(U,{children:p&&a&&e.jsx(ke,{scanId:a,onClose:b})})]})};function Te(s){if(!s)return 1/0;const r=new Date,i=new Date(s),a=Math.abs(r.getTime()-i.getTime());return Math.ceil(a/(1e3*60*60*24))}function Me(s){return s===1/0?{status:"never_scanned",urgency:"high",color:"#8B5CF6",message:"Créez votre premier avatar",subtitle:"Commencez votre parcours de transformation corporelle"}:s<=7?{status:"up_to_date",urgency:"low",color:"#8B5CF6",message:"Vous êtes à jour !",subtitle:`Dernier scan il y a ${s} jour${s>1?"s":""}`}:s<=10?{status:"due_soon",urgency:"medium",color:"#F59E0B",message:"Scan recommandé bientôt",subtitle:`Dernier scan il y a ${s} jours`}:{status:"overdue",urgency:"high",color:"#EF4444",message:"Nouveau scan recommandé",subtitle:`Dernier scan il y a ${s} jours`}}async function Ee(s){const{data:r,error:i}=await H.from("body_scans").select("id, created_at, timestamp").eq("user_id",s).order("created_at",{ascending:!1}).limit(1);if(i)throw y.error("SCAN_CTA","Failed to fetch latest body scan",{error:i.message,userId:s,timestamp:new Date().toISOString()}),i;return r&&r.length>0?r[0]:null}const De=()=>{const s=P(),{profile:r}=z(),{click:i,success:a}=K(),{isPerformanceMode:m}=M(),{data:p,isLoading:l,error:n}=B({queryKey:["body-scans","latest",r?.userId],queryFn:()=>Ee(r?.userId),enabled:!!r?.userId,staleTime:5*60*1e3,retry:1}),c=Te(p?.created_at||null),t=Me(c),f=()=>{i(),a(),y.info("SCAN_CTA","User initiated new scan from CTA",{userId:r?.userId,daysSinceLastScan:c,scanStatus:t.status,timestamp:new Date().toISOString()}),s("/body-scan")},j=()=>{i(),y.info("SCAN_CTA","User navigated to insights from CTA",{userId:r?.userId,daysSinceLastScan:c,scanStatus:t.status,timestamp:new Date().toISOString()}),s("/avatar#insights")};return l?e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(v,{className:"text-center p-8",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
              var(--glass-opacity-base)
            `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
              var(--glass-shadow-sm),
              0 0 16px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent)
            `},children:[e.jsx(d,{Icon:o.Loader2,size:48,className:"bodyscan-text-accent loader-essential mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Vérification de votre historique..."}),e.jsx("p",{className:"text-white/70 text-sm",children:"Analyse de vos scans précédents."})]})}):n?e.jsx("div",{className:"space-y-6 w-full",children:e.jsxs(v,{className:"text-center p-8",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-error) 8%, transparent) 0%, transparent 60%),
              var(--glass-opacity-base)
            `,borderColor:"color-mix(in srgb, var(--color-body-scan-error) 25%, transparent)",boxShadow:`
              var(--glass-shadow-sm),
              0 0 16px color-mix(in srgb, var(--color-body-scan-error) 10%, transparent)
            `},children:[e.jsx(d,{Icon:o.AlertCircle,size:48,className:"bodyscan-text-error mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de chargement"}),e.jsx("p",{className:"bodyscan-text-error text-sm mb-6",children:n?.message}),e.jsx("button",{onClick:()=>window.location.reload(),className:"btn-glass--primary",children:"Réessayer"})]})}):e.jsxs(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeOut"},className:"space-y-6 w-full",children:[e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:e.jsxs(v,{className:"p-8 text-center relative overflow-visible",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, ${t.color} 12%, transparent) 0%, transparent 60%),
              radial-gradient(circle at 70% 80%, color-mix(in srgb, ${t.color} 8%, transparent) 0%, transparent 50%),
              var(--glass-opacity-base)
            `,borderColor:`color-mix(in srgb, ${t.color} 30%, transparent)`,boxShadow:`
              0 12px 40px rgba(0, 0, 0, 0.25),
              0 0 30px color-mix(in srgb, ${t.color} 20%, transparent),
              inset 0 2px 0 rgba(255, 255, 255, 0.15)
            `},children:[!m&&e.jsx("div",{className:"training-hero-corners","aria-hidden":"true",children:[0,1,2,3].map(x=>e.jsx(A.div,{className:"corner-particle",style:{position:"absolute",width:"8px",height:"8px",borderRadius:"2px",background:`linear-gradient(135deg, ${t.color}, rgba(255, 255, 255, 0.8))`,boxShadow:`0 0 20px ${t.color}`,top:x<2?"12px":"auto",bottom:x>=2?"12px":"auto",left:x%2===0?"12px":"auto",right:x%2===1?"12px":"auto"},initial:{rotate:x%2===0?45:-45},animate:{scale:[1,1.3,1],opacity:[.6,1,.6],rotate:x%2===0?[45,60,45]:[-45,-60,-45]},transition:{duration:3,repeat:1/0,delay:x*.2,ease:[.4,0,.2,1]}},x))}),e.jsx("div",{className:`absolute inset-0 rounded-inherit pointer-events-none ${m?"":"urgent-forge-glow-css"}`,style:{background:`radial-gradient(circle at center, color-mix(in srgb, ${t.color} 8%, transparent) 0%, transparent 70%)`,filter:m?"blur(10px)":"blur(20px)",transform:"scale(1.2)",zIndex:-1}}),e.jsxs(h,{className:"w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center relative",style:{background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                linear-gradient(135deg, color-mix(in srgb, ${t.color} 35%, transparent), color-mix(in srgb, ${t.color} 25%, transparent))
              `,border:`2px solid color-mix(in srgb, ${t.color} 50%, transparent)`,boxShadow:m?`0 0 20px color-mix(in srgb, ${t.color} 20%, transparent)`:`0 0 40px color-mix(in srgb, ${t.color} 40%, transparent)`},initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:300,damping:25,delay:.2},children:[e.jsx(d,{Icon:t.status==="never_scanned"?o.Scan:t.status==="up_to_date"?o.Check:o.Timer,size:48,style:{color:t.color},variant:"pure"}),t.urgency==="high"&&!m&&e.jsx(A.div,{className:"absolute inset-0 rounded-full border-2",style:{borderColor:`color-mix(in srgb, ${t.color} 40%, transparent)`},animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),t.urgency==="high"&&m&&e.jsx("div",{className:"absolute inset-0 rounded-full border-2",style:{borderColor:`color-mix(in srgb, ${t.color} 40%, transparent)`,opacity:.5}}),t.status==="up_to_date"&&!m&&e.jsx(e.Fragment,{children:[...Array(6)].map((x,b)=>{const u=b*360/6,g=60,I=Math.cos(u*Math.PI/180)*g,N=Math.sin(u*Math.PI/180)*g;return e.jsx("div",{className:`absolute w-2 h-2 rounded-full dynamic-particle-css dynamic-particle-css--${b+1}`,style:{background:t.color,boxShadow:`0 0 12px color-mix(in srgb, ${t.color} 70%, transparent)`,"--particle-x":`${I*.4}px`,"--particle-y":`${N*.4}px`,"--particle-x-end":`${I}px`,"--particle-y-end":`${N}px`}},b)})})]}),e.jsxs(h,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},className:"mb-8",children:[e.jsx("h3",{className:"text-3xl font-bold mb-3",style:{color:t.color},children:t.message}),e.jsx("p",{className:"text-white/80 text-lg leading-relaxed max-w-md mx-auto",children:t.subtitle})]}),e.jsxs(h,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,delay:.6},className:"mb-8 p-4 rounded-xl",style:{background:`color-mix(in srgb, ${t.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${t.color} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)"},children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(d,{Icon:o.Info,size:16,style:{color:t.color}}),e.jsx("span",{className:"text-white font-medium text-sm",children:"Recommandation TwinForge"})]}),e.jsx("p",{className:"text-white/80 text-sm leading-relaxed",children:"Pour un suivi optimal de votre évolution corporelle, nous recommandons un scan tous les 7 jours. Cela permet de détecter les changements subtils et d'ajuster vos objectifs en conséquence."})]}),e.jsxs(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.8},className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsxs(h,{as:"button",onClick:f,className:"px-8 py-4 rounded-full font-bold text-lg text-white relative overflow-hidden min-h-[64px]",style:{background:`
                  linear-gradient(135deg,
                    color-mix(in srgb, ${t.color} 85%, transparent),
                    color-mix(in srgb, ${t.color} 70%, transparent)
                  )
                `,border:`2px solid ${t.color}`,boxShadow:`
                  0 12px 40px color-mix(in srgb, ${t.color} 40%, transparent),
                  0 0 60px color-mix(in srgb, ${t.color} 30%, transparent),
                  inset 0 3px 0 rgba(255, 255, 255, 0.4)
                `,backdropFilter:"blur(20px) saturate(160%)"},whileHover:{scale:1.02,y:-2,boxShadow:`
                  0 16px 50px color-mix(in srgb, ${t.color} 50%, transparent),
                  0 0 80px color-mix(in srgb, ${t.color} 40%, transparent),
                  inset 0 3px 0 rgba(255, 255, 255, 0.5)
                `},whileTap:{scale:.98},children:[!m&&e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)",animation:"celebration-cta-shimmer-movement 2s ease-in-out infinite",borderRadius:"inherit"}}),e.jsxs("div",{className:"relative z-10 flex items-center justify-center gap-3",children:[e.jsx(d,{Icon:o.Scan,size:24,style:{color:"white",filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.3))"},variant:"pure"}),e.jsx("span",{style:{textShadow:"0 2px 4px rgba(0,0,0,0.3)"},children:t.status==="never_scanned"?"Créer mon Avatar 3D":"Nouveau Scan"})]})]}),t.status!=="never_scanned"&&e.jsx(h,{as:"button",onClick:j,className:"px-6 py-4 rounded-full font-medium text-white/90 transition-all duration-200 min-h-[64px]",style:{background:`color-mix(in srgb, ${t.color} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${t.color} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)"},onMouseEnter:x=>{x.currentTarget.style.background=`color-mix(in srgb, ${t.color} 12%, transparent)`,x.currentTarget.style.borderColor=`color-mix(in srgb, ${t.color} 30%, transparent)`,x.currentTarget.style.transform="translateY(-1px) scale(1.02)"},onMouseLeave:x=>{x.currentTarget.style.background=`color-mix(in srgb, ${t.color} 8%, transparent)`,x.currentTarget.style.borderColor=`color-mix(in srgb, ${t.color} 20%, transparent)`,x.currentTarget.style.transform="translateY(0) scale(1)"},whileHover:{scale:1.02,y:-1},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(d,{Icon:o.Zap,size:20,color:"white",variant:"pure"}),e.jsx("span",{children:"Voir mes Insights"})]})})]})]})}),t.status!=="never_scanned"&&e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.3},children:e.jsxs(v,{className:"p-6",style:{background:`
                radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 8%, transparent) 0%, transparent 60%),
                var(--glass-opacity-base)
              `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent)",boxShadow:`
                0 12px 40px rgba(0, 0, 0, 0.25),
                0 0 30px color-mix(in srgb, var(--color-body-scan-primary) 15%, transparent),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm text-xl",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, var(--color-body-scan-primary) 35%, transparent), color-mix(in srgb, var(--color-body-scan-primary) 25%, transparent))
                    `,border:"2px solid color-mix(in srgb, var(--color-body-scan-primary) 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, var(--color-body-scan-primary) 30%, transparent)"},children:e.jsx(d,{Icon:o.TrendingUp,size:20,style:{color:"var(--color-body-scan-primary)"},variant:"pure"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-sm",children:"Suivi de Progression"}),e.jsx("div",{className:"text-white/60 text-xs font-normal mt-0.5",children:"État de votre évolution corporelle"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"bodyscan-status-badge bodyscan-status-badge--active",children:[e.jsx("div",{className:"bodyscan-status-icon"}),e.jsx("span",{className:"bodyscan-status-text",children:t.urgency==="low"?"À jour":t.urgency==="medium"?"Bientôt":"Urgent"})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl font-bold mb-2",style:{color:t.color},children:c===1/0?"∞":c}),e.jsx("div",{className:"text-white/70 text-sm",children:c===1/0?"Aucun scan effectué":c===1?"jour depuis le dernier scan":"jours depuis le dernier scan"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-full bg-white/10 rounded-full h-3 overflow-hidden",children:e.jsx(h,{className:"h-3 rounded-full relative overflow-hidden",style:{background:`linear-gradient(90deg, ${t.color}, color-mix(in srgb, ${t.color} 80%, white))`,boxShadow:`0 0 12px ${t.color}60, inset 0 1px 0 rgba(255,255,255,0.3)`},initial:{width:0},animate:{width:`${Math.min(100,Math.max(0,100-c/7*100))}%`},transition:{duration:1.2,ease:"easeOut",delay:.5},children:e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:`linear-gradient(90deg,
                          transparent 0%,
                          rgba(255,255,255,0.4) 50%,
                          transparent 100%
                        )`,animation:"progressShimmer 2s ease-in-out infinite"}})})}),e.jsxs("div",{className:"flex justify-between mt-2 text-xs text-white/50",children:[e.jsx("span",{children:"Nouveau"}),e.jsx("span",{children:"7 jours"})]})]}),e.jsx("div",{className:"text-center p-3 rounded-xl",style:{background:`color-mix(in srgb, ${t.color} 6%, transparent)`,border:`1px solid color-mix(in srgb, ${t.color} 15%, transparent)`},children:e.jsx("p",{className:"text-white/80 text-sm",children:t.status==="up_to_date"?`Prochain scan recommandé dans ${7-c} jour${7-c>1?"s":""}`:"Un nouveau scan est recommandé pour suivre votre évolution"})})]})]})}),e.jsx(h,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.5},children:e.jsxs(v,{className:"p-6",style:{background:`
              radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-accent) 6%, transparent) 0%, transparent 60%),
              var(--glass-opacity-base)
            `,borderColor:"color-mix(in srgb, var(--color-body-scan-accent) 20%, transparent)",boxShadow:`
              var(--glass-shadow-sm),
              0 0 12px color-mix(in srgb, var(--color-body-scan-accent) 8%, transparent)
            `},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #8B5CF6 35%, transparent), color-mix(in srgb, #8B5CF6 25%, transparent))
                `,border:"2px solid color-mix(in srgb, #8B5CF6 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, #8B5CF6 30%, transparent)"},children:e.jsx(d,{Icon:o.Info,size:20,style:{color:"#8B5CF6"},variant:"pure"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:"Pourquoi scanner régulièrement ?"}),e.jsx("div",{className:"text-white/60 text-xs font-normal mt-0.5",children:"Optimisez votre suivi corporel avec des scans réguliers"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(h,{className:"morphology-insight-item",style:{"--insight-color":"#22C55E"},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.1},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(d,{Icon:o.TrendingUp,size:20,style:{color:"#22C55E"},variant:"pure"})}),e.jsx("div",{className:"morphology-insight-value",children:"Suivi Précis"}),e.jsx("div",{className:"morphology-insight-title",children:"Détectez les changements subtils"})]}),e.jsxs(h,{className:"morphology-insight-item",style:{"--insight-color":"#3B82F6"},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.2},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(d,{Icon:o.Zap,size:20,style:{color:"#3B82F6"},variant:"pure"})}),e.jsx("div",{className:"morphology-insight-value",children:"Insights IA"}),e.jsx("div",{className:"morphology-insight-title",children:"Recommandations personnalisées"})]}),e.jsxs(h,{className:"morphology-insight-item",style:{"--insight-color":"#A855F7"},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.3},whileHover:{y:-2},children:[e.jsx("div",{className:"morphology-insight-icon-container",children:e.jsx(d,{Icon:o.Heart,size:20,style:{color:"#A855F7"},variant:"pure"})}),e.jsx("div",{className:"morphology-insight-value",children:"Motivation"}),e.jsx("div",{className:"morphology-insight-title",children:"Visualisez vos progrès"})]})]})]})})]})};function Be(s){switch(s){case"scanCta":return{icon:"Scan",title:"Forge Corporelle",subtitle:"Capturez votre évolution corporelle avec un nouveau scan 3D",circuit:"avatar",color:"#8B5CF6"};case"avatar":return{icon:"Eye",title:"Votre Avatar 3D",subtitle:"Visualisez et ajustez votre reflet numérique personnalisé",circuit:"avatar",color:"#06B6D4"};case"insights":return{icon:"Zap",title:"Insights Avatar",subtitle:"Analyses IA personnalisées et recommandations basées sur votre scan corporel",circuit:"avatar",color:"#F59E0B"};case"history":return{icon:"History",title:"Historique des Scans",subtitle:"Revivez vos transformations corporelles au fil du temps",circuit:"avatar",color:"#8B5CF6"};default:return{icon:"Eye",title:"Votre Avatar 3D",subtitle:"Visualisez et ajustez votre reflet numérique personnalisé",circuit:"avatar",color:"#8B5CF6"}}}const We=()=>{const s=le(),r=P(),{click:i}=K(),a=T.useMemo(()=>{const l=s.hash.replace("#","");return["scanCta","avatar","insights","history"].includes(l)?l:"scanCta"},[s.hash]);me(`avatar:${a}`);const m=Be(a),p=l=>{const n=l||"scanCta";i(),y.debug("AVATAR_PAGE","Changement d'onglet déclenché",{nouvelOnglet:n}),r({pathname:s.pathname,search:s.search,hash:`#${n}`},{replace:!1})};return e.jsxs("div",{className:"space-y-6 w-full max-w-none",children:[e.jsx(de,{icon:m.icon,title:m.title,subtitle:m.subtitle,circuit:m.circuit,iconColor:m.color}),e.jsxs(F,{defaultValue:"scanCta",className:"w-full min-w-0 avatar-tabs",onValueChange:p,forgeContext:"avatar",children:[e.jsxs(F.List,{role:"tablist","aria-label":"Sections de l'avatar",className:"mb-4 md:mb-6 w-full",children:[e.jsx(F.Trigger,{value:"scanCta",icon:"Scan","aria-controls":"panel-scancta",children:e.jsx("span",{className:"tab-text",children:"Scanner"})}),e.jsx(F.Trigger,{value:"avatar",icon:"Eye","aria-controls":"panel-avatar",children:e.jsx("span",{className:"tab-text",children:"Avatar"})}),e.jsx(F.Trigger,{value:"insights",icon:"Zap","aria-controls":"panel-insights",children:e.jsx("span",{className:"tab-text",children:"Insights"})}),e.jsx(F.Trigger,{value:"history",icon:"History","aria-controls":"panel-history",children:e.jsx("span",{className:"tab-text",children:"Historique"})})]}),e.jsx(F.Panel,{id:"panel-scancta",value:"scanCta",children:e.jsx(De,{})}),e.jsx(F.Panel,{id:"panel-avatar",value:"avatar",children:e.jsx(ge,{})}),e.jsx(F.Panel,{id:"panel-insights",value:"insights",children:e.jsx(Ce,{})}),e.jsx(F.Panel,{id:"panel-history",value:"history",children:e.jsx(Fe,{})})]})]})};export{We as default};
