const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/page-fridge-Cp-W9isk.js","assets/vendor-BefW7Bxj.js","assets/utils-CUtLAp28.js","assets/supabase-pyFrrmXL.js","assets/page-fridge-scan-C62RDC3k.js","assets/stores-Dp3vmZ5-.js","assets/ui-components-lrK_WhZu.js","assets/motion-BQvLDPOm.js","assets/ui-components-DyoLTZgZ.css","assets/page-fridge-scan-DAz6gEg3.css","assets/date-utils-BlBdbPk_.js"])))=>i.map(i=>d[i]);
var he=Object.defineProperty;var ge=(m,t,s)=>t in m?he(m,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):m[t]=s;var se=(m,t,s)=>ge(m,typeof t!="symbol"?t+"":t,s);import{r as g,j as e,bD as ae,d0 as fe,bH as be,c1 as M,bu as re,bZ as ye,cg as ve,d1 as je}from"./vendor-BefW7Bxj.js";import{G as S,S as y,I as f,W as Ne,t as J,w as we,u as te,x as ne,y as Y,z as I,A as z,E as W,H as L,J as K,K as _e,m as Ee,p as X}from"./ui-components-lrK_WhZu.js";import{P as Se,U as De}from"./UnderConstructionCard-DKwpKbnZ.js";import{a as G,n as Ae,N as Ce,o as Pe,p as Te,q as ke,D as ie,r as Oe}from"./stores-Dp3vmZ5-.js";import{_ as He,a as Ie}from"./page-fridge-scan-C62RDC3k.js";import{l as r,s as _,u as Re,a as me}from"./page-fridge-Cp-W9isk.js";import{A as ee,m as k}from"./motion-BQvLDPOm.js";import{f as oe,a as le}from"./date-utils-BlBdbPk_.js";import"./utils-CUtLAp28.js";import"./supabase-pyFrrmXL.js";class ce{async isAvailable(){return console.log("AppleHealthWeb: isAvailable called - returning false (web platform)"),{available:!1}}async requestAuthorization(t){return console.log("AppleHealthWeb: requestAuthorization called",t),{granted:!1}}async getAuthorizationStatus(t){return console.log("AppleHealthWeb: getAuthorizationStatus called",t),{status:"notDetermined"}}async getHeartRateData(t){return console.log("AppleHealthWeb: getHeartRateData called",t),{data:[]}}async getHRVData(t){return console.log("AppleHealthWeb: getHRVData called",t),{data:[]}}async getStepsData(t){return console.log("AppleHealthWeb: getStepsData called",t),{data:[]}}async getActiveCaloriesData(t){return console.log("AppleHealthWeb: getActiveCaloriesData called",t),{data:[]}}async getRestingCaloriesData(t){return console.log("AppleHealthWeb: getRestingCaloriesData called",t),{data:[]}}async getDistanceData(t){return console.log("AppleHealthWeb: getDistanceData called",t),{data:[]}}async getWorkouts(t){return console.log("AppleHealthWeb: getWorkouts called",t),{workouts:[]}}async getWorkoutDetails(t){throw console.log("AppleHealthWeb: getWorkoutDetails called",t),new Error("No workout found")}async getSleepData(t){return console.log("AppleHealthWeb: getSleepData called",t),{data:[]}}async getVO2MaxData(t){return console.log("AppleHealthWeb: getVO2MaxData called",t),{data:[]}}async getRestingHeartRateData(t){return console.log("AppleHealthWeb: getRestingHeartRateData called",t),{data:[]}}async startObserving(t){return console.log("AppleHealthWeb: startObserving called",t),{success:!1}}async stopObserving(t){return console.log("AppleHealthWeb: stopObserving called",t),{success:!1}}}const Le=()=>{let m=new ce,t=!1;return typeof window<"u"&&(async()=>{if(!t){t=!0;try{const n=await new Function("modulePath","return import(modulePath)")("@capacitor/core"),{registerPlugin:i}=n;m=i("AppleHealth",{web:()=>Promise.resolve(new ce)}),console.info("Apple Health: Capacitor plugin registered")}catch{console.info("Apple Health: Using web implementation (Capacitor not installed)")}}})(),{isAvailable:(...a)=>m.isAvailable(...a),requestAuthorization:(...a)=>m.requestAuthorization(...a),getAuthorizationStatus:(...a)=>m.getAuthorizationStatus(...a),getHeartRateData:(...a)=>m.getHeartRateData(...a),getHRVData:(...a)=>m.getHRVData(...a),getStepsData:(...a)=>m.getStepsData(...a),getActiveCaloriesData:(...a)=>m.getActiveCaloriesData(...a),getRestingCaloriesData:(...a)=>m.getRestingCaloriesData(...a),getDistanceData:(...a)=>m.getDistanceData(...a),getWorkouts:(...a)=>m.getWorkouts(...a),getWorkoutDetails:(...a)=>m.getWorkoutDetails(...a),getSleepData:(...a)=>m.getSleepData(...a),getVO2MaxData:(...a)=>m.getVO2MaxData(...a),getRestingHeartRateData:(...a)=>m.getRestingHeartRateData(...a),startObserving:(...a)=>m.startObserving(...a),stopObserving:(...a)=>m.stopObserving(...a)}},F=Le();class ze{async isAvailable(){try{const{available:t}=await F.isAvailable();return t}catch(t){return r.error("APPLE_HEALTH","Error checking availability",{error:t}),!1}}async requestPermissions(){try{r.info("APPLE_HEALTH","Requesting permissions");const t=["heartRate","heartRateVariability","steps","activeCalories","restingCalories","distance","workout","sleep","vo2Max","restingHeartRate","oxygenSaturation"],{granted:s}=await F.requestAuthorization({readTypes:t});return s?(r.info("APPLE_HEALTH","Permissions granted"),await this.createDeviceConnection()):r.warn("APPLE_HEALTH","Permissions denied"),s}catch(t){return r.error("APPLE_HEALTH","Error requesting permissions",{error:t}),!1}}async createDeviceConnection(){try{const{data:{user:t}}=await _.auth.getUser();if(!t)throw new Error("User not authenticated");const{data:s}=await _.from("connected_devices").select("id").eq("user_id",t.id).eq("provider","apple_health").maybeSingle();if(s)return await _.from("connected_devices").update({status:"connected",last_sync_at:new Date().toISOString()}).eq("id",s.id),s.id;const{data:a,error:n}=await _.from("connected_devices").insert({user_id:t.id,provider:"apple_health",provider_user_id:t.id,display_name:"Apple Health",device_type:"smartwatch",status:"connected",scopes:["heart_rate","hrv","steps","calories","distance","workout","sleep","vo2max"],metadata:{device:"Apple Watch",platform:"iOS"},connected_at:new Date().toISOString()}).select("id").single();if(n)throw r.error("APPLE_HEALTH","Error creating device connection",{error:n}),n;return r.info("APPLE_HEALTH","Device connection created",{deviceId:a.id}),a.id}catch(t){return r.error("APPLE_HEALTH","Failed to create device connection",{error:t}),null}}async syncAllData(t){const s=Date.now(),a=t.endDate||new Date;let n=0;try{r.info("APPLE_HEALTH","Starting full sync",{startDate:t.startDate.toISOString(),endDate:a.toISOString()});const{data:{user:i}}=await _.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:c}=await _.from("connected_devices").select("id").eq("user_id",i.id).eq("provider","apple_health").maybeSingle();if(!c)throw new Error("Apple Health device not connected");const o=await this.createSyncHistory(c.id,i.id);await _.from("connected_devices").update({status:"syncing"}).eq("id",c.id);const u=await this.syncHeartRate(i.id,c.id,t.startDate,a);n+=u;const N=await this.syncHRV(i.id,c.id,t.startDate,a);n+=N;const v=await this.syncSteps(i.id,c.id,t.startDate,a);n+=v;const D=await this.syncCalories(i.id,c.id,t.startDate,a);n+=D;const A=await this.syncDistance(i.id,c.id,t.startDate,a);n+=A;const b=await this.syncWorkouts(i.id,c.id,t.startDate,a);n+=b;const p=Date.now()-s;return await this.updateSyncHistory(o.id,{status:"success",recordsStored:n,durationMs:p}),await _.from("connected_devices").update({status:"connected",last_sync_at:new Date().toISOString(),error_count:0,last_error:null}).eq("id",c.id),r.info("APPLE_HEALTH","Sync completed successfully",{recordsStored:n,durationMs:p}),{success:!0,recordsStored:n}}catch(i){return r.error("APPLE_HEALTH","Sync failed",{error:i}),{success:!1,recordsStored:n}}}async syncHeartRate(t,s,a,n){try{const{data:i}=await F.getHeartRateData({startDate:a.toISOString(),endDate:n.toISOString(),limit:1e3});let c=0;for(const o of i){const{error:u}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"heart_rate",timestamp:o.startDate,value_numeric:o.value,unit:"bpm",quality_score:95,raw_data:o,synced_at:new Date().toISOString()});u||c++}return r.info("APPLE_HEALTH","Heart rate data synced",{count:c}),c}catch(i){return r.error("APPLE_HEALTH","Failed to sync heart rate",{error:i}),0}}async syncHRV(t,s,a,n){try{const{data:i}=await F.getHRVData({startDate:a.toISOString(),endDate:n.toISOString(),limit:1e3});let c=0;for(const o of i){const{error:u}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"hrv",timestamp:o.startDate,value_numeric:o.value,unit:"ms",quality_score:95,raw_data:o,synced_at:new Date().toISOString()});u||c++}return r.info("APPLE_HEALTH","HRV data synced",{count:c}),c}catch(i){return r.error("APPLE_HEALTH","Failed to sync HRV",{error:i}),0}}async syncSteps(t,s,a,n){try{const{data:i}=await F.getStepsData({startDate:a.toISOString(),endDate:n.toISOString()});let c=0;for(const o of i){const{error:u}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"steps",timestamp:o.startDate,value_numeric:o.value,unit:"count",quality_score:95,raw_data:o,synced_at:new Date().toISOString()});u||c++}return r.info("APPLE_HEALTH","Steps data synced",{count:c}),c}catch(i){return r.error("APPLE_HEALTH","Failed to sync steps",{error:i}),0}}async syncCalories(t,s,a,n){try{const{data:i}=await F.getActiveCaloriesData({startDate:a.toISOString(),endDate:n.toISOString()}),{data:c}=await F.getRestingCaloriesData({startDate:a.toISOString(),endDate:n.toISOString()});let o=0;for(const u of i){const{error:N}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"calories",timestamp:u.startDate,value_numeric:u.value,unit:"kcal",quality_score:95,raw_data:{...u,type:"active"},synced_at:new Date().toISOString()});N||o++}for(const u of c){const{error:N}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"calories",timestamp:u.startDate,value_numeric:u.value,unit:"kcal",quality_score:95,raw_data:{...u,type:"resting"},synced_at:new Date().toISOString()});N||o++}return r.info("APPLE_HEALTH","Calories data synced",{count:o}),o}catch(i){return r.error("APPLE_HEALTH","Failed to sync calories",{error:i}),0}}async syncDistance(t,s,a,n){try{const{data:i}=await F.getDistanceData({startDate:a.toISOString(),endDate:n.toISOString()});let c=0;for(const o of i){const{error:u}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"distance",timestamp:o.startDate,value_numeric:o.value,unit:"meters",quality_score:95,raw_data:o,synced_at:new Date().toISOString()});u||c++}return r.info("APPLE_HEALTH","Distance data synced",{count:c}),c}catch(i){return r.error("APPLE_HEALTH","Failed to sync distance",{error:i}),0}}async syncWorkouts(t,s,a,n){try{const{workouts:i}=await F.getWorkouts({startDate:a.toISOString(),endDate:n.toISOString(),limit:100});let c=0;for(const o of i)try{const{workout:u}=await F.getWorkoutDetails({workoutId:o.id}),{error:N}=await _.from("wearable_health_data").insert({user_id:t,device_id:s,data_type:"workout",timestamp:o.startDate,value_json:{activityType:o.activityType,duration:o.duration,distance:o.totalDistance,calories:o.totalCalories,averageHeartRate:u.averageHeartRate,maxHeartRate:u.maxHeartRate,zones:u.zones,elevationGain:u.elevationGain,averagePace:u.averagePace,averageCadence:u.averageCadence,averagePower:u.averagePower},unit:"workout",quality_score:98,source_workout_id:o.id,raw_data:u,synced_at:new Date().toISOString()});N||c++}catch(u){r.warn("APPLE_HEALTH","Failed to get workout details",{workoutId:o.id,error:u})}return r.info("APPLE_HEALTH","Workouts synced",{count:c}),c}catch(i){return r.error("APPLE_HEALTH","Failed to sync workouts",{error:i}),0}}async createSyncHistory(t,s){const{data:a,error:n}=await _.from("device_sync_history").insert({device_id:t,user_id:s,sync_type:"manual",status:"success",data_types_synced:["heart_rate","hrv","steps","calories","distance","workout"],started_at:new Date().toISOString()}).select("id").single();if(n)throw n;return a}async updateSyncHistory(t,s){await _.from("device_sync_history").update({status:s.status,records_stored:s.recordsStored,duration_ms:s.durationMs,completed_at:new Date().toISOString()}).eq("id",t)}}const Q=new ze;function Fe(){const[m,t]=g.useState(!1),[s,a]=g.useState(!1),[n,i]=g.useState(!0),[c,o]=g.useState(null),{user:u}=G();g.useEffect(()=>{N()},[]),g.useEffect(()=>{u&&v()},[u]);const N=async()=>{try{const b=await Q.isAvailable();t(b),r.info("APPLE_HEALTH_HOOK","Availability checked",{available:b})}catch(b){r.error("APPLE_HEALTH_HOOK","Error checking availability",{error:b}),o("Impossible de vérifier la disponibilité d'Apple Health")}finally{i(!1)}},v=g.useCallback(async()=>{if(!u){a(!1);return}try{const{supabase:b}=await He(async()=>{const{supabase:x}=await import("./page-fridge-Cp-W9isk.js").then(w=>w.k);return{supabase:x}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),{data:p,error:d}=await b.from("connected_devices").select("status").eq("user_id",u.id).eq("provider","apple_health").maybeSingle();if(d){r.error("APPLE_HEALTH_HOOK","Error checking connection",{error:d}),a(!1);return}a(p?.status==="connected"),r.info("APPLE_HEALTH_HOOK","Connection checked",{connected:p?.status==="connected"})}catch(b){r.error("APPLE_HEALTH_HOOK","Error checking connection",{error:b}),a(!1)}},[u]),D=g.useCallback(async()=>{i(!0),o(null);try{r.info("APPLE_HEALTH_HOOK","Requesting permissions");const b=await Q.requestPermissions();return b?(a(!0),r.info("APPLE_HEALTH_HOOK","Permissions granted")):(o("Permissions refusées. Activez l'accès dans Réglages > Santé."),r.warn("APPLE_HEALTH_HOOK","Permissions denied")),b}catch(b){const p=b instanceof Error?b.message:"Erreur lors de la demande de permissions";return o(p),r.error("APPLE_HEALTH_HOOK","Error requesting permissions",{error:b}),!1}finally{i(!1)}},[]),A=g.useCallback(async(b=7)=>{i(!0),o(null);try{r.info("APPLE_HEALTH_HOOK","Starting sync",{days:b});const p=new Date;p.setDate(p.getDate()-b);const d=await Q.syncAllData({startDate:p});return d.success?r.info("APPLE_HEALTH_HOOK","Sync completed",{recordsStored:d.recordsStored}):(o("Erreur lors de la synchronisation des données"),r.error("APPLE_HEALTH_HOOK","Sync failed")),d}catch(p){const d=p instanceof Error?p.message:"Erreur lors de la synchronisation";return o(d),r.error("APPLE_HEALTH_HOOK","Error syncing data",{error:p}),{success:!1,recordsStored:0}}finally{i(!1)}},[]);return{isAvailable:m,isConnected:s,isLoading:n,error:c,requestPermissions:D,syncData:A,checkConnection:v}}const qe=()=>{const{isAvailable:m,isConnected:t,isLoading:s,error:a,requestPermissions:n,syncData:i,checkConnection:c}=Fe(),{click:o,success:u,error:N}=Re(),[v,D]=g.useState(!1),[A,b]=g.useState(7),[p,d]=g.useState(null),x=async()=>{o(),await n()?(u(),await c()):N()},w=async()=>{o(),D(!0),d(null);const E=await i(A);d(E),E.success?u():N(),D(!1)};return m?e.jsxs(S,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-12 h-12 rounded-2xl flex items-center justify-center",style:{background:t?"rgba(52, 199, 89, 0.15)":"rgba(255, 59, 48, 0.15)",border:t?"1px solid rgba(52, 199, 89, 0.3)":"1px solid rgba(255, 59, 48, 0.3)"},children:e.jsx(y,{Icon:f.Heart,size:24,style:{color:t?"#34C759":"#FF3B30"}})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Apple Health"}),t&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/20 border border-green-500/30",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-400"}),e.jsx("span",{className:"text-green-300 text-xs font-medium",children:"Connecté"})]})]}),e.jsx("p",{className:"text-white/60 text-sm mb-4",children:t?"Synchronisez vos données Apple Watch et iPhone avec TwinForge":"Connectez Apple Health pour tracker vos données de santé et fitness"}),a&&e.jsx("div",{className:"mb-4 p-3 rounded-xl border",style:{background:"rgba(239, 68, 68, 0.1)",borderColor:"rgba(239, 68, 68, 0.3)"},children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(y,{Icon:f.AlertTriangle,size:14,className:"text-red-300 mt-0.5"}),e.jsx("p",{className:"text-red-200 text-sm",children:a})]})}),p&&e.jsx(ee,{children:e.jsx(k.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mb-4 p-3 rounded-xl border",style:{background:p.success?"rgba(52, 199, 89, 0.1)":"rgba(239, 68, 68, 0.1)",borderColor:p.success?"rgba(52, 199, 89, 0.3)":"rgba(239, 68, 68, 0.3)"},children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(y,{Icon:p.success?f.CheckCircle2:f.AlertTriangle,size:14,className:p.success?"text-green-300":"text-red-300"}),e.jsx("p",{className:`text-sm ${p.success?"text-green-200":"text-red-200"}`,children:p.success?`Synchronisation réussie : ${p.recordsStored} enregistrements importés`:"Erreur lors de la synchronisation"})]})})}),t?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-white/80 text-sm font-medium",children:"Synchroniser les"}),e.jsxs("select",{value:A,onChange:E=>b(Number(E.target.value)),className:"flex-1 px-3 py-2 rounded-lg text-sm text-white",style:{background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsx("option",{value:1,children:"dernières 24h"}),e.jsx("option",{value:7,children:"7 derniers jours"}),e.jsx("option",{value:14,children:"14 derniers jours"}),e.jsx("option",{value:30,children:"30 derniers jours"}),e.jsx("option",{value:90,children:"90 derniers jours"})]})]}),e.jsx("button",{onClick:w,disabled:v,className:"w-full px-4 py-3 rounded-xl font-medium text-white transition-all",style:{background:v?"rgba(255, 255, 255, 0.1)":"linear-gradient(135deg, #34C759, #30D158)",boxShadow:v?"none":"0 4px 16px rgba(52, 199, 89, 0.3)"},children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:v?e.jsxs(e.Fragment,{children:[e.jsx(y,{Icon:f.Loader2,size:18,className:"animate-spin"}),e.jsx("span",{children:"Synchronisation en cours..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{Icon:f.RefreshCw,size:18}),e.jsx("span",{children:"Synchroniser maintenant"})]})})}),e.jsx("div",{className:"pt-3 border-t border-white/10",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-white/50 mb-1",children:"Données synchronisées"}),e.jsx("p",{className:"text-white font-medium",children:"Fréquence cardiaque, HRV, Pas, Calories, Distance, Entraînements"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white/50 mb-1",children:"Fréquence"}),e.jsx("p",{className:"text-white font-medium",children:"Manuel"})]})]})})]}):e.jsx("button",{onClick:x,disabled:s,className:"w-full px-4 py-3 rounded-xl font-medium text-white transition-all",style:{background:"linear-gradient(135deg, #FF3B30, #FF6B6B)",boxShadow:"0 4px 16px rgba(255, 59, 48, 0.3)"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s?e.jsx(y,{Icon:f.Loader2,size:18,className:"animate-spin"}):e.jsx(y,{Icon:f.Heart,size:18}),e.jsx("span",{children:s?"Connexion...":"Connecter Apple Health"})]})})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-white/10",children:e.jsxs("details",{className:"group",children:[e.jsxs("summary",{className:"flex items-center justify-between cursor-pointer text-white/70 hover:text-white text-sm",children:[e.jsx("span",{children:"Permissions et confidentialité"}),e.jsx(y,{Icon:f.ChevronDown,size:16,className:"transition-transform group-open:rotate-180"})]}),e.jsxs("div",{className:"mt-3 text-white/60 text-sm space-y-2",children:[e.jsx("p",{children:"TwinForge accède uniquement aux données de santé que vous autorisez explicitement. Vos données restent privées et ne sont jamais partagées avec des tiers."}),e.jsx("p",{children:"Vous pouvez révoquer les permissions à tout moment dans Réglages → Santé → Partage de données → Apps."})]})]})})]}):e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-12 h-12 rounded-2xl flex items-center justify-center",style:{background:"rgba(255, 59, 48, 0.15)",border:"1px solid rgba(255, 59, 48, 0.3)"},children:e.jsx(y,{Icon:f.Heart,size:24,style:{color:"#FF3B30"}})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-1",children:"Apple Health"}),e.jsx("p",{className:"text-white/60 text-sm mb-4",children:"Apple Health n'est disponible que sur les appareils iOS. Veuillez ouvrir cette page sur votre iPhone ou iPad pour connecter Apple Health."})]})]})})},Be=()=>{const{user:m}=G(),{devices:t,loading:s,syncing:a,syncDevice:n,disconnectDevice:i}=Ie(m?.id||null),[c,o]=g.useState(null),[u,N]=g.useState(!1),v=async d=>{r.info("[CONNECTED_DEVICES] Connect device initiated",{provider:d,showSimulator:u,userId:m?.id});const x=J[d];if(!x){r.error("[CONNECTED_DEVICES] Provider config not found",{provider:d}),alert("Configuration du provider introuvable");return}if(u){r.info("[CONNECTED_DEVICES] Simulation mode active - showing success alert",{provider:d,providerName:x.name}),alert(`Mode Simulation: Connexion à ${x.name} simulée avec succès!`);return}const E=`https://kwipydbtjagypocpvbwn.supabase.co/functions/v1/wearable-oauth-callback?provider=${d}`;try{r.info("[CONNECTED_DEVICES] Creating OAuth flow in database",{provider:d,redirectUri:E});const{data:P,error:O}=await _.rpc("create_device_auth_flow",{p_provider:d,p_redirect_uri:E});if(O){r.error("[CONNECTED_DEVICES] Failed to create auth flow",{provider:d,error:O}),alert("Erreur lors de l'initialisation de la connexion. Veuillez réessayer.");return}const C=P.state,V=P.expires_at;r.info("[CONNECTED_DEVICES] Auth flow created successfully",{provider:d,state:C,expiresAt:V});const T=new URL(x.authUrl);T.searchParams.set("response_type","code");const H=d==="google_fit"?"156410607041-k8g4ft9iblbhn5g3r92stc144mgrcrku.apps.googleusercontent.com":"YOUR_CLIENT_ID";T.searchParams.set("client_id",H),T.searchParams.set("redirect_uri",E),T.searchParams.set("state",C),T.searchParams.set("scope",x.scopes.join(" ")),d==="google_fit"&&(T.searchParams.set("access_type","offline"),T.searchParams.set("prompt","consent")),r.info("[CONNECTED_DEVICES] Redirecting to OAuth provider",{provider:d,authUrl:T.toString()}),window.location.href=T.toString()}catch(P){r.error("[CONNECTED_DEVICES] Unexpected error during OAuth initialization",{provider:d,error:P instanceof Error?P.message:"Unknown error"}),alert("Une erreur inattendue s'est produite. Veuillez réessayer.")}},D=async d=>{r.info("[CONNECTED_DEVICES] Sync initiated",{deviceId:d,userId:m?.id});try{await n(d),r.info("[CONNECTED_DEVICES] Sync successful",{deviceId:d}),alert("Synchronisation réussie!")}catch(x){r.error("[CONNECTED_DEVICES] Sync failed",{deviceId:d,error:x instanceof Error?x.message:"Unknown error"}),alert(`Erreur: ${x instanceof Error?x.message:"Synchronisation échouée"}`)}},A=async d=>{if(r.info("[CONNECTED_DEVICES] Disconnect initiated",{deviceId:d,userId:m?.id}),!confirm("Voulez-vous vraiment déconnecter cet appareil?")){r.info("[CONNECTED_DEVICES] Disconnect cancelled by user",{deviceId:d});return}try{await i(d),r.info("[CONNECTED_DEVICES] Disconnect successful",{deviceId:d})}catch(x){r.error("[CONNECTED_DEVICES] Disconnect failed",{deviceId:d,error:x instanceof Error?x.message:"Unknown error"}),alert(`Erreur: ${x instanceof Error?x.message:"Déconnexion échouée"}`)}},b=d=>({connected:"Connecté",syncing:"Synchronisation...",error:"Erreur",disconnected:"Déconnecté",pending_auth:"En attente",token_expired:"Expiré"})[d];return e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeOut"},children:[!1,e.jsx(ee,{children:u&&e.jsx(k.div,{initial:{opacity:0,y:-10,scale:.98},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-10,scale:.98},transition:{duration:.3,ease:[.4,0,.2,1]},className:"simulation-alert",children:e.jsxs("div",{className:"simulation-alert-content",children:[e.jsx("div",{className:"simulation-alert-icon",children:e.jsx(y,{Icon:f.AlertCircle,size:22,color:"#F59E0B"})}),e.jsxs("div",{className:"simulation-alert-text",children:[e.jsx("h4",{children:"Mode Simulation Activé"}),e.jsx("p",{children:"Les connexions aux appareils sont simulées. Idéal pour tester sans montres réelles."})]})]})})}),e.jsx("div",{style:{marginBottom:"2rem"},children:e.jsx(Ne,{variant:"detailed",showSyncButton:!0})}),e.jsx("div",{style:{marginBottom:"2rem"},children:e.jsx(qe,{})}),s?e.jsxs("div",{className:"devices-loading",children:[e.jsx("div",{className:"devices-loading-spinner",children:e.jsx(y,{Icon:f.Loader2,size:36,color:"#18E3FF"})}),e.jsx("p",{className:"devices-loading-text",children:"Chargement des appareils..."})]}):e.jsxs(e.Fragment,{children:[t.length>0&&e.jsxs("div",{style:{marginBottom:"2.5rem"},children:[e.jsxs("h3",{className:"providers-section-title",children:["Mes Appareils (",t.length,")"]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:t.map(d=>{const x=J[d.provider],w=c===d.id;return e.jsxs(k.div,{className:"device-card",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"device-card-main",children:[e.jsxs("div",{className:"device-card-info",children:[e.jsx("div",{className:"device-icon-wrapper",style:{background:`linear-gradient(135deg, ${x.color}15 0%, ${x.color}30 100%)`},children:e.jsx(y,{Icon:f[x.icon],size:28,color:x.color})}),e.jsxs("div",{className:"device-details",children:[e.jsx("h4",{children:d.displayName||x.name}),e.jsxs("div",{className:"device-meta",children:[e.jsx("span",{className:`status-badge ${d.status}`,children:b(d.status)}),d.lastSyncAt&&e.jsxs("span",{className:"device-last-sync",children:["Dernière synchro: ",new Date(d.lastSyncAt).toLocaleDateString("fr-FR")]})]})]})]}),e.jsxs("div",{className:"device-actions",children:[e.jsx("button",{onClick:()=>D(d.id),disabled:a||d.status==="disconnected",className:"device-action-btn",title:"Synchroniser maintenant",children:e.jsx(y,{Icon:f.RefreshCw,size:20,className:a?"animate-spin":""})}),e.jsx("button",{onClick:()=>o(w?null:d.id),className:"device-action-btn",title:w?"Réduire":"Développer",children:e.jsx(y,{Icon:w?f.ChevronUp:f.ChevronDown,size:20})})]})]}),e.jsx(ee,{children:w&&e.jsxs(k.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3,ease:[.4,0,.2,1]},className:"device-expanded",children:[e.jsxs("div",{className:"device-stats-grid",children:[e.jsxs("div",{className:"device-stat-item",children:[e.jsx("h5",{children:"Types de données"}),e.jsx("div",{className:"data-types-chips",children:x.dataTypes.slice(0,5).map(E=>e.jsx("span",{className:"data-type-chip",children:E},E))})]}),e.jsxs("div",{className:"device-stat-item",children:[e.jsx("h5",{children:"Connexion"}),e.jsx("p",{className:"device-stat-value",children:new Date(d.connectedAt).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})})]})]}),e.jsxs("button",{onClick:()=>A(d.id),className:"disconnect-btn",children:[e.jsx(y,{Icon:f.Unlink,size:18}),e.jsx("span",{children:"Déconnecter"})]})]})})]},d.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"providers-section-title",children:"Connecter un Appareil"}),e.jsx("div",{className:"providers-grid",children:Object.values(J).filter(d=>we.includes(d.id)).map((d,x)=>{const w=t.some(E=>E.provider===d.id);return e.jsxs(k.div,{className:`provider-card ${w?"connected":""}`,initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:x*.05},children:[e.jsx("div",{className:"provider-icon-container",style:{background:`linear-gradient(135deg, ${d.color}15 0%, ${d.color}35 100%)`},children:e.jsx(y,{Icon:f[d.icon],size:26,color:d.color})}),e.jsxs("div",{className:"provider-info",children:[e.jsx("h4",{children:d.name}),e.jsx("p",{children:d.description})]}),e.jsx("button",{onClick:()=>v(d.id),disabled:w,className:"provider-connect-btn",style:{background:w?void 0:`radial-gradient(circle at 30% 20%, ${d.color}25 0%, transparent 60%),
                             radial-gradient(circle at 70% 80%, ${d.color}20 0%, transparent 50%),
                             linear-gradient(135deg, ${d.color}15 0%, ${d.color}30 100%)`,color:w?void 0:d.color,borderColor:w?void 0:`${d.color}50`},children:w?"Déjà connecté":"Connecter"})]},d.id)})}),e.jsxs("div",{style:{marginTop:"2rem",padding:"1.5rem",borderRadius:"16px",background:"rgba(255, 255, 255, 0.03)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"0.75rem"},children:[e.jsx(y,{Icon:f.Clock,size:20,style:{color:"#06B6D4"}}),e.jsx("h4",{style:{fontSize:"1rem",fontWeight:"600",color:"white",margin:0},children:"Prochainement"})]}),e.jsx("p",{style:{fontSize:"0.875rem",color:"rgba(255, 255, 255, 0.7)",margin:0,lineHeight:"1.5"},children:"Garmin, Polar, Fitbit, Whoop, Oura, Suunto, Coros, et Wahoo seront bientôt disponibles."})]})]})]})]})},Ve=()=>{const{mode:m,recommendedMode:t,isLoading:s,setMode:a}=me(),{showToast:n}=te(),[i,c]=g.useState(null),[o,u]=g.useState(!1);g.useEffect(()=>{const v=ne.analyzeDevice();c(v)},[]);const N=async v=>{if(!(o||s)){u(!0);try{await a(v),n({type:"success",title:`Mode ${{"high-performance":"Performance Maximale",balanced:"Équilibré",quality:"Qualité Premium"}[v]} activé`,message:"La page va se recharger pour appliquer les changements",duration:2e3}),setTimeout(()=>{window.location.reload()},2e3)}catch{n({type:"error",title:"Erreur",message:"Impossible de modifier le mode performance",duration:3e3}),u(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[i&&e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(y,{Icon:f.Smartphone,size:28,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Votre Appareil"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Modèle"}),e.jsx("span",{className:"text-sm text-white font-medium",children:i.deviceSpecs.deviceModel})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Catégorie"}),e.jsx("span",{className:"text-sm text-white font-medium",children:ne.getCategoryLabel(i.deviceCategory)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"RAM"}),e.jsxs("span",{className:"text-sm text-white font-medium",children:[i.deviceSpecs.memoryGB,"GB"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-slate-500 block mb-1",children:"Score"}),e.jsxs("span",{className:"text-sm text-white font-medium",children:[i.performanceScore,"/100"]})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"h-2 rounded-full bg-slate-700 overflow-hidden",children:e.jsx(k.div,{initial:{width:0},animate:{width:`${i.performanceScore}%`},transition:{delay:.3,duration:1,ease:"easeOut"},className:"h-full rounded-full",style:{background:i.performanceScore>=70?"linear-gradient(90deg, #10B981, #34D399)":i.performanceScore>=50?"linear-gradient(90deg, #3B82F6, #60A5FA)":"linear-gradient(90deg, #F59E0B, #FBBF24)"}})})})})]})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Choisissez votre mode de performance"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Nous avons conçu 3 niveaux de qualité visuelle pour adapter l'expérience à votre appareil. Vous pouvez changer de mode à tout moment."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(Y,{mode:"high-performance",isSelected:m==="high-performance",isRecommended:t==="high-performance",onClick:()=>N("high-performance"),disabled:o||s}),e.jsx(Y,{mode:"balanced",isSelected:m==="balanced",isRecommended:t==="balanced",onClick:()=>N("balanced"),disabled:o||s}),e.jsx(Y,{mode:"quality",isSelected:m==="quality",isRecommended:t==="quality",onClick:()=>N("quality"),disabled:o||s})]})]}),e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{Icon:f.Info,size:20,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-white mb-2",children:"À propos des modes de performance"}),e.jsxs("ul",{className:"text-xs text-slate-400 leading-relaxed space-y-2",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-emerald-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-slate-300",children:"Performance Maximale:"})," Désactive tous les effets visuels coûteux pour garantir 60fps. Idéal pour les appareils anciens (iPhone 8-10) ou si vous privilégiez la fluidité et la batterie."]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-slate-300",children:"Équilibré:"})," Active les animations essentielles et un design soigné. Compromis idéal entre performance et esthétique. Recommandé pour iPhone 11-12 et appareils mid-range."]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-purple-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-slate-300",children:"Qualité Premium:"})," Active tous les effets visuels pour une expérience immersive complète. Nécessite un appareil performant (iPhone 13+ ou desktop récent)."]})]})]})]})]})})]})},Z=[{id:"nova",name:"Nova",description:"Voix dynamique et jeune",personality:"Énergique et moderne",sampleText:"Hey ! Je suis Nova. Ensemble, on va déchirer cet entraînement !",isRecommended:!0,isNew:!0},{id:"shimmer",name:"Shimmer",description:"Voix féminine chaleureuse",personality:"Encourageante et bienveillante",sampleText:"Bonjour, je suis Shimmer. Je suis là pour t'encourager à chaque étape de ton parcours.",isRecommended:!0},{id:"echo",name:"Echo",description:"Voix masculine dynamique",personality:"Énergique et motivante",sampleText:"Salut ! Je suis Echo. Prêt à donner le meilleur de toi-même ? Allez, on y va !",isRecommended:!0},{id:"alloy",name:"Alloy",description:"Voix neutre et équilibrée",personality:"Professionnelle, claire et posée",sampleText:"Bonjour, je suis Alloy. Je vous accompagne dans votre entraînement avec une voix claire et professionnelle."},{id:"fable",name:"Fable",description:"Voix expressive britannique",personality:"Élégante et inspirante",sampleText:"Bonjour, je suis Fable. Laisse-moi t'accompagner dans ton parcours avec style et élégance.",isNew:!0},{id:"onyx",name:"Onyx",description:"Voix profonde et posée",personality:"Calme et rassurante",sampleText:"Salut, je suis Onyx. Je t'accompagne avec calme et détermination vers tes objectifs.",isNew:!0}],Ue=()=>{const{profile:m,updateProfile:t}=G(),{showToast:s}=te(),[a,n]=g.useState(m?.preferences?.voice_coach_voice||"alloy"),[i,c]=g.useState(null),[o,u]=g.useState(!1),N=g.useRef(null),v=g.useRef(null);g.useEffect(()=>()=>{D(),N.current?.state!=="closed"&&N.current?.close()},[]);const D=()=>{if(v.current){try{"stop"in v.current?(v.current.stop(),v.current.disconnect()):"pause"in v.current&&(v.current.pause(),v.current.currentTime=0)}catch{}v.current=null}c(null)},A=async p=>{D();const d=Z.find(x=>x.id===p);if(d){c(p);try{const x="https://kwipydbtjagypocpvbwn.supabase.co",w="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3aXB5ZGJ0amFneXBvY3B2YnduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODg0MjIsImV4cCI6MjA3MDI2NDQyMn0.IS5IdKbmnGtgU_AaGYtUgX3ewaNpsiSAui5kbFV31_U";s({type:"info",title:`Aperçu: ${d.name}`,message:"Génération de l'aperçu vocal...",duration:2e3});const E=await fetch(`${x}/functions/v1/generate-voice-preview`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w}`,apikey:w},body:JSON.stringify({voice:p,text:d.sampleText})});if(!E.ok)throw new Error("Failed to generate voice preview");const P=await E.blob(),O=URL.createObjectURL(P),C=new Audio(O);C.volume=1,C.onended=()=>{c(null),URL.revokeObjectURL(O)},C.onerror=()=>{c(null),URL.revokeObjectURL(O),s({type:"error",title:"Erreur",message:"Erreur lors de la lecture de l'aperçu",duration:3e3})},await C.play(),v.current=C}catch(x){console.error("Error playing voice preview:",x),c(null),s({type:"error",title:"Erreur",message:"Impossible de générer l'aperçu audio. Vérifiez votre connexion.",duration:3e3})}}},b=async p=>{n(p),u(!0);try{await t({preferences:{...m?.preferences,voice_coach_voice:p}}),s({type:"success",title:"Voix enregistrée",message:`${Z.find(d=>d.id===p)?.name} sera utilisée pour le coach vocal`,duration:3e3})}catch{s({type:"error",title:"Erreur",message:"Impossible de sauvegarder la préférence de voix",duration:3e3})}finally{u(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Voix du Coach Vocal"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Choisissez la voix qui vous accompagnera pendant vos entraînements. Cliquez sur le bouton de lecture pour écouter un aperçu."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Z.map(p=>{const d=a===p.id,x=i===p.id;return e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsx(S,{className:`p-4 cursor-pointer transition-all duration-300 ${d?"ring-2 ring-cyan-400/50 bg-gradient-to-br from-cyan-500/10 to-blue-500/10":p.isRecommended?"border border-cyan-500/20 hover:border-cyan-500/40 hover:bg-white/5":"hover:bg-white/5"} ${o?"opacity-50 pointer-events-none":""}`,onClick:()=>!o&&b(p.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(y,{Icon:f.Mic,size:24,color:d||p.isRecommended?"#18E3FF":"#60A5FA",variant:"pure"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"text-base font-semibold text-white",children:p.name}),p.isNew&&e.jsx("span",{className:"px-2 py-0.5 text-xs font-semibold rounded-full bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 border border-purple-500/30",children:"Nouveau"}),p.isRecommended&&!p.isNew&&e.jsx("span",{className:"text-xs text-cyan-400/70",children:"★"})]}),d&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-cyan-400",children:[e.jsx(y,{Icon:f.Check,size:14,color:"#18E3FF",variant:"pure"}),e.jsx("span",{children:"Sélectionnée"})]})]}),e.jsx("p",{className:"text-sm text-slate-400 mb-2",children:p.description}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[e.jsx(y,{Icon:f.Sparkles,size:12,color:"#94A3B8",variant:"pure"}),e.jsx("span",{children:p.personality})]}),e.jsxs("button",{onClick:w=>{w.stopPropagation(),x?D():A(p.id)},className:`mt-3 w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all ${x?"bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30":"bg-white/10 text-white hover:bg-white/15"}`,disabled:o,children:[e.jsx(y,{Icon:x?f.X:f.Play,size:16,color:x?"#18E3FF":"#FFFFFF",variant:"pure"}),e.jsx("span",{children:x?"Arrêter l'aperçu":"Écouter un aperçu"})]})]})]})})},p.id)})}),e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{Icon:f.Info,size:20,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-white mb-2",children:"À propos du Coach Vocal"}),e.jsxs("ul",{className:"text-xs text-slate-400 leading-relaxed space-y-2",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Le coach vocal utilise la technologie OpenAI Realtime pour vous guider en temps réel pendant vos entraînements"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Chaque voix a sa propre personnalité pour s'adapter à votre style d'entraînement"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Les aperçus audio sont des simulations. La voix réelle sera utilisée lors de vos séances d'entraînement"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Vous pouvez changer de voix à tout moment selon vos préférences"})]})]})]})]})})]})},We="/sw.js";class $e{constructor(){se(this,"serviceWorkerRegistration",null)}async registerServiceWorker(){if(!("serviceWorker"in navigator))return r.warn("WEB_PUSH","Service Workers not supported"),null;try{const t=await navigator.serviceWorker.register(We);return this.serviceWorkerRegistration=t,r.info("WEB_PUSH","Service Worker registered",{scope:t.scope}),t}catch(t){return r.error("WEB_PUSH","Failed to register Service Worker",{error:t}),null}}async getServiceWorkerRegistration(){if(this.serviceWorkerRegistration)return this.serviceWorkerRegistration;if(!("serviceWorker"in navigator))return null;try{const t=await navigator.serviceWorker.ready;return this.serviceWorkerRegistration=t,t}catch(t){return r.error("WEB_PUSH","Failed to get Service Worker registration",{error:t}),null}}async checkPermissionState(){const t="Notification"in window&&"serviceWorker"in navigator;if(!t)return{permission:"denied",isSupported:!1,isSubscribed:!1,subscription:null};const s=Notification.permission;let a=null,n=!1;if(s==="granted"){const i=await this.getCurrentSubscription();i&&(a=this.convertSubscriptionToWebPush(i),n=!0)}return{permission:s,isSupported:t,isSubscribed:n,subscription:a}}async checkPushPermission(){return"Notification"in window?Notification.permission:"denied"}async requestPermission(){if(!("Notification"in window))return r.warn("WEB_PUSH","Notifications not supported"),"denied";try{const t=await Notification.requestPermission();return r.info("WEB_PUSH","Permission requested",{permission:t}),t}catch(t){return r.error("WEB_PUSH","Error requesting permission",{error:t}),"denied"}}async getCurrentSubscription(){const t=await this.getServiceWorkerRegistration();if(!t)return null;try{return await t.pushManager.getSubscription()}catch(s){return r.error("WEB_PUSH","Failed to get current subscription",{error:s}),null}}async subscribe(t){try{const s=await this.requestPermission();if(s!=="granted")return r.warn("WEB_PUSH","Permission not granted",{permission:s}),null;const a=await this.getServiceWorkerRegistration();if(!a)return r.error("WEB_PUSH","No service worker registration available"),null;const n=await this.getVapidPublicKey();if(!n)return r.error("WEB_PUSH","VAPID public key not available"),null;const i=await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(n)});return r.info("WEB_PUSH","Subscribed to push notifications",{endpoint:i.endpoint}),this.convertSubscriptionToPayload(i)}catch(s){return r.error("WEB_PUSH","Failed to subscribe to push notifications",{error:s}),null}}async unsubscribe(){try{const t=await this.getCurrentSubscription();if(!t)return r.warn("WEB_PUSH","No active subscription to unsubscribe"),!0;const s=await t.unsubscribe();return r.info("WEB_PUSH","Unsubscribed from push notifications",{success:s}),s}catch(t){return r.error("WEB_PUSH","Failed to unsubscribe from push notifications",{error:t}),!1}}async refreshSubscription(t){try{return await this.unsubscribe(),await this.subscribe(t)}catch(s){return r.error("WEB_PUSH","Failed to refresh subscription",{error:s}),null}}async getVapidPublicKey(){try{return r.warn("WEB_PUSH","VAPID public key not configured"),null}catch(t){return r.error("WEB_PUSH","Failed to get VAPID public key",{error:t}),null}}async sendTestNotification(t){try{const{data:s,error:a}=await _.functions.invoke("send-push-notification",{body:{userId:t,notification:{title:"Test Notification",body:"Les notifications push fonctionnent correctement !",icon:"/brand/dual-ingot.svg",badge:"/brand/dual-ingot.svg",tag:"test-notification",data:{url:"/"}}}});return a?(r.error("WEB_PUSH","Failed to send test notification",{error:a}),!1):(r.info("WEB_PUSH","Test notification sent",{data:s}),!0)}catch(s){return r.error("WEB_PUSH","Error sending test notification",{error:s}),!1}}convertSubscriptionToPayload(t){const s=t.getKey("p256dh"),a=t.getKey("auth");return{subscription_endpoint:t.endpoint,subscription_keys:{p256dh:this.arrayBufferToBase64(s),auth:this.arrayBufferToBase64(a)},device_info:{userAgent:navigator.userAgent,platform:navigator.platform,browser:this.getBrowserInfo(),os:this.getOSInfo()}}}convertSubscriptionToWebPush(t){const s=t.getKey("p256dh"),a=t.getKey("auth");return{endpoint:t.endpoint,expirationTime:t.expirationTime,keys:{p256dh:this.arrayBufferToBase64(s),auth:this.arrayBufferToBase64(a)}}}urlBase64ToUint8Array(t){const s="=".repeat((4-t.length%4)%4),a=(t+s).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(a),i=new Uint8Array(n.length);for(let c=0;c<n.length;++c)i[c]=n.charCodeAt(c);return i}arrayBufferToBase64(t){const s=new Uint8Array(t);let a="";for(let n=0;n<s.byteLength;n++)a+=String.fromCharCode(s[n]);return window.btoa(a)}getBrowserInfo(){const t=navigator.userAgent;return t.includes("Chrome")?"Chrome":t.includes("Firefox")?"Firefox":t.includes("Safari")?"Safari":t.includes("Edge")?"Edge":"Unknown"}getOSInfo(){const t=navigator.userAgent;return t.includes("Win")?"Windows":t.includes("Mac")?"macOS":t.includes("Linux")?"Linux":t.includes("Android")?"Android":t.includes("iOS")?"iOS":"Unknown"}}const de=new $e,Me=()=>{const{profile:m}=G(),t=m?.id,{globalSettings:s,categoryPreferences:a,pushSubscriptions:n,activePushSubscription:i,isLoading:c,isSaving:o,error:u,loadGlobalSettings:N,updateGlobalSetting:v,loadCategoryPreferences:D,updateCategoryPreference:A,loadPushSubscriptions:b,subscribeToPush:p,unsubscribeFromPush:d,clearError:x}=Ae(),[w,E]=g.useState("default"),[P,O]=g.useState(!1);g.useEffect(()=>{t&&(async()=>{try{await Promise.all([N(t),D(t),b(t),C()])}catch(j){console.error("Failed to load notification preferences:",j)}})()},[t]);const C=async()=>{try{if(!("Notification"in window)){E("denied");return}const l=Notification.permission;E(l)}catch(l){console.error("Failed to check push permission:",l),E("denied")}},V=async()=>{if(t){O(!0);try{const l=await de.subscribe(t);l&&(await p(l,t),await C())}catch(l){console.error("Failed to subscribe to push notifications",l)}finally{O(!1)}}},T=async()=>{if(!(!i||!t)){O(!0);try{await d(i.id,t),await de.unsubscribe(),await C()}catch(l){console.error("Failed to unsubscribe from push notifications",l)}finally{O(!1)}}},H=async(l,j)=>{await v(l,j,t)},U=async(l,j,R)=>{await A(l,{[j]:R},t)},B=s.push_notifications_enabled,$=!!i,h=!("Notification"in window)||!("serviceWorker"in navigator);return e.jsxs("div",{className:"space-y-6",children:[u&&e.jsx(I,{type:"error",message:u,actions:e.jsx(z,{variant:"ghost",onClick:x,children:"Fermer"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Gérer vos notifications"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Personnalisez vos préférences de notifications pour rester informé sans être submergé."})]}),e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(S,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-6",children:[e.jsx(y,{Icon:f.Bell,size:24,color:"#18E3FF",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-base font-semibold text-white mb-1",children:"Paramètres globaux"}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:"Contrôlez tous vos types de notifications"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(W,{label:"Notifications push",description:"Recevez des notifications sur votre appareil même quand l'app est fermée",enabled:B,onChange:l=>H("push_notifications_enabled",l),disabled:c,loading:o}),e.jsx(W,{label:"Notifications in-app",description:"Affichez les notifications quand vous utilisez l'application",enabled:s.in_app_notifications_enabled,onChange:l=>H("in_app_notifications_enabled",l),disabled:c,loading:o}),e.jsx(W,{label:"Notifications email",description:"Recevez des emails pour les notifications importantes",enabled:s.email_notifications_enabled,onChange:l=>H("email_notifications_enabled",l),disabled:c,loading:o}),e.jsx(W,{label:"Son des notifications",description:"Jouez un son lors de la réception d'une notification",enabled:s.notification_sound_enabled,onChange:l=>H("notification_sound_enabled",l),disabled:c,loading:o}),e.jsx(W,{label:"Vibration",description:"Faites vibrer l'appareil lors de la réception d'une notification",enabled:s.notification_vibration_enabled,onChange:l=>H("notification_vibration_enabled",l),disabled:c,loading:o})]})]})}),B&&e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.1},children:e.jsxs(S,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-6",children:[e.jsx(y,{Icon:f.Smartphone,size:24,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-base font-semibold text-white mb-1",children:"Configuration Web Push"}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:"Gérez vos abonnements aux notifications push"})]})]}),h&&e.jsx(I,{type:"warning",message:"Les notifications push ne sont pas supportées par votre navigateur."}),!h&&w==="denied"&&e.jsx(I,{type:"error",title:"Permission refusée",message:"Vous avez refusé les notifications. Vous devez autoriser les notifications dans les paramètres de votre navigateur."}),!h&&w==="granted"&&!$&&e.jsx(I,{type:"info",title:"Activez les notifications push",message:"Abonnez-vous aux notifications push pour recevoir des alertes même quand l'app est fermée.",actions:e.jsx(z,{onClick:V,loading:P,icon:e.jsx(ae,{size:18}),children:"Activer les notifications push"})}),!h&&w==="default"&&e.jsx(I,{type:"info",message:"Cliquez sur le bouton ci-dessous pour autoriser les notifications push.",actions:e.jsx(z,{onClick:V,loading:P,icon:e.jsx(ae,{size:18}),children:"Demander l'autorisation"})}),$&&e.jsx(I,{type:"success",title:"Notifications push actives",message:`Abonné depuis ${new Date(i.created_at).toLocaleDateString()}`,actions:e.jsx(z,{variant:"danger",onClick:T,loading:P,icon:e.jsx(fe,{size:18}),children:"Désactiver les notifications push"})})]})}),e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.2},children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-base font-semibold text-white mb-2",children:"Notifications par catégorie"}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:"Personnalisez vos préférences pour chaque type de notification"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:Ce.map(l=>{const j=a.get(l.category);return e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(S,{className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-white mb-1",children:l.label}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:l.description})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Push"}),e.jsx("button",{onClick:()=>U(l.category,"push_enabled",!(j?.push_enabled??!0)),disabled:c||!l.canDisable,className:`w-8 h-4 rounded-full transition-all ${j?.push_enabled??!0?"bg-cyan-500":"bg-slate-600"} ${l.canDisable?"cursor-pointer":"opacity-50 cursor-not-allowed"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${j?.push_enabled??!0?"translate-x-4":"translate-x-0.5"}`})})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"In-app"}),e.jsx("button",{onClick:()=>U(l.category,"in_app_enabled",!(j?.in_app_enabled??!0)),disabled:c||!l.canDisable,className:`w-8 h-4 rounded-full transition-all ${j?.in_app_enabled??!0?"bg-cyan-500":"bg-slate-600"} ${l.canDisable?"cursor-pointer":"opacity-50 cursor-not-allowed"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${j?.in_app_enabled??!0?"translate-x-4":"translate-x-0.5"}`})})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Email"}),e.jsx("button",{onClick:()=>U(l.category,"email_enabled",!(j?.email_enabled??!1)),disabled:c||!l.canDisable,className:`w-8 h-4 rounded-full transition-all ${j?.email_enabled??!1?"bg-cyan-500":"bg-slate-600"} ${l.canDisable?"cursor-pointer":"opacity-50 cursor-not-allowed"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${j?.email_enabled??!1?"translate-x-4":"translate-x-0.5"}`})})]})]})]})},l.category)})})]}),e.jsx(S,{className:"p-6 bg-gradient-to-br from-blue-500/5 to-cyan-500/5",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{Icon:f.Info,size:20,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-white mb-2",children:"À propos des notifications"}),e.jsxs("ul",{className:"text-xs text-slate-400 leading-relaxed space-y-2",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Les notifications push vous permettent de rester informé même quand l'application est fermée"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Vous pouvez désactiver les notifications pour des catégories spécifiques tout en gardant les autres actives"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Les notifications importantes (sécurité, mises à jour critiques) ne peuvent pas être désactivées"})]})]})]})]})}),c&&!u&&e.jsx(I,{type:"info",message:"Chargement des préférences de notifications..."})]})};class Ge{async requestFullExport(t,s="json"){const a={request_type:"full_export",export_format:s,included_data:["profile","training","nutrition","fasting","body_scans","activities","health","preferences","notifications"]};return this.requestExport(t,a)}async requestPartialExport(t,s,a="json"){const n={request_type:"partial_export",export_format:a,included_data:s};return this.requestExport(t,n)}async requestExport(t,s){try{r.info("DATA_EXPORT","Requesting data export",{userId:t,type:s.request_type,format:s.export_format,categories:s.included_data.length});const{data:a,error:n}=await _.rpc("request_data_export",{p_user_id:t,p_request_type:s.request_type,p_export_format:s.export_format,p_included_data:s.included_data});if(n)throw r.error("DATA_EXPORT","Failed to request export",{error:n}),n;const i=a;return r.info("DATA_EXPORT","Export request created",{requestId:i}),await this.triggerExportProcessing(i,t),i}catch(a){return r.error("DATA_EXPORT","Error requesting export",{error:a}),null}}async triggerExportProcessing(t,s){try{const{error:a}=await _.functions.invoke("export-user-data",{body:{requestId:t,userId:s}});if(a)throw r.error("DATA_EXPORT","Failed to trigger export processing",{error:a}),a;r.info("DATA_EXPORT","Export processing triggered",{requestId:t})}catch(a){r.error("DATA_EXPORT","Error triggering export processing",{error:a})}}async getExportStatus(t){try{const{data:s,error:a}=await _.from("data_export_requests").select("*").eq("id",t).maybeSingle();return a?(r.error("DATA_EXPORT","Failed to get export status",{error:a}),null):s}catch(s){return r.error("DATA_EXPORT","Error getting export status",{error:s}),null}}async pollExportProgress(t,s,a=60,n=2e3){let i=0,c=n;for(;i<a;){const o=await this.getExportStatus(t);if(!o)return r.error("DATA_EXPORT","Export request not found",{requestId:t}),null;if(s){const u=this.calculateProgress(o);s(u)}if(o.status==="completed")return r.info("DATA_EXPORT","Export completed",{requestId:t}),o;if(o.status==="failed")return r.error("DATA_EXPORT","Export failed",{requestId:t,error:o.error_message}),o;await new Promise(u=>setTimeout(u,c)),c=Math.min(c*1.5,1e4),i++}return r.warn("DATA_EXPORT","Export polling timeout",{requestId:t,attempts:i}),await this.getExportStatus(t)}calculateProgress(t){let s=0,a="Préparation";switch(t.status){case"pending":s=10,a="En attente";break;case"processing":s=50,a="Extraction des données en cours";break;case"completed":s=100,a="Terminé";break;case"failed":s=0,a="Erreur";break}return{requestId:t.id,status:t.status,progress:s,estimatedTimeRemaining:this.estimateTimeRemaining(t),currentStep:a}}estimateTimeRemaining(t){if(t.status==="completed"||t.status==="failed")return 0;if(t.status==="pending")return 120;if(t.status==="processing"){const s=new Date(t.requested_at).getTime(),n=(Date.now()-s)/1e3,c=Math.max(0,180-n);return Math.round(c)}return null}async getDownloadUrl(t){try{const s=await this.getExportStatus(t);return s?s.status!=="completed"?(r.warn("DATA_EXPORT","Export not completed",{requestId:t,status:s.status}),null):s.file_url?s.expires_at&&new Date(s.expires_at)<new Date?(r.warn("DATA_EXPORT","Download link expired",{requestId:t,expiresAt:s.expires_at}),null):s.file_url:(r.error("DATA_EXPORT","No file URL available",{requestId:t}),null):(r.error("DATA_EXPORT","Export request not found",{requestId:t}),null)}catch(s){return r.error("DATA_EXPORT","Error getting download URL",{error:s}),null}}async downloadExport(t){try{const s=await this.getDownloadUrl(t);if(!s)return r.error("DATA_EXPORT","No download URL available",{requestId:t}),!1;const a=document.createElement("a");return a.href=s,a.download=`twinforge-export-${t}`,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a),r.info("DATA_EXPORT","Export download triggered",{requestId:t}),!0}catch(s){return r.error("DATA_EXPORT","Error downloading export",{error:s}),!1}}async getExportHistory(t,s=10){try{const{data:a,error:n}=await _.from("data_export_requests").select("*").eq("user_id",t).order("requested_at",{ascending:!1}).limit(s);return n?(r.error("DATA_EXPORT","Failed to get export history",{error:n}),[]):a||[]}catch(a){return r.error("DATA_EXPORT","Error getting export history",{error:a}),[]}}async cleanupOldExports(t){try{const s=new Date;s.setDate(s.getDate()-7);const{data:a,error:n}=await _.from("data_export_requests").select("id").eq("user_id",t).eq("status","completed").lt("completed_at",s.toISOString());if(n||!a||a.length===0)return;r.info("DATA_EXPORT","Old exports found for cleanup",{count:a.length})}catch(s){r.error("DATA_EXPORT","Error cleaning up old exports",{error:s})}}formatFileSize(t){return t?t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(2)} KB`:t<1024*1024*1024?`${(t/(1024*1024)).toFixed(2)} MB`:`${(t/(1024*1024*1024)).toFixed(2)} GB`:"N/A"}estimateExportSize(t){const s={profile:100,training:5e3,nutrition:3e3,fasting:500,body_scans:2e4,activities:2e3,health:1e3,preferences:50,notifications:500},a=t.reduce((n,i)=>n+(s[i]||0),0)*1024;return this.formatFileSize(a)}}const ue=new Ge;class Xe{async requestDeletion(t,s){try{r.info("ACCOUNT_DELETION","Requesting account deletion",{userId:t,deleteAllData:s.delete_all_data,anonymizeOnly:s.anonymize_only});const{data:a,error:n}=await _.rpc("request_account_deletion",{p_user_id:t,p_delete_all_data:s.delete_all_data,p_anonymize_only:s.anonymize_only,p_reason:s.reason||null});if(n)throw r.error("ACCOUNT_DELETION","Failed to request deletion",{error:n}),n;const i=a;return r.info("ACCOUNT_DELETION","Deletion request created",{requestId:i}),i}catch(a){return r.error("ACCOUNT_DELETION","Error requesting deletion",{error:a}),null}}async cancelDeletion(t,s){try{r.info("ACCOUNT_DELETION","Cancelling deletion request",{userId:t,reason:s.reason});const{data:a,error:n}=await _.rpc("cancel_account_deletion",{p_user_id:t,p_cancellation_reason:s.reason||null});if(n)throw r.error("ACCOUNT_DELETION","Failed to cancel deletion",{error:n}),n;const i=a;return i?r.info("ACCOUNT_DELETION","Deletion request cancelled successfully"):r.warn("ACCOUNT_DELETION","No active deletion request to cancel"),i}catch(a){return r.error("ACCOUNT_DELETION","Error cancelling deletion",{error:a}),!1}}async getActiveDeletionRequest(t){try{const{data:s,error:a}=await _.from("account_deletion_requests").select("*").eq("user_id",t).in("status",["pending","scheduled","processing"]).maybeSingle();return a?(r.error("ACCOUNT_DELETION","Failed to get deletion request",{error:a}),null):s}catch(s){return r.error("ACCOUNT_DELETION","Error getting deletion request",{error:s}),null}}async hasActiveDeletion(t){return await this.getActiveDeletionRequest(t)!==null}async getDeletionHistory(t){try{const{data:s,error:a}=await _.from("account_deletion_requests").select("*").eq("user_id",t).order("requested_at",{ascending:!1});return a?(r.error("ACCOUNT_DELETION","Failed to get deletion history",{error:a}),[]):s||[]}catch(s){return r.error("ACCOUNT_DELETION","Error getting deletion history",{error:s}),[]}}getDeletionWarningInfo(t){const s=Pe(t.deletion_scheduled_at),a=new Date(t.deletion_scheduled_at),n=Te(t);let i="info",c="";return s<=3?(i="critical",c=`Votre compte sera définitivement supprimé dans ${s} jour${s>1?"s":""}.`):s<=7?(i="warning",c=`Votre compte sera supprimé dans ${s} jours.`):(i="info",c=`Votre demande de suppression sera effective dans ${s} jours.`),{daysRemaining:s,scheduledDate:a,canCancel:n,warningLevel:i,message:c}}getDataToBeDeleted(t,s){return s?["Vos informations personnelles seront anonymisées","Vos données d'entraînement resteront pour les statistiques","Votre email et photo de profil seront supprimés","Votre identité ne sera plus associée à vos données"]:t?["Profil et informations personnelles","Historique d'entraînement complet","Journal alimentaire et recettes","Sessions de jeûne","Scans corporels et photos","Activités enregistrées","Données de santé","Préférences et paramètres","Historique des notifications"]:["Profil et informations personnelles","Données sensibles (photos, santé)","Préférences et paramètres"]}getDeletionConsequences(){return["⚠️ Cette action est irréversible après le délai de grâce","⚠️ Vous ne pourrez plus accéder à vos données","⚠️ Votre progression sera définitivement perdue","⚠️ Vos abonnements et achats seront annulés","ℹ️ Vous avez 30 jours pour annuler cette demande","ℹ️ Un email de confirmation vous sera envoyé"]}async processScheduledDeletions(){try{r.info("ACCOUNT_DELETION","Processing scheduled deletions");const{error:t}=await _.functions.invoke("process-account-deletion");if(t)throw r.error("ACCOUNT_DELETION","Failed to process scheduled deletions",{error:t}),t;r.info("ACCOUNT_DELETION","Scheduled deletions processed successfully")}catch(t){r.error("ACCOUNT_DELETION","Error processing scheduled deletions",{error:t})}}getAnonymizationInfo(){return{title:"Anonymisation des données",description:"L'anonymisation supprime vos informations personnelles tout en conservant vos données d'entraînement pour les statistiques agrégées.",whatIsKept:["Données d'entraînement (sans identification)","Statistiques de progression (anonymisées)","Données nutritionnelles agrégées"],whatIsRemoved:["Nom, email, et informations personnelles","Photos et scans corporels","Données de connexion","Préférences personnelles"]}}async sendDeletionReminder(t,s){try{r.info("ACCOUNT_DELETION","Sending deletion reminder",{userId:t,daysRemaining:s})}catch(a){r.error("ACCOUNT_DELETION","Error sending deletion reminder",{error:a})}}async sendDeletionConfirmation(t,s){try{r.info("ACCOUNT_DELETION","Sending deletion confirmation",{userId:t,requestId:s})}catch(a){r.error("ACCOUNT_DELETION","Error sending deletion confirmation",{error:a})}}async sendCancellationConfirmation(t){try{r.info("ACCOUNT_DELETION","Sending cancellation confirmation",{userId:t})}catch(s){r.error("ACCOUNT_DELETION","Error sending cancellation confirmation",{error:s})}}}const Ke=new Xe,Je=()=>{const{profile:m}=G(),t=m?.id,{preferences:s,activeDeletionRequest:a,recentExportRequests:n,isLoading:i,isSaving:c,error:o,loadPrivacyPreferences:u,updatePrivacyPreference:N,loadExportRequests:v,requestDataExport:D,loadDeletionRequest:A,requestAccountDeletion:b,cancelAccountDeletion:p,clearError:d}=ke(),[x,w]=g.useState(ie.filter(l=>l.includeByDefault).map(l=>l.category)),[E,P]=g.useState(!1),[O,C]=g.useState("");g.useEffect(()=>{(async()=>{if(t)try{await Promise.all([u(t),v(t),A(t)])}catch(j){console.error("Failed to load privacy settings:",j)}})()},[t]);const V=async()=>{t&&await D({request_type:"partial_export",export_format:"json",included_data:x},t)},T=async()=>{if(!t)return;await b({delete_all_data:!0,anonymize_only:!1,reason:O||void 0},t)&&(P(!1),C(""))},H=async()=>{if(!t)return;await p({reason:"Annulation par l'utilisateur"},t)&&await A(t)},U=async l=>{await ue.downloadExport(l)},B=l=>{w(j=>j.includes(l)?j.filter(R=>R!==l):[...j,l])},$=ue.estimateExportSize(x),h=a?Ke.getDeletionWarningInfo(a):null;return e.jsxs("div",{className:"space-y-6",children:[o&&e.jsx(I,{type:"error",message:o,actions:e.jsx(z,{variant:"ghost",onClick:d,children:"Fermer"})}),a&&h&&e.jsx(I,{type:h.warningLevel,title:"Suppression de compte programmée",message:e.jsxs("div",{children:[e.jsx("p",{children:h.message}),e.jsxs("p",{style:{marginTop:"0.5rem"},children:[e.jsx("strong",{children:"Date prévue:"})," ",h.scheduledDate.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})]})]}),actions:h.canCancel&&e.jsx(z,{variant:"secondary",onClick:H,loading:c,icon:e.jsx(be,{size:18}),children:"Annuler la suppression"})}),e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsx(S,{className:"p-6 bg-gradient-to-br from-green-500/10 to-emerald-500/5 border border-green-500/20",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(y,{Icon:f.Shield,size:32,color:"#22C55E",variant:"pure"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"Vos données sont strictement confidentielles et ultra-protégées"}),e.jsxs("ul",{className:"space-y-2 text-sm text-slate-300",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(M,{size:18,className:"text-green-400 flex-shrink-0 mt-0.5"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Chiffrement de bout en bout:"})," Toutes vos données sensibles sont chiffrées avant stockage"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(M,{size:18,className:"text-green-400 flex-shrink-0 mt-0.5"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Accès strictement limité:"})," Seul vous avez accès à vos données personnelles et métriques"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(M,{size:18,className:"text-green-400 flex-shrink-0 mt-0.5"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Conformité RGPD:"})," Nous respectons vos droits d'accès, de rectification et de suppression"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(M,{size:18,className:"text-green-400 flex-shrink-0 mt-0.5"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Aucun partage:"})," Vos données ne sont jamais partagées avec des tiers à des fins commerciales"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(M,{size:18,className:"text-green-400 flex-shrink-0 mt-0.5"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Contrôle total:"})," Vous pouvez exporter ou supprimer vos données à tout moment"]})]})]})]})]})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Gérer votre confidentialité"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Contrôlez vos préférences de confidentialité et gérez vos données personnelles en toute transparence."})]}),e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.1},children:e.jsxs(S,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-6",children:[e.jsx(y,{Icon:f.Shield,size:24,color:"#18E3FF",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-base font-semibold text-white mb-1",children:"Préférences de confidentialité"}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:"Contrôlez comment vos données sont utilisées"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Durée de conservation des données"}),e.jsxs("select",{value:s.data_retention_preference,onChange:l=>N("data_retention_preference",l.target.value,t),disabled:i,className:"w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50",children:[e.jsx("option",{value:"minimal",children:"Minimale (30 jours)"}),e.jsx("option",{value:"standard",children:"Standard (2 ans)"}),e.jsx("option",{value:"extended",children:"Étendue (indéfinie)"})]}),e.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"Choisissez combien de temps nous conservons vos données historiques"})]}),e.jsx(W,{label:"Suivi analytique",description:"Nous aide à améliorer l'application en analysant votre utilisation de manière anonymisée",enabled:s.analytics_tracking_enabled,onChange:l=>N("analytics_tracking_enabled",l,t),disabled:i,loading:c}),e.jsx(W,{label:"Communications marketing",description:"Recevez des actualités, conseils et offres promotionnelles",enabled:s.marketing_communications_enabled,onChange:l=>N("marketing_communications_enabled",l,t),disabled:i,loading:c})]})]})}),e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.2},children:e.jsxs(S,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-6",children:[e.jsx(y,{Icon:f.Download,size:24,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-base font-semibold text-white mb-1",children:"Export de vos données"}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:"Téléchargez une copie complète de vos données (droit à la portabilité RGPD)"})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(I,{type:"info",message:"Sélectionnez les catégories de données que vous souhaitez exporter. Le fichier sera disponible pendant 7 jours."})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-4",children:ie.map(l=>e.jsxs("label",{className:"flex items-start gap-3 p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition-all",children:[e.jsx("input",{type:"checkbox",checked:x.includes(l.category),onChange:()=>B(l.category),className:"mt-0.5 w-4 h-4 rounded border-white/20 bg-white/10 text-cyan-500 focus:ring-cyan-500/50"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-white",children:l.label}),e.jsx("span",{className:"text-xs text-slate-400",children:l.estimatedSize})]}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:l.description})]})]},l.category))}),e.jsxs("div",{className:"p-4 rounded-lg bg-white/5 border border-white/10 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-slate-400",children:"Taille estimée:"}),e.jsx("span",{className:"font-semibold text-white",children:$})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm mt-2",children:[e.jsx("span",{className:"text-slate-400",children:"Format:"}),e.jsx("span",{className:"font-semibold text-white",children:"JSON"})]})]}),e.jsx(z,{onClick:V,loading:c,disabled:x.length===0,icon:e.jsx(re,{size:18}),fullWidth:!0,children:"Demander un export"}),n.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h5",{className:"text-sm font-semibold text-white mb-3",children:"Exports récents"}),e.jsx("div",{className:"space-y-2",children:n.map(l=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm text-white",children:new Date(l.requested_at).toLocaleDateString()}),e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${l.status==="completed"?"bg-green-500/20 text-green-400":l.status==="processing"?"bg-blue-500/20 text-blue-400":l.status==="failed"?"bg-red-500/20 text-red-400":"bg-yellow-500/20 text-yellow-400"}`,children:[l.status==="completed"&&"Prêt",l.status==="processing"&&"En cours",l.status==="pending"&&"En attente",l.status==="failed"&&"Échec"]})]}),l.file_size_bytes&&e.jsx("span",{className:"text-xs text-slate-400",children:Oe(l.file_size_bytes)})]}),l.status==="completed"&&l.file_url&&e.jsx(z,{variant:"secondary",onClick:()=>U(l.id),icon:e.jsx(re,{size:16}),children:"Télécharger"})]},l.id))})]})]})}),!a&&e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.3},children:e.jsxs(S,{className:"p-6 border border-red-500/20",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-6",children:[e.jsx(y,{Icon:f.Trash,size:24,color:"#EF4444",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-base font-semibold text-white mb-1",children:"Suppression de compte"}),e.jsx("p",{className:"text-xs text-slate-400 leading-relaxed",children:"Supprimer définitivement votre compte et toutes vos données"})]})]}),e.jsx(I,{type:"warning",title:"Action irréversible",message:e.jsxs("div",{children:[e.jsx("p",{className:"mb-2",children:"La suppression de votre compte entraînera:"}),e.jsxs("ul",{className:"space-y-1 text-sm",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Suppression de toutes vos données personnelles"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Perte définitive de votre progression"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-400 mt-0.5",children:"•"}),e.jsx("span",{children:"Annulation de vos abonnements"})]})]}),e.jsxs("p",{className:"mt-3 text-xs",children:[e.jsx("strong",{children:"Délai de grâce:"})," Vous aurez 30 jours pour annuler cette demande."]})]})}),E?e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Pourquoi souhaitez-vous supprimer votre compte? (optionnel)"}),e.jsx("textarea",{value:O,onChange:l=>C(l.target.value),placeholder:"Raison de la suppression...",rows:3,className:"w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 text-white text-sm focus:outline-none focus:ring-2 focus:ring-red-500/50 placeholder-slate-500"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(z,{variant:"ghost",onClick:()=>{P(!1),C("")},fullWidth:!0,children:"Annuler"}),e.jsx(z,{variant:"danger",onClick:T,loading:c,icon:e.jsx(ve,{size:18}),fullWidth:!0,children:"Confirmer la suppression"})]})]}):e.jsx(z,{variant:"danger",onClick:()=>P(!0),icon:e.jsx(ye,{size:18}),fullWidth:!0,children:"Demander la suppression du compte"})]})}),e.jsx(S,{className:"p-6 bg-gradient-to-br from-blue-500/5 to-purple-500/5",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{Icon:f.Info,size:20,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-white mb-2",children:"Vos droits RGPD"}),e.jsxs("ul",{className:"text-xs text-slate-400 leading-relaxed space-y-2",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Droit d'accès:"})," Consultez toutes vos données stockées à tout moment"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Droit de rectification:"})," Modifiez vos informations personnelles depuis votre profil"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Droit à la portabilité:"})," Exportez vos données dans un format standard"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-cyan-400 mt-0.5",children:"•"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Droit à l'oubli:"})," Supprimez votre compte et toutes vos données définitivement"]})]})]})]})]})}),i&&!o&&e.jsx(I,{type:"info",message:"Chargement des paramètres de confidentialité..."})]})},q={free:{color:"#64748B",gradient:"linear-gradient(135deg, #64748B, #475569)",borderColor:"rgba(100, 116, 139, 0.3)",label:"Essai Gratuit"},starter_9:{color:"#3B82F6",gradient:"linear-gradient(135deg, #3B82F6, #60A5FA)",borderColor:"rgba(59, 130, 246, 0.3)",label:"Starter"},pro_19:{color:"#10B981",gradient:"linear-gradient(135deg, #10B981, #34D399)",borderColor:"rgba(16, 185, 129, 0.3)",label:"Pro"},premium_29:{color:"#F97316",gradient:"linear-gradient(135deg, #F97316, #FB923C)",borderColor:"rgba(249, 115, 22, 0.3)",label:"Premium"},elite_39:{color:"#EC4899",gradient:"linear-gradient(135deg, #EC4899, #F472B6)",borderColor:"rgba(236, 72, 153, 0.3)",label:"Elite"},expert_49:{color:"#EF4444",gradient:"linear-gradient(135deg, #EF4444, #F87171)",borderColor:"rgba(239, 68, 68, 0.3)",label:"Expert"},master_59:{color:"#8B5CF6",gradient:"linear-gradient(135deg, #8B5CF6, #A78BFA)",borderColor:"rgba(139, 92, 246, 0.3)",label:"Master"},ultimate_99:{color:"#FBBF24",gradient:"linear-gradient(135deg, #FBBF24, #FCD34D)",borderColor:"rgba(251, 191, 36, 0.3)",label:"Ultimate"}},Ye=(m,t)=>m==="free"?q.free:t===9?q.starter_9:t===19?q.pro_19:t===29?q.premium_29:t===39?q.elite_39:t===49?q.expert_49:t===59?q.master_59:t===99?q.ultimate_99:q.free,Qe=({planId:m,name:t,priceEur:s,tokensPerMonth:a,isCurrentPlan:n,isFree:i,onSelect:c,isLoading:o})=>{const u=Ye(m,s);return e.jsx(_e,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"relative",children:e.jsxs(S,{className:`p-5 transition-all cursor-pointer ${n?"ring-2 scale-[1.05] shadow-2xl":"hover:scale-[1.02]"}`,style:{background:n?`${u.gradient.replace("linear-gradient","linear-gradient(135deg, ")}35, ${u.gradient.split(", ")[1]}20)`:`${u.gradient.replace("linear-gradient","linear-gradient(135deg, ")}20, ${u.gradient.split(", ")[1]}10)`,borderColor:n?`${u.color}80`:u.borderColor,boxShadow:n?`0 0 40px ${u.color}40, 0 8px 32px rgba(0, 0, 0, 0.3)`:void 0},onClick:()=>!n&&!o&&c(m),children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h3",{className:`text-lg font-bold text-white mb-1 ${n?"text-xl":""}`,children:u.label}),i&&e.jsx("p",{className:"text-xs text-slate-400",children:"Découvrez l'application"})]}),e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx(K,{size:48,variant:n?"success":"normal",withGlow:n,customColor:u.color})}),e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("div",{className:"text-3xl font-bold text-white mb-1",children:i?"Gratuit":`${s}€`}),e.jsx("div",{className:"text-xs text-slate-400",children:i?"À l'inscription":"par mois"})]}),e.jsxs("div",{className:"mb-4 py-3 px-4 rounded-lg border text-center",style:{background:"rgba(255, 255, 255, 0.05)",borderColor:u.borderColor},children:[e.jsx("div",{className:"text-2xl font-bold text-white mb-1",children:L.formatTokenAmount(a)}),e.jsx("div",{className:"text-xs text-slate-400",children:"tokens / mois"})]}),n&&e.jsx("div",{className:"mt-4 py-2 px-4 rounded-lg text-center font-bold text-sm",style:{background:`linear-gradient(135deg, ${u.color}30, ${u.color}20)`,border:`2px solid ${u.color}60`,color:"#ffffff",textShadow:`0 0 8px ${u.color}`},children:"✓ Plan Actuel"}),!n&&!i&&e.jsx("button",{onClick:N=>{N.stopPropagation(),c(m)},disabled:o,className:"w-full px-4 py-2.5 rounded-lg font-semibold text-white text-sm transition-all disabled:opacity-50",style:{background:u.gradient},children:o?"Chargement...":"Choisir ce plan"}),i&&!n&&e.jsx("div",{className:"text-center text-xs text-slate-500",children:"Plan offert à l'inscription"})]})})},Ze=()=>{const{showToast:m}=te(),{mode:t}=me(),[s,a]=g.useState(null),[n,i]=g.useState(null),[c,o]=g.useState(null),[u,N]=g.useState([]),[v,D]=g.useState(!0),[A,b]=g.useState(!1),[p,d]=g.useState(!1),x=t==="high-performance";g.useEffect(()=>{w()},[]);const w=async()=>{D(!0);try{const[h,l,j,R]=await Promise.all([L.getTokenBalance(),L.getUserSubscription(),L.getPricingConfig(),L.getTokenTransactions(20)]);a(h),i(l),o(j),N(R),j?.subscriptionPlans&&(console.log("Loaded subscription plans:",j.subscriptionPlans),Object.entries(j.subscriptionPlans).forEach(([pe,xe])=>{console.log(`Plan ${pe}:`,xe)}))}catch(h){console.error("Error loading subscription data:",h),m({type:"error",title:"Erreur",message:"Impossible de charger les données",duration:3e3})}finally{D(!1)}},E=async h=>{if(!A){b(!0);try{const l=await L.createCheckoutSession("subscription",h);if(l?.url)window.location.href=l.url;else throw new Error("Failed to create checkout session")}catch(l){console.error("Error creating checkout session:",l),m({type:"error",title:"Erreur",message:"Impossible de créer la session de paiement",duration:3e3}),b(!1)}}},P=async h=>{if(!A){b(!0);try{const l=await L.createCheckoutSession("payment",void 0,h);if(l?.url)window.location.href=l.url;else throw new Error("Failed to create checkout session")}catch(l){console.error("Error creating checkout session:",l),m({type:"error",title:"Erreur",message:"Impossible de créer la session de paiement",duration:3e3}),b(!1)}}};if(v)return e.jsx("div",{className:"space-y-6",children:e.jsx(S,{className:"p-6",children:e.jsx("div",{className:"flex items-center justify-center h-40",children:e.jsx("div",{className:"text-slate-400",children:"Chargement..."})})})});const O=n?.planType||"free",C=c?.subscriptionPlans||{},T=(()=>{if(!n||n.status!=="trialing")return null;const h=n.trialEnd?new Date(n.trialEnd):null;if(!h)return null;const l=new Date,j=h.getTime()-l.getTime(),R=Math.ceil(j/(1e3*60*60*24));return R>0?R:0})(),H=["starter_9","pro_19","premium_29","elite_39","expert_49","master_59","ultimate_99","free"],U=Object.entries(C).sort(([h],[l])=>{const j=H.indexOf(h),R=H.indexOf(l);return j===-1?1:R===-1?-1:j-R}),B=c?.tokenPacks?.pack_19,$=p?u:u.slice(0,5);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-xl p-5 border",style:x?{background:"rgba(247, 147, 30, 0.15)",borderColor:"rgba(247, 147, 30, 0.3)"}:{background:"linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(253, 200, 48, 0.05))",borderColor:"rgba(247, 147, 30, 0.3)",boxShadow:"0 4px 16px rgba(247, 147, 30, 0.1)"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-xs text-slate-400 font-medium",children:"Tokens Disponibles"}),e.jsx(K,{size:24,variant:"success",withGlow:!1})]}),e.jsx("div",{className:"text-4xl font-bold mb-1",style:x?{color:"#F7931E"}:{background:"linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FDC830 100%)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"},children:s?L.formatTokenAmount(s.balance):"0"}),e.jsx("div",{className:"text-xs text-slate-500",children:"Votre réserve d'énergie numérique"})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-5 border border-slate-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-xs text-slate-400 font-medium",children:"Statut"}),e.jsx(y,{Icon:n?.status==="active"?f.Check:f.Clock,size:20,color:n?.status==="active"?"#10B981":"#3B82F6",variant:"pure"})]}),e.jsx("div",{className:`text-3xl font-bold mb-1 ${n?.status==="active"?"text-emerald-400":"text-blue-400"}`,children:n?.status==="active"?"Actif":"Essai Gratuit"}),e.jsx("div",{className:"text-xs text-slate-500",children:n?.status==="active"?`Renouvellement le ${oe(new Date(n.currentPeriodEnd),"dd/MM/yyyy",{locale:le})}`:T!==null?`${T} ${T>1?"jours restants":"jour restant"} sur 14`:"15 000 tokens offerts pour découvrir l'app"})]})]})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Forfaits Mensuels"}),e.jsx("p",{className:"text-sm text-slate-400 mb-6",children:"Choisissez le forfait qui correspond à votre utilisation. Vos tokens sont renouvelés automatiquement chaque mois."}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:U.map(([h,l])=>l?e.jsx(Qe,{planId:h,name:l.name||h,priceEur:l.price_eur||0,tokensPerMonth:l.tokens_per_month||0,isCurrentPlan:O===h,isFree:h==="free",onSelect:E,isLoading:A},h):(console.warn(`Plan ${h} is undefined`),null))})]}),B&&e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(K,{size:48,variant:"warning",withGlow:!1})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-2",children:"Besoin de tokens supplémentaires ?"}),e.jsx("p",{className:"text-sm text-slate-400 mb-4",children:"Rechargez votre réserve à tout moment avec un pack de tokens. Les tokens achetés sont permanents et s'ajoutent à votre solde mensuel."}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"px-4 py-2 rounded-lg border",style:{background:"rgba(247, 147, 30, 0.1)",borderColor:"rgba(247, 147, 30, 0.3)"},children:e.jsxs("div",{className:"text-sm font-semibold text-white",children:[L.formatTokenAmount(B.tokens)," tokens"]})}),e.jsx("button",{onClick:()=>P("pack_19"),disabled:A,className:"px-6 py-2 rounded-lg font-semibold text-white text-sm transition-all disabled:opacity-50",style:{background:"linear-gradient(135deg, #FF6B35, #F7931E)"},children:A?"Chargement...":`Acheter pour ${L.formatCurrency(B.price_eur)}`})]})]})]})}),u.length>0&&e.jsxs(S,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(y,{Icon:f.History,size:24,color:"#60A5FA",variant:"pure"}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Historique des Transactions"})]}),u.length>5&&e.jsx("button",{onClick:()=>d(!p),className:"text-xs text-blue-400 hover:text-blue-300 transition-colors",children:p?"Voir moins":`Voir tout (${u.length})`})]}),e.jsx("div",{className:"space-y-2",children:$.map(h=>e.jsxs("div",{className:"flex items-center justify-between py-3 px-4 bg-slate-800/30 rounded-lg border border-slate-700/30",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(K,{size:28,variant:h.transactionType==="consume"?"warning":"success",withGlow:!1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-white mb-1",children:h.operationType?L.getOperationTypeLabel(h.operationType):h.source||"Transaction"}),e.jsx("div",{className:"text-xs text-slate-500",children:oe(new Date(h.createdAt),"dd MMM yyyy HH:mm",{locale:le})})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:`text-sm font-bold ${h.transactionType==="consume"?"text-red-400":"text-emerald-400"}`,children:[h.transactionType==="consume"?"-":"+",h.amount]}),e.jsxs("div",{className:"text-xs text-slate-500",children:["Solde: ",h.balanceAfter]})]})]},h.id))})]}),e.jsx(S,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(y,{Icon:f.Info,size:20,color:"#60A5FA",variant:"pure"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-white mb-3",children:"Comment fonctionnent les forfaits ?"}),e.jsxs("div",{className:"space-y-3 text-xs text-slate-400",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"Renouvellement automatique :"})," Vos tokens sont renouvelés automatiquement chaque mois à la date anniversaire de votre abonnement."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"Tokens non utilisés :"})," Les tokens non utilisés d'un mois ne sont pas reportés. Choisissez le forfait adapté à votre utilisation réelle."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"Changement de forfait :"})," Vous pouvez changer de forfait à tout moment. Le changement prendra effet lors du prochain renouvellement."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"Annulation :"})," Vous pouvez annuler votre abonnement à tout moment. Vous conserverez l'accès jusqu'à la fin de la période en cours."]})]})]})]})})]})},ut=()=>{const m=Se.settings,[t]=je(),s=t.get("tab"),a=s&&m.tabs.find(o=>o.value===s)?s:m.tabs[0].value,[n,i]=g.useState(a);g.useEffect(()=>{s&&m.tabs.find(o=>o.value===s)&&i(s)},[s,m.tabs]);const c=m.tabs.find(o=>o.value===n)||m.tabs[0];return e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeOut"},className:"space-y-6",style:{"--settings-active-color":c.color||m.color},children:[e.jsx(Ee,{icon:c.icon||m.icon,title:c.label,subtitle:c.description,circuit:m.circuit,iconColor:c.color||m.color}),e.jsxs(X,{value:n,defaultValue:a,className:"w-full settings-tabs",onValueChange:o=>i(o),children:[e.jsx(X.List,{role:"tablist","aria-label":"Sections des Réglages",className:"mb-6 w-full",children:m.tabs.map(o=>e.jsx(X.Trigger,{value:o.value,icon:o.icon,children:e.jsx("span",{className:"tab-text",children:o.label})},o.value))}),m.tabs.map(o=>e.jsx(X.Panel,{value:o.value,children:o.value==="preferences"?e.jsx(Ue,{}):o.value==="notifications"?e.jsx(Me,{}):o.value==="appareils"?e.jsx(Be,{}):o.value==="performance"?e.jsx(Ve,{}):o.value==="confidentialite"?e.jsx(Je,{}):o.value==="account"?e.jsx(Ze,{}):e.jsx(S,{className:"p-6",children:e.jsx(De,{title:o.label,description:o.description,icon:o.icon,color:m.color,features:o.features})})},o.value))]})]})};export{ut as default};
