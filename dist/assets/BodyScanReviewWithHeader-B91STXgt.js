const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/page-fridge-BvAjnJpI.js","assets/vendor-DX97-qL9.js","assets/utils-CUtLAp28.js","assets/supabase-C_rF2iqf.js","assets/page-fridge-scan-ZLPWYd6x.js","assets/stores-DcNfcD_j.js","assets/ui-components-DWjWyKd7.js","assets/motion-DLE-fuXv.js","assets/ui-components-BfdLI5ID.css","assets/page-fridge-scan-DAz6gEg3.css","assets/date-utils-sCOX3Ksr.js","assets/normalizeSkinTone-gBHfMnNZ.js"])))=>i.map(i=>d[i]);
import{cK as Oe,u as be,r as v,R as de,j as i}from"./vendor-DX97-qL9.js";import{b as ye,m as Z}from"./stores-DcNfcD_j.js";import{B as Ie}from"./BodyScanProgressHeader-C9OstcTU.js";import{t as ee,n as G,u as we,A as Ee}from"./Avatar3DViewer-ChhNpHs3.js";import{u as je,G as Q,S as B,I as N}from"./ui-components-DWjWyKd7.js";import{l as o,u as se,s as Me}from"./page-fridge-BvAjnJpI.js";import{_ as J}from"./page-fridge-scan-ZLPWYd6x.js";import{resolveSkinTone as Pe,isSkinToneV2 as ne}from"./normalizeSkinTone-gBHfMnNZ.js";import{m as W}from"./motion-DLE-fuXv.js";import"./utils-CUtLAp28.js";import"./supabase-C_rF2iqf.js";import"./date-utils-sCOX3Ksr.js";function Ce(e){if(!e||typeof e!="string")return o.warn("Invalid dbKey provided to toBlenderKey",{dbKey:e,type:typeof e}),null;const n=ee(e),r={pregnant:"BS_LOD0.BodyPregnant",pearFigure:"BS_LOD0.BodyPearFigure",bigHips:"BS_LOD0.BodyBigHips",assLarge:"BS_LOD0.BodyAssLarge",narrowWaist:"BS_LOD0.BodyNarrowWaist",bodybuilderSize:"BS_LOD0.BodyBodybuilderSize",bodybuilderDetails:"BS_LOD0.BodyBodybuilderDetails",emaciated:"BS_LOD0.BodyEmaciated",superBreast:"BS_LOD0.BodySuperBreast",breastsSmall:"BS_LOD0.BodyBreastsSmall",breastsSag:"BS_LOD0.BodyBreastsSag",animeWaist:"BS_LOD0.BodyAnimeWaist",dollBody:"BS_LOD0.BodyDollBody",nipples:"BS_LOD0.BodyNipples",animeNeck:"BS_LOD0.BodyAnimeNeck",animeProportion:"BS_LOD0.BodyAnimeProportion",eyesClosedL:"BS_LOD0.AnimEyesClosedL",eyesClosedR:"BS_LOD0.AnimEyesClosedR",FaceLowerEyelashLength:"BS_LOD0.FaceLowerEyelashLength",eyelashLength:"BS_LOD0.FaceEyelashLength",eyelashesSpecial:"BS_LOD0.FaceEyelashesSpecial",eyesShape:"BS_LOD0.FaceEyesShape",eyesSpacing:"BS_LOD0.FaceEyesSpacing",eyesDown:"BS_LOD0.FaceEyesDown",eyesUp:"BS_LOD0.FaceEyesUp",eyesSpacingWide:"BS_LOD0.FaceEyesSpacingWide",FaceJawWidth:"BS_LOD0.FaceJawWidth",FaceCheekFullness:"BS_LOD0.FaceCheekFullness",FaceCheeksSize:"BS_LOD0.FaceCheeksSize",FaceNoseSize:"BS_LOD0.FaceNoseSize",FaceEyeSize:"BS_LOD0.FaceEyeSize",FaceLipThickness:"BS_LOD0.FaceLipThickness",FaceChinLength:"BS_LOD0.FaceChinLength",FaceChinSize:"BS_LOD0.FaceChinSize",FaceForeheadHeight:"BS_LOD0.FaceForeheadHeight",FaceBrowHeight:"BS_LOD0.FaceBrowHeight",FaceEarSize:"BS_LOD0.FaceEarSize",FaceHeadSize:"BS_LOD0.FaceHeadSize",FaceNarrow:"BS_LOD0.FaceNarrow",FaceNoseAngle:"BS_LOD0.FaceNoseAngle",FaceNoseHump:"BS_LOD0.FaceNoseHump",FaceNoseNarrow:"BS_LOD0.FaceNoseNarrow",FaceNoseSmall:"BS_LOD0.FaceNoseSmall",FaceNoseWide:"BS_LOD0.FaceNoseWide",FaceRoundFace:"BS_LOD0.FaceRoundFace",FaceSymmetry:"BS_LOD0.FaceSymmetry",FaceLongFace:"BS_LOD0.FaceLongFace",FaceCheekbones:"BS_LOD0.FaceCheekbones",FaceMouthWidth:"BS_LOD0.FaceMouthWidth",FaceMouthSize:"BS_LOD0.FaceMouthSize",FaceLipsToMegalips:"BS_LOD0.FaceLipsToMegalips",FaceNostrilsFlare:"BS_LOD0.FaceNostrilsFlare"};if(r[n])return r[n];if(n.startsWith("Face")){const a=`BS_LOD0.${n}`;return o.warn("Attempted to construct Blender key for face morph (should be in direct mapping)",{dbKey:n,blenderKey:a}),a}const c=`BS_LOD0.Body${n.charAt(0).toUpperCase()+n.slice(1)}`;return o.trace("Blender key generated",{dbKey:n,blenderKey:c,method:r[n]?"direct_mapping":"constructed"}),c}function me(e,n){const r=n==="male"?e.mapping_masculine:e.mapping_feminine;if(!r||!r.morph_values)throw o.error("MORPH_POLICY","Invalid gender mapping - missing morph_values",{gender:n,hasGenderMapping:!!r,genderMappingKeys:r?Object.keys(r):[],philosophy:"db_validation_failed"}),new Error(`Invalid gender mapping for ${n} - missing morph_values`);o.info("MORPH_POLICY","Building morph policy from gender-specific mapping",{gender:n,mappingMorphValuesCount:Object.keys(r.morph_values).length,mappingLimbMassesCount:Object.keys(r.limb_masses).length,philosophy:"ai_driven_db_bounds_only_no_caps_mutex"});const c=[],a=[],t={};return Object.entries(r.morph_values).forEach(([l,m])=>{if(!m||typeof m.min!="number"||typeof m.max!="number"){o.warn("MORPH_POLICY","Invalid range for morph key",{key:l,range:m,gender:n,philosophy:"db_validation_warning"});return}const k=ee(l);t[k]=m,m.min===0&&m.max===0?(a.push(k),o.debug("MORPH_POLICY","Morph banned by DB range [0,0]",{key:k,gender:n,philosophy:"db_banned_morph"})):c.push(k)}),["FaceLowerEyelashLength","eyelashLength","eyelashesSpecial","eyesShape","eyesSpacing","eyesDown","eyesUp","eyesSpacingWide","eyesClosedL","eyesClosedR"].forEach(l=>{const m=ee(l);!a.includes(m)&&!c.includes(m)&&(a.push(m),t[m]||(t[m]={min:-2,max:2}))}),o.info("MORPH_POLICY","DB-only morph policy built",{gender:n,mappingSource:n==="male"?"mapping_masculine":"mapping_feminine",requiredKeys:c.length,optionalKeys:a.length,totalRanges:Object.keys(t).length,philosophy:"ai_driven_db_bounds_only"}),{requiredKeys:c,optionalKeys:a,ranges:t}}const Ne=Object.freeze(Object.defineProperty({__proto__:null,buildMorphPolicy:me},Symbol.toStringTag,{value:"Module"}));function De(){return{DISABLE_LIMB_TO_MORPH:!1,FALLBACK_MODE:"PERMISSIVE",ENFORCE_CAPS_MUTEX:!1,STRICT_ARCHETYPE_MATCH:!1,AI_REFINE_MODE:"PERMISSIVE"}}function Le(e,n,r){const c=r==="male"?n.mapping_masculine:n.mapping_feminine;if(o.info("MORPH_BLEND","Starting client-side archetype blending",{archetypesCount:e.length,gender:r,mappingMorphValuesCount:Object.keys(c.morph_values).length,mappingLimbMassesCount:Object.keys(c.limb_masses).length,primaryArchetype:e[0]?.id}),e.length===0)throw new Error("No archetypes provided for blending");const a=Re(e),t=new Set,s=new Set;e.forEach(u=>{Object.keys(u.morph_values||{}).forEach(p=>{t.add(ee(p))}),Object.keys(u.limb_masses||{}).forEach(p=>{s.add(p)})});const l={};for(const u of t){let p=0,w=0;e.forEach((F,d)=>{const M=a[d][1];let D=0;const C=[u,u.toLowerCase(),`Body${u}`];for(const T of C)if(F.morph_values&&T in F.morph_values){D=F.morph_values[T];break}p+=D*M,w+=M}),l[u]=w>0?p/w:0}const m={};for(const u of s){let p=0,w=0;e.forEach((F,d)=>{const M=a[d][1],D=F.limb_masses?.[u]||1;p+=D*M,w+=M}),m[u]=w>0?p/w:1}const k=Fe(e,a),S=Ve(e,a,l);return o.info("MORPH_BLEND","Archetype blending completed",{blendedShapeKeys:Object.keys(l).length,blendedLimbKeys:Object.keys(m).length,confidence:k.toFixed(3),qualityScore:S.toFixed(3),weights:a.map(([u,p])=>({id:u,weight:p.toFixed(3)}))}),{shape_params:l,limb_masses:m,blend_weights:a,confidence:k,quality_score:S}}function Re(e){if(e.length===1)return[[e[0].id,1]];const n=e.map(u=>{const w=1/(.1+(u.distance||1));return[u.id,w]}),r=n.reduce((u,[p,w])=>u+w,0),c=n.map(([u,p])=>[u,p/r]),a=2,t=c.map(([u,p])=>[u,Math.exp(p/a)]),s=t.reduce((u,[p,w])=>u+w,0),m=t.map(([u,p])=>[u,p/s]).filter(([u,p])=>p>=.01),k=m.reduce((u,[p,w])=>u+w,0),S=m.map(([u,p])=>[u,p/k]);return o.debug("MORPH_BLEND","Blend weights calculated",{originalCount:e.length,significantCount:S.length,weights:S.map(([u,p])=>({id:u,weight:p.toFixed(3)}))}),S}function Fe(e,n){if(e.length===0)return 0;const r=e.reduce((m,k)=>m+(k.distance||1),0)/e.length,c=Math.max(.1,1/(1+r)),a=Math.min(.2,e.length*.05),t=-n.reduce((m,[k,S])=>m+(S>0?S*Math.log(S):0),0),s=Math.log(n.length),l=s>0?t/s*.1:0;return Math.min(.95,c+a+l)}function Ve(e,n,r){let c=1;Object.entries(r).forEach(([s,l])=>{Math.abs(l)>3&&(c*=.9)});const a=n.filter(([s,l])=>l>.1).length,t=Math.min(.2,a*.05);return Math.max(.1,Math.min(1,c+t))}function Be(e,n){const r={...e};return n.requiredKeys.forEach(c=>{if(!(c in r)){const a=n.ranges[c],t=a&&a.min<=0&&a.max>=0?0:a?(a.min+a.max)/2:0;r[c]=t,o.debug("MORPH_BLEND","Added missing required key",{key:c,defaultValue:t.toFixed(3),range:a?`[${a.min}, ${a.max}]`:"no_range"})}}),o.debug("MORPH_BLEND","Shape params completed",{originalKeys:Object.keys(e).length,completeKeys:Object.keys(r).length,addedKeys:Object.keys(r).length-Object.keys(e).length}),r}function ve(e,n){const r={};return e.requiredKeys.forEach(c=>{const a=e.ranges[c];if(a&&a.min===0&&a.max===0){r[c]=0;return}a?a.min<=0&&a.max>=0?r[c]=0:r[c]=Math.abs(a.min)<Math.abs(a.max)?a.min:a.max:r[c]=0}),n==="male"&&("pregnant"in r&&(r.pregnant=0),"nipples"in r&&(r.nipples=0),"superBreast"in r&&(r.superBreast=0),"animeProportion"in r&&(r.animeProportion=0)),o.info("MORPH_PAYLOAD","PHASE A.4: Generated strict DB-only fallback",{gender:n,keysCount:Object.keys(r).length,sampleKeys:Object.keys(r).slice(0,5),bannedKeysForced:Object.entries(r).filter(([c,a])=>a===0).length,philosophy:"phase_a_strict_db_only_no_contradictory_morphs"}),r}function Te(){return{gate:1,armMass:1,calfMass:1,neckMass:1,thighMass:1,torsoMass:1,forearmMass:1}}function He(e,n,r){const c=r==="male"?n.mapping_masculine:n.mapping_feminine,a={...e};return Object.keys(c.limb_masses).forEach(t=>{if(!(t in a)){const s=c.limb_masses[t];a[t]=s&&s.min<=1&&s.max>=1?1:s?(s.min+s.max)/2:1,o.debug("MORPH_PAYLOAD","Added missing limb mass with default value",{key:t,defaultValue:a[t],range:s?`[${s.min}, ${s.max}]`:"no_range",gender:r,philosophy:"ai_driven_completion"})}}),o.debug("MORPH_PAYLOAD","Limb masses completed for AI-driven processing",{originalKeys:Object.keys(e).length,completeKeys:Object.keys(a).length,addedKeys:Object.keys(a).length-Object.keys(e).length,gender:r,philosophy:"ai_driven_completion"}),a}function Ke(e){const n=[];return e.commit?.photos_metadata&&Array.isArray(e.commit.photos_metadata)&&e.commit.photos_metadata.forEach(r=>{r.type&&r.url&&n.push({view:r.type,url:r.url,report:r.captureReport||r.report})}),n.length===0&&e.estimate?.photos_metadata&&Array.isArray(e.estimate.photos_metadata)&&e.estimate.photos_metadata.forEach(r=>{r.view&&r.url&&n.push({view:r.view,url:r.url,report:r.report})}),o.debug("MORPH_PAYLOAD","Extracted photos for AI refinement",{photosCount:n.length,photoViews:n.map(r=>r.view),hasReports:n.filter(r=>!!r.report).length}),n}function Ue(e,n,r,c,a){let t="comprehensive_fallback";if(c.FALLBACK_MODE==="DB_ONLY"){if(o.info("MORPH_PAYLOAD","Using DB-ONLY fallback mode",{finalGender:r,philosophy:"phase_a_strict_db_only_no_generic_morphs"}),e.match?.ai_refinement?.ai_refine&&e.match?.ai_refinement?.final_shape_params)return o.info("MORPH_PAYLOAD","Using AI-refined results from scan results"),t="ai_refined_from_scan_results",{shape_params:G(e.match.ai_refinement.final_shape_params??{},r,a),limb_masses:e.match.ai_refinement.final_limb_masses??{},strategy:t};if(e.match?.selected_archetypes&&e.match.selected_archetypes.length>0){const s=e.match.selected_archetypes[0];return o.info("MORPH_PAYLOAD","Using primary archetype (DB-only mode)",{archetypeId:s.id,archetypeName:s.name,philosophy:"phase_a_strict_db_archetype_only"}),t="primary_archetype_db_only",{shape_params:G(s.morph_values??{},r,a),limb_masses:s.limb_masses??{},strategy:t}}return o.warn("MORPH_PAYLOAD","No archetype data available, using strict DB-only fallback"),t="strict_db_only_fallback",{shape_params:ve(n,r),limb_masses:generateStrictDBOnlyLimbMasses(n,r),strategy:t}}if(e.match?.blended_shape_params&&Object.keys(e.match.blended_shape_params).length>0)return o.debug("MORPH_PAYLOAD","Using blended data from match result"),t=e.match?.strategy_used??e.match?.strategy??"match_blended_data",{shape_params:G(e.match.blended_shape_params,r,a),limb_masses:e.match.blended_limb_masses??{},strategy:t};if(e.match?.selected_archetypes&&e.match.selected_archetypes.length>0){const s=e.match.selected_archetypes[0];return o.debug("MORPH_PAYLOAD","Using primary archetype data",{archetypeId:s.id,archetypeName:s.name}),t=e.match?.strategy_used??e.match?.strategy??"primary_archetype",{shape_params:G(s.morph_values??{},r,a),limb_masses:s.limb_masses??{},strategy:t}}return e.semantic?.semantic_profile?.validated_morph_values?(o.debug("MORPH_PAYLOAD","Using validated morph values from semantic"),t=e.match?.strategy_used??e.match?.strategy??"semantic_validated",{shape_params:G(e.semantic.semantic_profile.validated_morph_values,r,a),limb_masses:{},strategy:t}):e.estimate?.extracted_data?.shape_params?(o.debug("MORPH_PAYLOAD","Using shape params from estimate"),t=e.match?.strategy_used??e.match?.strategy??"estimate_data",{shape_params:G(e.estimate.extracted_data.shape_params,r,a),limb_masses:e.estimate.extracted_data.limb_masses??{},strategy:t}):(o.warn("MORPH_PAYLOAD","PHASE A.4: No morph data found, using comprehensive fallback"),t=e.match?.strategy_used??e.match?.strategy??"comprehensive_fallback",{shape_params:Ye(n,r),limb_masses:Te(),strategy:t})}function Ye(e,n){return ve(e,n)}function ue(e,n,r,c){const a=new Set(Object.keys(n.mapping_masculine.morph_values)),t=new Set(Object.keys(n.mapping_feminine.morph_values)),s=new Set([...a,...t]);r==="male"?n.mapping_masculine:n.mapping_feminine;const l={};let m=0;return Object.entries(e).forEach(([k,S])=>{const u=ee(k);s.has(u)?l[u]=S:(m++,o.warn("MORPH_PAYLOAD","PHASE A.4: Rejected non-DB key",{originalKey:k,canonicalKey:u,value:typeof S=="number"?S.toFixed(3):S,gender:r,source:c,reason:"key_not_in_stable_allowlist",philosophy:"strict_allowlisting"}))}),o.info("MORPH_PAYLOAD","PHASE A.4: Stable allowlisting applied to shape params",{originalKeys:Object.keys(e).length,allowlistedKeys:Object.keys(l).length,rejectedKeys:m,stableAllowlistSize:s.size,gender:r,source:c,philosophy:"stable_union_allowlisting"}),l}function he(e,n,r,c){const a=new Set(Object.keys(n.mapping_masculine.limb_masses)),t=new Set(Object.keys(n.mapping_feminine.limb_masses)),s=new Set([...a,...t]);r==="male"?n.mapping_masculine:n.mapping_feminine;const l={};let m=0;return Object.entries(e).forEach(([k,S])=>{s.has(k)?l[k]=S:(m++,o.warn("MORPH_PAYLOAD","PHASE A.4: Rejected non-DB limb mass key",{key:k,value:typeof S=="number"?S.toFixed(3):S,gender:r,source:c,reason:"key_not_in_stable_allowlist",philosophy:"strict_allowlisting"}))}),o.info("MORPH_PAYLOAD","PHASE A.4: Stable allowlisting applied to limb masses",{originalKeys:Object.keys(e).length,allowlistedKeys:Object.keys(l).length,rejectedKeys:m,stableAllowlistSize:s.size,gender:r,source:c,philosophy:"stable_union_allowlisting"}),l}function te(e,n,r){const c=r==="male"?n.mapping_masculine:n.mapping_feminine,a={...e};return Object.entries(a).forEach(([t,s])=>{const l=c.morph_values[t];if(l&&typeof s=="number"){const m=Math.max(l.min,Math.min(l.max,s));Math.abs(s-m)>.001&&(o.debug("MORPH_CONSTRAINTS","Clamped value to DB range",{key:t,original:s.toFixed(3),clamped:m.toFixed(3),range:`[${l.min}, ${l.max}]`}),a[t]=m)}}),a}function re(e,n,r){const c=r==="male"?n.mapping_masculine:n.mapping_feminine,a={...e};return Object.entries(a).forEach(([t,s])=>{const l=c.limb_masses[t];if(l&&typeof s=="number"){const m=Math.max(l.min,Math.min(l.max,s));Math.abs(s-m)>.001&&(o.debug("MORPH_CONSTRAINTS","Clamped limb mass to DB range",{key:t,original:s.toFixed(3),clamped:m.toFixed(3),range:`[${l.min}, ${l.max}]`,philosophy:"ai_driven_db_only"}),a[t]=m)}}),a}function ie(e){const n={};return Object.entries(e).forEach(([r,c])=>{const a=Ce(r);a?n[a]=c:o.warn("MORPH_PAYLOAD","No Blender key mapping found",{dbKey:r})}),o.debug("MORPH_PAYLOAD","Converted to Blender keys",{dbKeysCount:Object.keys(e).length,blenderKeysCount:Object.keys(n).length}),n}function ze(e,n,r){return{missing_required:[],missing_optional:[]}}async function We(e){const{validateRefineResponse:n}=await J(async()=>{const{validateRefineResponse:m}=await import("./types-CMUW8gDJ.js");return{validateRefineResponse:m}},[]),{RefineResponse:r}=await J(async()=>{const{RefineResponse:m}=await import("./types-CMUW8gDJ.js");return{RefineResponse:m}},[]),{supabase:c}=await J(async()=>{const{supabase:m}=await import("./page-fridge-BvAjnJpI.js").then(k=>k.j);return{supabase:m}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),a={};Object.entries(e.blend_limb_masses).forEach(([m,k])=>{typeof k=="number"&&isFinite(k)&&(a[m]=k)}),o.info("MORPH_PAYLOAD","Calling scan-refine-morphs Edge Function",{scanId:e.scan_id,userId:e.user_id,resolvedGender:e.resolvedGender,photosCount:e.photos.length,blendShapeParamsCount:Object.keys(e.blend_shape_params).length,blendLimbMassesCount:Object.keys(a).length,originalLimbMassesCount:Object.keys(e.blend_limb_masses).length,filteredOutKeys:Object.keys(e.blend_limb_masses).filter(m=>typeof e.blend_limb_masses[m]!="number"||!isFinite(e.blend_limb_masses[m])),mappingVersion:e.mapping_version,hasUserMeasurements:!!e.user_measurements,philosophy:"ai_driven_edge_function_call"});const{data:t,error:s}=await c.functions.invoke("scan-refine-morphs",{body:{...e,blend_limb_masses:a,user_measurements:e.user_measurements}});if(s)throw o.error("MORPH_PAYLOAD","scan-refine-morphs Edge Function failed",{scanId:e.scan_id,error:s.message||s,philosophy:"ai_refinement_failed"}),new Error(`AI refinement failed: ${s.message}`);if(!t)throw o.error("MORPH_PAYLOAD","PHASE 1: scan-refine-morphs returned null/undefined data",{scanId:e.scan_id,philosophy:"phase_1_null_response_validation"}),new Error("AI refinement service returned null or undefined data");const l=n(t);if(!l.isValid)throw o.error("MORPH_PAYLOAD","PHASE 1: scan-refine-morphs response validation failed",{scanId:e.scan_id,errors:l.errors,warnings:l.warnings,responseData:t,philosophy:"phase_1_edge_function_response_validation_failed"}),new Error(`AI refinement response validation failed: ${l.errors.join(", ")}`);return l.warnings.length>0&&o.warn("MORPH_PAYLOAD","PHASE 1: scan-refine-morphs response has warnings",{scanId:e.scan_id,warnings:l.warnings,philosophy:"phase_1_edge_function_response_quality_warnings"}),o.info("MORPH_PAYLOAD","scan-refine-morphs Edge Function completed successfully",{scanId:e.scan_id,aiRefine:t.ai_refine,finalShapeParamsCount:Object.keys(t.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(t.final_limb_masses||{}).length,clampedKeysCount:t.clamped_keys?.length||0,outOfRangeCount:t.out_of_range_count||0,activeKeysCount:t.active_keys_count||0,aiConfidence:t.ai_confidence,validationPassed:!0,philosophy:"ai_refinement_success"}),t}async function $e(e,n,r,c){const a=De(),t=c||r;if(o.info("MORPH_PAYLOAD","Starting AI-driven morphological payload preparation",{gender:t,explicitResolvedGender:c,originalGender:r,hasScanResults:!!e,hasMapping:!!n,featureFlags:a,philosophy:"phase_a_strict_allowlisting_robust_fallback"}),!n||!n.mapping_masculine||!n.mapping_feminine){const g="Invalid morphology mapping - missing gender mappings";return o.error("MORPH_PAYLOAD","PHASE 2: Critical input validation failed",{error:g,hasMapping:!!n,hasMasculineMapping:!!n?.mapping_masculine,hasFeminineMapping:!!n?.mapping_feminine,philosophy:"phase_2_critical_input_validation"}),{status:"error",shape_params:{},limb_masses:{},blender_shape_keys:{},metadata:{strategy:"critical_input_validation_failed",finalGender:t,confidence:0,quality_score:0,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!1,mapping_version:"unknown",allowlisted_keys_count:0,rejected_keys_count:0,envelope_constrained:!1,morph_generation_fallback:!0},error:g}}let s;try{s=me(n,t)}catch(g){const A=`Failed to build morph policy: ${g instanceof Error?g.message:"Unknown error"}`;return o.error("MORPH_PAYLOAD","PHASE 2: Morph policy building failed",{error:A,finalGender:t,philosophy:"phase_2_policy_building_failure"}),{status:"error",shape_params:{},limb_masses:{},blender_shape_keys:{},metadata:{strategy:"morph_policy_building_failed",finalGender:t,confidence:0,quality_score:0,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!1,mapping_version:"unknown",allowlisted_keys_count:0,rejected_keys_count:0,envelope_constrained:!1,morph_generation_fallback:!0},error:A}}const l=t==="male"?n.mapping_masculine:n.mapping_feminine;if(o.info("MORPH_PAYLOAD","Using gender-specific mapping for AI-driven processing",{finalGender:t,mappingMorphValuesCount:Object.keys(l.morph_values).length,mappingLimbMassesCount:Object.keys(l.limb_masses).length,policyRequiredKeys:s.requiredKeys.length,policyOptionalKeys:s.optionalKeys.length,philosophy:"ai_driven_db_mapping"}),e.match?.ai_refinement?.ai_refine===!0&&e.match?.ai_refinement?.final_shape_params){const{validateRefineResponse:g}=await J(async()=>{const{validateRefineResponse:X}=await import("./types-CMUW8gDJ.js");return{validateRefineResponse:X}},[]),A=g(e.match.ai_refinement);if(!A.isValid)throw o.error("MORPH_PAYLOAD","PHASE 1: AI refinement response validation failed",{finalGender:t,errors:A.errors,warnings:A.warnings,philosophy:"phase_1_strict_schema_validation"}),new Error(`AI refinement data validation failed: ${A.errors.join(", ")}`);A.warnings.length>0&&o.warn("MORPH_PAYLOAD","PHASE 1: AI refinement response has warnings",{finalGender:t,warnings:A.warnings,philosophy:"phase_1_data_quality_warnings"});const x=e.match.ai_refinement;if(!x.final_shape_params||Object.keys(x.final_shape_params).length===0)throw o.error("MORPH_PAYLOAD","PHASE 1: AI refinement missing final_shape_params",{finalGender:t,aiRefine:x.ai_refine,hasFinalShapeParams:!!x.final_shape_params,finalShapeParamsKeys:x.final_shape_params?Object.keys(x.final_shape_params):[],philosophy:"phase_1_critical_data_validation"}),new Error("AI refinement succeeded but final_shape_params is missing or empty");if(!x.final_limb_masses||Object.keys(x.final_limb_masses).length===0)throw o.error("MORPH_PAYLOAD","PHASE 1: AI refinement missing final_limb_masses",{finalGender:t,aiRefine:x.ai_refine,hasFinalLimbMasses:!!x.final_limb_masses,finalLimbMassesKeys:x.final_limb_masses?Object.keys(x.final_limb_masses):[],philosophy:"phase_1_critical_data_validation"}),new Error("AI refinement succeeded but final_limb_masses is missing or empty");o.info("MORPH_PAYLOAD","Using AI-refined results directly",{finalGender:t,aiRefined:!0,mappingVersion:e.match.ai_refinement.mapping_version,validationPassed:!0,philosophy:"phase_a_ai_refined_direct_use"});const R=ue(x.final_shape_params,n,t,"ai_refined"),$=te(R,n,t),z=he(x.final_limb_masses,n,t,"ai_refined"),K=re(z,n,t);return{shape_params:$,limb_masses:K,blender_shape_keys:ie($),metadata:{strategy:"ai_refined_k5_constrained_validated",finalGender:t,confidence:.95,quality_score:.95,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!0,mapping_version:x.mapping_version,allowlisted_keys_count:Object.keys($).length,rejected_keys_count:Object.keys(x.final_shape_params).length-Object.keys(R).length,envelope_constrained:!1,morph_generation_fallback:!1,phase_b_ai_refinement_metrics:{clamped_keys:x.clamped_keys||[],envelope_violations:x.envelope_violations||[],db_violations:x.db_violations||[],out_of_range_count:x.out_of_range_count||0,missing_keys_added:x.missing_keys_added||[],extra_keys_removed:x.extra_keys_removed||[],active_keys_count:x.active_keys_count||0,top_shape_deltas:x.refinement_deltas?.top_10_shape_deltas||[],top_limb_deltas:x.refinement_deltas?.top_10_limb_deltas||[],k5_envelope_used:!!e.match?.k5_envelope,vision_classification_used:!!e.semantic?.semantic_profile}}}}const m=Ue(e,s,t,a,n),{shape_params:k,limb_masses:S,strategy:u="comprehensive_fallback"}=m,p=u||"comprehensive_fallback_no_strategy_detected";o.info("MORPH_PAYLOAD","PHASE 1: Strategy validation and assignment completed",{originalStrategy:u,finalStrategy:p,strategyWasUndefined:!u,philosophy:"phase_1_explicit_strategy_assignment"});let w={shape_params:k,limb_masses:S},F=.8,d=.8;if(e.match?.selected_archetypes&&e.match.selected_archetypes.length>1){o.info("MORPH_PAYLOAD","Applying client-side blending (pre-AI refinement)",{archetypesCount:e.match.selected_archetypes.length,philosophy:"pre_ai_blending"});const g=Le(e.match.selected_archetypes,n,t);w={shape_params:g.shape_params,limb_masses:g.limb_masses},F=g.confidence,d=g.quality_score}try{const g=e.estimate?.extracted_data?{height_cm:e.estimate.extracted_data.raw_measurements?.height_cm||175,weight_kg:e.estimate.extracted_data.raw_measurements?.weight_kg||70,estimated_bmi:e.estimate.extracted_data.estimated_bmi||22,raw_measurements:{waist_cm:e.estimate.extracted_data.raw_measurements?.waist_cm||80,chest_cm:e.estimate.extracted_data.raw_measurements?.chest_cm||95,hips_cm:e.estimate.extracted_data.raw_measurements?.hips_cm||100}}:void 0,A=e.match?.k5_envelope,x=e.semantic?.semantic_profile?{muscularity:e.semantic.semantic_profile.muscularity,obesity:e.semantic.semantic_profile.obesity,morphotype:e.semantic.semantic_profile.morphotype,level:e.semantic.semantic_profile.level}:null;o.info("MORPH_PAYLOAD","Calling scan-refine-morphs for AI refinement",{finalGender:t,blendedShapeParamsCount:Object.keys(w.shape_params).length,blendedLimbMassesCount:Object.keys(w.limb_masses).length,hasK5Envelope:!!A,hasVisionClassification:!!x,hasUserMeasurements:!!g,philosophy:"phase_b_ai_driven_k5_constrained_refinement"});const R=await We({scan_id:e.serverScanId||e.commit?.scan_id||"unknown",user_id:e.userId||"unknown",resolvedGender:t==="male"?"masculine":"feminine",photos:Ke(e),blend_shape_params:w.shape_params,blend_limb_masses:w.limb_masses,mapping_version:"v1.0",k5_envelope:A,vision_classification:x,user_measurements:g});if(!R)throw new Error("AI refinement service returned null or undefined response");const{validateRefineResponse:$}=await J(async()=>{const{validateRefineResponse:K}=await import("./types-CMUW8gDJ.js");return{validateRefineResponse:K}},[]),z=$(R);if(!z.isValid)throw o.error("MORPH_PAYLOAD","PHASE 1: AI refinement result validation failed",{finalGender:t,errors:z.errors,warnings:z.warnings,aiRefinementResult:R,philosophy:"phase_1_ai_result_validation_failed"}),new Error(`AI refinement result validation failed: ${z.errors.join(", ")}`);if(z.warnings.length>0&&o.warn("MORPH_PAYLOAD","PHASE 1: AI refinement result has warnings",{finalGender:t,warnings:z.warnings,philosophy:"phase_1_ai_result_quality_warnings"}),R.ai_refine){if(Object.keys(R.final_shape_params).length===0)throw new Error("AI refinement succeeded but final_shape_params is empty");if(Object.keys(R.final_limb_masses).length===0)throw new Error("AI refinement succeeded but final_limb_masses is empty");const K=te(R.final_shape_params,n,t),X=re(R.final_limb_masses,n,t);return{shape_params:K,limb_masses:X,blender_shape_keys:ie(K),metadata:{strategy:"phase_b_ai_refined_k5_constrained_validated",finalGender:t,confidence:R.ai_confidence||.95,quality_score:.95,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!0,mapping_version:R.mapping_version,allowlisted_keys_count:Object.keys(K).length,rejected_keys_count:0,envelope_constrained:!0,morph_generation_fallback:!1,phase_b_ai_refinement_metrics:{clamped_keys:R.clamped_keys||[],envelope_violations:R.envelope_violations||[],db_violations:R.db_violations||[],out_of_range_count:R.out_of_range_count||0,missing_keys_added:R.missing_keys_added||[],extra_keys_removed:R.extra_keys_removed||[],active_keys_count:R.active_keys_count||0,top_shape_deltas:R.refinement_deltas?.top_10_shape_deltas||[],top_limb_deltas:R.refinement_deltas?.top_10_limb_deltas||[],k5_envelope_used:!!A,vision_classification_used:!!x}}}}}catch(g){if(o.error("MORPH_PAYLOAD","PHASE 1: AI refinement failed with validation error",{finalGender:t,error:g instanceof Error?g.message:"Unknown error",stack:g instanceof Error?g.stack:void 0,philosophy:"phase_1_ai_refinement_critical_failure"}),g instanceof Error&&(g.message.includes("validation failed")||g.message.includes("missing or empty")||g.message.includes("null or undefined")))throw g;o.warn("MORPH_PAYLOAD","PHASE 1: AI refinement service error, falling back to blended data",{finalGender:t,error:g instanceof Error?g.message:"Unknown error",philosophy:"phase_1_service_error_fallback"})}const{constrainedParams:M,constraintsApplied:D}=await J(async()=>{const{constrainedParams:g,constraintsApplied:A}=await Promise.resolve().then(()=>Ne);return{constrainedParams:g,constraintsApplied:A}},void 0).then(g=>g.applyMorphologicalConstraints(w.shape_params,s,t)),C=ue(M,n,t,u),T=he(w.limb_masses,n,t,u),L=p||"fallback_blend_with_constraints",U=te(C,n,t),b=re(T,n,t),E=Be(U,s),_=He(b,n,t),I=qe(E,t,"realistic"),f=ie(I),{missing_required:P,missing_optional:O}=ze(),j={shape_params:I,limb_masses:_,blender_shape_keys:f,metadata:{strategy:L||"fallback_blend_with_constraints_validated",finalGender:t,confidence:F,quality_score:d,constraints_applied:D.length,missing_required:P,missing_optional:O,ai_refined:!1,mapping_version:"v1.0",allowlisted_keys_count:Object.keys(I).length,rejected_keys_count:Object.keys(M).length-Object.keys(C).length,envelope_constrained:!1,morph_generation_fallback:!1}};if(!j.metadata.strategy||j.metadata.strategy.length===0)throw o.error("MORPH_PAYLOAD","PHASE 1: Critical error - strategy is still undefined after all fallbacks",{finalGender:t,robustFinalStrategy:L,originalStrategy:u,philosophy:"phase_1_critical_strategy_validation"}),new Error("Critical error: strategy field is undefined after all fallback attempts");if(Object.keys(j.shape_params).length===0)throw o.error("MORPH_PAYLOAD","PHASE 1: Critical error - no shape parameters in final payload",{finalGender:t,strategy:j.metadata.strategy,philosophy:"phase_1_critical_data_validation"}),new Error("Critical error: final payload contains no shape parameters");return o.info("MORPH_PAYLOAD","PHASE A.4: Fallback morphological payload prepared",{strategy:j.metadata.strategy,finalGender:t,shapeParamsCount:Object.keys(E).length,limbMassesCount:Object.keys(_).length,blenderKeysCount:Object.keys(f).length,confidence:F.toFixed(3),qualityScore:d.toFixed(3),constraintsApplied:D.length,allowlistedKeysCount:j.metadata.allowlisted_keys_count,rejectedKeysCount:j.metadata.rejected_keys_count,validationPassed:!0,philosophy:"phase_a_fallback_with_strict_allowlisting"}),j}function qe(e,n,r="realistic"){if(r!=="realistic"||n!=="male")return e;const c={...e},a=["superBreast","breastsSmall","breastsSag","pregnant","animeWaist","dollBody","animeProportion","animeNeck","nipples"];let t=0;return a.forEach(s=>{if(s in c&&Math.abs(c[s])>.01){const l=c[s],m=Math.min(l,.05);Math.abs(l-m)>.001&&(c[s]=m,t++,o.debug("STYLE_CONSTRAINTS","Applied realistic soft-clamp for male avatar",{morphKey:s,originalValue:l.toFixed(3),softClampedValue:m.toFixed(3),style:r,gender:n,philosophy:"realistic_male_avatar_soft_clamping"}))}}),t>0&&o.info("STYLE_CONSTRAINTS","Applied realistic style constraints",{gender:n,style:r,adjustedMorphsCount:t,philosophy:"realistic_avatar_style_optimization"}),c}const oe=["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass"];function ge(e){const n=typeof e=="string"?parseFloat(e):typeof e=="number"?e:NaN;return Number.isFinite(n)?n:null}function Je(e){const n=e?.limb_masses??e?.limbMasses??e?.match?.blended_limb_masses??e?.match?.primary_archetype?.limb_masses??e?.match?.selected_archetypes?.[0]?.limb_masses??e?.estimate?.extracted_data?.limb_masses??null,r=typeof n=="string"?Ge(n):n;if(!r||typeof r!="object")throw new Error("Missing limb_masses in scan");const c={};for(const l of oe){const m=ge(r[l]);m!==null&&(c[l]=m)}const a=ge(r.gate);c.gate=a===null?1:a,c.isActive=r.isActive??!0;const t=Object.keys(c).filter(l=>oe.includes(l)),s=oe.filter(l=>!t.includes(l));return o.info("LIMB_MASSES_EXTRACTED","Limb masses extracted",{count:t.length,missing:s.length>0?s.join(", "):"none",values:t.reduce((l,m)=>(l[m]=c[m],l),{})}),{masses:c,count:t.length,missing:s}}function Ge(e){try{return JSON.parse(e)}catch{return null}}function Xe(){const e=Oe(),n=be(),{profile:r}=ye(),{successMajor:c}=se(),{data:a}=we(),{showToast:t}=je(),[s,l]=v.useState(e.state?.scanResults||null),[m,k]=v.useState({}),[S,u]=v.useState("front"),[p,w]=v.useState(!0),[F,d]=v.useState(!1),[M,D]=v.useState(!1),[C,T]=v.useState(null),[L,U]=v.useState(0),b=v.useRef(null),E=v.useRef(!1),_=v.useRef(!1),I=v.useRef(null),f=v.useRef(null),P=v.useRef({}),O=v.useMemo(()=>s?.userProfile?{sex:s.userProfile.sex,height_cm:s.userProfile.height_cm,weight_kg:s.userProfile.weight_kg}:{sex:"male",height_cm:175,weight_kg:70},[s?.userProfile?.sex,s?.userProfile?.height_cm,s?.userProfile?.weight_kg]),j=v.useMemo(()=>s?.match?.k5_envelope||s?.match?.morph_bounds||s?.morph_bounds||s?.k5_envelope||{},[s?.match?.k5_envelope,s?.match?.morph_bounds,s?.morph_bounds,s?.k5_envelope]),g=v.useMemo(()=>s?.match?.selected_archetypes||[],[s?.match?.selected_archetypes]),A=v.useMemo(()=>{if(!s||!s.userProfile&&!s.match?.selected_archetypes?.length)return"male";if(s?.resolvedGender)return o.info("RESOLVED_GENDER_REVIEW","Using explicit resolved gender from scan results",{resolvedGender:s.resolvedGender,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),s.resolvedGender;if(O?.sex)return o.info("RESOLVED_GENDER_REVIEW","Using user profile gender",{profileGender:O.sex,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),O.sex;if(g?.length>0){const h=g[0],Y=h.gender==="feminine"?"female":"male";return o.warn("RESOLVED_GENDER_REVIEW","Using archetype gender as fallback",{archetypeGender:Y,archetypeId:h.id,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,reason:"no_explicit_gender_in_scan_results_or_profile"}),Y}const y="male";return o.warn("RESOLVED_GENDER_REVIEW","Using ultimate fallback gender",{fallbackGender:y,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,reason:"no_gender_information_available_anywhere"}),y},[s,O?.sex,g]),x=v.useMemo(()=>{if(!s)return{};o.info("LIMB_MASSES_EXTRACTION_REVIEW","Starting limb masses extraction from scan results",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,scanResultsKeys:s?Object.keys(s):[]});try{const{masses:y,count:h,missing:Y}=Je(s);return o.info("LIMB_MASSES_NORMALIZED",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,count:h,missing:Y,masses:Object.entries(y).map(([q,H])=>({key:q,value:H}))}),h===0?(o.warn("LIMB_MASSES_EXTRACTION_REVIEW","No limb masses available, using empty object",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),{}):y}catch(y){return o.error("LIMB_MASSES_EXTRACTION_REVIEW","Failed to normalize limb masses",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,error:y instanceof Error?y.message:"Unknown error"}),{}}},[s]),R=v.useMemo(()=>{if(!s)return null;const y=Pe(s),h=y?.tone;return h?o.info("SKIN_TONE_EXTRACTION_REVIEW","Skin tone resolved successfully",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,skinTone:`rgb(${h.rgb.r}, ${h.rgb.g}, ${h.rgb.b})`,skinToneHex:h.hex,source:y.source,confidence:h.confidence?h.confidence.toFixed(3):"N/A",schema:h.schema}):o.debug("SKIN_TONE_EXTRACTION_REVIEW","Skin tone not yet available - pending state",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,reason:"skin_tone_pending_not_error"}),h},[s]),$=v.useMemo(()=>{if(!a||!O||!A)return null;try{const y=me(a,A);return o.info("MORPH_CONSTRAINTS Policy built from DB",{gender:A,requiredKeys:y.requiredKeys.length,optionalKeys:y.optionalKeys.length,totalRanges:Object.keys(y.ranges).length}),y}catch(y){return o.error("Failed to build morph policy",{error:y instanceof Error?y.message:"Unknown error",gender:A,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),null}},[a,O,A,s?.clientScanId,s?.serverScanId]),z=v.useMemo(()=>{const y=O?.sex||"male";if(!f.current||f.current._generatedForSex!==y){const h=ce(y);h._generatedForSex=y,f.current=h,o.debug("MORPH_FALLBACK","Generated new stable fallback morph data",{sex:y,morphCount:Object.keys(h).length})}return f.current},[O?.sex]),K=v.useMemo(()=>{if(m&&Object.keys(m).length>0&&L===0)return o.debug("BODY_SCAN_REVIEW","Using currentMorphData as primary source",{clientScanId:s?.clientScanId,morphDataKeys:Object.keys(m),resetTrigger:L,philosophy:"current_morph_data_priority"}),m;let y={},h="unknown";s?.match?.ai_refinement?.ai_refine&&s.match.final_shape_params?(o.info("AI_REFINEMENT","Using AI-refined morphological data",{scanId:s?.serverScanId,resolvedGender:A,finalShapeParamsCount:Object.keys(s.match.final_shape_params).length,aiConfidence:s.match.ai_refinement.ai_confidence,philosophy:"ai_refined_direct_use"}),y=s.match.final_shape_params,h="ai_refined"):s?.match?.blended_shape_params&&Object.keys(s.match.blended_shape_params).length>0?(o.info("BODY_SCAN_REVIEW","Using blended shape params from match result",{clientScanId:s?.clientScanId,morphDataKeys:Object.keys(s.match.blended_shape_params),philosophy:"blend_fallback"}),y=s.match.blended_shape_params,h="blended"):(o.info("BODY_SCAN_REVIEW","Using stable fallback morph data",{clientScanId:s?.clientScanId,philosophy:"stable_fallback"}),y=z,h="fallback");const Y=JSON.stringify(Object.keys(y).sort().map(H=>[H,y[H]])),q=JSON.stringify(Object.keys(P.current).sort().map(H=>[H,P.current[H]]));return Y!==q?(P.current=y,o.debug("BODY_SCAN_REVIEW","Morph data content changed, updating stable reference",{clientScanId:s?.clientScanId,dataSource:h,morphDataKeys:Object.keys(y),reason:"content_changed"})):o.debug("BODY_SCAN_REVIEW","Morph data content unchanged, using stable reference",{clientScanId:s?.clientScanId,dataSource:h,reason:"content_identical"}),(!b.current||Object.keys(b.current).length===0)&&(b.current=JSON.parse(JSON.stringify(P.current)),o.info("REVIEW_STATE","Initial morph data stored for reset functionality",{morphKeysCount:Object.keys(b.current).length,philosophy:"initial_morph_data_storage_from_completeMorphData"})),P.current},[m,L,s,a,O,A,z,A,s?.clientScanId,s?.serverScanId]);de.useEffect(()=>{K&&Object.keys(K).length>0&&!b.current&&(b.current={...K},o.debug("REVIEW_STATE","Initial morph data stored for reset functionality",{morphKeysCount:Object.keys(K).length,sampleMorphs:Object.entries(K).slice(0,3).map(([y,h])=>({key:y,value:h.toFixed(3)})),philosophy:"initial_morph_data_storage"}))},[K]);const X=v.useMemo(()=>{const y=Object.keys(K||{}).length,h=Object.keys(x||{}).filter(q=>["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass","hipMass"].includes(q)).length,Y=y+h;return{shapeParamCount:y,limbMassCount:h,totalMorphKeys:Y}},[K,x]),xe=v.useCallback(()=>{if(!M){D(!0);const y=Z.getState().progress;y<100&&Z.getState().setRenderReady(),o.info("BODY_SCAN_REVIEW Avatar 3D viewer ready",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,currentProgress:y})}},[M,s?.clientScanId,s?.serverScanId]);v.useEffect(()=>{(async()=>{if(_.current)return;const h=e.state?.scanResults;if(o.logOnce("navigation-state-received","info","BODY_SCAN_REVIEW Navigation state received",{hasLocationState:!!e.state,hasScanData:!!h,scanDataKeys:h?Object.keys(h):[],clientScanId:h?.clientScanId,serverScanId:h?.serverScanId,timestamp:new Date().toISOString()}),_.current=!0,!h){o.warn("BODY_SCAN_REVIEW No scan data available, redirecting to body-scan"),n("/body-scan",{replace:!0});return}const Y=JSON.stringify(h),q=s?JSON.stringify(s):null;if(Y!==q?(l(h),o.debug("BODY_SCAN_REVIEW","Scan results updated due to content change",{clientScanId:h.clientScanId,contentChanged:!0,reason:"deep_comparison_detected_change"})):o.debug("BODY_SCAN_REVIEW","Scan results content unchanged, skipping update",{clientScanId:h.clientScanId,contentChanged:!1,reason:"deep_comparison_no_change"}),m&&Object.keys(m).length>0){o.debug("BODY_SCAN_REVIEW","Morph data already set, skipping re-extraction",{clientScanId:h.clientScanId,existingMorphDataKeys:Object.keys(m)});return}let H={},ae="unknown";if(a&&O)try{const V=await $e(h,a,O.sex,A);H=V.shape_params,ae=`prepared_payload_${V.metadata.strategy}`,o.info("BODY_SCAN_REVIEW Used prepared morphological payload",{clientScanId:h.clientScanId,morphDataKeys:Object.keys(H),strategy:V.metadata.strategy,confidence:V.metadata.confidence.toFixed(3),qualityScore:V.metadata.quality_score.toFixed(3),morphGenerationFallback:V.metadata.morph_generation_fallback,validationPassed:!0})}catch(V){if(o.error("BODY_SCAN_REVIEW","PHASE 1: Critical error during payload preparation",{clientScanId:h.clientScanId,error:V instanceof Error?V.message:"Unknown error",stack:V instanceof Error?V.stack:void 0,scanDataKeys:Object.keys(h),hasMorphologyMapping:!!a,hasStableUserProfile:!!O,philosophy:"phase_1_critical_payload_preparation_error"}),V instanceof Error&&(V.message.includes("validation failed")||V.message.includes("missing or empty")||V.message.includes("null or undefined")||V.message.includes("Critical error"))){const pe=`Erreur de préparation des données: ${V instanceof Error?V.message:"Erreur inconnue"}`;T(pe),o.error("BODY_SCAN_REVIEW","PHASE 1: Critical error state set due to payload preparation failure",{clientScanId:h.clientScanId,errorMessage:pe,criticalErrorSet:!0,philosophy:"phase_1_critical_error_state_management"});return}else o.warn("BODY_SCAN_REVIEW","PHASE 1: Non-critical payload preparation error, using fallback",{clientScanId:h.clientScanId,error:V instanceof Error?V.message:"Unknown error",philosophy:"phase_1_non_critical_error_fallback"}),H=ce(O?.sex||"male"),ae="payload_preparation_failed_fallback_validated"}else H=ce(O?.sex||"male"),ae="comprehensive_fallback_no_mapping_or_profile";if(C){o.debug("BODY_SCAN_REVIEW","PHASE 1: Skipping morph data setting due to critical error",{clientScanId:h.clientScanId,criticalError:C});return}o.info("BODY_SCAN_REVIEW Final morph data extracted for 3D viewer",{clientScanId:h.clientScanId,serverScanId:h.serverScanId,morphDataKeys:Object.keys(H),morphDataCount:Object.keys(H).length,strategy:ae,timestamp:new Date().toISOString()}),(!b.current||JSON.stringify(b.current)!==JSON.stringify(H))&&(b.current={...H},o.info("REVIEW_STATE","Initial morph data set/updated for reset",{morphKeysCount:Object.keys(H).length,sampleMorphs:Object.entries(H).slice(0,3).map(([V,_e])=>({key:V,value:_e.toFixed(3)})),philosophy:"initial_morph_data_storage_fix"})),k(H)})()},[e.state?.scanResults,n,m,a,O]);const ke=v.useCallback(()=>{if(o.info("REVIEW_STATE","Reset morphs requested - BEFORE reset",{hasInitialData:!!b.current,initialDataKeys:b.current?Object.keys(b.current):[],initialDataCount:b.current?Object.keys(b.current).length:0,currentMorphDataKeys:Object.keys(m),currentMorphDataCount:Object.keys(m).length,resetTrigger:L,philosophy:"reset_morphs_before_audit"}),!b.current||Object.keys(b.current).length===0){o.error("REVIEW_STATE","Cannot reset morphs - no initial data available",{hasInitialDataRef:!!b.current,initialDataKeys:b.current?Object.keys(b.current):[],philosophy:"reset_morphs_no_initial_data_error"});return}const y=JSON.parse(JSON.stringify(b.current));k(y),I.current?.forceMorphsUpdate&&(I.current.forceMorphsUpdate(y),o.info("REVIEW_STATE","Forced morph cache reset with immediate reapplication",{resetDataKeys:Object.keys(y),philosophy:"force_3d_viewer_cache_reset_with_data"})),U(h=>h+1),o.info("REVIEW_STATE","Reset morphs completed - AFTER reset",{resetDataKeys:Object.keys(y),resetDataCount:Object.keys(y).length,sampleResetMorphs:Object.entries(y).slice(0,3).map(([h,Y])=>({key:h,value:Y.toFixed(3)})),newResetTrigger:L+1,philosophy:"reset_morphs_after_audit"})},[k,m,L,I]);return v.useEffect(()=>{const y=Z.getState().progress;if(y<100){const{setRenderReady:h}=Z.getState();h()}c(),o.info("BODY_SCAN_REVIEW — page mounted, avatar ready for initialization",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,currentProgress:y,timestamp:new Date().toISOString()}),E.current=!0},[c,K,s?.clientScanId,s?.serverScanId]),{scanResults:s,setScanResults:l,currentMorphData:m,completeMorphData:K,morphCounters:X,setCurrentMorphData:k,activeView:S,setActiveView:u,autoRotate:p,setAutoRotate:w,showMorphControls:F,setShowMorphControls:d,avatar3DRef:I,resetMorphsToInitial:ke,stableUserProfile:O,stableMorphBounds:j,stableSelectedArchetypes:g,stableLimbMasses:x,stableSkinTone:R,profile:r,isViewerReady:M,handleViewerReady:xe,morphologyMapping:a,morphPolicy:$,showToast:t,resolvedGender:A,criticalError:C,setCriticalError:T,initialMorphDataRef:b}}function ce(e){const n={pearFigure:.1,bodybuilderSize:.1,emaciated:0,narrowWaist:.1,bigHips:e==="female"?.2:.1,assLarge:e==="female"?.2:.1,superBreast:e==="female"?.1:0,breastsSmall:e==="female"?.1:0,breastsSag:0,pregnant:0,bodybuilderDetails:0,animeWaist:0,dollBody:0,animeProportion:0,animeNeck:0,nipples:0,FaceLowerEyelashLength:0,eyesClosedL:0,eyesClosedR:0,eyelashLength:0,eyelashesSpecial:0,eyesShape:0,eyesSpacing:0,eyesDown:0,eyesUp:0,eyesSpacingWide:0};return o.debug("MORPH_FALLBACK","Generated comprehensive morph fallback",{sex:e,morphCount:Object.keys(n).length,sampleMorphs:Object.entries(n).slice(0,5).map(([r,c])=>({key:r,value:c}))}),n}const Ze={waist_cm:"Tour de taille",chest_cm:"Tour de poitrine",hips_cm:"Tour de hanches",shoulder_width_cm:"Largeur d'épaules",neck_cm:"Tour de cou",arm_length_cm:"Longueur de bras",bicep_cm:"Tour de biceps",thigh_cm:"Tour de cuisse",calf_cm:"Tour de mollet",forearm_cm:"Tour d'avant-bras",wrist_cm:"Tour de poignet",ankle_cm:"Tour de cheville",height_cm:"Taille",weight_kg:"Poids",inseam_cm:"Entrejambe",torso_length_cm:"Longueur du torse",estimated_body_fat_perc:"Masse Grasse Estimée",estimated_muscle_mass_kg:"Masse Musculaire Estimée",waist_to_hip_ratio:"Ratio Taille/Hanches"};function Qe(e,n,r){const a=r==="male"?15:25,t=Math.abs(e-22)/22,s=Math.abs(n-a)/a,m=30+(t+s)*15;return Math.max(18,Math.min(65,m))}function ea(e){const r=e/100;return 22*r*r}function aa(e){return e<18.5?{category:"Insuffisant",color:"#06B6D4",description:"Poids en dessous de la normale"}:e<25?{category:"Normal",color:"#10B981",description:"Poids dans la plage normale"}:e<30?{category:"Surpoids",color:"#F59E0B",description:"Poids au-dessus de la normale"}:{category:"Obésité",color:"#EF4444",description:"Poids significativement élevé"}}const sa=e=>{switch(e){case"weight_kg":return"measurement-detail-item--weight";case"height_cm":return"measurement-detail-item--height";case"waist_cm":return"measurement-detail-item--waist";case"chest_cm":return"measurement-detail-item--chest";default:return""}},na=e=>{switch(e){case"weight_kg":return"Scale";case"height_cm":return"Ruler";case"waist_cm":return"Circle";case"chest_cm":return"Heart";case"hips_cm":return"Circle";case"shoulder_width_cm":return"Users";case"neck_cm":return"Circle";case"arm_length_cm":return"Minus";case"bicep_cm":return"Dumbbell";case"thigh_cm":return"Triangle";case"calf_cm":return"Triangle";case"forearm_cm":return"Minus";case"wrist_cm":return"Circle";case"ankle_cm":return"Circle";case"inseam_cm":return"Minus";case"torso_length_cm":return"Minus";case"estimated_body_fat_perc":return"Zap";case"estimated_muscle_mass_kg":return"Dumbbell";case"waist_to_hip_ratio":return"GitCompare";default:return"Info"}},ta=({scanResults:e,userProfile:n,skinTone:r})=>{const{click:c}=se(),a=e?.estimate?.extracted_data||{};let t=null;r&&ne(r)?t=r:a?.skin_tone&&ne(a.skin_tone)?t=a.skin_tone:e?.commit?.data?.skin_tone&&ne(e.commit.data.skin_tone)?t=e.commit.data.skin_tone:r&&o.warn("MEASUREMENTS_CARD","Received skin tone is not in V2 format",{skinTone:r,hasSkinToneProp:!!r,skinToneKeys:r?Object.keys(r):[]});const s=a?.raw_measurements||{},l=Number(s.waist_cm)||0,m=Number(s.hips_cm)||0,k=Number(s.chest_cm)||0,S=Number(s.height_cm)||n.height_cm||0,u=Number(s.weight_kg)||n.weight_kg||0,p=Number(a.estimated_body_fat_perc)||0,w=Number(a.estimated_muscle_mass_kg)||0,F=a?.estimated_bmi??n.weight_kg/Math.pow(n.height_cm/100,2),d=a?.estimated_body_fat_perc??(n.sex==="male"?15:25),M=a?.processing_confidence,D=l>0&&m>0&&k>0&&S>0&&u>0&&p>0&&w>0;if(!a||Object.keys(s).length===0)return null;const C=F||n.weight_kg/Math.pow(n.height_cm/100,2),T=aa(C),L=C&&d?Qe(C,d,n.sex):null,U=ea(n.height_cm),E=[...Object.entries(s),["estimated_body_fat_perc",a.estimated_body_fat_perc],["estimated_muscle_mass_kg",a.estimated_muscle_mass_kg]].filter(([_,I])=>I!=null).map(([_,I])=>{const f=Ze[_]||_.replace(/_/g," "),P=_.includes("_cm")?"cm":_.includes("_kg")?"kg":_.includes("_perc")?"%":"",O=typeof I=="number"?I.toFixed(1):I;let j=na(_),g="#9CA3AF";switch(_){case"weight_kg":case"estimated_muscle_mass_kg":g="#60A5FA";break;case"height_cm":g="#8B5CF6";break;case"waist_cm":case"hips_cm":case"chest_cm":g="#10B981";break;case"estimated_body_fat_perc":case"waist_to_hip_ratio":g="#F59E0B";break;default:g="var(--color-body-scan-primary)";break}return{key:_,value:O,label:f,unit:P,icon:j,color:g}});return i.jsx(W.div,{className:"measurements-card",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,ease:"easeOut"},children:i.jsxs(Q,{className:"p-6 relative overflow-visible",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 6%, transparent) 0%, transparent 60%),
            radial-gradient(circle at 70% 80%, color-mix(in srgb, var(--color-plasma-cyan) 4%, transparent) 0%, transparent 50%),
            rgba(18, 24, 38, 0.7)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 20%, transparent)",boxShadow:`
            0 8px 32px rgba(0, 0, 0, 0.25),
            0 0 20px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent),
            inset 0 1px 0 rgba(255, 255, 255, 0.1)
          `,backdropFilter:"blur(var(--glass-blur-base)) saturate(var(--glass-saturate-base))"},children:[i.jsxs("div",{className:"flex items-center justify-between mb-6",children:[i.jsxs("div",{className:"flex items-center bodyscan-gap-md",children:[i.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, var(--color-body-scan-success) 35%, transparent), color-mix(in srgb, var(--color-body-scan-success) 25%, transparent))
                `,border:"2px solid color-mix(in srgb, var(--color-body-scan-success) 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, var(--color-body-scan-success) 30%, transparent)"},children:i.jsx(B,{Icon:D?N.Activity:N.Info,size:20,style:{color:D?"var(--color-body-scan-success)":"var(--color-body-scan-warning)"},variant:"pure"})}),i.jsx("h3",{className:"text-lg font-semibold text-white",children:"Mesures extraites"})]}),M&&i.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full ${D?"bg-emerald-500/20 border border-emerald-500/30":"bg-yellow-500/20 border border-yellow-400/30"}`,children:[i.jsx("div",{className:`w-2 h-2 rounded-full ${D?"bg-emerald-400":"bg-yellow-400"} ${D?"":"animate-pulse"}`}),i.jsx("span",{className:`${D?"text-emerald-400":"text-yellow-300"} text-xs font-medium`,children:D?`${Math.round(M*100)}% confiance`:"Données incomplètes"})]})]}),i.jsxs("div",{className:"measurements-grid mb-8",children:[C&&T&&i.jsxs(W.div,{className:"measurement-summary-card",style:{"--measurement-color":T.color},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.1},whileHover:{scale:1.02,y:-2},onClick:()=>c(),children:[i.jsx("div",{className:"measurement-value measurement-value--large",children:C.toFixed(1)}),i.jsxs("div",{className:"measurement-label measurement-label--primary",children:["IMC • ",T.category]}),i.jsx("div",{className:"measurement-description",children:T.description})]}),L&&i.jsxs(W.div,{className:"measurement-detail-item",initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.2},whileHover:{scale:1.02,y:-2},onClick:()=>c(),children:[i.jsxs("div",{className:"measurement-value",children:[Math.round(L)," ans"]}),i.jsx("div",{className:"measurement-label",children:"Âge Corporel"})]}),i.jsxs(W.div,{className:"measurement-detail-item",initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.3},whileHover:{scale:1.02,y:-2},onClick:()=>c(),children:[i.jsxs("div",{className:"measurement-value",children:[U.toFixed(1)," kg"]}),i.jsx("div",{className:"measurement-label",children:"Poids Idéal"})]})]}),t&&t.hex&&i.jsx(W.div,{className:"measurement-detail-item",style:{"--icon-bg-color":`${t.hex}20`,"--icon-border-color":`${t.hex}50`,"--icon-text-color":t.hex},initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{duration:.4,delay:.4},whileHover:{scale:1.02,y:-2},onClick:()=>c(),children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-12 h-12 rounded-full border-2 shadow-lg",style:{backgroundColor:t.hex,borderColor:`${t.hex}80`,boxShadow:`0 4px 12px ${t.hex}40`}}),i.jsxs("div",{children:[i.jsx("div",{className:"measurement-value text-sm",children:t.hex.toUpperCase()}),i.jsxs("div",{className:"measurement-label text-xs",children:["Couleur de Peau Extraite",t.confidence&&i.jsxs("span",{className:"ml-2 text-xs opacity-70",children:[Math.round(t.confidence*100),"% confiance"]})]})]})]})}),i.jsx("div",{className:"measurements-grid",children:E.map((_,I)=>i.jsxs(W.div,{className:`measurement-detail-item ${sa(_.key)}`,style:{"--icon-bg-color":`color-mix(in srgb, ${_.color} 20%, transparent)`,"--icon-border-color":`color-mix(in srgb, ${_.color} 30%, transparent)`,"--icon-text-color":_.color},initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:I*.1,ease:"easeOut"},whileHover:{scale:1.02,y:-2},onClick:()=>c(),children:[i.jsx("div",{className:"measurement-detail-icon-container",children:i.jsx(B,{Icon:N[_.icon],size:12,style:{color:_.color},variant:"pure"})}),i.jsxs("div",{className:"measurement-value",children:[_.value,_.unit]}),i.jsx("div",{className:"measurement-label",children:_.label})]},_.key))})]})})};function ra(e,n){const[r,c]=v.useState(e);return v.useEffect(()=>{const a=setTimeout(()=>{c(e)},n);return()=>{clearTimeout(a)}},[e,n]),r}const fe=.05,le={bodyShape:[{key:"bodybuilderSize",label:"Développement musculaire",icon:"Zap",color:"#8B5CF6"},{key:"pearFigure",label:"Masse grasse",icon:"Triangle",color:"#F59E0B"},{key:"narrowWaist",label:"Tour de taille",icon:"Minimize2",color:"#10B981"},{key:"emaciated",label:"Gabarit",icon:"Minus",color:"#06B6D4"}],curves:[{key:"bigHips",label:"Hanches",icon:"Circle",color:"#EC4899"},{key:"assLarge",label:"Fessiers",icon:"Circle",color:"#F97316"}],chest:[]};function ia(e,n){const r=[];return le.bodyShape.forEach(c=>{const a=n.ranges[c.key];a&&!(a.min===0&&a.max===0)&&r.push({...c,category:"Corps"})}),le.curves.forEach(c=>{const a=n.ranges[c.key];a&&!(a.min===0&&a.max===0)&&r.push({...c,category:"Courbes"})}),le.chest.forEach(c=>{const a=n.ranges[c.key];a&&!(a.min===0&&a.max===0)&&r.push({...c,category:"Poitrine"})}),r}const Se=de.memo(({currentMorphData:e,setCurrentMorphData:n,resetMorphsToInitial:r,morphPolicy:c,morphologyMapping:a,resolvedGender:t,isViewerReady:s,avatar3DRef:l})=>{const[m,k]=v.useState(!1),[S,u]=v.useState(new Set),{click:p,formInput:w}=se(),F=ra(e,50),d=v.useMemo(()=>ia(t,c),[t,c]);de.useEffect(()=>{s&&l.current?.updateMorphData&&(o.debug("MORPH_ADJUSTMENT","Applying debounced morph data to 3D viewer",{morphDataKeys:Object.keys(F),resolvedGender:t}),l.current.updateMorphData(F))},[F,s,l,t]);const M=v.useCallback((_,I)=>{const f=c.ranges[_];if(!f)return;const P=Math.max(f.min,Math.min(f.max,I)),O={...e,[_]:P};n(O),u(j=>new Set([...j,_]));try{w()}catch(j){console.warn("MORPH_ADJUSTMENT","Audio feedback failed for button click",{audioError:j})}o.debug("MORPH_ADJUSTMENT","Morph value updated with direct 3D update",{morphKey:_,value:P.toFixed(3),resolvedGender:t,philosophy:"direct_3d_morph_update"})},[e,n,u,w,c.ranges,t]),D=v.useCallback(_=>{const f=(e[_]!==void 0&&e[_]!==null?e[_]:0)+fe;M(_,f)},[e,M]),C=v.useCallback(_=>{const f=(e[_]!==void 0&&e[_]!==null?e[_]:0)-fe;M(_,f)},[e,M]),T=v.useCallback(()=>{p(),u(new Set),r()},[r,p,u]),L=v.useMemo(()=>{const _={};return d.forEach(I=>{_[I.category]||(_[I.category]=[]),_[I.category].push(I)}),_},[d]),U=v.useMemo(()=>{const _=L.Corps||[],I=Object.entries(L).filter(([O])=>O!=="Corps"),f=Math.max(0,_.length-2),P=I.reduce((O,[,j])=>O+j.length,0);return f+P},[L]);if(!s||d.length===0)return null;const b=L.Corps||[],E=Object.entries(L).filter(([_])=>_!=="Corps");return i.jsx(W.div,{className:"slide-enter",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.4},children:i.jsxs(Q,{className:"morph-adjustment-card",children:[i.jsxs("div",{className:"bodyscan-flex-between mb-6",children:[i.jsxs("h4",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm",children:[i.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, var(--color-body-scan-accent) 35%, transparent), color-mix(in srgb, var(--color-body-scan-accent) 25%, transparent))
                `,border:"2px solid color-mix(in srgb, var(--color-body-scan-accent) 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, var(--color-body-scan-accent) 30%, transparent)"},children:i.jsx(B,{Icon:N.Settings,size:20,style:{color:"var(--color-body-scan-accent)"},variant:"pure"})}),"Ajustements morphologiques",S.size>0&&i.jsxs("span",{className:"morph-adjustment-badge",children:[S.size," modifié",S.size>1?"s":""]})]}),i.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[S.size>0&&i.jsxs("button",{onClick:T,className:"btn-glass px-4 py-2 text-sm bodyscan-flex-center bodyscan-gap-sm",title:"Réinitialiser tous les ajustements",children:[i.jsx(B,{Icon:N.RotateCcw,size:14}),i.jsx("span",{children:"Réinitialiser"})]}),i.jsx("button",{onClick:()=>{p(),k(!m)},className:"btn-glass--secondary-nav",children:i.jsx(B,{Icon:m?N.ChevronUp:N.ChevronDown,size:18,className:"bodyscan-text-warning"})})]})]}),i.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Ajustez subtilement votre avatar en temps réel. Les modifications sont appliquées instantanément au modèle 3D."}),b.length>0&&i.jsxs("div",{className:"mb-6",children:[i.jsxs("h5",{className:"glowing-title-text bodyscan-flex-center bodyscan-gap-sm mb-4",children:[i.jsx("div",{className:"bodyscan-header-icon-container",children:i.jsx(B,{Icon:N.Circle,size:16,className:"bodyscan-text-accent"})}),"Corps"]}),i.jsx("div",{className:"space-y-3",children:b.slice(0,m?b.length:2).map((_,I)=>{const f=c.ranges[_.key];if(!f)return null;const P=e[_.key]!==void 0&&e[_.key]!==null?e[_.key]:0,O=P>f.min,j=P<f.max,g=S.has(_.key);return i.jsx(W.div,{className:`glass-nested-card glass-field-container p-4 ${g?"ring-2 ring-blue-400/30":""}`,initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1*I,duration:.4},children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center space-x-3",children:[i.jsx(B,{Icon:N[_.icon]||N.Circle,size:16,style:{color:_.color},variant:"pure"}),i.jsx("span",{className:"text-white font-medium",children:_.label}),g&&i.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full"})]}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("button",{onClick:()=>C(_.key),disabled:!O,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${O?"":"opacity-30 cursor-not-allowed"}`,title:"Diminuer",children:i.jsx(B,{Icon:N.Minus,size:14})}),i.jsx("div",{className:`glass-field-container px-3 py-1 min-w-[60px] text-center text-sm font-mono ${g?"text-blue-300":"text-white/80"}`,title:P.toFixed(2),children:P.toFixed(2)}),i.jsx("button",{onClick:()=>D(_.key),disabled:!j,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${j?"":"opacity-30 cursor-not-allowed"}`,title:"Augmenter",children:i.jsx(B,{Icon:N.Plus,size:14})})]})]})},_.key)})})]}),U>0&&i.jsxs("button",{onClick:()=>{p(),k(!m)},className:"btn-glass w-full py-2 text-sm bodyscan-flex-center bodyscan-gap-sm mb-6",children:[i.jsx(B,{Icon:m?N.ChevronUp:N.ChevronDown,size:14}),i.jsx("span",{children:m?"Réduire":`Voir ${U} ajusteur${U>1?"s":""} de plus`})]}),m&&E.map(([_,I])=>i.jsxs("div",{className:"mb-6",children:[i.jsxs("h5",{className:"glowing-title-text bodyscan-flex-center bodyscan-gap-sm mb-4",children:[i.jsx("div",{className:"bodyscan-header-icon-container",children:i.jsx(B,{Icon:N.Circle,size:16,className:"bodyscan-text-accent"})}),_]}),i.jsx("div",{className:"space-y-3",children:I.map((f,P)=>{const O=c.ranges[f.key];if(!O)return null;const j=e[f.key]!==void 0&&e[f.key]!==null?e[f.key]:0,g=j>O.min,A=j<O.max,x=S.has(f.key);return i.jsx(W.div,{className:`glass-nested-card glass-field-container p-4 ${x?"ring-2 ring-blue-400/30":""}`,initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1*P,duration:.4},children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center space-x-3",children:[i.jsx(B,{Icon:N[f.icon]||N.Circle,size:16,style:{color:f.color},variant:"pure"}),i.jsx("span",{className:"text-white font-medium",children:f.label}),x&&i.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full"})]}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("button",{onClick:()=>C(f.key),disabled:!g,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${g?"":"opacity-30 cursor-not-allowed"}`,title:"Diminuer",children:i.jsx(B,{Icon:N.Minus,size:14})}),i.jsx("div",{className:`glass-field-container px-3 py-1 min-w-[60px] text-center text-sm font-mono ${x?"text-blue-300":"text-white/80"}`,title:j.toFixed(2),children:j.toFixed(2)}),i.jsx("button",{onClick:()=>D(f.key),disabled:!A,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${A?"":"opacity-30 cursor-not-allowed"}`,title:"Augmenter",children:i.jsx(B,{Icon:N.Plus,size:14})})]})]})},f.key)})})]},_)),!m&&S.size>0&&i.jsx("div",{className:"mt-4 p-3 glass-nested-card",children:i.jsxs("p",{className:"text-white/60 text-sm text-center",children:[S.size," ajustement",S.size>1?"s":""," appliqué",S.size>1?"s":""]})})]})})});Se.displayName="MorphAdjustmentControls";const oa=({isViewerReady:e,onSaveAvatar:n,onNewScan:r})=>i.jsxs("div",{className:"review-action-buttons",children:[i.jsx("button",{onClick:n,disabled:!e,className:`review-action-button ${e?"review-action-button--primary":"review-action-button--primary review-action-button--disabled"}`,children:i.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[i.jsx(B,{Icon:N.Save,size:20}),i.jsx("span",{children:"Sauvegarder cet avatar"})]})}),i.jsx("button",{onClick:r,className:"review-action-button review-action-button--secondary",children:i.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[i.jsx(B,{Icon:N.Scan,size:20}),i.jsx("span",{children:"Nouveau scan"})]})})]}),Ae=e=>Math.round(e*1e3)/1e3;function ca(e){const n={};return Object.entries(e).forEach(([r,c])=>{typeof c=="number"&&Number.isFinite(c)&&(n[r]=Ae(c))}),n}function la(e){const n={},r=["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass","hipMass"];return Object.entries(e).forEach(([c,a])=>{r.includes(c)&&typeof a=="number"&&Number.isFinite(a)&&(n[c]=Ae(a))}),n}function da(e){return`${e}_v4.13`}async function ma(e){o.info("AVATAR_SAVE_SKIN_TONE_PREP","AUDIT: Starting skin tone preparation for persistence",{inputSkinTone:e,inputSkinToneType:typeof e,inputSkinToneKeys:e?Object.keys(e):[],inputSkinToneStringified:e?JSON.stringify(e):null,hasRgbProperty:!!e?.rgb,rgbValue:e?.rgb,hasLinearF32Property:!!e?.linear_f32,linearF32Value:e?.linear_f32});const n=await J(()=>import("./normalizeSkinTone-gBHfMnNZ.js"),__vite__mapDeps([11,0,1,2,3,4,5,6,7,8,9,10])),r=n.resolveSkinTone,c=n.isSkinToneV2,a=r({skin_tone:e});if(!c(a.tone))throw o.error("AVATAR_SAVE_SKIN_TONE_PREP","CRITICAL: Resolved skin tone is NOT V2 format",{resolvedTone:a.tone,resolvedSource:a.source,hasSchema:!!a.tone?.schema,schema:a.tone?.schema,hasRgb:!!a.tone?.rgb,hasHex:!!a.tone?.hex,hasSrgbF32:!!a.tone?.srgb_f32,hasLinearF32:!!a.tone?.linear_f32,philosophy:"skin_tone_v2_validation_failed_after_resolve"}),new Error("Resolved skin tone is not in V2 format");const t={hasSchema:a.tone.schema==="v2",hasSpace:a.tone.space==="sRGB",hasFormat:a.tone.format==="rgb255",hasRgb:!!a.tone.rgb&&typeof a.tone.rgb.r=="number"&&typeof a.tone.rgb.g=="number"&&typeof a.tone.rgb.b=="number",rgbInRange:a.tone.rgb&&a.tone.rgb.r>=0&&a.tone.rgb.r<=255&&a.tone.rgb.g>=0&&a.tone.rgb.g<=255&&a.tone.rgb.b>=0&&a.tone.rgb.b<=255,hasHex:!!a.tone.hex&&/^#[0-9A-Fa-f]{6}$/.test(a.tone.hex),hasSrgbF32:!!a.tone.srgb_f32&&typeof a.tone.srgb_f32.r=="number"&&typeof a.tone.srgb_f32.g=="number"&&typeof a.tone.srgb_f32.b=="number",srgbF32InRange:a.tone.srgb_f32&&a.tone.srgb_f32.r>=0&&a.tone.srgb_f32.r<=1&&a.tone.srgb_f32.g>=0&&a.tone.srgb_f32.g<=1&&a.tone.srgb_f32.b>=0&&a.tone.srgb_f32.b<=1,hasLinearF32:!!a.tone.linear_f32&&typeof a.tone.linear_f32.r=="number"&&typeof a.tone.linear_f32.g=="number"&&typeof a.tone.linear_f32.b=="number",linearF32InRange:a.tone.linear_f32&&a.tone.linear_f32.r>=0&&a.tone.linear_f32.r<=1&&a.tone.linear_f32.g>=0&&a.tone.linear_f32.g<=1&&a.tone.linear_f32.b>=0&&a.tone.linear_f32.b<=1},s=Object.values(t).every(l=>l===!0);if(!s)throw o.error("AVATAR_SAVE_SKIN_TONE_PREP","CRITICAL: V2 skin tone validation failed",{validationResults:t,resolvedTone:a.tone,philosophy:"skin_tone_v2_properties_validation_failed"}),new Error("V2 skin tone properties validation failed");return o.info("AVATAR_SAVE_V2","Skin tone re-canonicalized and validated before persistence",{originalInput:e,resolvedTone:a.tone,resolvedSource:a.source,resolvedToneRGB:`rgb(${a.tone.rgb.r}, ${a.tone.rgb.g}, ${a.tone.rgb.b})`,resolvedToneHex:a.tone.hex,resolvedToneSchema:a.tone.schema,resolvedToneLinearF32:a.tone.linear_f32,validationResults:t,allPropertiesValid:s,philosophy:"re_canonicalize_and_validate_before_persistence"}),a.tone}async function _a(e,n,r,c,a,t,s,l,m,k,S,u){if(o.info("AVATAR_SAVE_AUDIT","Starting avatar save with complete input audit",{userId:e?.userId,hasSkinTone:!!l,skinToneRGB:l?`rgb(${l.rgb.r}, ${l.rgb.g}, ${l.rgb.b})`:"none",skinToneHex:l?.hex,skinToneSource:l?.source,skinToneConfidence:l?.confidence,skinToneSchema:l?.schema,resolvedGender:m,completeMorphDataCount:Object.keys(r).length,stableLimbMassesCount:Object.keys(s).length,scanResultsKeys:c?Object.keys(c):[],philosophy:"skin_tone_save_audit_entry_point"}),!e?.userId){k({type:"error",title:"Erreur d'authentification",message:"Impossible de sauvegarder sans utilisateur connecté",duration:4e3});return}if(!r||Object.keys(r).length===0){k({type:"error",title:"Aucune donnée à sauvegarder",message:"Aucune donnée morphologique disponible",duration:4e3});return}try{const p=ca(r),w=la(s);let F=null;const d=await ma(l);o.info("AVATAR_SAVE_CRITICAL_AUDIT","AUDIT: skinTonePayload after preparation - COMPLETE STRUCTURE",{skinTonePayload:d,skinTonePayloadType:typeof d,skinTonePayloadKeys:d?Object.keys(d):[],skinTonePayloadStringified:d?JSON.stringify(d):null,hasAllV2Properties:!!(d?.rgb&&d?.hex&&d?.srgb_f32&&d?.linear_f32&&d?.schema),v2PropertiesIntegrity:d?{rgb:d.rgb,hex:d.hex,srgb_f32:d.srgb_f32,linear_f32:d.linear_f32,schema:d.schema,source:d.source,confidence:d.confidence}:null,philosophy:"critical_skin_tone_payload_audit_after_preparation"}),o.info("AVATAR_SAVE_V2","V2 skin tone payload preparation - canonical format validation",{userId:e.userId,inputSkinToneAudit:l?{hasRgbProperty:!!l.rgb,rgbValue:l.rgb,hasHexProperty:!!l.hex,hexValue:l.hex,hasSchemaProperty:!!l.schema,schemaValue:l.schema,hasLinearF32Property:!!l.linear_f32,linearF32Value:l.linear_f32,hasSrgbF32Property:!!l.srgb_f32,srgbF32Value:l.srgb_f32,hasSourceProperty:!!l.source,sourceValue:l.source,hasConfidenceProperty:!!l.confidence,confidenceValue:l.confidence,completeObjectStructure:l}:null,originalSkinTone:l?{rgb:l.rgb,hex:l.hex,schema:l.schema,source:l.source,confidence:l.confidence}:null,preparedSkinTone:d?{rgb:d.rgb,hex:d.hex,schema:d.schema,srgb_f32:d.srgb_f32,linear_f32:d.linear_f32,source:d.source,confidence:d.confidence}:null,preparedSkinToneCompleteAudit:d?{hasAllRequiredProperties:!!(d.rgb&&d.hex&&d.srgb_f32&&d.linear_f32),rgbIntegrity:d.rgb?{r:d.rgb.r,g:d.rgb.g,b:d.rgb.b,allFinite:Number.isFinite(d.rgb.r)&&Number.isFinite(d.rgb.g)&&Number.isFinite(d.rgb.b)}:null,hexIntegrity:{value:d.hex,isValidHex:/^#[0-9A-Fa-f]{6}$/.test(d.hex||"")},srgbF32Integrity:d.srgb_f32?{r:d.srgb_f32.r,g:d.srgb_f32.g,b:d.srgb_f32.b,allFinite:Number.isFinite(d.srgb_f32.r)&&Number.isFinite(d.srgb_f32.g)&&Number.isFinite(d.srgb_f32.b),inRange:d.srgb_f32.r>=0&&d.srgb_f32.r<=1&&d.srgb_f32.g>=0&&d.srgb_f32.g<=1&&d.srgb_f32.b>=0&&d.srgb_f32.b<=1}:null,linearF32Integrity:d.linear_f32?{r:d.linear_f32.r,g:d.linear_f32.g,b:d.linear_f32.b,allFinite:Number.isFinite(d.linear_f32.r)&&Number.isFinite(d.linear_f32.g)&&Number.isFinite(d.linear_f32.b),inRange:d.linear_f32.r>=0&&d.linear_f32.r<=1&&d.linear_f32.g>=0&&d.linear_f32.g<=1&&d.linear_f32.b>=0&&d.linear_f32.b<=1}:null,completePayloadStructure:d}:null,skinTonePreparationSuccess:!!d,v2FormatIntegrity:!!(l?.rgb&&d?.rgb&&l.rgb.r===d.rgb.r&&l.rgb.g===d.rgb.g&&l.rgb.b===d.rgb.b),philosophy:"v2_canonical_format_validation"});const M=da(m),D="pbr-v2",C="v1.0",T=Object.keys(w),U=["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass"].filter(f=>!T.includes(f));U.length>0&&o.warn("AVATAR_SAVE","Missing limb masses detected",{missing:U.join(", "),present:T.join(", ")}),o.info("AVATAR_SAVE_LIMB_MASSES","Limb masses before persistence",{count:T.length,values:w});const b={final_shape_params:p,final_limb_masses:w,skin_tone:d,resolved_gender:m,mapping_version:C,gltf_model_id:M,material_config_version:D,savedMorphData:p,morphBounds:a,selectedArchetypes:t,lastMorphSave:new Date().toISOString(),scanId:c?.serverScanId||c?.commit?.scan_id,avatar_version:"v2.0"},E={...b};delete E.skinTone,delete E.skinToneLegacy,delete E.skin_tone_legacy,delete E.legacy_skin_tone,o.info("AVATAR_SAVE_V2","Legacy skin tone fields purged from payload",{purgedFields:["skinTone","skinToneLegacy","skin_tone_legacy","legacy_skin_tone"],canonicalField:"skin_tone",philosophy:"legacy_purge_prevent_fallback_confusion"}),o.info("AVATAR_SAVE_V2","Complete V2 payload prepared - canonical skin tone persistence",{userId:e.userId,payloadKeys:Object.keys(b),canonicalSkinTone:b.skin_tone?{rgb:b.skin_tone.rgb,hex:b.skin_tone.hex,schema:b.skin_tone.schema,source:b.skin_tone.source,confidence:b.skin_tone.confidence}:null,avatarVersion:b.avatar_version,resolvedGender:b.resolved_gender,gltfModelId:b.gltf_model_id,materialConfigVersion:b.material_config_version,v2SkinTonePersistenceReady:!!b.skin_tone,legacyFieldsPurged:!0,philosophy:"v2_canonical_payload_persistence"});const _={...e.preferences,...E};delete _.skinTone,delete _.skinToneLegacy,delete _.skin_tone_legacy,delete _.legacy_skin_tone,o.info("AVATAR_SAVE_V2","Purging legacy skin tone fields from preferences",{userId:e.userId,purgedFromPreferences:["skinTone","skinToneLegacy","skin_tone_legacy","legacy_skin_tone"],canonicalFieldPresent:!!_.skin_tone,philosophy:"preferences_legacy_purge"}),o.info("AVATAR_SAVE_V2","Saving avatar with V2 canonical skin tone data",{userId:e.userId,scanId:E.scanId,resolvedGender:m,hasV2SkinTone:!!d,v2SkinToneRGB:d?.rgb?`rgb(${d.rgb.r}, ${d.rgb.g}, ${d.rgb.b})`:"none",v2SkinToneHex:d?.hex||"none",v2SkinToneSchema:d?.schema||"none",skinToneSource:d?.source,completePayloadAuditBeforeSave:{finalShapeParamsCount:Object.keys(E.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(E.final_limb_masses||{}).length,skinToneCompleteStructure:E.skin_tone,skinToneLinearF32Present:!!E.skin_tone?.linear_f32,skinToneSrgbF32Present:!!E.skin_tone?.srgb_f32,skinToneRgbPresent:!!E.skin_tone?.rgb,skinToneHexPresent:!!E.skin_tone?.hex,avatarVersion:E.avatar_version,gltfModelId:E.gltf_model_id,materialConfigVersion:E.material_config_version,mappingVersion:E.mapping_version},legacyFieldsPurged:!0,philosophy:"v2_canonical_avatar_persistence"}),o.info("AVATAR_SAVE_AUDIT","About to call updateProfile with payload",{userId:e.userId,payloadSkinToneIncluded:!!b.skin_tone,finalPayloadAuditBeforeUpdateProfile:{preferencesKeys:Object.keys(_),skinToneInPreferences:!!_.skin_tone,skinToneStructureInPreferences:_.skin_tone,skinToneLinearF32InPreferences:_.skin_tone?.linear_f32,skinToneSrgbF32InPreferences:_.skin_tone?.srgb_f32,skinToneRgbInPreferences:_.skin_tone?.rgb,skinToneHexInPreferences:_.skin_tone?.hex,avatarVersionInPreferences:_.avatar_version,resolvedGenderInPreferences:_.resolved_gender},philosophy:"pre_update_profile_call_audit"});try{await n({preferences:{...e.preferences,...b}}),o.info("AVATAR_SAVE_AUDIT","updateProfile call completed successfully",{userId:e.userId,updateProfileCallSuccess:!0,payloadKeys:Object.keys(b),skinToneIncluded:!!b.skin_tone,avatarVersion:b.avatar_version,philosophy:"update_profile_success"})}catch(f){throw o.error("AVATAR_SAVE_AUDIT","updateProfile call failed - database error",{error:f instanceof Error?f.message:"Unknown error",stack:f instanceof Error?f.stack:void 0,userId:e.userId,payloadKeys:Object.keys(b),philosophy:"update_profile_database_failure"}),f}const I=c?.serverScanId||c?.commit?.scan_id;if(I){o.info("AVATAR_SAVE_AUDIT","About to update body_scans table with complete avatar payload",{serverScanId:I,userId:e.userId,skinToneIncluded:!!d,skinToneRGB:d?.srgb_u8?`rgb(${d.srgb_u8.r}, ${d.srgb_u8.g}, ${d.srgb_u8.b})`:"none",skinToneHex:d?.hex||"none",philosophy:"body_scans_update_pre_call_audit"});const{data:f,error:P}=await Me.from("body_scans").update({metrics:{...c.estimate?.extracted_data,final_shape_params:p,final_limb_masses:w,skin_tone:d,resolved_gender:m,mapping_version:C,gltf_model_id:M,material_config_version:D,avatar_version:"v2.0",user_adjusted_morph:p,morph_saved_at:new Date().toISOString()}}).eq("id",I).select("metrics").single();if(F=P,!P&&f?.metrics){const O=f.metrics.skin_tone,j=O&&O.schema==="v2"&&O.rgb&&O.hex&&O.srgb_f32&&O.linear_f32;o.info("AVATAR_SAVE_AUDIT","Body scans skin tone persistence verification",{serverScanId:I,userId:e.userId,bodyScanSkinTonePersistenceValid:j,persistedBodyScanSkinTone:O,expectedSkinTone:d,philosophy:"body_scans_skin_tone_persistence_verification"}),j||o.error("AVATAR_SAVE_AUDIT","CRITICAL: Body scans skin tone persistence validation failed",{serverScanId:I,userId:e.userId,persistedBodyScanSkinTone:O,expectedSkinTone:d,philosophy:"body_scans_skin_tone_persistence_validation_failed"})}P?o.error("AVATAR_SAVE_AUDIT","Failed to update body_scans table",{error:P.message,serverScanId:I,userId:e.userId,philosophy:"body_scans_update_failure_audit"}):o.info("AVATAR_SAVE_AUDIT","Successfully updated body_scans table",{serverScanId:I,userId:e.userId,philosophy:"body_scans_update_success_audit"})}o.info("AVATAR_SAVE_V2","All V2 canonical persistence operations completed successfully",{userId:e.userId,scanId:E.scanId,serverScanId:I,feedbackWorked:!0,philosophy:"complete_success_with_feedback"});try{k({type:"success",title:"Avatar sauvegardé",message:"Votre avatar a été sauvegardé avec succès",duration:3e3}),S(),o.info("AVATAR_SAVE_V2","Success feedback delivered successfully",{userId:e.userId,legacyFieldsPurged:!0,philosophy:"v2_canonical_persistence_success_confirmed_before_feedback"}),u&&setTimeout(()=>{u("/avatar#avatar"),o.info("AVATAR_SAVE_V2","Auto-redirected to avatar page after save",{userId:e.userId,redirectPath:"/avatar#avatar",philosophy:"post_save_auto_redirect"})},1500)}catch(f){o.error("AVATAR_SAVE_V2","Success feedback failed but save succeeded",{feedbackError:f instanceof Error?f.message:"Unknown error",userId:e.userId,saveSucceeded:!0,philosophy:"feedback_failure_but_save_success"})}}catch(p){o.error("AVATAR_SAVE","Avatar save failed - operation error",{error:p instanceof Error?p.message:"Unknown error",errorType:p instanceof Error?p.constructor.name:typeof p,stack:p instanceof Error?p.stack:void 0,userId:e.userId,scanId:c?.serverScanId||c?.commit?.scan_id,serverScanId:c?.serverScanId,hasSkinTone:!!l,philosophy:"save_operation_failure"}),o.error("AVATAR_SAVE_AUDIT","Avatar save failed - detailed error audit",{error:p instanceof Error?p.message:"Unknown error",errorName:p instanceof Error?p.name:"UnknownError",userId:e.userId,serverScanId:c?.serverScanId,stableSkinToneAtFailure:l?{hasRgb:!!l.rgb,rgbValue:l.rgb,source:l.source,schema:l.schema}:null,payloadPreparationCompleted:!!skinTonePayload,philosophy:"save_failure_detailed_audit"});try{k({type:"error",title:"Erreur de sauvegarde",message:"Erreur de base de données lors de la sauvegarde",duration:4e3})}catch(w){o.error("AVATAR_SAVE_AUDIT","Error toast also failed",{originalError:p instanceof Error?p.message:"Unknown error",toastError:w instanceof Error?w.message:"Unknown error",userId:e.userId,philosophy:"error_toast_failure"})}throw p}}const pa=()=>{const e=be(),{updateProfile:n}=ye(),{success:r}=se(),{scanResults:c,currentMorphData:a,completeMorphData:t,setCurrentMorphData:s,setActiveView:l,autoRotate:m,setAutoRotate:k,avatar3DRef:S,resetMorphsToInitial:u,stableUserProfile:p,stableMorphBounds:w,stableSelectedArchetypes:F,stableLimbMasses:d,stableSkinTone:M,profile:D,isViewerReady:C,handleViewerReady:T,morphologyMapping:L,morphPolicy:U,showToast:b,resolvedGender:E,criticalError:_,setCriticalError:I}=Xe(),f=v.useMemo(()=>{const A=t||{};return o.debug("BODY_SCAN_REVIEW","Using AI-refined morphs directly (no filtering)",{originalKeys:Object.keys(A).length,finalKeys:Object.keys(A).length,gender:E,philosophy:"ai_driven_no_filtering"}),A},[t,E]);if(v.useMemo(()=>{const A=!!(c&&p&&L&&f&&Object.keys(f).length>0&&E);return A&&!C&&queueMicrotask(()=>{o.info("Gate resolved - viewer ready for initialization",{hasScanResults:!!c,hasUserProfile:!!p,hasMorphologyMapping:!!L,finalShapeParamsCount:Object.keys(f).length,resolvedGender:E,readyForViewer:A})}),A},[c,p,L,f,E,C]),_)return i.jsx("div",{className:"space-y-8",children:i.jsxs(Q,{className:"text-center p-8",children:[i.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center",children:i.jsx(B,{Icon:N.AlertCircle,size:32,className:"text-red-400"})}),i.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de données critiques"}),i.jsx("p",{className:"text-red-300 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:_}),i.jsxs("div",{className:"space-y-4",children:[i.jsx("button",{onClick:()=>e("/body-scan"),className:"btn-glass--primary px-6 py-3",children:i.jsxs("div",{className:"flex items-center justify-center gap-2",children:[i.jsx(B,{Icon:N.Scan,size:16}),i.jsx("span",{children:"Nouveau scan"})]})}),i.jsx("button",{onClick:()=>{I(null),window.location.reload()},className:"btn-glass px-6 py-3",children:i.jsxs("div",{className:"flex items-center justify-center gap-2",children:[i.jsx(B,{Icon:N.RotateCcw,size:16}),i.jsx("span",{children:"Recharger"})]})})]})]})});const P=v.useCallback(A=>{s(A)},[s]);v.useCallback(A=>{l(A);const x=S.current?.getCameraControls?.();x?.setCameraView&&x.setCameraView(A)},[l,S]),v.useCallback(()=>{k(!m);const x=S.current?.getCameraControls?.();x?.toggleAutoRotate&&x.toggleAutoRotate()},[m,k,S]);const O=v.useCallback(async()=>{await _a(D,n,t,c,w,F,d,M,E,b,r,e)},[D,n,t,c,w,F,d,M,E,b,r,e]),j=v.useCallback(()=>{e("/body-scan")},[e]),g=c?.estimate?.extracted_data?.processing_confidence||c?.match?.semantic_coherence_score||c?.insights?.confidence||null;return v.useMemo(()=>{if(!g)return null;const A=c?.metadata?.morph_generation_fallback||c?.match?.metadata?.morph_generation_fallback||!1,x=A?g*.7:g;return o.debug("CONFIDENCE_CALCULATION","Adjusted confidence based on morph generation fallback",{baseConfidence:g.toFixed(3),morphGenerationFallback:A,adjustedConfidence:x.toFixed(3),philosophy:"telemetry_coherent_confidence_calculation"}),x},[g,c?.metadata?.morph_generation_fallback,c?.match?.metadata?.morph_generation_fallback]),c?i.jsxs("div",{className:"space-y-8 visionos-grid",children:[i.jsxs(Q,{className:"bodyscan-card p-8 -mt-4",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsxs("h3",{className:"text-white font-semibold flex items-center gap-2",children:[i.jsx("div",{className:"glowing-icon-container",children:i.jsx(B,{Icon:N.Eye,size:16,className:"text-purple-400"})}),i.jsx("span",{className:"glowing-title-text",children:"Votre Avatar 3D"})]}),!C&&i.jsxs("div",{className:"viewer-status-badge viewer-status-badge--preparing flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/20 border border-blue-400/30",children:[i.jsx("div",{className:"viewer-status-icon w-2 h-2 rounded-full bg-blue-400 animate-pulse"}),i.jsx("span",{className:"viewer-status-text text-blue-300 text-xs font-medium",children:"Préparation..."})]}),C&&i.jsxs("div",{className:"viewer-status-badge viewer-status-badge--ready flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/20 border border-green-400/30",children:[i.jsx(B,{Icon:N.Check,size:12,className:"viewer-status-icon text-green-400"}),i.jsx("span",{className:"viewer-status-text text-green-300 text-xs font-medium",children:"Prêt"})]})]}),i.jsx("div",{className:"avatar-3d-viewer-container h-[400px] sm:h-[500px] md:h-[550px] lg:h-[600px] xl:h-[650px] rounded-2xl bg-gradient-to-br from-purple-500/10 via-blue-500/10 to-cyan-500/10 border border-purple-400/20 relative overflow-hidden",children:i.jsx(Ee,{ref:S,scanResult:c,userProfile:p||{sex:E,height_cm:175,weight_kg:70},morphData:f,limbMasses:d,skinTone:M,minMaxBounds:w,selectedArchetypes:F,serverScanId:c?.serverScanId||c?.commit?.scan_id,resolvedGender:E,className:"w-full h-full",autoRotate:m,onMorphDataChange:P,onViewerReady:T,showControls:!0})})]}),L&&U&&i.jsx("div",{className:"mt-8",children:i.jsx(Se,{currentMorphData:a,setCurrentMorphData:s,resetMorphsToInitial:u,morphPolicy:U,morphologyMapping:L,resolvedGender:E,isViewerReady:C,avatar3DRef:S})}),i.jsx("div",{className:"mt-8",children:i.jsx(ta,{scanResults:c,userProfile:p,skinTone:M})}),i.jsx("div",{className:"mt-12",children:i.jsx(oa,{isViewerReady:C,onSaveAvatar:O,onNewScan:j})})]}):i.jsxs(Q,{className:"text-center p-8",children:[i.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-purple-500/20 flex items-center justify-center",children:i.jsx(B,{Icon:N.Loader2,size:24,className:"text-purple-400 animate-spin"})}),i.jsx("h3",{className:"text-white font-semibold mb-2",children:"Chargement de votre avatar"}),i.jsx("p",{className:"text-white/60 text-sm",children:"Préparation de l'expérience 3D..."})]})},Ia=()=>{const{isActive:e,steps:n,currentStep:r,progress:c,message:a,subMessage:t}=Z();return i.jsxs("div",{className:"max-w-7xl mx-auto mt-4 space-y-6 pb-4",children:[e&&n.length>0&&i.jsx(Ie,{steps:n,currentStepId:"avatar",progress:100,message:"Avatar 3D Prêt",subMessage:"Ajustez et sauvegardez votre reflet numérique"}),i.jsx(pa,{})]})};export{Ia as default};
