/* =========================================
   TOUCH OPTIMIZATION - Consolidated Mobile Touch Support
   Fast, accessible touch interactions across devices
   ========================================= */

html{
  -webkit-tap-highlight-color:transparent;
  -webkit-touch-callout:none;
  /* DO NOT disable user-select globally - breaks scroll */
}

button, [role="button"] {
  -webkit-user-select:none;
  user-select:none;
}

input, textarea, [contenteditable]{ -webkit-user-select:auto; user-select:auto; }

/* Touch feedback (CSS-only) - Réduit pour mobile */
.touch-feedback{ transition:transform 80ms ease-out, opacity 80ms ease-out; }
.touch-feedback:active{
  transform:scale(.97) translateZ(0);
  opacity:.92;
  box-shadow:inset 0 3px 8px rgba(0,0,0,.3), inset 0 1px 2px rgba(0,0,0,.4);
}
.touch-feedback-css{ transition:transform 80ms ease-out, background 80ms ease-out; }
.touch-feedback-css:active{
  transform:scale(.98) translateZ(0);
  background:rgba(255,255,255,.12) !important;
}

/* Buttons - Feedback réduit */
.btn-touch-feedback:active{
  transform:scale(.97) translateZ(0);
  box-shadow:inset 0 2px 6px rgba(0,0,0,.25) !important;
  transition:all 80ms ease-out;
}

/* Targets & actions */
button,[role="button"],.glass-card[data-interactive],.tabs-trigger,.sidebar-item,.nav-item,
input[type="submit"],input[type="button"]{
  min-width:var(--touch-target-min,44px) !important;
  min-height:var(--touch-target-min,44px) !important;
  position:relative;
  touch-action:manipulation;
}

/* CRITICAL: Ensure body and main containers allow scroll WITHOUT animations */
body, #root, [class*="route-container"], main {
  touch-action: pan-y pinch-zoom !important;
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior-y: auto !important;
}

/* Mobile - Disable all will-change on scrollable elements */
@media (max-width: 1024px), (hover: none), (pointer: coarse) {
  body,
  #root,
  [class*="route-container"],
  main,
  .sidebar-content,
  [class*="scroll"],
  [class*="overflow"] {
    will-change: auto !important;
    transform: none !important;
    transition: none !important;
  }

  /* Disable animations on scroll */
  * {
    animation-play-state: paused !important;
  }

  /* Re-enable only essential animations */
  .loader-essential,
  [class*="spinner"],
  [class*="loading"] {
    animation-play-state: running !important;
  }
}

/* Expansion halos */
.touch-extend::before,.touch-target-expanded::before{
  content:""; position:absolute; inset:-8px; border-radius:inherit; z-index:-1;
}
.touch-target-enhanced{
  min-width:var(--touch-target-recommended,48px);
  min-height:var(--touch-target-recommended,48px);
  display:inline-flex; align-items:center; justify-content:center; position:relative;
}

/* Scroll UX */
.momentum-scroll-enhanced{
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
  overscroll-behavior-y:auto;
  /* REMOVED: scroll-snap-type causing scroll issues */
}
.modal-scroll-lock{
  overscroll-behavior:none;
  -webkit-overflow-scrolling:auto;
  /* PREVENT body scroll when modal open */
  touch-action: none;
}

/* iOS */
@supports (-webkit-touch-callout: none){
  body{ overflow-x:hidden; overflow-y:auto; }
  .ios-optimized{
    -webkit-overflow-scrolling:touch;
    -webkit-transform:translate3d(0,0,0);
    -webkit-touch-callout:none;
    -webkit-user-select:none;
    -webkit-tap-highlight-color:transparent;
  }
  .ios-keyboard-aware{ height:calc(100vh - env(keyboard-inset-height, 0px)); }
  input,select,textarea{ font-size:16px !important; }
}

/* Android */
@media (pointer:coarse) and (hover:none){
  .android-optimized{ touch-action:manipulation; -webkit-tap-highlight-color:transparent; }
  .glass-card:active{ background-color:rgba(255,255,255,.1); }
}

/* Desktop feedback for glass cards - FORGE HAMMER ONLY ON TAP */
@media (min-width:641px) and (hover: hover) and (pointer: fine){
  /* IMPORTANT: Pas de lueur orange au hover, seulement feedback subtil */
  .glass-card:hover{
    background: rgba(255,255,255,.08);
    transition:background 120ms ease-out;
  }

  /* Lueur orange uniquement au clic/tap - effet réduit et plus subtil */
  .glass-card:active{
    background:
      radial-gradient(circle at var(--mx, 50%) var(--my, 50%),
        var(--color-ember-copper,#FF7A45) 8%,
        rgba(255, 122, 69, 0.4) 20%,
        transparent 65%
      ),
      rgba(255,255,255,.15) !important;
    transform:scale(.98) translateZ(0) !important;
    box-shadow:
      inset 0 3px 8px rgba(0,0,0,.3),
      0 0 20px rgba(255, 122, 69, 0.5),
      0 0 40px rgba(255, 122, 69, 0.25) !important;
    transition:all 80ms ease-out !important;
  }
}

/* Mobile feedback for glass cards - COMPLETELY DISABLED */
@media (max-width:640px), (hover: none), (pointer: coarse){
  /* Désactiver complètement TOUS les effets sur mobile */
  .glass-card:hover,
  .glass-card:active {
    background: initial !important;
    transform: none !important;
    box-shadow: none !important;
    opacity: 1 !important;
    scale: 1 !important;
    transition: none !important;
  }

  /* Supprimer tous les pseudo-éléments d'animation */
  .glass-card::before,
  .glass-card::after {
    display: none !important;
    animation: none !important;
  }
  .tab-content{
    max-height:calc(100vh - var(--header-height,80px) - var(--tabs-height,60px));
    overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  .glass-card-child{ padding:.75rem; }
}

/* Mobile full-width */
@media (max-width:768px){
  .responsive-content-container{
    padding:0 !important;
    /* ALLOW SCROLL - do not use position:static with transforms */
  }
  .space-y-6 > *:not(.header-liquid-glass):not(.fab-nexus-forge){
    margin-left:0 !important;
    margin-right:0 !important;
  }
  .route-container{
    padding-left:0 !important;
    padding-right:0 !important;
  }

  /* Ensure body can scroll WITHOUT flickering */
  body {
    overflow-y: auto !important;
    touch-action: pan-y pinch-zoom !important;
    -webkit-overflow-scrolling: touch !important;
    will-change: auto !important;
    transform: none !important;
  }

  /* Disable all transforms and animations during scroll */
  body *:not(.loader-essential):not([class*="spinner"]):not([class*="loading"]) {
    will-change: auto !important;
  }

  /* IMPORTANT: garder les particules actives et visibles sur mobile */
  .cosmic-forge-particles{ display:block !important; opacity:.8 !important; }
  .forge-particle{ display:block !important; opacity:.6 !important; }
  /* On laisse la durée aux variables JS (--duration) pour fluidité */
}

/* Accessibility */
@media (prefers-contrast: high){
  .touch-feedback:active,.touch-feedback-css:active{
    outline:3px solid var(--brand-primary, #3D13B3);
    outline-offset:2px;
  }
}

/* Larger targets on reduced-data */
@media (prefers-reduced-data: reduce){
  button,[role="button"],.glass-card[data-interactive]{
    min-width:calc(var(--touch-target-min,44px) * 1.2);
    min-height:calc(var(--touch-target-min,44px) * 1.2);
  }
}

/* Low-end throttle */
.low-performance-device .touch-feedback:active,
.low-performance-device .touch-feedback-css:active{
  transform:none !important;
  box-shadow:none !important;
  background:rgba(255,255,255,.1) !important;
  transition:background 100ms ease !important;
}

/* Gestures */
.swipe-container{ touch-action:pan-x; -webkit-overflow-scrolling:touch; overscroll-behavior-x:none; }
.swipe-vertical{ touch-action:pan-y; -webkit-overflow-scrolling:touch; overscroll-behavior-y:auto; }
.pinch-zoom-enabled{ touch-action:pinch-zoom; }
/* REMOVED: .touch-action-none to prevent scroll blocking */

/* Scrollbars */
.touch-scroll-optimized{
  -webkit-overflow-scrolling:touch; scroll-behavior:smooth; overscroll-behavior:contain;
  scroll-snap-type:y proximity; scrollbar-width:thin; scrollbar-color:rgba(255,255,255,.2) transparent;
}
.touch-scroll-optimized::-webkit-scrollbar{ width:8px; height:8px; }
.touch-scroll-optimized::-webkit-scrollbar-track{ background:transparent; }
.touch-scroll-optimized::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.2); border-radius:4px; border:1px solid rgba(255,255,255,.1);
}
.touch-scroll-optimized::-webkit-scrollbar-thumb:active{ background:rgba(255,255,255,.3); }

/* Mobile - Disable scroll-linked animations */
@media (max-width: 1024px), (hover: none), (pointer: coarse) {
  .touch-scroll-optimized {
    scroll-behavior: auto !important;
  }

  /* Disable position: fixed animations during scroll */
  [style*="position: fixed"],
  .fixed,
  [class*="fixed"] {
    will-change: auto !important;
    transform: none !important;
  }
}

/* Ripple */
.touch-ripple{ position:relative; overflow:hidden; }
.touch-ripple::before{
  content:""; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%;
  background:rgba(255,255,255,.3); transform:translate(-50%,-50%);
  transition:width .3s ease, height .3s ease; pointer-events:none;
}
.touch-ripple:active::before{ width:200%; height:200%; }

/* FORGE SPARKS - Particules d'étincelles réduites - DESKTOP UNIQUEMENT */
@media (min-width: 641px) and (hover: hover) and (pointer: fine) {
  .glass-card::before{
    content:'';
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:
      radial-gradient(1.5px 1.5px at 20% 30%, var(--color-ember-copper,#FF7A45) 100%, transparent),
      radial-gradient(0.8px 0.8px at 80% 40%, rgba(255,255,255,.7) 100%, transparent),
      radial-gradient(1px 1px at 50% 70%, var(--color-ember-copper,#FF7A45) 100%, transparent),
      radial-gradient(0.8px 0.8px at 30% 60%, rgba(255,255,255,.6) 100%, transparent);
    opacity:0;
    pointer-events:none;
    z-index:10;
    transition:opacity 0.1s ease-out;
  }

  .glass-card:active::before{
    animation:forge-sparks 0.15s ease-out;
  }
}

/* Désactiver TOUS les effets visuels sur mobile pour performance */
@media (max-width: 640px), (hover: none), (pointer: coarse) {
  .glass-card::before,
  .glass-card::after,
  button::before,
  button::after,
  [role="button"]::before,
  [role="button"]::after {
    display: none !important;
    opacity: 0 !important;
    animation: none !important;
  }
}

@keyframes forge-sparks{
  0%{
    opacity:0;
    transform:scale(0.9);
  }
  50%{
    opacity:0.8;
    transform:scale(1.05);
  }
  100%{
    opacity:0;
    transform:scale(1.1);
  }
}