/**
 * CRITICAL FIX: Mobile Scroll Restoration
 * Ensures proper scroll behavior on mobile devices
 * Addresses conflicts between position:fixed and overflow
 */

/* =========================================
   CORE SCROLL FIX
   ========================================= */

/* Ensure html and body allow proper scrolling */
@media (max-width: 1024px) {
  html {
    overflow-x: clip !important; /* clip instead of hidden preserves position:fixed */
    overflow-y: visible !important; /* allow scrolling */
    height: 100% !important;
  }

  body {
    overflow-x: clip !important; /* clip instead of hidden preserves position:fixed */
    overflow-y: auto !important; /* body scrolls */
    min-height: 100vh !important;
    min-height: 100dvh !important;
    -webkit-overflow-scrolling: touch !important;
    overscroll-behavior-x: none !important;
    overscroll-behavior-y: auto !important;
  }

  /* Root container must allow overflow */
  #root {
    overflow: visible !important;
    min-height: 100vh !important;
    min-height: 100dvh !important;
  }

  /* Main content MUST scroll */
  #main-content,
  [role="main"] {
    overflow-y: auto !important;
    overflow-x: clip !important;
    -webkit-overflow-scrolling: touch !important;
    overscroll-behavior-y: auto !important;
    overscroll-behavior-x: none !important;
    /* Ensure proper height for scrolling */
    min-height: calc(100vh - 80px) !important; /* Account for header */
    min-height: calc(100dvh - 80px) !important;
  }
}

/* =========================================
   POSITION FIXED PRESERVATION
   ========================================= */

/* Ensure fixed elements stay fixed despite overflow changes */
@media (max-width: 1024px) {
  .header-liquid-glass,
  .new-mobile-bottom-bar {
    position: fixed !important;
    transform: translate3d(0, 0, 0) !important;
    -webkit-transform: translate3d(0, 0, 0) !important;
    will-change: transform !important;
    backface-visibility: hidden !important;
    -webkit-backface-visibility: hidden !important;
    contain: layout style paint !important;
    isolation: isolate !important;
  }

  /* Header must stay at top */
  .header-liquid-glass {
    top: 8px !important;
    left: 24px !important;
    right: 24px !important;
  }

  /* Bottom bar must stay at bottom */
  .new-mobile-bottom-bar {
    bottom: var(--new-bottom-bar-bottom-offset, 8px) !important;
    left: 8px !important;
    right: 8px !important;
  }
}

/* =========================================
   TOUCH SCROLL OPTIMIZATION
   ========================================= */

@media (max-width: 1024px) {
  /* Momentum scrolling for iOS */
  * {
    -webkit-overflow-scrolling: touch !important;
  }

  /* Prevent scroll chaining on fixed elements */
  .header-liquid-glass,
  .new-mobile-bottom-bar,
  .header-liquid-glass *,
  .new-mobile-bottom-bar * {
    overscroll-behavior: contain !important;
    -webkit-overflow-scrolling: auto !important;
  }

  /* Allow scroll chaining on scrollable content */
  #main-content,
  [role="main"],
  .scrollable-content {
    overscroll-behavior: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
}

/* =========================================
   IOS SPECIFIC FIXES
   ========================================= */

@supports (-webkit-touch-callout: none) {
  html, body {
    overflow-x: clip !important;
    overflow-y: auto !important;
    position: static !important;
  }

  #main-content {
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Prevent iOS scroll bounce on fixed elements */
  .header-liquid-glass,
  .new-mobile-bottom-bar {
    -webkit-overflow-scrolling: auto !important;
    overscroll-behavior: contain !important;
  }
}

/* =========================================
   ANDROID SPECIFIC FIXES
   ========================================= */

@media (pointer: coarse) and (hover: none) {
  body {
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }

  #main-content {
    overflow-y: auto !important;
    touch-action: pan-y !important;
  }
}

/* =========================================
   PREVENT SCROLL LOCK BUGS
   ========================================= */

/* Override any body.overflow-hidden from overlays when needed */
@media (max-width: 1024px) {
  body:not(.overlay-open) {
    overflow-y: auto !important;
  }

  /* When overlay is open, only hide overflow, don't fix position */
  body.overlay-open {
    overflow: hidden !important;
    position: static !important; /* CRITICAL: Don't use fixed */
  }
}

/* =========================================
   SAFE AREA INSETS
   ========================================= */

@media (max-width: 1024px) {
  body {
    /* Respect safe areas on iOS */
    padding-left: max(0px, env(safe-area-inset-left)) !important;
    padding-right: max(0px, env(safe-area-inset-right)) !important;
  }

  #main-content {
    /* Add bottom padding for bottom bar + safe area */
    padding-bottom: calc(
      var(--new-bottom-bar-height, 80px) +
      var(--new-bottom-bar-bottom-offset, 8px) +
      max(16px, env(safe-area-inset-bottom))
    ) !important;
  }
}
